<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水母终端</title>
    <style>
        :root {
            /* 主题色调 */
            --bg-color-start: #ffffff; /* White */
            --bg-color-end: #f0f0f0;   /* Light Gray */
            --glass-bg: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-color: #475569;
            --icon-color: #334155;
            --card-radius: 24px;
            --pill-radius: 999px; /* 胶囊形状圆角 */
            --app-radius: 16px; 
            --gap-size: 16px;
            --page-gap: 40px; 
            --accent-color: #334155; /* 新增：主题强调色，默认为深灰蓝 */
        }


        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(160deg, var(--bg-color-start) 0%, #e5e5e5 50%, var(--bg-color-end) 100%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }


        /* 背景装饰 */
        body::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            width: 60%;
            height: 40%;
            background: rgba(200, 200, 200, 0.3); /* 调整为中性灰色光晕 */
            filter: blur(80px);
            border-radius: 50%;
            z-index: -1;
        }
        
        body::after {
            content: '';
            position: absolute;
            bottom: -10%;
            right: -10%;
            width: 60%;
            height: 40%;
            background: rgba(150, 150, 150, 0.3); /* 调整为中性灰色光晕 */
            filter: blur(80px);
            border-radius: 50%;
            z-index: -1;
        }


        /* 移动端限制容器 */
        #mobile-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            max-width: 520px; 
            max-height: 920px; 
            background: transparent;
            box-shadow: 0 0 0 0 rgba(0,0,0,0);
            transition: all 0.3s ease;
        }

        @media (min-width: 600px) {
            #mobile-wrapper {
                height: 90vh;
                border-radius: 40px;
                border: 1px solid rgba(255,255,255,0.4);
                box-shadow: 0 20px 50px rgba(0,0,0,0.15);
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
            }
        }

        #viewport {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* 修改：顶部增加padding让整体下沉一点点，底部padding加大 */
            padding: 40px 24px 60px 24px; 
            position: relative;
            overflow: hidden; 
        }

        #slider-container {
            display: flex;
            gap: var(--page-gap); 
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform;
        }

        .page {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 2px; 
        }

        /* === Grid 布局核心修改 === */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 修改：
               第一行 auto (给顶部胶囊自适应)
               第二行 1fr (App区域)
               第三行 1fr (App区域)
               不再使用固定比例填充整个高度
            */
            grid-template-rows: auto auto auto; 
            gap: var(--gap-size);
            width: 100%;
            /* 关键：内容向上对齐，底部自然留白 */
            align-content: start; 
        }

        /* === 顶部区域容器 === */
        .top-section-container {
            grid-column: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 底部留出一点距离给下面的App */
            margin-bottom: 20px; 
            gap: 12px;
        }

        /* 1. 顶部小状态栏 (胶囊) */
        .status-capsule {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--pill-radius);
            box-shadow: var(--glass-shadow);
            
            /* 尺寸设定 */
            width: 50%; /* 约半个屏幕宽 */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 简单纯CSS电池图标 */
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1.5px solid var(--text-color);
            border-radius: 2px;
            position: relative;
            padding: 1px;
        }
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 2px;
            width: 2px;
            height: 4px;
            background: var(--text-color);
            border-radius: 0 1px 1px 0;
        }
        .battery-level {
            height: 100%;
            background: var(--text-color);
            width: 80%; /* 默认电量 */
            border-radius: 0.5px;
        }

        /* 2. 个人信息大胶囊 */
        .profile-capsule {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50px; /* 较大的圆角 */
            box-shadow: var(--glass-shadow);
            
            width: 100%;
            height: 80px; /* 高度适中 */
            display: flex;
            align-items: center;
            padding: 8px;
            padding-right: 24px;
            gap: 16px;
        }

        /* 头像框 */
        .avatar-frame {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.5);
            /* [已修复] 彻底URL编码并使用单引号 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255,255,255,0.8);
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            flex-shrink: 0;
        }

        
        .avatar-frame:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 4px;
        }

        .profile-bio {
            font-size: 14px;
            color: #64748b;

            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* === 下方格子区域 === */
        
        /* 通用盒子样式 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            /* 关键：强制正方形 */
            aspect-ratio: 1 / 1; 
            width: 100%;
        }

        /* App 区域容器 */
        .app-grid-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            place-items: center; 
            padding: 4px;
            /* 关键：强制正方形 */
            aspect-ratio: 1 / 1; 
            width: 100%;
        }

        .area-mid-left {
            grid-column: 1 / 2;
            /* 移除 grid-row 强制设定，让它自动流式布局 */
        }

        .area-mid-right {
            grid-column: 2 / 3;
            background: rgba(255, 255, 255, 0.25);
            padding: 0;
        }
        
        .photo-placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            border-radius: var(--card-radius);
        }

        .area-bot-left {
            grid-column: 1 / 2;
            opacity: 0.6;
        }

        .area-bot-right {
            grid-column: 2 / 3;
        }

        /* App 样式 */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            width: 100%; 
            height: 100%;
            cursor: pointer;
        }

        .app-icon-box {
            width: 56px; 
            height: 56px;
            aspect-ratio: 1 / 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--app-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease, background-color 0.2s;
            flex-shrink: 0; 
        }

        .app-wrapper:active .app-icon-box {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.6);
        }

        .app-icon {
            width: 50%;
            height: 50%;
        }
        .app-icon path {
            fill: var(--icon-color) !important;
        }

        .app-name {
            font-size: 10px; 
            font-weight: 500;
            opacity: 0.9;


            margin-top: 5px;
            text-align: center;
            color: var(--text-color);
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        /* 底部导航点 */
        .pagination {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dot.active {
            background: #64748b;
            transform: scale(1.1);
            width: 16px;
            border-radius: 3px;
            opacity: 0.8;
        }
        
        .empty-text {
            font-size: 14px;
            color: #94a3b8;
            letter-spacing: 1px;
        }
        /* 在这里添加新样式 */

        /* === 全屏界面样式 (重构) === */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            /* 移除背景模糊，变为纯色背景 */
            background-color: var(--bg-color-end); 
            transition: opacity 0.3s ease;
        }

        #modal-overlay.visible {
            pointer-events: auto;
            opacity: 1;
        }

        #modal-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: transparent; /* 背景由 overlay 提供 */
            /* 核心动效：从点击位置放大 */
            transform-origin: 50% 50%; /* JS会动态修改这个值 */
            transform: scale(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0;
        }
        
        #modal-overlay.visible #modal-container {
            transform: scale(1);
        }
        /* 添加一个关闭时的动画类 */
        #modal-container.is-closing {
             transform: scale(0);
        }


        #modal-header {
            display: flex;
            /* 修改：让返回按钮在左，标题居中 */
            justify-content: flex-start; 
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
            position: relative; /* 为了标题绝对定位 */
        }

        #modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--icon-color);
            /* 绝对定位实现完美居中 */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            
        }

        #modal-close-btn {
            /* 修改：移除所有背景和边框，变为纯图标按钮 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            z-index: 1; /* 确保在标题上层，可点击 */
        }
        
        #modal-close-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
            transition: transform 0.2s;
        }

        #modal-close-btn:active svg {
            transform: scale(0.85);
        }

        #modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* 模态框内的表单样式 (通用) */
        .modal-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-form-group label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.7;
        }
        
        .modal-input, .modal-select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.5);
            /* 修改：将字体大小设置为16px可防止在iOS上自动缩放 */
            font-size: 16px;
            color: var(--text-color);
            /* 新增：允许在输入框中选择文字 */
            user-select: text;
            -webkit-user-select: text;
        }

        .modal-input::placeholder {
            color: #94a3b8;
        }
        
        .modal-button {
            padding: 14px 24px; /* 增加内边距 */
            border-radius: 12px; /* 相应增大圆角 */
            border: none;
            /* 使用 CSS 变量作为强调色 */
            background: var(--accent-color); 
            color: white;
            font-size: 15px; /* 增大字体 */
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            width: auto; /* 关键：让按钮宽度自适应内容 */
            flex-grow: 0; /* 关键：在flex布局中不拉伸 */
        }

        .modal-button:active {
            transform: scale(0.98);
        }
        
        .modal-button.secondary {
             background: rgba(100, 116, 139, 0.5); /* 更新按钮颜色 */
             color: var(--text-color);
             border: 1px solid var(--glass-border);
        }

        /* 昼夜模式切换样式 */
        body.dark-mode {
            --bg-color-start: #27272a; /* Zinc 800 */
            --bg-color-end: #18181b;   /* Zinc 900 */
            --glass-bg: rgba(39, 39, 42, 0.45);
            --glass-border: rgba(63, 63, 70, 0.6);
            --text-color: #cbd5e1;
            --icon-color: #e2e8f0;
            --accent-color: #60a5fa; /* 新增：暗黑模式下的默认强调色，可选一个亮色 */
        }

        body.dark-mode .profile-name {
            color: #f1f5f9;
        }
        body.dark-mode .profile-bio {
            color: #94a3b8;
        }
        body.dark-mode .app-name {
            text-shadow: none;
        }
        body.dark-mode .dot {
            background: rgba(255, 255, 255, 0.2);
        }
        body.dark-mode .dot.active {
            background: #cbd5e1;
        }
        body.dark-mode .modal-button {
            /* 暗黑模式下也使用强调色 */
             background: var(--accent-color, #4f46e5);
        }
        body.dark-mode .modal-button.secondary {
             background: rgba(71, 85, 105, 0.6);
             color: #e2e8f0;
        }



        /* 预设区域样式 */
        .preset-section {
            padding: 16px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .preset-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
        }
        .preset-controls .modal-select {
            grid-column: 1 / 2;
        }
        .preset-controls .modal-button {
            padding: 8px 12px; /* 调整为较小的内边距 */
            margin-top: 0;
            font-size: 13px; /* 保持较小的字体 */
            border-radius: 8px; /* 较小的圆角 */
            white-space: nowrap;
        }


        /* 表单组新样式 */
        .modal-form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 滑杆样式 */
        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .slider-group input[type="range"] {
            flex-grow: 1;
        }
        .slider-group .slider-value {
            font-size: 14px;
            font-weight: 500;
            min-width: 30px;
            text-align: right;
        }

        /* 开关样式 */
        .switch-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .switch-container {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            transition: .4s;
            border-radius: 34px;
        }
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .switch-slider {
            background-color: var(--accent-color);
        }

        input:checked + .switch-slider:before {
            transform: translateX(20px);
        }
        /* 在这里添加新样式 */

        /* 手机预览框样式 */
        .mockup-container {
            display: flex;
            justify-content: space-around;
            gap: 16px;
            margin: 20px 0;
        }
        .phone-mockup {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .phone-mockup label {
            font-size: 14px;
            font-weight: 600;
        }
        .phone-frame {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 9 / 19.5;
            background: #111;
            border: 8px solid #111;
            border-radius: 24px;
            padding: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0;
            border-radius: 16px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .phone-mockup.dark .phone-screen {
            background-color: #0f172a;
        }
        .phone-screen::before {
            content: '点击更换';
            position: absolute;
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .phone-screen:hover::before {
            opacity: 1;
        }
        .mockup-text {
            font-size: 10px;
            font-weight: bold;
            color: #334155;
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        .phone-mockup.dark .mockup-text {
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        /* 在这里添加新样式 */

        /* 手机预览框样式 */
        .mockup-container {
            display: flex;
            justify-content: space-around;
            gap: 16px;
            margin: 20px 0;
        }
        .phone-mockup {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .phone-mockup label {
            font-size: 14px;
            font-weight: 600;
        }
        .phone-frame {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 9 / 16;
            background: #111;
            border: 3px solid #111;
            border-radius: 24px;
            padding: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0;
            border-radius: 16px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .phone-mockup.dark .phone-screen {
            background-color: #0f172a;
        }
        .phone-screen::before {
            content: '点击更换';
            position: absolute;
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .phone-screen:hover::before {
            opacity: 1;
        }
        .mockup-text {
            font-size: 10px;
            font-weight: bold;
            color: #334155;
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        .phone-mockup.dark .mockup-text {
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        /* === 在这里添加新样式 === */

        /* 主题色选择器样式 */
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .color-swatch-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }
        #theme-accent-color-picker {
            opacity: 0;
            width: 100%;
            height: 100%;
            position: absolute;
            cursor: pointer;
        }
        #theme-accent-color-swatch {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            background-color: var(--accent-color);
            cursor: pointer; /* 添加手型光标 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #theme-accent-color-hex {
            flex-grow: 1;
            /* 限制最大宽度以防超出屏幕 */
            max-width: 120px; 
        }

        /* 分隔线样式 */
        .subtle-divider {
            height: 1px;
            border: none;
            width: 80%;
            margin: 24px auto;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.1), transparent);
        }
        body.dark-mode .subtle-divider {
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
        }

        /* API模型选择器布局 */
        .model-selection-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-selection-group .modal-select {
            flex-grow: 1;
        }
        .model-selection-group .modal-button {
            padding: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 16px; /* 增加与上方内容的间距 */
        }
        /* 正在回复的加载动画 */
        @keyframes dot-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-dots {
            display: flex;
            align-items: center;
            height: 1em; /* 确保高度足够显示点 */
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background-color: var(--text-color); /* 使用主题文本颜色 */
            border-radius: 50%;
            margin: 0 2px;
            animation: dot-pulse 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .message-line.loading {
            align-self: flex-start;
            pointer-events: none; /* 防止点击 */
        }

        .message-line.loading .chat-bubble {
            background-color: var(--glass-bg); /* 保持一致的背景 */
            backdrop-filter: blur(10px);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px; /* 确保能容纳三个点 */
            padding: 8px 12px;
        }

        .message-line.loading .chat-bubble .loading-dots span {
             background-color: var(--icon-color); /* 配合背景调整点颜色 */
        }

        /* === 世界书 App 样式 === */
        #world-book-fab {
            position: fixed;
            bottom: 80px;
            right: 25px;
            /* 修改：尺寸缩小约 1/3 */
            width: 38px;
            height: 38px;
            /* 修改：应用磨砂玻璃质感 */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s, background-color 0.2s;
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        #world-book-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #world-book-fab:active {
            transform: scale(0.95) !important;
        }
        #world-book-fab svg {
            /* 修改：图标尺寸相应缩小 */
            width: 20px;
            height: 20px;
            /* 修改：图标颜色跟随主题 */
            fill: var(--icon-color);
        }


        #modal-header-controls {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .world-book-category {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .world-book-category:hover {
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .world-book-category:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .category-title {
            font-weight: 600;
        }
        .category-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
        }
        .world-book-category.expanded .category-arrow {
            transform: rotate(90deg);
        }
        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background-color: rgba(0,0,0,0.02);
            padding: 0 16px;
        }
        body.dark-mode .category-items {
             background-color: rgba(0,0,0,0.1);
        }
        .category-items.visible {
            max-height: 1000vh; /* 一个足够大的值 */
            padding: 10px 16px;
        }
        .world-book-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: var(--glass-shadow);
        }
        .item-title {
            font-weight: 500;
            margin-bottom: 6px;
        }
        .item-content {
            font-size: 14px;
            opacity: 0.8;
            /* 修改：实现单行文本溢出显示省略号 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* word-wrap 不再需要 */
        }


        .add-item-placeholder {
            padding: 12px;
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            text-align: center;
            color: var(--text-color);
            opacity: 0.6;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            margin-top: 10px;
        }
        .add-item-placeholder:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .add-item-placeholder:hover {
            background-color: rgba(255,255,255,0.05);
        }

        /* 编辑模式样式 */
        .edit-mode-controls {
            display: flex;
            gap: 8px;
        }
        .edit-mode-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }
        .edit-mode-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--text-color);
            opacity: 0.6;
        }
        .edit-mode-btn:hover svg {
            opacity: 1;
        }
        .world-book-category[draggable="true"] {
            cursor: grab;
        }
        .world-book-category.dragging {
            opacity: 0.5;
            background: rgba(0,0,0,0.1);
        }
        .drag-over {
            border-top: 2px solid var(--accent-color);
        }

        #world-book-add-item-form textarea {
            min-height: 120px;
            /* 限制最大高度为视口高度的45%，留下足够空间给标题、按钮和边距 */
            max-height: 45vh; 
            resize: vertical;
        }


        /* 按钮容器样式，用于居中 */
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 16px; /* 增加与上方内容的间距 */
        }
        .world-book-category.in-edit-mode {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .world-book-category.in-edit-mode {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* === Chat App 样式 === */
        #chat-app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1500;
            opacity: 0;
            transform: scale(1.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-app-container.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #chat-wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color-end);
            background-image: url('https://images.unsplash.com/photo-1616047778988-19814a0cb723?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb'); /* 默认壁纸 */
            background-size: cover;
            background-position: center;
            z-index: -1;
            transition: background-image 0.5s;
        }

        #chat-app-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* --- 顶栏和底栏的模糊渐变效果 --- */
        .chat-header, .chat-footer {
            position: relative;
            z-index: 10;
        }

        .chat-header::before, .chat-footer::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            z-index: -1;
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }

        .chat-header::before {
            top: -40px;
            height: calc(100% + 40px);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        .chat-footer::after {
            bottom: -10px;
            height: calc(100% + 10px);
            -webkit-mask-image: linear-gradient(to top, black 60%, transparent 100%);
            mask-image: linear-gradient(to top, black 60%, transparent 100%);
        }

        /* --- 联系人列表页 --- */
        .chat-contact-list-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .chat-main-header {
            padding: 16px 20px;
            font-size: 24px;
            font-weight: bold;
            color: var(--text-color);
            background-color: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        
        body.dark-mode .chat-main-header {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .chat-contact-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .chat-contact-item {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        
        .chat-contact-item:last-child {
            border-bottom: none;
        }

        .chat-contact-item:hover {
            background-color: rgba(0,0,0,0.03);
        }
        
        body.dark-mode .chat-contact-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .chat-contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background-color: #ccc;
            margin-right: 15px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        
        .chat-contact-info {
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-contact-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .chat-contact-last-msg {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        /* --- 聊天室页面 --- */
        .chat-room-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 10px;
            flex-shrink: 0;
            background: transparent; /* 背景由伪元素模糊层提供 */
        }
        
        .chat-header-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .chat-header-btn svg {
            width: 28px;
            height: 28px;
            fill: var(--icon-color);
        }
        
        .chat-contact-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px; /* 增加消息之间的间距 */
        }
        
        .message-line {
            display: flex;
            align-items: flex-start; /* 头像和气泡顶部对齐 */
            gap: 10px;
            max-width: 85%; /* 限制整行最大宽度，防止过长 */
        }

        .message-line.sent {
            align-self: flex-end;
            flex-direction: row-reverse; /* 我方消息，头像在右 */
        }

        .message-line.received {
            align-self: flex-start;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            margin-top: 2px; /* 微调对齐 */
        }

        
        .chat-bubble {
            max-width: 100%; /* 气泡现在可以撑满 .message-line 的可用空间 */
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-bubble.sent {
            background-color: var(--accent-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.received {
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            /* 恢复：禁止在聊天气泡上选择文字，以优化长按菜单体验 */
            -webkit-user-select: none; /* Safari, Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;
        }

        .chat-footer {
            display: flex;
            /* 修改：改为纵向布局，让工具栏显示在输入框下方 */
            flex-direction: column;
            /* padding 和 gap 移动到内部wrapper中 */
            padding: 0; 
            gap: 0;
            flex-shrink: 0;
        }

        /* 在 .chat-footer 样式下方添加 */
        .chat-footer-content-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-footer-input-row {
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 10px;
        }

        .chat-input-area {
            flex-grow: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 22px;
            display: flex;
            align-items: center;
            padding: 0 5px 0 15px;
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 16px;
            padding: 10px 0;
            outline: none;
            /* 新增：允许在聊天输入框中选择文字 */
            user-select: text;
            -webkit-user-select: text;
        }


        #chat-input::placeholder {
            color: var(--text-color);
            opacity: 0.5;
        }
        
        .chat-action-btn {
            background: none;
            border: none; /* 明确移除边框 */
            padding: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .chat-action-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--icon-color);
        }

        /* [修改] 强制所有工具栏按钮的SVG路径都使用主题图标颜色 */
        .chat-footer .chat-action-btn svg path {
            fill: var(--icon-color);
        }
        
        /* 发送按钮和AI回复按钮，移除背景颜色和圆形样式，直接显示SVG */
        #send-btn, #api-reply-btn {
             background: none; /* 移除背景 */
             border: none;     /* 移除边框 */
             padding: 0;       /* 移除内边距 */
             margin-left: 5px;
             /* 调整为按钮的默认大小，让SVG居中 */
             width: 32px; /* 可以根据SVG大小调整 */
             height: 32px; /* 可以根据SVG大小调整 */
             display: flex;
             align-items: center;
             justify-content: center;
        }
        
        #send-btn svg, #api-reply-btn svg {
            fill: var(--icon-color); /* 调整填充色，使其与普通图标一致 */
            width: 24px; /* 调整SVG图标大小，使其与普通图标一致 */
            height: 24px; /* 调整SVG图标大小，使其与普通图标一致 */
        }


        /* --- 聊天设置侧边栏 --- */
        #chat-settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 1900;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #chat-settings-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #chat-settings-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 320px;
            height: 100%;
            background-color: var(--bg-color-start);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 20px;
            padding-top: 60px; /* 为状态栏留出空间 */
        }
        
        body.dark-mode #chat-settings-modal {
             background-color: var(--bg-color-end);
        }

        #chat-settings-modal.visible {
            transform: translateX(0);
        }

        /* 新增：侧边栏保存按钮样式 */
        #chat-settings-save-btn {
            position: absolute;
            top: 18px;
            right: 20px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s, transform 0.1s;
        }
        #chat-settings-save-btn:active {
            transform: scale(0.95);
        }

        /* 设置界面的滚动容器 */
        #chat-settings-body {
            height: 100%;
            overflow-y: auto;
            padding-right: 10px; /* 防止滚动条遮挡内容 */
            margin-right: -10px;
        }

        /* 磨砂玻璃质感的分组 */
        .settings-group-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* 设置项通用样式 */
        .chat-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chat-setting-item:last-child {
            margin-bottom: 0;
        }

        .chat-setting-item label {
            font-size: 15px;
            font-weight: 500;
            flex-shrink: 0;
            margin-right: 15px;
        }

        .chat-setting-item .setting-input,
        .chat-setting-item .setting-textarea {
            flex-grow: 1;
            background: rgba(128, 128, 128, 0.1);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-color);
            width: 100%; /* 确保在flex布局中能正确计算宽度 */
        }
        
        .chat-setting-item .setting-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .chat-setting-item.vertical {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
                /* === 在这里添加新样式 === */
        .avatar-selection-container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center; /* 居中两个头像 */
            margin-top: 8px;
        }
        .avatar-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .avatar-preview-circle {
            width: 60px; /* 稍微放大一点以突出 */
            height: 60px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--glass-border);
            transition: transform 0.2s;
        }
        .avatar-picker:active .avatar-preview-circle {
            transform: scale(0.95);
        }
        .avatar-picker-label {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }
        /* === 添加结束 === */
        /* 角色头像设置 */
        .char-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #char-avatar-preview {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 2px solid var(--glass-border);
        }
        
        /* 数据操作按钮 */
        .setting-action-button {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: rgba(128, 128, 128, 0.15);
            color: var(--text-color);
            text-align: left;
        }
        .setting-action-button.danger {
            color: #ef4444; /* 红色警告 */
        }
        .setting-action-button:active {
            transform: scale(0.98);
            background-color: rgba(128, 128, 128, 0.25);
        }
        /* 聊天设置中的手机壁纸预览 */
        .wallpaper-mockup-container {
            display: flex;
            /* 保持 justify-content: space-around; 确保间距 */
            justify-content: space-around; 
            gap: 16px; /* 增大间距 */
            margin-top: 8px;
            width: 100%; /* 确保容器撑满父元素 */
            padding: 0 10px; /* 左右留一点边距 */
        }
        .wallpaper-mockup {
            flex: 1; /* 自动填充可用宽度 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* 增大元素间距 */
            max-width: 150px; /* 限制每个模拟框的最大宽度 */
        }
        .wallpaper-mockup .phone-frame {
            width: 100%; /* 撑满 flex 项的宽度 */
            max-width: none; /* 移除原来的 max-width 限制 */
            aspect-ratio: 9 / 16; /* 确保 9:16 比例 */
            background: #111; /* 手机边框颜色 */
            border: 3px solid #111; /* 手机边框粗细 */
            border-radius: 24px; /* 手机圆角 */
            padding: 2px; /* 屏幕与边框的间距 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* 阴影效果 */
        }
        .wallpaper-mockup .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0; /* 默认屏幕颜色 */
            border-radius: 16px; /* 内部屏幕圆角 */
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .wallpaper-mockup-label {
            font-size: 14px; /* 增大标签字体 */
            font-weight: 600; /* 增加字体粗细 */
            opacity: 1; /* 恢复不透明度 */
            color: var(--text-color); /* 继承主题文本颜色 */
        }

        /* 世界书绑定下拉框样式 */
        .worldbook-binder-container {
            width: 100%;
        }
        .worldbook-binder-tree {
            width: 100%;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            max-height: 250px; /* 限制最大高度，出现滚动条 */
            overflow-y: auto;
            background: rgba(128, 128, 128, 0.05);
        }
        .worldbook-binder-tree details {
            border-bottom: 1px solid var(--glass-border);
        }
        .worldbook-binder-tree details:last-child {
            border-bottom: none;
        }
        .worldbook-binder-tree summary {
            padding: 10px 12px;
            cursor: pointer;
            list-style: none; /* 移除默认箭头 */
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .worldbook-binder-tree summary::-webkit-details-marker {
            display: none; /* 移除默认箭头 for Chrome */
        }
        .worldbook-binder-items {
            padding: 5px 12px 10px 40px; /* 左侧缩进 */
            background: rgba(128, 128, 128, 0.05);
        }
        .worldbook-binder-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            font-size: 14px;
        }
        .binder-checkbox {
            cursor: pointer;
            accent-color: var(--accent-color); /* 让checkbox颜色跟随主题 */
        }
/* 修改前：世界书和档案FAB共用一个ID，导致样式冲突 */
/* #world-book-fab, #archive-fab { ... } */
/* 
    改为分别定义，并新增 chatapp-fab
*/
#world-book-fab {
    position: fixed;
    bottom: 80px;
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

#archive-fab {
    position: fixed;
    bottom: 80px;
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

/* === 新增：Chat App FAB 样式 === */
#chatapp-fab {
    position: fixed;
    bottom: 80px; /* 与世界书和档案FAB对齐 */
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1600;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

#chatapp-fab.visible {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}
#chatapp-fab:active {
    transform: scale(0.95) !important;
}
#chatapp-fab svg {
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
}

/* === 新增：Chat App 添加联系人悬浮窗样式 === */
#add-contact-modal {
    position: absolute; /* 相对于 chat-app-container */
    bottom: 60px; /* 位于FAB上方，避免遮挡 */
    right: 20px;
    width: 280px;
    max-height: 400px;
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--glass-shadow);
    z-index: 1601;
    overflow: hidden;
    transform: scale(0.8);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}

#add-contact-modal.visible {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}

#add-contact-modal h4 {
    margin: 0;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 1px solid var(--glass-border);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#add-contact-modal h4 button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
}
#add-contact-modal h4 button svg {
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
    opacity: 0.6;
}
#add-contact-modal h4 button:hover svg {
    opacity: 1;
}

#add-contact-list-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 0;
}

.add-contact-item {
    display: flex;
    align-items: center;
    padding: 8px 20px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.add-contact-item:hover {
    background-color: rgba(0,0,0,0.03);
}
body.dark-mode .add-contact-item:hover {
    background-color: rgba(255,255,255,0.05);
}

.add-contact-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.add-contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background-color: #ccc;
    background-size: cover;
    background-position: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.add-contact-name {
    font-weight: 500;
    color: var(--text-color);
    flex-grow: 1;
}

        /* === 档案 App 样式 (重构) === */
        /* 模态框重写 */
        #archive-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* 半透明黑色背景 */
            backdrop-filter: blur(8px); /* 模糊背景 */
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000; /* 比主模态框低 */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #archive-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #archive-detail-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow);
            max-width: 90%; /* 增大宽度 */
            max-height: 90%; /* 增大高度 */
            width: 500px; /* 设定一个相对较大的固定宽度作为基准 */
            height: 700px; /* 设定一个相对较大的固定高度作为基准 */
            overflow-y: auto;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            position: relative; /* 用于放置关闭按钮 */
        }

        /* 响应式调整：小屏幕下恢复为最大95% */
        @media (max-width: 520px) {
            #archive-detail-modal {
                width: 90%;
                height: 90%;
            }
        }

        #archive-modal-overlay.visible #archive-detail-modal {
            transform: scale(1);
            opacity: 1;
        }

        #archive-detail-modal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            z-index: 10;
        }
        #archive-detail-modal .close-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
        }


        /* 档案App悬浮添加按钮 */
        #archive-fab {
            position: fixed;
            bottom: 80px; /* 与世界书按钮一致 */
            right: 25px;
            width: 38px;
            height: 38px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001; /* 确保在其他内容之上 */
            transition: transform 0.2s, background-color 0.2s;
            transform: scale(0); /* 初始隐藏 */
            opacity: 0;
            pointer-events: none;
        }

        #archive-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #archive-fab:active {
            transform: scale(0.95) !important;
        }
        #archive-fab svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color); /* 图标颜色跟随主题 */
        }


        /* 档案页面布局容器 */
        .archive-page-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 20px; /* 底部留白 */
        }

        /* User 角色卡片 (高度缩小) */
        .user-profile-card {
            display: flex;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            
            /* 修改：高度缩小1/3，比例从 4/3 变为 4/2 (即 2/1) */
            width: 100%;
            aspect-ratio: 2 / 1; 
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
        }

        .user-profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .user-profile-card .card-avatar {
            width: 80px; /* 适配大卡片 */
            height: 80px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.7);
        }
        .user-profile-card .card-info {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-profile-card .card-info .name {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-profile-card .card-info .bio {
            font-size: 15px;
            opacity: 0.7;
            white-space: normal; /* 允许换行 */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 最多显示2行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Char 角色列表容器 */
        .char-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 每行两个 */
            gap: 16px;
        }

        /* Char 角色卡片 (4x3 纵向) */
        .char-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            
            /* 4x3 比例 (纵向): 宽度4，高度3 */
            width: 100%;
            aspect-ratio: 3 / 4; /* 高度是4，宽度是3 */
            display: flex;
            flex-direction: column; /* 垂直排列 */
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 10px;
        }
        .char-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .char-card .card-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.7);
        }
        .char-card .card-info .name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .char-card .card-info .bio {
            font-size: 12px;
            opacity: 0.6;
            white-space: normal;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* 角色详情展开效果 (信封/档案 - 模态框内部样式) */
        .profile-detail-content {
            padding: 24px;
            width: 100%; /* 模态框内部内容宽度自适应 */
            max-width: 500px; /* 限制最大宽度，与模态框一致 */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 300px;
            max-height: calc(95vh - 48px); /* 减去上下padding */
        }
        @media (max-width: 520px) { /* 根据新的模态框尺寸调整媒体查询 */
            .profile-detail-content {
                max-width: 95vw; /* 小屏幕下宽度自适应 */
            }
        }
        /* 新增：角色编辑页面内的表单样式 */
        .profile-edit-form .modal-form-group {
            margin-bottom: 15px; /* 表单项之间增加间距 */
        }
        .profile-edit-form .modal-form-group label {
            margin-bottom: 8px;
        }
        .profile-edit-form .button-container {
            margin-top: 30px; /* 按钮上方增加间距 */
        }
        /* 角色卡片编辑按钮图标 */
        .edit-char-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            margin-left: 5px; /* 与名字保持一定距离 */
            opacity: 0.4; /* 很淡 */
            transition: opacity 0.2s;
            vertical-align: middle; /* 垂直居中对齐文本 */
            flex-shrink: 0; /* 防止被压缩 */
            display: inline-flex; /* 确保svg内部元素对齐 */
            align-items: center;
            justify-content: center;
        }
        .edit-char-btn:hover {
            opacity: 0.7;
        }
        .edit-char-btn svg {
            width: 14px; /* 小一点 */
            height: 14px;
            fill: #cdcdcd; /* 淡灰色 */
            /* 确保SVG的填充色直接应用到path上 */
        }
        body.dark-mode .edit-char-btn svg path {
            fill: #a1a1aa; /* 暗黑模式下的淡灰色 */
        }

        /* 调整卡片名字的flex布局以便容纳编辑按钮 */
        .user-profile-card .card-info .name,
        .char-card .card-info .name {
            display: inline-flex; /* 让名字和按钮在同一行 */
            align-items: center; /* 垂直居中对齐 */
            max-width: calc(100% - 20px); /* 留出空间给按钮 */
            word-break: break-all; /* 防止长文本撑开 */
            white-space: normal; /* 允许换行 */
            line-height: 1.2;
        }

        .profile-detail-header-section {
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 20px;
        }

        .profile-detail-avatar-large {
            width: 90px; /* 立绘宽度 */
            aspect-ratio: 9 / 16;
            border-radius: 8px;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            box-shadow: var(--glass-shadow);
        }

        .profile-detail-basic-info-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .profile-detail-basic-info-display .name {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-color);
        }
        .profile-detail-basic-info-display .meta-info {
            font-size: 14px;
            opacity: 0.8;
            color: var(--text-color);
        }

        .profile-detail-extended-info-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .profile-detail-extended-info-display .field-group {
            display: flex;
            flex-direction: column;
        }
        .profile-detail-extended-info-display .field-group label {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        .profile-detail-extended-info-display .field-group span {
            font-size: 15px;
            opacity: 0.9;
            line-height: 1.5;
            padding-left: 5px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            padding: 8px;
        }

        /* 在这里添加新样式，紧接着 .field-group span { ... } 后面 */
        /* === 聊天框工具栏面板 (新增) === */
        #chat-tool-panel {
            /* 移除自身背景和边框，让它“浸入”父级的模糊效果中 */
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-top: none; 
            padding: 20px 10px;
            max-height: 0;
            /* 修改：允许垂直滚动 */
            overflow-y: auto; 
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
            /* 初始隐藏时移除padding */
            padding-top: 0;
            padding-bottom: 0;
        }

        #chat-tool-panel.visible {
            /* 设定一个固定高度，刚好可以容纳两行图标 + padding */
            max-height:180px; 
            padding-top: 10px;
            padding-bottom: 10px;
        }


        #chat-tool-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            row-gap: 16px; /* 修改：减小行间距，使整体更紧凑 */
        }

        .tool-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            cursor: pointer;
        }

        .tool-panel-icon-box {
            width: 52px; /* 修改：缩小宽度 */
            height: 52px; /* 修改：缩小高度 */
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 14px; /* 修改：为获得更好的视觉比例，轻微增加圆角 */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.1s ease;
            position: relative; /* 新增：为修复层级问题创建堆叠上下文 */
        }


        .tool-panel-item:active .tool-panel-icon-box {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 1);
        }

        body.dark-mode .tool-panel-icon-box {
            background-color: rgba(63, 63, 70, 0.8);
            border: 1px solid rgba(82, 82, 90, 0.7);
        }

        body.dark-mode .tool-panel-item:active .tool-panel-icon-box {
            background-color: rgba(82, 82, 90, 1);
        }

        .tool-panel-icon-box svg {
            width: 28px; /* 修改：缩小SVG图标宽度 */
            height: 28px; /* 修改：缩小SVG图标高度 */
            z-index: 1; /* 新增：确保SVG图标层级高于父元素的背景 */
        }

        .tool-panel-icon-box svg path {
            fill: var(--icon-color) !important;
        }

        .tool-panel-name {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.8;
        }


        /* === Message Context Menu Styles (新增) === */
        #message-context-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2500; /* 需要比所有聊天界面元素都高 */
            display: none; /* 默认隐藏 */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            background-color: rgba(0, 0, 0, 0.1);
        }

        #message-context-menu.visible {
            display: block; /* 改为block以进行定位 */
            opacity: 1;
        }

        #context-menu-buttons {
            position: absolute;
            display: flex;
            gap: 8px; /* 减小间距 */
            padding: 7px; /* 减小内边距 */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 999px; /* 圆弧形边框 */
            box-shadow: 0 0 20px 3px color-mix(in srgb, var(--accent-color) 30%, transparent); /* 主题色辉光 */
            
            /* 动画效果 */
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transform-origin: center center;
            transition: opacity 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform, opacity;
        }

        #message-context-menu.visible #context-menu-buttons {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .context-menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 48px; /* 减小宽度 */
            height: 48px; /* 减小高度 */
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .context-menu-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .context-menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .context-menu-button svg {
            width: 20px; /* 图标大小固定 */
            height: 20px;
        }

        .context-menu-button svg path {
            fill: var(--icon-color) !important; /* 颜色强制固定 */
        }

        .context-menu-button span {
            font-size: 10px; /* 小字解释 */
            font-weight: 500;
            color: var(--text-color);
            opacity: 0.8;
        }
        /* === 在这里添加新样式，紧接着 .field-group span { ... } 后面 === */

        /* === 引用功能样式 (新增) === */
        #quote-preview-container {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 8px 12px 8px 35px; /* 左侧留出关闭按钮位置 */
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            position: relative;
            display: none; /* 默认隐藏 */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        body.dark-mode #quote-preview-container {
             background-color: rgba(255, 255, 255, 0.08);
        }
        #quote-preview-close {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #quote-preview-close svg {
            width: 16px;
            height: 16px;
            fill: var(--text-color);
        }
        .quoted-message-in-bubble {
            background-color: rgba(0, 0, 0, 0.08);
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            border-left: 3px solid var(--accent-color);
            opacity: 0.8;
            white-space: pre-wrap; /* 保留换行 */
            word-break: break-all;
        }
        .chat-bubble.sent .quoted-message-in-bubble {
             background-color: rgba(255, 255, 255, 0.2);
             border-left-color: #fff;
        }
        /* 长按时不选中文字，但允许通过JS进行复制操作 */
        .chat-bubble.received {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }


        /* === 重回功能样式 (重构) === */
        #alternative-replies-container {
            position: absolute;
            /* 自动检测位置，JS会处理 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column; /* 改为正序排列 */
            gap: 8px;
            max-height: 40vh; /* 限制最大高度 */
            overflow-y: auto;
            align-items: center;
            /* 【需求1修改】移除固定宽度，由JS动态设置 */
            max-width: 90vw; /* 保留一个最大宽度以防意外 */
            z-index: 2600; /* 确保在菜单之上 */
        }

        .alternative-reply-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px; /* 圆角稍大 */
            padding: 10px; /* 内边距 */
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--glass-shadow);
            width: 100%; /* 宽度撑满容器 */
            opacity: 0.95;
            display: flex; /* 内部使用flex布局 */
            flex-direction: column;
            gap: 5px; /* 内部气泡的间距 */
        }
        .alternative-reply-card:hover {
            opacity: 1;
            border-color: color-mix(in srgb, var(--accent-color) 50%, transparent);
            transform: scale(1.01); /* 悬浮效果微调 */
        }

         /* 新增：卡片内部的单行回复气泡样式 */
        .alt-reply-line {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 999px;
            background-color: var(--accent-color);
            color: white;
            font-weight: 500;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: none;
            
            /* === 核心修改：实现自适应宽度 === */
            width: fit-content;      /* 宽度根据内容自适应 */
            max-width: 100%;         /* 最大宽度不超过父容器（卡片） */
            align-self: flex-start;  /* 从左侧开始排列 */
        }


        /* body.dark-mode .alt-reply-line 的样式不再需要，因为 accent-color 会自动适应主题 */

        /* === 新增：聊天框长按功能相关样式 === */

        /* --- 1. 多选模式 --- */
        #chat-messages-container.multi-select-mode .message-line {
            padding-left: 40px; /* 为选择框留出空间 */
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #chat-messages-container.multi-select-mode .message-line::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            background-color: #fff;
            transition: all 0.2s;
        }

        #chat-messages-container.multi-select-mode .message-line.selected {
            background-color: rgba(9, 132, 227, 0.1);
        }

        #chat-messages-container.multi-select-mode .message-line.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
            background-size: 14px;
        }

        /* --- 2. 多选工具栏 --- */
        #multi-select-toolbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            padding: 10px 20px;
            border-top: 1px solid var(--glass-border);
            display: none; /* 默认隐藏 */
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }
        
        #multi-select-toolbar.visible {
            display: flex;
        }

        #multi-select-toolbar .action-buttons button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            margin-left: 20px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        #multi-select-toolbar .action-buttons button.active {
            opacity: 1;
            pointer-events: auto;
            font-weight: 600;
        }

        /* --- 3. 撤回消息样式 --- */
        .retracted-message-notice {
            align-self: center; /* 居中显示 */
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            opacity: 0.7;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 80%;
            text-align: center;
        }
        
        .retracted-message-notice .clickable-retract {
            cursor: pointer;
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        /* --- 4. 撤回内容悬浮窗 --- */
        #retracted-content-popover {
            position: fixed;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            max-width: 80vw;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            z-index: 3000;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        #retracted-content-popover.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #retracted-content-popover .original-content {
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        #retracted-content-popover .inner-thought {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--glass-border);
            font-size: 13px;
            font-style: italic;
            opacity: 0.7;
        }

        /* --- 5. 编辑消息悬浮窗 --- */
        #edit-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 2800;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #edit-message-modal.visible {
            display: flex;
        }
        
        .edit-message-box {
            background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .edit-message-box textarea {
            width: 100%;
            min-height: 100px;
            max-height: 40vh;
            resize: vertical;
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(128,128,128,0.1);
            color: var(--text-color);
            user-select: text;
        }

        .edit-message-box .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

    </style>

</head>
<body>

    <div id="mobile-wrapper">
        <div id="viewport">
            <div id="slider-container">
                <!-- 第一页 -->
                <div class="page" id="page-1">
                    <div class="bento-grid">
                        
                        <!-- 1. 顶部区域：状态栏 + 个人信息 -->
                        <div class="top-section-container">
                            <!-- 小胶囊状态栏 -->
                            <div class="status-capsule">
                                <span id="clock">12:00</span>
                                <div class="status-right">
                                    <span id="battery-text" style="font-size:12px; opacity:0.6;">100%</span>
                                    <div class="battery-icon">
                                        <div class="battery-level" id="battery-level"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 大胶囊个人卡片 -->
                            <div class="profile-capsule">
                                <div class="avatar-frame" id="avatar-box" title="点击更换头像">
                                    <!-- 隐藏的文件上传 Input -->
                                    <input type="file" id="avatar-upload" accept="image/*" hidden>
                                </div>
                                <div class="profile-info">
                                    <span class="profile-name" id="profile-name" title="点击编辑">Administrator</span>
                                    <span class="profile-bio" id="profile-bio" title="点击编辑">Reality is just a simulation.</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. 中间行: 4个设置类 App (左) + 相册 (右) -->
                        <div class="app-grid-area area-mid-left">
                            <!-- API设置 -->
                            <div class="app-wrapper" id="app-api">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M975.657 96.914l-48.457-48.457c-1.829-1.829-4.114-2.629-6.514-2.629s-4.686 0.915-6.514 2.629l-86.972 86.971a227.737 227.737 0 0 0-128.114-39.2c-58.514 0-117.029 22.286-161.714 66.972L420.914 279.657a9.177 9.177 0 0 0 0 12.914L731.429 603.086c1.828 1.828 4.114 2.628 6.514 2.628s4.686-0.914 6.514-2.628l116.457-116.457c78.743-78.857 88-200.8 27.772-289.715l86.971-86.971c3.543-3.657 3.543-9.486 0-13.029zM805.829 431.657l-67.886 67.886-213.486-213.486 67.886-67.886c28.457-28.457 66.4-44.229 106.743-44.229 40.343 0 78.171 15.657 106.743 44.229 28.457 28.457 44.229 66.4 44.229 106.743 0 40.343-15.771 78.171-44.229 106.743z m-217.372 120a9.177 9.177 0 0 0-12.914 0L499.429 627.771 396.229 524.571l76.228-76.228c3.543-3.543 3.543-9.372 0-12.914L430.857 393.829a9.177 9.177 0 0 0-12.914 0L341.714 470.057l-49.143-49.143a8.971 8.971 0 0 0-6.514-2.629c-2.286 0-4.686 0.915-6.514 2.629L163.2 537.371c-78.743 78.857-88 200.8-27.771 289.715l-86.972 86.971a9.177 9.177 0 0 0 0 12.914l48.457 48.457c1.829 1.829 4.114 2.629 6.515 2.629s4.686-0.915 6.514-2.629l86.971-86.971c38.514 26.171 83.314 39.2 128.114 39.2 58.514 0 117.029-22.286 161.714-66.971l116.457-116.457c3.543-3.543 3.543-9.372 0-12.915l-49.143-49.143 76.229-76.228c3.543-3.543 3.543-9.372 0-12.914l-41.829-41.372zM431.657 805.829a150.08 150.08 0 0 1-106.743 44.229c-40.343 0-78.171-15.657-106.743-44.229a150.08 150.08 0 0 1-44.229-106.743c0-40.343 15.657-78.171 44.229-106.743l67.886-67.886 213.486 213.486-67.886 67.886z"></path></svg>
                                </div>
                                <span class="app-name">API</span>
                            </div>
                            <!-- 美化设置 -->
                            <div class="app-wrapper" id="app-beautify">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M511.787 0c282.634 0 511.787 229.153 511.787 511.787v4.905l-0.043 2.559-0.128 5.16-0.17 5.374-0.213 5.544-0.299 5.63-0.341 5.8-0.682 8.914-0.512 6.056-0.597 6.184-0.682 6.27-0.768 6.397-0.426 3.156-0.853 6.44-0.981 6.525-1.024 6.525-1.152 6.568-1.237 6.611-0.64 3.284-1.365 6.61c-0.597 2.858-1.279 5.673-1.919 8.53l-1.365 5.63-0.725 2.857-1.493 5.63a388.105 388.105 0 0 1-3.199 11.131l-1.706 5.544c-17.06 53.098-45.805 99.116-92.378 111.058-30.409 7.805-67.94 5.118-107.688-1.535l-7.975-1.365-8.018-1.493-8.103-1.535-8.103-1.62-8.103-1.706-8.146-1.706-15.012-3.284-32.285-7.165-13.733-2.985-6.781-1.407-10.108-2.09-6.653-1.28-6.61-1.28-6.568-1.151-6.483-1.109-6.397-1.024-6.312-0.938a416.253 416.253 0 0 0-12.368-1.535l-5.971-0.597c-32.925-2.985-61.116-0.512-80.478 12.88-13.562 9.383-13.648 24.651-7.378 42.734l1.151 3.199 0.64 1.62 1.322 3.327 0.725 1.663 1.535 3.37 2.431 5.117 1.706 3.455 1.791 3.497 3.838 7.122 3.924 7.165 12.752 22.519 2.9 5.246 2.815 5.203 1.322 2.474 2.559 4.904c8.274 16.292 14.33 31.774 14.33 44.782v2.004l-0.128 4.094c-0.128 4.095-0.426 8.189-0.853 12.24l-0.426 4.052c-5.544 42.521-27.509 81.033-71.949 81.033-282.634 0-511.787-229.153-511.787-511.787S229.153 0 511.787 0z m0 79.753C273.166 79.753 79.753 273.166 79.753 511.787c0 233.844 185.779 424.271 417.789 431.777l4.691 0.128 0.17-0.64c1.322-4.393 2.346-10.065 2.772-16.42l0.128-2.687-0.298-0.853-0.725-1.748-0.853-2.09-0.938-2.005-1.535-3.241-1.791-3.54-2.815-5.374-2.559-4.648-5.118-9.212-8.274-14.543-3.327-5.971-4.563-8.36-2.772-5.203a219.13 219.13 0 0 1-19.277-47.212c-12.368-46.061-2.218-92.932 40.943-122.786 36.294-25.12 79.071-31.39 131.188-26.869 2.687 0.213 5.374 0.47 8.018 0.768l7.847 0.853 5.8 0.725 5.928 0.81 6.014 0.896 4.137 0.682 6.397 1.066 6.653 1.194 6.994 1.322 7.378 1.45 7.847 1.62 11.302 2.346 9.127 1.962 23.883 5.246 20.983 4.691 11.942 2.559 6.824 1.45 9.894 1.962 6.312 1.28 6.099 1.109 5.928 1.066 5.715 0.981 5.502 0.896 5.288 0.853 7.592 1.023 4.819 0.64 4.649 0.512 6.61 0.64 4.18 0.341 4.052 0.256 1.919 0.085 3.753 0.128 3.625 0.043h1.706l3.412-0.043 6.227-0.341 2.9-0.341 2.772-0.341a60.988 60.988 0 0 0 6.227-1.28c10.108-2.559 24.31-21.026 36.294-58.343 12.24-38.129 18.68-87.43 18.68-129.27 0-238.62-193.413-432.033-432.033-432.033z m-305.75 372.197a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z m564.97-152.854a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937zM299.097 219.343a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z m252.567-86.407a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z"></path></svg>
                                </div>
                                <span class="app-name">美化</span>
                            </div>
                            <!-- 世界书 -->
                            <div class="app-wrapper" id="app-world-book">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M704 170.667a234.667 234.667 0 0 0-192 100.266A234.667 234.667 0 0 0 85.333 405.333v411.307a7.893 7.893 0 0 0 0 2.346v2.774a15.787 15.787 0 0 0 0 2.986v1.28a12.587 12.587 0 0 0 1.28 2.987v1.28l2.133 2.986v1.28l1.707 1.92 1.493 1.28v1.067l1.92 1.493 3.84 2.56h10.88l2.134 1.28H143.573l2.773-1.493h1.493c6.827-3.84 174.507-93.44 342.614 0h1.28a24.96 24.96 0 0 0 5.546 2.133H500.48a16.213 16.213 0 0 0 4.48 0H524.587l4.48-1.92h1.92c6.827-3.84 174.507-93.44 342.613 0h1.493l6.827 2.774h2.56A37.12 37.12 0 0 0 896 853.333a51.627 51.627 0 0 0 10.027-1.28h2.56a42.667 42.667 0 0 0 7.253-2.986l1.493-2.134a37.12 37.12 0 0 0 8.107-6.186 36.693 36.693 0 0 0 5.973-7.894v-1.066a7.68 7.68 0 0 1 0-1.92 25.387 25.387 0 0 0 1.707-4.267l1.28-3.84a22.613 22.613 0 0 0 0-4.053 31.787 31.787 0 0 0 0-4.48V405.333A234.667 234.667 0 0 0 704 170.667zM170.667 746.667V405.333a149.333 149.333 0 0 1 298.666 0v339.414A458.027 458.027 0 0 0 170.667 746.667z m384 0V405.333a149.333 149.333 0 0 1 298.666 0v339.414A458.027 458.027 0 0 0 554.667 746.667z"></path></svg>
                                </div>
                                <span class="app-name">世界书</span>
                            </div>
                            <!-- 数据管理 -->
                            <div class="app-wrapper" id="app-data">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M528 504a16 16 0 0 1 16 16v208h66.112c12.8 0 20.416 14.272 13.312 24.896l-98.112 147.136a16 16 0 0 1-26.624 0l-98.112-147.2a16 16 0 0 1 13.312-24.832H480v-208a16 16 0 0 1 16-16z m-16-384a256.384 256.384 0 0 1 254.08 224.384 240.32 240.32 0 0 1 225.92 240.768c-0.64 132.672-110.912 238.848-243.648 238.848h-28.352a16 16 0 0 1-16-16v-32a16 16 0 0 1 16-16h28.864c98.496 0 180.8-80.64 179.136-179.072a176.192 176.192 0 0 0-176-172.928h-32a16 16 0 0 1-16-16v-12.8c0-105.088-83.2-193.152-188.288-195.2a192.192 192.192 0 0 0-195.712 192v16a16 16 0 0 1-16 16h-32A176.192 176.192 0 0 0 96 580.928c-1.664 98.496 80.64 179.072 179.136 179.072h28.864a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16h-28.352C142.912 824 32.64 717.824 32 585.152a240.32 240.32 0 0 1 225.92-240.768A256.384 256.384 0 0 1 512 120z"></path></svg>
                                </div>
                                <span class="app-name">数据</span>
                            </div>
                        </div>

                        <!-- 右侧: 相册 (玻璃盒子，保持正方形) -->
                        <div class="glass-card area-mid-right">
                            <div class="photo-placeholder" style="background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); display:flex; align-items:center; justify-content:center;">
                                <span style="font-size:10px; color:#fff; letter-spacing:2px; text-shadow:0 1px 2px rgba(0,0,0,0.2)">GALLERY</span>
                            </div>
                        </div>

                        <!-- 3. 底部行: 留白 (左) + 4个功能 App (右) -->
                        <div class="glass-card area-bot-left">
                        </div>

                        <div class="app-grid-area area-bot-right">
                        <!-- Chat -->
                        <div class="app-wrapper" id="app-chat">
                            <div class="app-icon-box">
                                <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M381.7 985.3c-10.2 0-20.4-3.9-28.3-11.7-15.6-15.6-15.6-40.9 0-56.5L496 774.5c39-39 90.9-60.5 146.1-60.5h136.2c91.4 0 165.7-74.3 165.8-165.7V284.4c0-91.4-74.4-165.8-165.8-165.8H245.7c-91.4 0-165.8 74.4-165.8 165.8v263.9c0 91.4 74.4 165.7 165.8 165.7h74.4c22.1 0 40 17.9 40 40s-17.9 40-40 40h-74.4C110.2 793.9 0 683.7 0 548.3V284.4C0 148.9 110.2 38.7 245.7 38.7h532.6c135.5 0 245.7 110.2 245.7 245.7v263.9C1024 683.8 913.8 794 778.3 794H642.2c-33.8 0-65.7 13.2-89.6 37.1L410 973.6c-7.8 7.8-18 11.7-28.3 11.7z"></path><path d="M322.965 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path><path d="M512.065 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path><path d="M701.165 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path></svg>
                            </div>
                            <span class="app-name">Chat</span>
                        </div>
                            <!-- 档案 -->
                            <div class="app-wrapper" id="app-archive">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M768 96H320c-88 0-160 72-160 160v96h-32c-17.6 0-32 14.4-32 32s14.4 32 32 32h32v192h-32c-17.6 0-32 14.4-32 32s14.4 32 32 32h32v96c0 88 72 160 160 160h448c88 0 160-72 160-160V256c0-88-72-160-160-160z m96 672c0 52.8-43.2 96-96 96H320c-52.8 0-96-43.2-96-96v-96h32c17.6 0 32-14.4 32-32s-14.4-32-32-32h-32V416h32c17.6 0 32-14.4 32-32s-14.4-32-32-32h-32v-96c0-52.8 43.2-96 96-96h448c52.8 0 96 43.2 96 96v512z" fill="#2c2c2c" p-id="1335"></path><path d="M659.2 464c17.6-22.4 28.8-49.6 28.8-80 0-70.4-57.6-128-128-128s-128 57.6-128 128c0 30.4 11.2 57.6 28.8 80C387.2 496 336 577.6 336 672c0 52.8 43.2 96 96 96h256c52.8 0 96-43.2 96-96 0-94.4-51.2-176-124.8-208zM560 320c35.2 0 64 28.8 64 64s-28.8 64-64 64-64-28.8-64-64 28.8-64 64-64z m128 384H432c-17.6 0-32-14.4-32-32 0-88 59.2-160 131.2-160h56c72 0 131.2 72 131.2 160 1.6 17.6-12.8 32-30.4 32z" fill="#2c2c2c" p-id="1336"></path></svg>
                                </div>
                                <span class="app-name">档案</span>
                            </div>
                            <!-- 副本 -->
                            <div class="app-wrapper">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M598.1 392.7m-56.8 0a56.8 56.8 0 1 0 113.6 0 56.8 56.8 0 1 0-113.6 0Z" fill="#2c2c2c" p-id="1337"></path><path d="M434.6 392.7m-33.8 0a33.8 33.8 0 1 0 67.6 0 33.8 33.8 0 1 0-67.6 0Z" fill="#2c2c2c" p-id="1338"></path><path d="M236.6 828.1c-68.7 0-123.9-20.2-152.4-67.5-37.3-62-14.6-148.9 63.9-244.8 4.6-5.4 19.2-21.7 37-30 22.4-10.5 49-0.8 59.5 21.6 10.4 22.4 0.8 49-21.6 59.5-0.7 0.6-4.7 4.6-6 6.2-59.9 73.2-67.7 122-56 141.3 28.6 47.6 208 33.8 423.7-96.2 99.8-60.2 184-131.7 237-201.2 41.8-54.9 59.9-105.4 45.9-128.6-12.7-21.1-57.8-29.5-117.6-22-12.1 1.5-25 3.7-38.1 6.5-24.3 5.1-47.9-10.4-53-34.6-5.1-24.2 10.4-47.9 34.6-53 15.6-3.3 30.8-5.8 45.4-7.7 127.9-16.1 182.3 26.3 205.4 64.7 35.1 58.2 16.8 139.6-51.4 229-59.7 78.3-152.8 157.6-262.1 223.5-129.9 78.3-280.7 133.3-394.2 133.3z" fill="#2c2c2c" p-id="1339"></path><path d="M529.8 874.7c-200.4 0-363.5-163.1-363.5-363.5s163.1-363.5 363.5-363.5 363.5 163.1 363.5 363.5-163 363.5-363.5 363.5z m0-637.5c-151.1 0-274 122.9-274 274s122.9 274 274 274 274-122.9 274-274-122.9-274-274-274z" fill="#2c2c2c" p-id="1340"></path></svg>
                                </div>
                                <span class="app-name">副本</span>
                            </div>
                            <!-- 记忆 -->
                            <div class="app-wrapper">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M512 958.9c-246.7 0-447.3-200.7-447.3-447.3S265.3 64.3 512 64.3c246.7 0 447.3 200.7 447.3 447.3S758.7 958.9 512 958.9z m0-805.2c-197.3 0-357.9 160.5-357.9 357.9S314.7 869.5 512 869.5c197.3 0 357.9-160.5 357.9-357.9S709.3 153.7 512 153.7z" fill="#333333" p-id="7813"></path><path d="M758.7 518.1c-21.7 0-40.8-15.8-44.2-37.9-13.4-87-80.7-155.5-167.4-170.4-24.3-4.2-40.7-27.3-36.5-51.7 4.2-24.3 27.2-40.8 51.7-36.5 124.7 21.5 221.4 120 240.6 245 3.8 24.4-13 47.3-37.4 51-2.3 0.3-4.6 0.5-6.8 0.5zM475.1 803.3c-2.2 0-4.4-0.2-6.6-0.5-127.4-18.9-229.3-121.1-247.8-248.6-3.5-24.4 13.4-47.1 37.9-50.7 24.5-3.4 47.2 13.4 50.7 37.9C322.1 630 393 701.1 481.6 714.3c24.4 3.6 41.3 26.4 37.7 50.8-3.3 22.2-22.4 38.2-44.2 38.2z" fill="#333333" p-id="7814"></path><path d="M512 654.6c-78.8 0-143-64.1-143-143s64.1-143 143-143 143 64.1 143 143-64.2 143-143 143z m0-196.5c-29.5 0-53.5 24-53.5 53.5s24 53.5 53.5 53.5 53.5-24 53.5-53.5-24-53.5-53.5-53.5z" fill="#333333" p-id="7815"></path></svg>
                                </div>
                                <span class="app-name">记忆</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 第二页 -->
                <div class="page" id="page-2">
                    <div class="glass-card" style="width:100%; height:100%; border-radius:32px;">
                        <span class="empty-text">AWAITING DATA STREAM...</span>
                    </div>
                </div>
            </div>

            <div class="pagination">
                <div class="dot active" data-index="0"></div>
                <div class="dot" data-index="1"></div>
            </div>
        </div>
    </div>
    <!-- === 通用模态框结构 开始 === -->
    <div id="modal-overlay">
        <div id="modal-container">
            <div id="modal-header">
                <span id="modal-title"></span>
                <button id="modal-close-btn" title="返回">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
                </button>
                <!-- 这里移除了档案App的头部控制，将由右下角悬浮按钮替代 -->
            </div>
            <div id="modal-body">
                <!-- 内容将由JS动态填充 -->
            </div>
        </div>
    </div>
    <!-- === 通用模态框结构 结束 === -->
    <!-- === 档案详情模态框结构 开始 === -->
    <div id="archive-modal-overlay">
        <div id="archive-detail-modal">
            <button class="close-btn" id="archive-detail-close-btn" title="关闭">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
            <div id="archive-detail-content">
                <!-- 档案详情内容将由JS填充 -->
            </div>
        </div>
    </div>
    <!-- === 档案详情模态框结构 结束 === -->
    <!-- 世界书悬浮添加按钮 -->
    <div id="world-book-fab" title="添加分类">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
    </div>
    <!-- 档案App悬浮添加角色按钮 -->
<div id="archive-fab" title="添加角色">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
    </div>
<!-- === Chat App 结构 开始 === -->
<div id="chat-app-container">
    <!-- 壁纸层 -->
    <div id="chat-wallpaper"></div>
    <!-- 内容层 -->
    <div id="chat-app-content">
        <!-- 联系人列表 或 聊天界面 将被JS注入这里 -->
    </div>
</div>

<!-- Chat App 设置侧边栏 -->
<div id="chat-settings-overlay"></div>
<div id="chat-settings-modal">
    <!-- 新增：保存按钮 -->
    <button id="chat-settings-save-btn">保存</button>
    <!-- 这个div用于实现内部滚动 -->
    <div id="chat-settings-body">
        <!-- 内容将由JS动态填充 -->
    </div>
</div>
<!-- === Chat App 结构 结束 === -->


<!-- ============================================= -->
<!-- === 新增：消息长按上下文菜单 (Message Context Menu) === -->
<!-- ============================================= -->
<div id="message-context-menu">
    <div id="context-menu-buttons">
        <div class="context-menu-button" data-action="re-answer">
            <svg t="1767115092714" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15983" width="16" height="16"><path d="M512 82c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="15984" fill="#2c2c2c"></path><path d="M512 72C268.995 72 72 268.995 72 512l0.017 3.868c1.075 123.712 53.693 240.24 145.233 322.825l1.247 1.114-66.97 79.814a30.18 30.18 0 0 0-7.06 19.182c-0.118 16.666 13.296 30.272 29.962 30.39l243.649 1.735a30.288 30.288 0 0 0 5.666-0.497c16.392-3.01 27.24-18.74 24.228-35.131l-44.015-239.647a30.176 30.176 0 0 0-10.283-17.665l-0.385-0.318c-12.762-10.36-31.523-8.602-42.129 4.037l-70.41 83.91-1.394-1.273C208.845 699.358 168.786 608.439 168.786 512c0-189.552 153.662-343.214 343.214-343.214S855.214 322.448 855.214 512c0 101.661-44.508 197.103-122.127 262.532l-2.363 1.973c-10.786 8.931-12.29 24.916-3.36 35.703l29.383 35.486c8.931 10.787 24.916 12.291 35.702 3.36C893.72 767.204 952 643.547 952 512c0-243.005-196.995-440-440-440z m0 10c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="15985" fill="#2c2c2c"></path></svg>
            <span>重回</span>
        </div>
        <div class="context-menu-button" data-action="quote">
            <svg t="1767115166619" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11056" width="16" height="16"><path d="M344.09546581 867.21961711L123.37647922 867.21961711C71.64546642 867.21961711 30.26065757 822.38607407 30.26065756 770.65506126l0-220.7189852c0-51.7310128 41.38481023-93.11582166 93.11582166-93.11582305l220.71898659 0c51.7310128 0 93.11582165 41.38481023 93.11582165 93.11582305L437.21128746 770.65506126c0 51.7310128-41.38481023 96.56455585-93.11582165 96.56455585zM895.89293018 867.21961711l-220.71898658 0c-51.7310128 0-93.11582166-41.38481023-93.11582167-93.11582168l0-220.7189852c0-51.7310128 41.38481023-93.11582166 93.11582167-93.11582303l220.71898658 0c51.7310128 0 93.11582166 41.38481023 93.11582165 93.11582303L989.00875183 770.65506126c3.4487342 51.7310128-41.38481023 96.56455585-93.11582165 96.56455585z" fill="#2c2c2c" p-id="11057"></path><path d="M26.81192338 684.43670797S-35.26529198 149.88291453 233.73597181 149.88291453l0 113.80822677s-82.7696191-41.38481023-82.76961909 251.7575929c10.34620256 200.02658146-124.15442932 168.98797378-124.15442934 168.98797377zM582.05812192 684.43670797S519.98090656 149.88291453 788.98217038 149.88291453l0 113.80822677s-82.7696191-41.38481023-82.7696191 251.7575929c3.4487342 200.02658146-124.15442932 168.98797378-124.15442936 168.98797377z" fill="#2c2c2c" p-id="11058"></path></svg>
            <span>引用</span>
        </div>
        <div class="context-menu-button" data-action="select-multiple">
            <svg t="1767117252981" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11037" width="16" height="16"><path d="M430.8992 492.1344a32.2048 32.2048 0 0 1-23.8592-10.5472L261.12 321.5872a32.256 32.256 0 0 1 47.6672-43.4688l125.4912 137.5744 341.504-275.1488a32.256 32.256 0 0 1 40.448 50.2272L451.1232 484.9664a32.1536 32.1536 0 0 1-20.224 7.168zM802.5088 912.7424H378.0096a33.536 33.536 0 1 1 0-67.072h424.4992a43.9296 43.9296 0 0 0 43.8784-43.8784V475.3408a33.536 33.536 0 1 1 67.072 0v326.4512a111.104 111.104 0 0 1-110.9504 110.9504z" p-id="11038" fill="#2c2c2c"></path><path d="M615.424 725.6576H232.192a111.104 111.104 0 0 1-110.9504-110.9504V231.4752a111.104 111.104 0 0 1 110.9504-110.9504H501.76a33.536 33.536 0 0 1 0 67.1232H232.192a43.9296 43.9296 0 0 0-43.8784 43.8784v383.232a43.9296 43.9296 0 0 0 43.8784 43.8784h383.232a43.9296 43.9296 0 0 0 43.8784-43.8784V475.3408a33.536 33.536 0 0 1 67.1232 0v139.3664a111.104 111.104 0 0 1-111.0016 110.9504z" p-id="11039" fill="#2c2c2c"></path></svg>
            <span>多选</span>
        </div>
        <div class="context-menu-button" data-action="edit">
            <svg t="1767122817601" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15640" width="16" height="16"><path d="M526.41 117.029v58.514a7.314 7.314 0 0 1-7.315 7.314H219.429a36.571 36.571 0 0 0-35.987 29.989l-0.585 6.583V804.57a36.571 36.571 0 0 0 29.989 35.987l6.583 0.585H804.57a36.571 36.571 0 0 0 35.987-29.989l0.585-6.583v-317.44a7.314 7.314 0 0 1 7.314-7.314h58.514a7.314 7.314 0 0 1 7.315 7.314v317.44a109.714 109.714 0 0 1-99.182 109.203l-10.533 0.512H219.43a109.714 109.714 0 0 1-109.203-99.182l-0.512-10.533V219.43a109.714 109.714 0 0 1 99.182-109.203l10.533-0.512h299.666a7.314 7.314 0 0 1 7.314 7.315z m307.345 31.817l41.4 41.399a7.314 7.314 0 0 1 0 10.313L419.985 655.726a7.314 7.314 0 0 1-10.313 0l-41.399-41.4a7.314 7.314 0 0 1 0-10.312l455.168-455.168a7.314 7.314 0 0 1 10.313 0z" p-id="15641" fill="#2c2c2c"></path></svg>
            <span>编辑</span>
        </div>
        <div class="context-menu-button" data-action="retract">
            <svg t="1767117153317" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1821" width="16" height="16"><path d="M581.056 288.32H232.96l108.352-102.208c15.552-15.744 19.456-31.104 4.16-46.208-16.064-15.872-32.576-15.808-48.64 0l-145.92 144.768c-8.768 8.832-23.488 20.608-22.08 32.448l0.64 4.8-0.64 4.864c-1.344 11.776 6.4 18.24 14.848 26.816l147.648 145.216c16.064 15.808 38.08 20.992 54.144 5.12 15.296-15.104 3.84-38.208-11.328-53.504L233.152 353.6 581.056 352c126.464 0 250.944 111.488 250.944 236.16C832 712.832 707.52 832 581.056 832H246.4c-22.592 0-29.696 9.6-29.696 32.256s7.04 31.744 29.696 31.744H581.12C755.136 896 896 757.696 896 588.16c0-169.408-140.8-299.84-314.944-299.84z" fill="#2c2c2c" p-id="1822"></path><path d="M323.392 192a32 32 0 1 1 0-64 32 32 0 0 1 0 64zM320.192 514.048a32 32 0 1 1 0-64 32 32 0 0 1 0 64zM237.824 896a32 32 0 1 1 0-64 32 32 0 0 1 0 64z" fill="#2c2c2c" p-id="1823"></path></svg>
            <span>撤回</span>
        </div>
        <div class="context-menu-button" data-action="copy">
            <svg t="1767115731853" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12940" width="16" height="16"><path d="M96.1 575.7a32.2 32.1 0 1 0 64.4 0 32.2 32.1 0 1 0-64.4 0Z" fill="#2c2c2c" p-id="12941"></path><path d="M742.1 450.7l-269.5-2.1c-14.3-0.1-26 13.8-26 31s11.7 31.3 26 31.4l269.5 2.1c14.3 0.1 26-13.8 26-31s-11.7-31.3-26-31.4zM742.1 577.7l-269.5-2.1c-14.3-0.1-26 13.8-26 31s11.7 31.3 26 31.4l269.5 2.1c14.3 0.2 26-13.8 26-31s-11.7-31.3-26-31.4z" fill="#2c2c2c" p-id="12942"></path><path d="M736.1 63.9H417c-70.4 0-128 57.6-128 128h-64.9c-70.4 0-128 57.6-128 128v128c-0.1 17.7 14.4 32 32.2 32 17.8 0 32.2-14.4 32.2-32.1V320c0-35.2 28.8-64 64-64H289v447.8c0 70.4 57.6 128 128 128h255.1c-0.1 35.2-28.8 63.8-64 63.8H224.5c-35.2 0-64-28.8-64-64V703.5c0-17.7-14.4-32.1-32.2-32.1-17.8 0-32.3 14.4-32.3 32.1v128.3c0 70.4 57.6 128 128 128h384.1c70.4 0 128-57.6 128-128h65c70.4 0 128-57.6 128-128V255.9l-193-192z m0.1 63.4l127.7 128.3H800c-35.2 0-64-28.8-64-64v-64.3h0.2z m64 641H416.1c-35.2 0-64-28.8-64-64v-513c0-35.2 28.8-64 64-64H671V191c0 70.4 57.6 128 128 128h65.2v385.3c0 35.2-28.8 64-64 64z" fill="#2c2c2c" p-id="12943"></path></svg>
            <span>复制</span>
        </div>
    </div>
</div>

<!-- 新增：Chat App 添加联系人按钮 -->
<div id="chatapp-fab" title="添加联系人">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
</div>
<!-- 新增：Chat App 添加联系人悬浮窗 -->
<div id="add-contact-modal">
    <h4>添加联系人 <button id="close-add-contact-modal-btn" title="关闭"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></h4>
    <div id="add-contact-list-container">
        <!-- 角色列表将由JS动态填充 -->
        <span class="empty-text" style="text-align:center; display:block; padding: 40px 0; font-size:14px;">暂无可用角色</span>
    </div>
</div>
<!-- === Chat App 结构 结束 === -->
    <script>
        // 1. 更新时钟
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. 获取电量
        async function getBatteryStatus() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    
                    function updateBatteryUI() {
                        const level = Math.floor(battery.level * 100);
                        document.getElementById('battery-level').style.width = `${level}%`;
                        document.getElementById('battery-text').textContent = `${level}%`;
                    }
                    
                    updateBatteryUI();
                    battery.addEventListener('levelchange', updateBatteryUI);
                } catch (e) {
                    console.log("Battery API error");
                }
            }
        }
        getBatteryStatus();

        // 3. 头像上传逻辑
        const avatarBox = document.getElementById('avatar-box');
        const fileInput = document.getElementById('avatar-upload');

        avatarBox.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarDataUrl = e.target.result;
                    avatarBox.style.backgroundImage = `url(${avatarDataUrl})`;
                    // [修复] 将主屏幕头像保存到独立的 localStorage
                    localStorage.setItem('homeScreenAvatar', avatarDataUrl);
                };
                reader.readAsDataURL(file);
            }
        });

        // 4. 页面切换逻辑 (保持不变)
        const slider = document.getElementById('slider-container');
        const dots = document.querySelectorAll('.dot');
        let currentPage = 0;
        const totalPages = 2;
        const gapSize = 40; 

        function goToPage(index) {
            if (index < 0 || index >= totalPages) return;
            currentPage = index;
            slider.style.transform = `translateX(calc(-100% * ${currentPage} - ${gapSize * currentPage}px))`;
            
            dots.forEach((dot, idx) => {
                if (idx === currentPage) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                goToPage(index);
            });
        });

        // 触摸滑动逻辑
        let startX = 0;
        let isDragging = false;

        document.getElementById('mobile-wrapper').addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
        }, {passive: true});

        document.getElementById('mobile-wrapper').addEventListener('touchmove', (e) => {
            if (!isDragging) return;
        }, {passive: true});

        document.getElementById('mobile-wrapper').addEventListener('touchend', (e) => {
            if (!isDragging) return;
            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;

            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    if (currentPage < totalPages - 1) goToPage(currentPage + 1);
                } else {
                    if (currentPage > 0) goToPage(currentPage - 1);
                }
            }
            isDragging = false;
        });

        // === 5. 新增功能：个人信息编辑 ===
        function makeEditable(elementId, storageKey) {
            const element = document.getElementById(elementId);
            
            // 从 localStorage 加载数据
            const savedValue = localStorage.getItem(storageKey);
            if (savedValue) {
                element.textContent = savedValue;
            }

            element.addEventListener('click', () => {
                const oldValue = element.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldValue;
                input.className = element.className; // 继承样式
                input.style.width = '100%';
                input.style.border = 'none';
                input.style.background = 'transparent';
                
                element.replaceWith(input);
                input.focus();

                const save = () => {
                    const newValue = input.value.trim();
                    element.textContent = newValue || oldValue; // 如果输入为空，则恢复旧值
                    input.replaceWith(element);
                    localStorage.setItem(storageKey, element.textContent);
                };

                input.addEventListener('blur', save);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur(); // 触发 blur 事件来保存
                    }
                });
            });
        }

        makeEditable('profile-name', 'profileName');
        makeEditable('profile-bio', 'profileBio');
        // [新增] 页面加载时，从独立的 localStorage 加载主屏幕信息
        const loadHomeScreenProfile = () => {
            const avatar = localStorage.getItem('homeScreenAvatar');
            if (avatar) {
                document.getElementById('avatar-box').style.backgroundImage = `url(${avatar})`;
            }
            // 名字和简介已由 makeEditable 函数处理加载
        };
        loadHomeScreenProfile();


        // === 6. 新增功能：通用模态框逻辑 (重构) ===
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        let lastClickedElement = null; // 用于记录点击的元素以计算动效原点

        function openModal(title, contentHTML, clickedElement) {
            lastClickedElement = clickedElement; // 保存点击的元素
            
            // 计算动效原点
            if (lastClickedElement) {
                const rect = lastClickedElement.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                modalContainer.style.transformOrigin = `${x}px ${y}px`;
            } else {
                modalContainer.style.transformOrigin = '50% 50%'; // 默认居中
            }
            
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHTML;

            // 移除可能存在的关闭动画类
            modalContainer.classList.remove('is-closing');
            modalOverlay.classList.add('visible');
        }

        function closeModal() {
            // 计算关闭动画的原点
            if (lastClickedElement) {
                const rect = lastClickedElement.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                modalContainer.style.transformOrigin = `${x}px ${y}px`;
            }
            
            modalContainer.classList.add('is-closing');

            // 监听动画结束事件，结束后再隐藏 overlay
            modalContainer.addEventListener('transitionend', () => {
                modalOverlay.classList.remove('visible');
                modalContainer.classList.remove('is-closing');
            }, { once: true }); // 事件只执行一次
        }

        modalCloseBtn.addEventListener('click', closeModal);
        // 注意：我们不再通过点击 overlay 来关闭，因为现在它是全屏的

        // === 7. 新增功能：App 功能实现 ===

         // 7.1 API 设置功能 (重构版)
        document.getElementById('app-api').addEventListener('click', function() {
            const currentSettings = JSON.parse(localStorage.getItem('apiSettings')) || { temp: 0.7, stream: true };
            
            const content = `
                <div class="preset-section">
                    <div class="modal-form-group">
                        <label>预设管理</label>
                        <div class="preset-controls">
                            <select id="api-preset-select" class="modal-select"></select>
                            <button id="save-preset-btn" class="modal-button">保存</button>
                            <button id="update-preset-btn" class="modal-button secondary">更新</button>
                            <button id="delete-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;">删除</button>
                        </div>
                    </div>
                </div>

                <div class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="api-url">API URL</label>
                        <input type="text" id="api-url" class="modal-input" placeholder="例如: https://api.openai.com/v1" value="${currentSettings.url || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="api-key">密钥 (Key)</label>
                        <input type="password" id="api-key" class="modal-input" value="${currentSettings.key || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="api-model">模型</label>
                        <div class="model-selection-group">
                            <select id="api-model-select" class="modal-select">
                                <!-- 模型列表将由JS填充 -->
                                ${currentSettings.model ? `<option value="${currentSettings.model}">${currentSettings.model}</option>` : '<option value="">请先拉取模型</option>'}
                            </select>
                            <button id="fetch-models-btn" class="modal-button secondary">拉取</button>
                        </div>
                    </div>

                    <div class="modal-form-group">
                        <label for="api-temp">温度</label>
                        <div class="slider-group">
                            <input type="range" id="api-temp" min="0" max="1" step="0.1" value="${currentSettings.temp}">
                            <span id="api-temp-value" class="slider-value">${currentSettings.temp}</span>
                        </div>
                    </div>
                    <div class="modal-form-group">
                         <div class="switch-group">
                            <label>流式传输</label>
                            <label class="switch-container">
                                <input type="checkbox" id="api-stream" ${currentSettings.stream ? 'checked' : ''}>
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="button-container">
                        <button id="save-api-btn" class="modal-button">应用并保存当前设置</button>
                    </div>
                </div>

            `;
            openModal('API 设置', content, this);

            // --- 绑定事件和逻辑 ---
            const tempSlider = document.getElementById('api-temp');
            const tempValue = document.getElementById('api-temp-value');
            tempSlider.addEventListener('input', () => {
                tempValue.textContent = tempSlider.value;
            });

            const getFormValues = () => ({
                url: document.getElementById('api-url').value,
                key: document.getElementById('api-key').value,
                model: document.getElementById('api-model-select').value,
                temp: parseFloat(document.getElementById('api-temp').value), // 显式转换为浮点数
                stream: document.getElementById('api-stream').checked,
            });


            
            const setFormValues = (settings) => {
                 document.getElementById('api-url').value = settings.url || '';
                 document.getElementById('api-key').value = settings.key || '';
                 const modelSelect = document.getElementById('api-model-select');
                 // 如果预设里有模型，确保它在选项中并被选中
                 if (settings.model) {
                     let optionExists = false;
                     for(let i=0; i<modelSelect.options.length; i++){
                         if(modelSelect.options[i].value === settings.model){
                             optionExists = true;
                             break;
                         }
                     }
                     if(!optionExists){
                         modelSelect.innerHTML = `<option value="${settings.model}">${settings.model}</option>` + modelSelect.innerHTML;
                     }
                     modelSelect.value = settings.model;
                 }
                 document.getElementById('api-temp').value = settings.temp || 0.7;
                 document.getElementById('api-temp-value').textContent = settings.temp || 0.7;
                 document.getElementById('api-stream').checked = settings.stream !== false; // 默认为 true
            };


            const presetSelect = document.getElementById('api-preset-select');
            const loadPresets = () => {
                const presets = JSON.parse(localStorage.getItem('apiPresets')) || {};
                presetSelect.innerHTML = '<option value="">选择一个预设...</option>';
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    presetSelect.appendChild(option);
                }
            };

            presetSelect.addEventListener('change', () => {
                const presets = JSON.parse(localStorage.getItem('apiPresets')) || {};
                const selectedName = presetSelect.value;
                if (selectedName && presets[selectedName]) {
                    setFormValues(presets[selectedName]);
                }
            });

            document.getElementById('save-preset-btn').addEventListener('click', () => {
                const name = prompt('请输入新预设的名称:');
                if (name) {
                    const presets = JSON.parse(localStorage.getItem('apiPresets')) || {};
                    presets[name] = getFormValues();
                    localStorage.setItem('apiPresets', JSON.stringify(presets));
                    loadPresets();
                    presetSelect.value = name;
                }
            });

            document.getElementById('update-preset-btn').addEventListener('click', () => {
                const selectedName = presetSelect.value;
                if (selectedName) {
                    if (confirm(`确定要更新预设 "${selectedName}" 吗？`)) {
                        const presets = JSON.parse(localStorage.getItem('apiPresets')) || {};
                        presets[selectedName] = getFormValues();
                        localStorage.setItem('apiPresets', JSON.stringify(presets));
                        alert('预设已更新！');
                    }
                } else {
                    alert('请先选择一个要更新的预设。');
                }
            });

            document.getElementById('delete-preset-btn').addEventListener('click', () => {
                const selectedName = presetSelect.value;
                if (selectedName) {
                    if (confirm(`确定要删除预设 "${selectedName}" 吗？此操作不可逆！`)) {
                        const presets = JSON.parse(localStorage.getItem('apiPresets')) || {};
                        delete presets[selectedName];
                        localStorage.setItem('apiPresets', JSON.stringify(presets));
                        loadPresets();
                    }
                } else {
                    alert('请先选择一个要删除的预设。');
                }
            });
            
            document.getElementById('save-api-btn').addEventListener('click', () => {
                const settings = getFormValues();
                localStorage.setItem('apiSettings', JSON.stringify(settings));
                alert('当前API设置已应用并保存！');
                closeModal();
            });

            loadPresets(); // 初始化时加载预设列表
            // 在 loadPresets(); 后面添加
            document.getElementById('fetch-models-btn').addEventListener('click', async () => {
                const apiUrl = document.getElementById('api-url').value;
                const apiKey = document.getElementById('api-key').value;
                const fetchBtn = document.getElementById('fetch-models-btn');

                if (!apiUrl || !apiKey) {
                    alert('请先输入有效的 API URL 和密钥。');
                    return;
                }
                
                fetchBtn.textContent = '拉取中...';
                fetchBtn.disabled = true;

                try {
                    // 兼容 OpenAI 的 API，端点通常是 /v1/models
                    const response = await fetch(new URL('/v1/models', apiUrl).href, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(`HTTP 错误! 状态: ${response.status}. ${errorData?.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    const models = data.data; // OpenAI 格式
                    
                    if (!models || !Array.isArray(models)) {
                         throw new Error('API返回的数据格式不正确，无法解析模型列表。');
                    }

                    const modelSelect = document.getElementById('api-model-select');
                    const currentVal = modelSelect.value;
                    modelSelect.innerHTML = ''; // 清空

                    const modelIds = models.map(m => m.id).sort();
                    
                    modelIds.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        modelSelect.appendChild(option);
                    });
                    
            // 尝试保留之前的选择
            if (modelIds.includes(currentVal)) {
                modelSelect.value = currentVal;
            }

            // 保存模型列表到localStorage，供Chat App设置使用
            currentSettings.modelList = modelIds;
            localStorage.setItem('apiSettings', JSON.stringify(currentSettings)); // 更新apiSettings
            
            alert(`成功拉取 ${modelIds.length} 个模型！`);

        } catch (error) {
            console.error('拉取模型失败:', error);
            alert(`拉取模型失败: ${error.message}`);
        } finally {
            fetchBtn.textContent = '拉取';
            fetchBtn.disabled = false;
        }
    });

});

        // 7.2 美化功能 (重构版)
        document.getElementById('app-beautify').addEventListener('click', function() {
            const currentSettings = JSON.parse(localStorage.getItem('themeSettings')) || {};
            
            const content = `
                <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 24px 4px;">主屏幕设置</h3>

                <div class="modal-form-section">
                     <div class="modal-form-group">
                        <label>主题强调色</label>

                        <div class="color-picker-group">
                            <div class="color-swatch-wrapper">
                                <div id="theme-accent-color-swatch"></div>
                                <input type="color" id="theme-accent-color-picker" value="${currentSettings.accentColor || '#334155'}">
                            </div>
                            <input type="text" id="theme-accent-color-hex" class="modal-input" value="${currentSettings.accentColor || '#334155'}">
                        </div>
                    </div>
                    <div class="mockup-container" style="margin-top: 0;">
                        <!-- 昼间模式预览 -->
                        <div class="phone-mockup">
                            <label>昼间壁纸</label>
                            <div class="phone-frame">
                                <div id="day-screen" class="phone-screen" style="background-image: url('${currentSettings.bgDay || ''}')"></div>
                            </div>
                            <input type="file" id="day-upload" accept="image/*" hidden>
                        </div>
                        <!-- 夜间模式预览 -->
                        <div class="phone-mockup dark">
                            <label>夜间壁纸</label>
                            <div class="phone-frame">
                                <div id="night-screen" class="phone-screen" style="background-image: url('${currentSettings.bgNight || ''}')"></div>
                            </div>
                            <input type="file" id="night-upload" accept="image/*" hidden>
                        </div>
                    </div>
                </div>

                <hr class="subtle-divider">

                <div class="preset-section" style="padding-top:0; margin-bottom: 20px;">
                    <div class="modal-form-group">
                        <label>字体预设管理</label>
                        <div class="preset-controls">
                            <select id="theme-preset-select" class="modal-select"></select>
                            <button id="save-theme-preset-btn" class="modal-button">保存</button>
                            <button id="update-theme-preset-btn" class="modal-button secondary">更新</button>
                            <button id="delete-theme-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;">删除</button>
                        </div>
                    </div>
                </div>
                
                <div class="modal-form-section" style="gap: 10px;">
                    <div class="modal-form-group">
                        <label for="theme-font">全局字体链接 (CSS)</label>
                        <input type="text" id="theme-font" class="modal-input" placeholder="留空则使用系统默认字体" value="${currentSettings.fontUrl || ''}">
                    </div>
                     <div class="button-container">
                        <button id="save-theme-btn" class="modal-button">应用并保存当前主题</button>
                     </div>
                </div>

            `;

            openModal('美化设置', content, this); 
            // 在 openModal(...) 之后，添加颜色选择器逻辑
            const colorPicker = document.getElementById('theme-accent-color-picker');
            const colorHexInput = document.getElementById('theme-accent-color-hex');
            const colorSwatch = document.getElementById('theme-accent-color-swatch');

            // 封装应用和保存颜色的函数
            const applyAndSaveColor = (color) => {
                // 1. 更新UI元素
                colorSwatch.style.backgroundColor = color;
                colorPicker.value = color;
                colorHexInput.value = color;
                
                // 2. 实时应用到整个App
                document.documentElement.style.setProperty('--accent-color', color);
                
                // 3. 实时保存到localStorage
                const settings = JSON.parse(localStorage.getItem('themeSettings')) || {};
                settings.accentColor = color;
                localStorage.setItem('themeSettings', JSON.stringify(settings));
            };

            const syncColor = (color) => {
                if (/^#([0-9a-f]{3}){1,2}$/i.test(color)) {
                    applyAndSaveColor(color);
                }
            };
            
            // 点击色块时，触发隐藏的input
            colorSwatch.addEventListener('click', () => colorPicker.click());
            
            // 当调色盘选择颜色时（input事件更实时）
            colorPicker.addEventListener('input', () => syncColor(colorPicker.value));
            
            // 当手动输入HEX值时
            colorHexInput.addEventListener('input', () => syncColor(colorHexInput.value));


            // --- 绑定事件和逻辑 ---
            let tempBgDay = currentSettings.bgDay || '';
            let tempBgNight = currentSettings.bgNight || '';

            const createUploader = (screenId, inputId, tempVarCallback) => {
                const screen = document.getElementById(screenId);
                const input = document.getElementById(inputId);
                screen.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = event.target.result;
                            screen.style.backgroundImage = `url(${dataUrl})`;
                            tempVarCallback(dataUrl);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            createUploader('day-screen', 'day-upload', (data) => tempBgDay = data);
            createUploader('night-screen', 'night-upload', (data) => tempBgNight = data);
            
            const getThemeFormValues = () => ({
                fontUrl: document.getElementById('theme-font').value,
                bgDay: tempBgDay,
                bgNight: tempBgNight,
                accentColor: document.getElementById('theme-accent-color-hex').value,
            });

            const setThemeFormValues = (settings) => {
                document.getElementById('theme-font').value = settings.fontUrl || '';
                document.getElementById('day-screen').style.backgroundImage = `url(${settings.bgDay || ''})`;
                document.getElementById('night-screen').style.backgroundImage = `url(${settings.bgNight || ''})`;
                
                // 更新颜色选择器
                const accentColor = settings.accentColor || (document.body.classList.contains('dark-mode') ? '#60a5fa' : '#334155');
                syncColor(accentColor);
                
                tempBgDay = settings.bgDay || '';
                tempBgNight = settings.bgNight || '';
            };

            
            // 预设逻辑 (与 API 类似, 但使用不同的 key)
            const themePresetSelect = document.getElementById('theme-preset-select');
            const loadThemePresets = () => {
                const presets = JSON.parse(localStorage.getItem('themePresets')) || {};
                themePresetSelect.innerHTML = '<option value="">选择一个预设...</option>';
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    themePresetSelect.appendChild(option);
                }
            };

            themePresetSelect.addEventListener('change', () => {
                const presets = JSON.parse(localStorage.getItem('themePresets')) || {};
                const selectedName = themePresetSelect.value;
                if (selectedName && presets[selectedName]) {
                    setThemeFormValues(presets[selectedName]);
                }
            });

            document.getElementById('save-theme-preset-btn').addEventListener('click', () => {
                const name = prompt('请输入新主题预设的名称:');
                if (name) {
                    const presets = JSON.parse(localStorage.getItem('themePresets')) || {};
                    presets[name] = getThemeFormValues();
                    localStorage.setItem('themePresets', JSON.stringify(presets));
                    loadThemePresets();
                    themePresetSelect.value = name;
                }
            });

            document.getElementById('update-theme-preset-btn').addEventListener('click', () => {
                 const selectedName = themePresetSelect.value;
                if (selectedName) {
                    if(confirm(`确定要更新主题预设 "${selectedName}" 吗？`)){
                        const presets = JSON.parse(localStorage.getItem('themePresets')) || {};
                        presets[selectedName] = getThemeFormValues();
                        localStorage.setItem('themePresets', JSON.stringify(presets));
                        alert('主题预设已更新！');
                    }
                } else {
                    alert('请先选择一个要更新的预设。');
                }
            });

             document.getElementById('delete-theme-preset-btn').addEventListener('click', () => {
                const selectedName = themePresetSelect.value;
                if (selectedName) {
                    if(confirm(`确定要删除主题预设 "${selectedName}" 吗？此操作不可逆！`)){
                        const presets = JSON.parse(localStorage.getItem('themePresets')) || {};
                        delete presets[selectedName];
                        localStorage.setItem('themePresets', JSON.stringify(presets));
                        loadThemePresets();
                    }
                } else {
                    alert('请先选择一个要删除的预设。');
                }
            });

            document.getElementById('save-theme-btn').addEventListener('click', () => {
                const settings = getThemeFormValues();
                localStorage.setItem('themeSettings', JSON.stringify(settings));
                applyThemeSettings();
                alert('主题已应用并保存！');
                closeModal();
            });

            loadThemePresets();
        });


        // 7.3 数据功能 (GitHub 同步)
        document.getElementById('app-data').addEventListener('click', function() {
            const settings = JSON.parse(localStorage.getItem('githubSyncSettings')) || {};
            const content = `
                <div class="modal-form-group">
                    <label for="github-user">GitHub 用户名</label>
                    <input type="text" id="github-user" class="modal-input" value="${settings.user || ''}">
                </div>
                <div class="modal-form-group">
                    <label for="github-repo">仓库名</label>
                    <input type="text" id="github-repo" class="modal-input" value="${settings.repo || ''}">
                </div>
                <div class="modal-form-group">
                    <label for="github-token">Personal Access Token (PAT)</label>
                    <input type="password" id="github-token" class="modal-input" value="${settings.token || ''}">
                </div>
                <div class="modal-form-group">
                    <label for="github-interval">自动同步间隔 (分钟, 0为关闭)</label>
                    <input type="number" id="github-interval" class="modal-input" min="0" value="${settings.interval || 0}">
                </div>
                <div class="button-container">
                    <button id="save-github-btn" class="modal-button">保存同步设置</button>
                </div>
                <div class="button-container" style="margin-top: 10px;">
                    <button id="manual-sync-btn" class="modal-button secondary">立即手动同步</button>
                </div>

            `;
            openModal('数据同步 (GitHub)', content, this);

            document.getElementById('save-github-btn').addEventListener('click', () => {
                const githubSyncSettings = {
                    user: document.getElementById('github-user').value,
                    repo: document.getElementById('github-repo').value,
                    token: document.getElementById('github-token').value,
                    interval: document.getElementById('github-interval').value,
                };
                localStorage.setItem('githubSyncSettings', JSON.stringify(githubSyncSettings));
                alert('GitHub同步设置已保存！');
                closeModal();
            });
             document.getElementById('manual-sync-btn').addEventListener('click', () => {
                // 实际的同步逻辑会很复杂，这里只做提示
                alert('正在尝试手动同步... (此功能需要后端或复杂前端API实现)');
            });
        });

        // === 8. 新增功能：页面加载时应用设置 ===
        function applyThemeSettings() {
            const settings = JSON.parse(localStorage.getItem('themeSettings')) || {};
            const root = document.documentElement;

            // 1. 应用字体
            const oldFontLink = document.getElementById('custom-font-link');
            if (oldFontLink) oldFontLink.remove();
            
            if (settings.fontUrl) {
                const fontLink = document.createElement('link');
                fontLink.id = 'custom-font-link';
                fontLink.rel = 'stylesheet';
                fontLink.href = settings.fontUrl;
                document.head.appendChild(fontLink);
            }

            // 2. 检测并应用深色模式
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const body = document.body;
            let bgImage = '';

            if (prefersDark) {
                body.classList.add('dark-mode');
                bgImage = settings.bgNight || '';
            } else {
                body.classList.remove('dark-mode');
                bgImage = settings.bgDay || '';
            }
            
            // 3. 应用强调色
            if (settings.accentColor) {
                root.style.setProperty('--accent-color', settings.accentColor);
            } else {
                // 如果未设置，则恢复为默认值
                root.style.removeProperty('--accent-color');
            }

            // 4. 应用背景图片
            if (bgImage) {
                 body.style.backgroundImage = `url('${bgImage}')`;
                 body.style.backgroundSize = 'cover';
                 body.style.backgroundPosition = 'center';
            } else {
                 // 如果没有设置图片，恢复默认渐变
                 body.style.backgroundImage = ''; 
                 body.style.background = 'linear-gradient(160deg, var(--bg-color-start) 0%, #cbd5e1 50%, var(--bg-color-end) 100%)';
            }
        }

        
        // 页面加载时就应用主题
        applyThemeSettings();
                // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);


        // === 9. 新增功能：世界书 App 完整逻辑 ===
        const worldBookFab = document.getElementById('world-book-fab');
        const archiveFab = document.getElementById('archive-fab'); // 新增：获取档案悬浮按钮
        let worldBookData = JSON.parse(localStorage.getItem('worldBookData')) || [];
        let isWorldBookEditMode = false;
        let draggedElement = null;

        const saveWorldBookData = () => {
            localStorage.setItem('worldBookData', JSON.stringify(worldBookData));
        };
        
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // 渲染世界书主界面
        const renderWorldBook = () => {
            modalBody.innerHTML = ''; // 清空
            if (worldBookData.length === 0) {
                modalBody.innerHTML = `<span class="empty-text" style="text-align:center; display:block; padding: 40px 0;">空空如也，点击右下角加号添加第一个分类吧</span>`;
            }

            worldBookData.forEach((category, index) => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'world-book-category';
                categoryEl.dataset.categoryId = category.id;
                
                let editControlsHTML = '';
                if (isWorldBookEditMode) {
                    categoryEl.draggable = true;
                    categoryEl.dataset.index = index;
                    editControlsHTML = `
                        <div class="edit-mode-controls">
                            <button class="edit-mode-btn" data-action="rename" title="重命名"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
                            <button class="edit-mode-btn" data-action="delete" title="删除"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                        </div>
                    `;
                }

                categoryEl.innerHTML = `
                    <span class="category-title">${category.name}</span>
                    <div class="d-flex align-items-center">
                        ${editControlsHTML}
                        ${/* 修改：仅在非编辑模式下显示箭头 */ ''}
                        ${!isWorldBookEditMode ? '<svg class="category-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>' : ''}
                    </div>
                `;


                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'category-items';
                itemsContainer.dataset.containerFor = category.id;

                // 修改：先创建并添加 "添加新条目" 的占位符
                const addItemPlaceholder = document.createElement('div');
                addItemPlaceholder.className = 'add-item-placeholder';
                addItemPlaceholder.textContent = '点击添加新条目';
                addItemPlaceholder.dataset.action = 'add-item';
                addItemPlaceholder.dataset.categoryId = category.id;
                itemsContainer.appendChild(addItemPlaceholder);
                
                // 再遍历并添加已有的条目
                if (category.items && category.items.length > 0) {
                    category.items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'world-book-item';
                        itemEl.dataset.itemId = item.id;

                        // [修复] 在编辑模式下为条目添加删除按钮
                        let itemHTML = `
                            <div class="item-title">${item.title}</div>
                            <div class="item-content">${item.content}</div>
                        `;
                        if (isWorldBookEditMode) {
                            itemEl.style.display = 'flex'; // 使用flex布局让内容和按钮分开
                            itemEl.style.justifyContent = 'space-between';
                            itemEl.style.alignItems = 'center';
                            
                            itemHTML = `
                                <div style="flex-grow: 1; overflow: hidden;">
                                    <div class="item-title">${item.title}</div>
                                    <div class="item-content">${item.content}</div>
                                </div>
                                <div class="edit-mode-controls">
                                    <button class="edit-mode-btn" data-action="delete-item" data-category-id="${category.id}" data-item-id="${item.id}" title="删除条目"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                                </div>
                            `;
                        }
                        itemEl.innerHTML = itemHTML;
                        itemsContainer.appendChild(itemEl);
                    });
                }

                
                modalBody.appendChild(categoryEl);
                modalBody.appendChild(itemsContainer);

            });

            // 添加拖拽事件
            if (isWorldBookEditMode) {
                 addDragAndDropListeners();
            }
        };

        const handleOpenWorldBook = (e) => {
            isWorldBookEditMode = false; // 每次打开重置编辑模式
            const headerControls = `
                <div id="modal-header-controls">
                    <button id="world-book-edit-btn" class="modal-button secondary" style="padding: 6px 12px; font-size: 14px;">编辑</button>
                </div>
            `;
            openModal('世界书', '', e.currentTarget);
            document.getElementById('modal-header').insertAdjacentHTML('beforeend', headerControls);
            worldBookFab.classList.add('visible');
            renderWorldBook();
        };

        const handleCloseWorldBook = () => {
             worldBookFab.classList.remove('visible');
             const headerControls = document.getElementById('modal-header-controls');
             if (headerControls) headerControls.remove();
             closeModal();
        };
        
        // 重写 close 按钮事件，以确保 FAB 消失和实现正确的返回逻辑
        modalCloseBtn.removeEventListener('click', closeModal); // 移除旧的，防止重复绑定
        modalCloseBtn.addEventListener('click', () => {
            const currentTitle = modalTitle.textContent;
            const editBtn = document.getElementById('world-book-edit-btn'); // 世界书编辑按钮

            // 检查是否在世界书的子页面
            if (currentTitle.startsWith('添加条目到') || currentTitle.startsWith('编辑条目')) {
                modalTitle.textContent = '世界书';
                if(editBtn) editBtn.style.display = ''; 
                worldBookFab.classList.add('visible'); 
                renderWorldBook();
            } 
            // 检查是否在世界书主页
            else if (currentTitle === '世界书') {
                handleCloseWorldBook();
            } 
            // 检查是否在档案App的编辑页面
            else if (currentTitle.startsWith('编辑角色：') || currentTitle === '添加新角色') {
                closeArchiveDetailModal(); // 关闭档案编辑模态框
                modalTitle.textContent = '档案'; // 将通用模态框标题设回档案
                archiveFab.classList.add('visible'); // 显示档案悬浮按钮
            }
            // 检查是否在档案App主页
            else if (currentTitle === '档案') {
                closeArchiveApp(); // 关闭档案App
            }
            // 其他情况，正常关闭
            else {
                closeModal();
            }
        });


        // 添加分类
        const handleAddCategory = () => {
            const categoryName = prompt('请输入新的分类名称：');
            if (categoryName && categoryName.trim()) {
                worldBookData.unshift({
                    id: generateId(),
                    name: categoryName.trim(),
                    items: []
                });
                saveWorldBookData();
                renderWorldBook();
            }
        };

        // 显示添加或编辑条目的表单
        const showItemForm = (categoryId, itemId = null) => {
            // 新增：进入表单页时，隐藏悬浮球
            worldBookFab.classList.remove('visible');

            const category = worldBookData.find(c => c.id === categoryId);
            let item = null;
            let currentTitle = '';
            let currentContent = '';

            const editBtn = document.getElementById('world-book-edit-btn');
            if(editBtn) editBtn.style.display = 'none'; // 隐藏“编辑”按钮


            if (itemId) {
                item = category.items.find(i => i.id === itemId);
                modalTitle.textContent = `编辑条目`;
                currentTitle = item.title;
                currentContent = item.content;
            } else {
                modalTitle.textContent = `添加条目到 "${category.name}"`;
            }

            
            modalBody.innerHTML = `
                <div id="world-book-add-item-form" class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="item-title-input">标题</label>
                        <input type="text" id="item-title-input" class="modal-input" placeholder="条目标题" value="${currentTitle}">
                    </div>
                    <div class="modal-form-group">
                        <label for="item-content-input">内容</label>
                        <textarea id="item-content-input" class="modal-input" placeholder="条目内容">${currentContent}</textarea>
                    </div>
                    <div class="button-container">
                        <button id="save-item-btn" class="modal-button">保存</button>
                    </div>
                </div>
            `;
            // 将 categoryId 和 itemId 传递给保存函数
            document.getElementById('save-item-btn').onclick = () => saveItem(categoryId, itemId);
        };


        // 保存新条目或更新现有条目
        const saveItem = (categoryId, itemId) => {
            const title = document.getElementById('item-title-input').value;
            const content = document.getElementById('item-content-input').value;

            if (!title.trim()) {
                alert('标题不能为空！');
                return;
            }

            const category = worldBookData.find(c => c.id === categoryId);

            if (itemId) { // 如果有 itemId，说明是编辑模式
                const itemToUpdate = category.items.find(i => i.id === itemId);
                itemToUpdate.title = title.trim();
                itemToUpdate.content = content.trim();
            } else { // 否则是新增模式
                category.items.push({
                    id: generateId(),
                    title: title.trim(),
                    content: content.trim()
                });
            }
            
             saveWorldBookData();
            
            // 返回主界面并渲染
            modalTitle.textContent = '世界书';
            // [修复] 重新显示“编辑”按钮和悬浮按钮
            worldBookFab.classList.add('visible');
            const editBtn = document.getElementById('world-book-edit-btn');
            if(editBtn) editBtn.style.display = '';

            renderWorldBook();
            
            // 展开刚刚操作的分类
            const categoryEl = document.querySelector(`.world-book-category[data-category-id="${categoryId}"]`);

            const itemsContainer = document.querySelector(`.category-items[data-container-for="${categoryId}"]`);
            if(categoryEl && itemsContainer) {
                categoryEl.classList.add('expanded');
                itemsContainer.classList.add('visible');
            }
        };


        // 切换编辑模式
        const toggleEditMode = () => {
            isWorldBookEditMode = !isWorldBookEditMode;
            const editBtn = document.getElementById('world-book-edit-btn');
            editBtn.textContent = isWorldBookEditMode ? '完成' : '编辑';
            renderWorldBook(); // 这会重新渲染并应用拖拽事件

            // 为现有元素切换 class，以应用 user-select: none
            const categories = document.querySelectorAll('.world-book-category');
            categories.forEach(cat => {
                if (isWorldBookEditMode) {
                    cat.classList.add('in-edit-mode');
                } else {
                    cat.classList.remove('in-edit-mode');
                }
            });
        };

        // 拖拽排序功能（兼容桌面和移动端）
        const addDragAndDropListeners = () => {
            const draggables = document.querySelectorAll('.world-book-category[draggable="true"]');

            const handleDragEnd = () => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                }
                draggedElement = null;
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            };

            const handleDrop = (targetElement) => {
                 if (draggedElement && targetElement && draggedElement !== targetElement) {
                    const fromIndex = parseInt(draggedElement.dataset.index, 10);
                    const toIndex = parseInt(targetElement.dataset.index, 10);
                    if (fromIndex !== toIndex) {
                        const [movedItem] = worldBookData.splice(fromIndex, 1);
                        worldBookData.splice(toIndex, 0, movedItem);
                        saveWorldBookData();
                        renderWorldBook(); // 会自动重新执行 addDragAndDropListeners
                    }
                }
            };
            
            draggables.forEach(draggable => {
                // --- 桌面端事件 ---
                draggable.addEventListener('dragstart', () => {
                    draggedElement = draggable;
                    draggable.classList.add('dragging');
                });

                draggable.addEventListener('dragend', handleDragEnd);

                draggable.addEventListener('dragover', e => {
                    e.preventDefault();
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    draggable.classList.add('drag-over');
                });

                draggable.addEventListener('drop', e => {
                    e.preventDefault();
                    handleDrop(draggable);
                });

                // --- 移动端触摸事件 ---
                draggable.addEventListener('touchstart', e => {
                    // 长按触发（例如 300ms）
                    const longPressTimer = setTimeout(() => {
                        draggedElement = draggable;
                        draggable.classList.add('dragging');
                        // 阻止页面滚动
                        modalBody.style.overflow = 'hidden';
                    }, 300);

                    // 如果手指移开或移动，则取消长按
                    const cancelLongPress = () => clearTimeout(longPressTimer);
                    draggable.addEventListener('touchend', cancelLongPress, { once: true });
                    draggable.addEventListener('touchmove', cancelLongPress, { once: true });
                }, { passive: true });

                draggable.addEventListener('touchmove', e => {
                    if (!draggedElement) return;
                    e.preventDefault(); // 阻止滚动
                    const touch = e.touches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = target ? target.closest('.world-book-category[draggable="true"]') : null;

                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    if (dropTarget) {
                        dropTarget.classList.add('drag-over');
                    }
                }, { passive: false }); // 需要 preventDefault，所以不是 passive

                draggable.addEventListener('touchend', e => {
                    modalBody.style.overflow = 'auto'; // 恢复滚动
                    if (!draggedElement) return;

                    // 使用 changedTouches 因为 touchend 事件的 touches 列表是空的
                    const touch = e.changedTouches[0]; 
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = target ? target.closest('.world-book-category[draggable="true"]') : null;

                    if (dropTarget) {
                         handleDrop(dropTarget);
                    }
                    handleDragEnd(); // 清理状态
                });
            });
        };

        
        // 主事件监听 (利用事件委托)
        document.getElementById('app-world-book').addEventListener('click', handleOpenWorldBook);
        worldBookFab.addEventListener('click', handleAddCategory);
        
        modalBody.addEventListener('click', e => {
            if (modalTitle.textContent !== '世界书') return; // 确保只在世界书界面生效

            const categoryEl = e.target.closest('.world-book-category');
            const actionBtn = e.target.closest('[data-action]');

            if (isWorldBookEditMode && actionBtn) {
                 const categoryId = actionBtn.closest('.world-book-category').dataset.categoryId;
                 const action = actionBtn.dataset.action;

                 if (action === 'rename') {
                     const category = worldBookData.find(c => c.id === categoryId);
                     const newName = prompt('请输入新的分类名称：', category.name);
                     if (newName && newName.trim() && newName !== category.name) {
                         category.name = newName.trim();
                         saveWorldBookData();
                         renderWorldBook();
                     }
                 } else if (action === 'delete') {
                     if (confirm('确定要删除这个分类及其所有条目吗？此操作不可撤销。')) {
                         worldBookData = worldBookData.filter(c => c.id !== categoryId);
                         saveWorldBookData();
                         renderWorldBook();
                     }

                 } else if (action === 'delete-item') {
                    // [新增] 处理删除条目的逻辑
                    const itemId = actionBtn.dataset.itemId;
                    if (confirm('确定要删除这个条目吗？')) {
                        const cat = worldBookData.find(c => c.id === categoryId);
                        if (cat) {
                            cat.items = cat.items.filter(i => i.id !== itemId);
                            saveWorldBookData();
                            renderWorldBook(); // 重新渲染以反映删除
                        }
                    }
                 }
                 return; // 防止触发折叠

            }
            
            if (actionBtn && actionBtn.dataset.action === 'add-item') {
                 // 修改：调用新的表单函数，不带 itemId
                 showItemForm(actionBtn.dataset.categoryId);
                 return; // 防止触发折叠
            }
            
            // 新增：处理点击条目进行编辑的逻辑
            const itemEl = e.target.closest('.world-book-item');
            if (itemEl && !isWorldBookEditMode) {
                const itemId = itemEl.dataset.itemId;
                const categoryId = itemEl.closest('.category-items').dataset.containerFor;
                showItemForm(categoryId, itemId);
                return;
            }


            // [修复] 在编辑模式下，只要没点到功能按钮，就允许展开/折叠分类
            if (categoryEl) {
                const itemsContainer = categoryEl.nextElementSibling;
                // 如果在编辑模式下，只有当点击的不是按钮时才触发展开
                if (isWorldBookEditMode && e.target.closest('.edit-mode-btn')) {
                    // 如果点击的是编辑按钮，则不执行展开/折叠逻辑
                } else {
                     categoryEl.classList.toggle('expanded');
                     itemsContainer.classList.toggle('visible');
                }
            }

        });
        
        // 监听模态框头部的动态按钮
        document.getElementById('modal-header').addEventListener('click', e => {
            if(e.target.id === 'world-book-edit-btn') {
                toggleEditMode();
            }
        });

        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);


        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);

        // ===================================
        // === 10. Chat App 完整逻辑 开始 ===
        // ===================================
        
        const appChat = document.getElementById('app-chat');
        const chatContainer = document.getElementById('chat-app-container');
        const chatContent = document.getElementById('chat-app-content');
        const chatSettingsOverlay = document.getElementById('chat-settings-overlay');
        const chatSettingsModal = document.getElementById('chat-settings-modal');

        // --- 数据模拟 ---
        // 你的要求提到数据后续会分开存储，目前我们先用localStorage模拟一个统一的'chatData'入口
        // 这符合你将数据聚合到"一个文件夹"的思路
        let chatAppData = JSON.parse(localStorage.getItem('chatAppData')) || {
            contacts: [
                { id: 'system', name: '系统', avatar: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2364748b'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z'/%3E%3C/svg%3E`, lastMessage: '欢迎使用水母终端。' }
            ],

            messages: {
                'system': [
                    { id: 'm-sys-1', text: '欢迎使用水母终端。', sender: 'them', timestamp: Date.now() - 10000 }
                ]
            },
            // 新增：用于存储API对话相关配置，例如每个角色的API模型、提示词等。
            // 初始时每个联系人都没有特定的API设置，会使用全局API设置。
            contactApiSettings: {} 
        };

        const saveChatData = () => {
            localStorage.setItem('chatAppData', JSON.stringify(chatAppData));
        };

        // --- 渲染函数 ---

        // 渲染联系人列表
        const renderContactList = () => {
            // [新增] 返回列表页时，重置聊天背景为默认
            const chatWallpaper = document.getElementById('chat-wallpaper');
            chatWallpaper.style.backgroundImage = `url('https://images.unsplash.com/photo-1616047778988-19814a0cb723?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb')`;

            // 显示 Chat App FAB
            chatappFab.classList.add('visible');

            let contactsHTML = chatAppData.contacts.map(contact => {
                // [修改] 从档案数据中获取最新名字
                const archiveProfile = archiveData.characters.find(c => c.id === contact.id) || contact;
                const authoritativeName = archiveProfile.name;
                const displayName = contact.remark || authoritativeName; // 优先使用备注作为显示名称

                return `
                <div class="chat-contact-item" data-contact-id="${contact.id}">
                    <div class="chat-contact-avatar" style="background-image: url('${contact.avatar}')"></div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name">${displayName}</div>
                        <div class="chat-contact-last-msg">${ (isApiReplying && contact.id === replyingContactId) ? '<div class="loading-dots" style="justify-content: flex-start;"><span></span><span></span><span></span></div>' : contact.lastMessage }</div>
                    </div>
                </div>
                `

            }).join('');

            chatContent.innerHTML = `
                <div class="chat-contact-list-view">
                    <div class="chat-main-header">
                        <button class="chat-header-btn" id="chat-app-close-btn" title="返回主屏">
                            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
                        </button>
                        <span style="position: absolute; left: 50%; transform: translateX(-50%);">聊天</span>
                    </div>
                    <div class="chat-contact-list">${contactsHTML}</div>
                </div>
            `;
            
            // 绑定事件
            document.querySelectorAll('.chat-contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    renderChatRoom(item.dataset.contactId);
                });
            });

            // 为新增的返回按钮绑定关闭事件
            document.getElementById('chat-app-close-btn').addEventListener('click', closeChatApp);
        };


        // 渲染聊天室
        const renderChatRoom = (contactId) => {
            // 隐藏 Chat App FAB
            chatappFab.classList.remove('visible');

            const contact = chatAppData.contacts.find(c => c.id === contactId);

            if (!contact) {
                console.error("找不到联系人:", contactId);
                renderContactList(); // 回到列表页
                return;
            }
            
            const messages = chatAppData.messages[contactId] || [];
            
            const chatWallpaper = document.getElementById('chat-wallpaper');
            const isDarkMode = document.body.classList.contains('dark-mode');
            const wallpaperUrl = isDarkMode ? contact.chatBgNight : contact.chatBgDay;
            
            if (wallpaperUrl) {
                chatWallpaper.style.backgroundImage = `url('${wallpaperUrl}')`;
            } else {
                chatWallpaper.style.backgroundImage = `url('https://images.unsplash.com/photo-1616047778988-19814a0cb723?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb')`;
            }

            const userAvatarUrl = localStorage.getItem('userProfileAvatar') 
                                  || (document.getElementById('avatar-box').style.backgroundImage.match(/url\("?([^"]+)"?\)/) || [])[1] 
                                  || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2394a3b8"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';

            let messagesHTML = messages.map(msg => {
                // 新增：检查是否是撤回消息
                if (msg.type === 'retracted') {
                    if (msg.senderType === 'user') {
                        return `<div class="retracted-message-notice">你撤回了一条消息</div>`;
                    } else if (msg.senderType === 'char') {
                        // 将撤回内容和心声保存在 data 属性中
                        return `<div class="retracted-message-notice" 
                                     data-action="view-retracted" 
                                     data-content="${escape(msg.originalContent)}" 
                                     data-thought="${escape(msg.innerThought)}">
                                     ${contact.name}撤回了一条消息，<span class="clickable-retract">点击查看</span>
                                </div>`;
                    }
                }
                
                const isSent = msg.sender === 'me';
                const avatarUrl = isSent ? userAvatarUrl : contact.avatar;
                let quoteHTML = '';
                if (msg.quote) {
                    quoteHTML = `<div class="quoted-message-in-bubble">${msg.quote.text}</div>`;
                }

                // 新增：在多选模式下，为选中的消息添加 'selected' 类
                const isSelected = isInMultiSelectMode && selectedMessageIds.has(msg.id);
                
                return `
                <div class="message-line ${isSent ? 'sent' : 'received'} ${isSelected ? 'selected' : ''}" data-message-id="${msg.id}">
                    <div class="chat-avatar" style="background-image: url('${avatarUrl}')"></div>
                    <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
                        ${quoteHTML}
                        ${msg.text}
                    </div>
                </div>
                `
            }).join('');
            
            if (isApiReplying && replyingContactId === contactId) {
                messagesHTML += `
                    <div class="message-line loading">
                        <div class="chat-avatar" style="background-image: url('${contact.avatar}')"></div>
                        <div class="chat-bubble received">
                            <div class="loading-dots"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                `;
            }

            chatContent.innerHTML = `
                <div class="chat-room-view">
                    <div class="chat-header">
                        <button class="chat-header-btn" id="chat-back-btn">
                            ${isInMultiSelectMode ? '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>' : '<svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>'}
                        </button>
                        <span class="chat-contact-title">${isInMultiSelectMode ? `已选择 ${selectedMessageIds.size} 项` : (contact.remark || contact.name)}</span>
                        <button class="chat-header-btn" id="chat-settings-btn" style="display: ${isInMultiSelectMode ? 'none' : 'block'};">
                            <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                        </button>
                    </div>

                    <div class="chat-messages ${isInMultiSelectMode ? 'multi-select-mode' : ''}" id="chat-messages-container">
                        ${messagesHTML}
                    </div>
                    
                    <!-- 新增：多选操作栏 -->
                    <div id="multi-select-toolbar" class="${isInMultiSelectMode ? 'visible' : ''}">
                        <div class="action-buttons">
                            <button id="multi-collect-btn">收藏</button>
                            <button id="multi-delete-btn">删除</button>
                        </div>
                    </div>

                    <div class="chat-footer" style="display: ${isInMultiSelectMode ? 'none' : 'flex'};">
                        <!-- 这个div是新增的，用于包裹原有的底栏内容 -->
                        <div class="chat-footer-content-wrapper">
                            <div id="quote-preview-container">
                                <button id="quote-preview-close" title="取消引用"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button>
                                <span id="quote-preview-content"></span>
                            </div>
                            <div class="chat-footer-input-row">
                                <button class="chat-action-btn" id="chat-tool-toggle-btn" title="工具">
                                     <svg t="1767102952154" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5004" width="16" height="16"><path d="M649.1 479.5c-56.7-0.3-102.6-46.5-102.4-103.1V271.1c-0.2-56.5 45.6-102.8 102.2-103.1h104.6c56.7 0.3 102.5 46.6 102.3 103.1v105.3c0.2 56.5-45.6 102.7-102.2 103H649.1z m0.1-263.5c-30.1 0.2-54.6 24.8-54.4 55v105.5c-0.1 30.2 24.3 54.9 54.5 55h104.4c30-0.2 54.5-24.8 54.3-54.9V271.1c0.1-30.2-24.3-54.9-54.4-55.1H649.2z" fill="#2c2c2c" opacity=".4" p-id="5005"></path><path d="M270.4 479.5c-56.7-0.3-102.6-46.5-102.4-103.1V271.1c-0.2-56.5 45.6-102.8 102.2-103.1h104.6c56.7 0.3 102.6 46.6 102.4 103.1v105.3c0.2 56.5-45.7 102.8-102.3 103H270.4z m0.1-263.5c-30.1 0.2-54.6 24.8-54.4 55v105.5c-0.1 30.2 24.3 54.9 54.5 55H375c30.1-0.1 54.5-24.8 54.4-54.9V271.1c0.1-30.2-24.3-54.9-54.5-55.1H270.5zM270.4 856c-56.7-0.3-102.6-46.5-102.4-103.1V647.6c-0.1-27.3 10.5-53.2 29.8-72.7s45.1-30.3 72.5-30.4h104.6c27.5 0.1 53.3 10.9 72.6 30.4s29.9 45.3 29.8 72.7V753c0.2 56.5-45.7 102.8-102.3 103H270.4z m0-263.5c-14.6 0.1-28.3 5.8-38.6 16.2-10.3 10.4-15.9 24.2-15.9 38.8V753c-0.1 30.2 24.3 54.9 54.5 55h104.4c30.1-0.1 54.5-24.8 54.4-54.9V647.6c0.1-14.7-5.6-28.5-15.9-38.9-10.3-10.4-24-16.1-38.6-16.2H270.4zM649.1 856c-56.7-0.3-102.6-46.5-102.4-103.1V647.6c-0.1-27.3 10.5-53.2 29.8-72.7s45.1-30.3 72.5-30.4h104.6c56.7 0.3 102.5 46.6 102.3 103.1V753c0.3 56.5-45.6 102.8-102.2 103H649.1z m0.1-263.5c-14.6 0.1-28.3 5.8-38.6 16.2-10.3 10.4-15.9 24.2-15.9 38.8V753c-0.1 30.2 24.3 54.9 54.5 55h104.4c30-0.1 54.5-24.8 54.3-54.9V647.6c0.1-30.2-24.3-54.9-54.4-55.1H649.2z" fill="#2c2c2c" p-id="5006"></path></svg>
                                </button>
                                <div class="chat-input-area">
                                    <input type="text" id="chat-input" placeholder="输入消息...">
                                </div>
                                <button class="chat-action-btn" id="api-reply-btn" title="${(isApiReplying && replyingContactId === contactId) ? '停止回复' : 'API回复'}">
                                    <svg id="api-reply-icon-default" style="display:${(isApiReplying && replyingContactId === contactId) ? 'none' : 'block'};" t="1767101507871" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1345" width="16" height="16"><path d="M201.1 913.6c-1.2 0-2.4 0-3.6-0.1-11.1-1-21.6-5.2-31.2-12.5-9.3-7.7-15.9-17.2-19.7-28.4-4-10.7-4.8-22.3-2.4-34.5l24.2-111.3c-24.7-31-43.8-64.3-56.8-98.8C95.3 586.2 87 542.7 87 498.6c0-104.8 44.9-202.7 126.5-275.9 38.8-35.1 83.9-62.7 134.2-81.9 52-19.9 107.2-30 164-30 112.3 0 218 39.8 297.7 112 39.6 35.7 70.8 77.3 92.5 123.7 22.6 48.1 34 99.3 34 152.2 0 52.8-11.4 104-34 152.1-21.8 46.5-52.9 88.1-92.5 123.6-38.7 35.2-83.8 62.8-134.1 82-51.9 19.9-106.9 29.9-163.6 29.9-33.8 0-67.9-3.8-101.6-11.4-28.8-6.2-55.6-14.9-79.7-25.7l-100.5 56.9c-9.5 4.9-19.2 7.5-28.8 7.5z m29.4-223.2c9.1 9 12.8 22 10 34.7l-22.8 105.5 94.9-53.9c5.2-2.8 10.9-4.3 16.6-4.3 5 0 9.7 1.1 14.1 3.2 26.5 12.9 53.9 22.4 81.4 28.3 27.4 6.2 56.6 9.4 87 9.4 95.5 0 185.3-33.4 252.7-94.1 31.9-28.6 57-62.1 74.5-99.4 18-38.5 27.2-79.3 27.2-121.3s-9.1-82.8-27.2-121.3c-17.5-37.3-42.6-70.9-74.5-99.7-67.7-60.7-157.4-94.1-252.7-94.1-95.5 0-185.4 33.4-253.1 94.1-31.8 28.9-56.9 62.4-74.5 99.7-18.2 38.6-27.5 79.5-27.5 121.3 0 34.7 6.5 68.9 19.2 101.8 12.9 33.1 31.2 63.4 54.7 90.1z m453.3-124.8c-13.2 0-26.2-5.7-36.5-16.1-9.7-10.2-15-23.6-15-37.8 0-14.1 5.3-27.6 14.9-38.1 10.1-10.2 23.1-15.8 36.6-15.8s26.5 5.6 36.5 15.7c9.7 10.6 15 24.1 15 38.2 0 14.3-5.3 27.7-15 37.8-10.3 10.4-23.2 16.1-36.5 16.1z m-172 0c-13.7 0-26.6-5.7-36.5-16.1-9.8-10.3-15.1-23.7-15.1-37.8 0-13.9 5.4-27.5 15.1-38.1 9.7-10.2 22.7-15.8 36.6-15.8 13.7 0 26.5 5.6 36.2 15.7 9.6 10.3 15 23.9 15 38.2 0 14.5-5.3 27.9-15 37.8-10 10.4-22.8 16.1-36.3 16.1z m-168.7 0c-13.4 0-26.6-5.9-36.3-16.1-9.6-9.9-14.9-23.3-14.9-37.8 0-14.3 5.3-27.8 14.9-38.1 9.7-10.2 22.6-15.8 36.4-15.8 13.6 0 26.5 5.6 36.4 15.7 9.8 10.5 15.1 24 15.1 38.2 0 14.3-5.4 27.8-15.1 37.8-10.2 10.4-23.2 16.1-36.5 16.1z" p-id="1346" fill="currentColor"></path></svg>
                                    <svg id="api-reply-icon-stop" style="display:${(isApiReplying && replyingContactId === contactId) ? 'block' : 'none'};" t="1767105419099" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4974" width="16" height="16"><path d="M512 928.3c-229.2 0-415-185.8-415-415s185.8-415 415-415 415 185.8 415 415-185.8 415-415 415z m0.4-77.5c186.2 0 337.2-151 337.2-337.2s-151-337.2-337.2-337.2-337.2 151-337.2 337.2 150.9 337.2 337.2 337.2zM382.3 357.6h259.4c14.3 0 25.9 11.6 25.9 25.9V643c0 14.3-11.6 25.9-25.9 25.9H382.3c-14.3 0-25.9-11.6-25.9-25.9V383.6c0-14.4 11.6-26 25.9-26z" p-id="4975" fill="currentColor"></path></svg>
                                </button>
                                <button class="chat-action-btn" id="send-btn" title="发送">
                                    <svg t="1767102878463" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4994" width="16" height="16"><path d="M955 125.6c-4.5-12.5-15.4-21.8-28.6-24.2-9.2-1.7-18.4 0.1-26.1 4.8L83.9 544.3c-12.8 6.8-20.6 20.6-19.8 35.1 0.8 14.3 9.9 27.3 23.2 32.9l238.5 97.9c12.4 5.2 26.8 3.4 37.5-4.9s16.1-21.3 14.4-34.8c-1.6-13.2-10.4-24.6-23-29.9l-165-67.7 573-307.3-357 421.9c-6.5 7.7-9.6 17.4-8.8 27.4L411.4 884c1.6 19.7 17.7 34.6 37.5 34.6 9.5 0 18.7-3.7 25.8-10.4l74-69.2 0.1-0.1c13.5-13.2 15.2-33.5 4.8-48.4l222.6 72c4 1.3 7.9 2 11.7 2 18.2 0 33.8-12.9 37-30.6l131.6-688.3h-0.1c1.4-6.6 0.9-13.5-1.4-20zM497.3 783.8L479.9 800l-6.5-75.9L856 271.6l-96.8 506.3L539 706.6c-19.7-6.4-41.1 4.4-47.5 24.2-5.8 17.9 2.5 37.1 18.9 45.4-4.7 1.5-9.2 4-13.1 7.6z" p-id="4995" fill="#2c2c2c"></path></svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 工具面板现在在这里，在底栏内部 -->
                        <div id="chat-tool-panel">
                            <div id="chat-tool-grid">
                                <div class="tool-panel-item" data-tool="emoji">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123002734" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5039"><path d="M682.666667 554.666667v21.333333c0 81.066667-68.266667 149.333333-149.333334 149.333333S384 657.066667 384 576V554.666667h42.666667v21.333333c0 59.733333 46.933333 106.666667 106.666666 106.666667s106.666667-46.933333 106.666667-106.666667V554.666667h42.666667z m-149.333334 341.333333C332.8 896 170.666667 733.866667 170.666667 533.333333S332.8 170.666667 533.333333 170.666667 896 332.8 896 533.333333 733.866667 896 533.333333 896z m0-42.666667c174.933333 0 320-145.066667 320-320S708.266667 213.333333 533.333333 213.333333 213.333333 358.4 213.333333 533.333333 358.4 853.333333 533.333333 853.333333zM469.333333 384v85.333333h-42.666666V384h42.666666z m170.666667 0v85.333333h-42.666667V384h42.666667z" fill="#2c2c2c" p-id="5040"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">表情包</span>
                                </div>
                                <div class="tool-panel-item" data-tool="image">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123093112" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15515"><path d="M938.666667 553.92V768c0 64.8-52.533333 117.333333-117.333334 117.333333H202.666667c-64.8 0-117.333333-52.533333-117.333334-117.333333V256c0-64.8 52.533333-117.333333 117.333334-117.333333h618.666666c64.8 0 117.333333 52.533333 117.333334 117.333333v297.92z m-64-74.624V256a53.333333 53.333333 0 0 0-53.333334-53.333333H202.666667a53.333333 53.333333 0 0 0-53.333334 53.333333v344.48A290.090667 290.090667 0 0 1 192 597.333333a286.88 286.88 0 0 1 183.296 65.845334C427.029333 528.384 556.906667 437.333333 704 437.333333c65.706667 0 126.997333 16.778667 170.666667 41.962667z m0 82.24c-5.333333-8.32-21.130667-21.653333-43.648-32.917333C796.768 511.488 753.045333 501.333333 704 501.333333c-121.770667 0-229.130667 76.266667-270.432 188.693334-2.730667 7.445333-7.402667 20.32-13.994667 38.581333-7.68 21.301333-34.453333 28.106667-51.370666 13.056-16.437333-14.634667-28.554667-25.066667-36.138667-31.146667A222.890667 222.890667 0 0 0 192 661.333333c-14.464 0-28.725333 1.365333-42.666667 4.053334V768a53.333333 53.333333 0 0 0 53.333334 53.333333h618.666666a53.333333 53.333333 0 0 0 53.333334-53.333333V561.525333zM320 480a96 96 0 1 1 0-192 96 96 0 0 1 0 192z m0-64a32 32 0 1 0 0-64 32 32 0 0 0 0 64z" fill="#2c2c2c" p-id="15516"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">图片</span>
                                </div>
                                <div class="tool-panel-item" data-tool="voice-msg">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123055674" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10189"><path d="M512.029676 663.540392c97.863888 0 177.468924-79.305207 177.468924-176.812985L689.4986 273.750781c0-124.120902-79.605036-194.297195-177.468924-194.297195-40.698934 0-94.097098 25.361621-121.103172 51.922557 0 0-53.383838 43.554982-56.42715 158.665673 0 1.195222 0.11768 2.357697 0.207731 3.074012-0.11768 1.699712-0.207731 3.341095-0.207731 5.042853l0 188.568726C334.500377 584.235185 414.135088 663.540392 512.029676 663.540392zM394.473283 290.041816c4.176113-89.808422 42.875506-121.04689 42.875506-121.04689 20.97573-18.916838 47.529503-29.331026 74.68191-29.331026 66.116837-4.356214 117.92069 59.598376 117.675096 137.219221l0 201.191208c0 70.235644-53.109592 125.226073-117.675096 125.226073-64.567551 0-117.557416-57.169047-117.557416-127.435391L394.473283 290.041816z" fill="#2c2c2c" p-id="10190"></path><path d="M787.592732 499.705999C787.502681 501.586836 788.099269 497.827209 787.592732 499.705999L787.592732 499.705999z" fill="#2c2c2c" p-id="10191"></path><path d="M767.131725 469.974861c-14.246469 0-26.502607 11.43647-26.786063 25.616424-8.593725 115.736954-108.846001 206.318996-228.222865 206.318996-119.407554 0-220.098837-90.617857-228.691539-206.355835-2.27788-12.418844-13.126972-21.979594-26.204825-21.979594-14.151301 0-25.596981 12.45466-26.487258 26.380834C242.74665 633.357975 347.325473 740.423433 482.107179 754.455008L482.107179 914.409023c0 16.620539 13.544481 30.137391 30.224372 30.137391 16.647145 0 30.193673-13.515828 30.193673-30.137391L542.525224 754.455008C675.837462 740.221842 780.9965 632.182196 793.260825 499.705999l-0.00921 0C793.251615 485.281475 781.557272 469.974861 767.131725 469.974861z" fill="#2c2c2c" p-id="10192"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">语音</span>
                                </div>
                                <div class="tool-panel-item" data-tool="api-switch">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767147196485" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3575" width="32" height="32"><path d="M390.368 673.04l277.2-277.216-56.432-56.432-277.168 277.216 56.4 56.432z m83.36-11.904c10.96 30.784 4.4 66.464-20.256 91.04-53.776 53.664-71.2 80.384-116.992 80.384-45.44 0-58.448-21.984-136.352-99.696a87.36 87.36 0 0 1 0.016-123.584c48.816-48.72 82.384-98.32 147.104-74.816l59.28-59.12c-64.64-40.896-151.36-33.328-207.632 22.848L143.888 553.12c-65.2 65.04-65.216 170.88-0.032 235.936 72.768 72.592 108 122.944 192.624 122.944 81.76 0 117.184-47.648 173.248-103.616 55.824-55.632 64.112-141.6 23.36-206.464l-59.36 59.232z m388.48-442.176l-74.24-74.24c-65.12-65.168-171.04-64.88-235.856-0.016l-54.896 54.896c-56 55.984-63.936 142.432-22.864 207.184l59.12-59.136c-12.496-34.32-2.8-69.168 19.888-91.872 55.296-55.28 71.488-80.336 116.688-80.336 45.376 0 58.384 22.048 136.016 99.696a87.504 87.504 0 0 1 0.016 123.568c-48.576 48.56-81.632 97.616-145.872 75.056l-59.28 59.296a165.968 165.968 0 0 0 88.48 25.408c81.408 0 116.576-47.344 172.816-103.584 65.056-65.056 65.024-170.88 0-235.92z" fill="#2c2c2c" p-id="3576"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">API切换</span>
                                </div>
                                <div class="tool-panel-item" data-tool="voice-call">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123163138" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="20740"><path d="M217.856 94.677333c-36.608 14.762667-60.928 38.485333-96.597333 83.2-88.618667 111.232-9.386667 332.8 194.730666 535.210667l10.581334 10.368c192 184.576 434.986667 264.533333 527.701333 184.064l3.029333-2.816-1.450666 1.194667a249.301333 249.301333 0 0 0 64.042666-77.994667c33.152-64 24.149333-130.858667-41.173333-182.954667-94.037333-75.008-157.184-77.568-219.434667-20.48l-6.997333 6.570667-18.005333 17.834667c-7.808-1.621333-19.882667-7.338667-34.730667-16.896-29.610667-19.114667-66.517333-50.901333-108.586667-92.586667-41.941333-41.642667-74.069333-78.208-93.312-107.605333l-3.882666-6.101334a120.448 120.448 0 0 1-12.245334-24.832l-0.938666-3.413333 18.133333-17.92 6.613333-6.954667c57.472-61.738667 54.912-124.373333-20.650666-217.642666-51.328-63.36-109.653333-83.328-166.826667-60.245334z m99.925333 113.493334l11.221334 14.08c37.546667 48.682667 37.888 64.853333 16.384 89.258666l-8.32 8.874667-21.12 20.821333c-45.482667 45.056-25.258667 102.314667 41.856 181.205334l14.08 16.085333 15.232 16.682667 8.106666 8.533333 16.981334 17.621333 18.176 18.261334 9.258666 9.130666 18.090667 17.450667 17.408 16.298667c5.717333 5.205333 11.306667 10.24 16.810667 15.104l16.213333 13.909333c79.616 66.56 137.216 86.570667 182.698667 41.685333l21.034666-20.992 5.546667-5.248c24.277333-22.186667 39.296-25.301333 80.725333 3.968l12.586667 9.258667 14.250667 11.093333c31.232 24.917333 34.261333 47.573333 18.602666 77.781334a165.845333 165.845333 0 0 1-26.88 36.608l-7.253333 7.338666-5.546667 5.12-5.333333 4.650667c-14.421333 14.293333-69.888 15.658667-141.184-7.722667-90.709333-29.781333-189.994667-92.074667-280.746667-182.101333-177.109333-175.658667-241.408-355.413333-188.16-422.272 26.453333-33.194667 43.648-49.92 61.653334-57.173333 19.285333-7.808 38.570667-1.194667 67.626666 34.688z" fill="#2c2c2c" p-id="20741"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">语音通话</span>
                                </div>
                                <div class="tool-panel-item" data-tool="video-call">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123196108" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25921"><path d="M800.3 707.3l-103.7-69.1c-38.2-25.5-87.3-28.5-128.2-8h-0.1L547 640.9c-16.6 8.3-36.3 5-49.3-8l-94-94.1c-13-13-16.2-32.8-8-49.3l10.7-21.3c20.5-40.9 17.5-90.1-8-128.3l-69.1-103.7c-13-19.6-34-32.2-57.4-34.5-23.6-2.4-46.5 5.9-63.1 22.5-116.1 116.2-116.1 305.1 0 421.3L391 827.8c58.1 58.1 134.3 87.1 210.6 87.1s152.6-29.1 210.7-87.2c16.6-16.7 24.8-39.7 22.5-63.1-2.3-23.4-14.9-44.3-34.5-57.3z m-349 60.1L269.2 585.3c-80.8-80.9-82.8-211.2-6-294.4l64.3 96.4c8.5 12.7 9.5 29.1 2.6 42.8l-10.7 21.4c-24.7 49.4-15 108.8 24 147.7l94 94c39 39 98.4 48.5 147.8 24l21.3-10.7c13.7-6.8 30-5.8 42.7 2.7l96.4 64.3c-83.2 76.7-213.5 74.7-294.3-6.1zM817 201.5v-7.1c0-47.1-38.3-85.3-85.3-85.3H560.9c-47 0-85.3 38.3-85.3 85.3v85.3c0 47.1 38.3 85.3 85.3 85.3h170.7c47 0 85.3-38.3 85.3-85.3v-7.1l85.3 71.1V130.4L817 201.5z m-256.1 78.3v-85.3h170.7v85.3H560.9z" p-id="25922" fill="#2c2c2c"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">视频通话</span>
                                </div>
                                <div class="tool-panel-item" data-tool="gift">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123230934" class="icon" viewBox="0 0 1137 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="31251"><path d="M1135.142452 361.58628c0-57.196057-46.96342-103.728338-104.689952-103.728338l-30.177676 0c17.059174-26.554471 26.182729-57.38756 26.182729-89.711715 0.003072-44.940856-17.691033-87.18735-49.821636-118.9585-32.078374-31.719945-74.707875-49.187728-120.035835-49.187728-43.922918 0-84.252328 19.345951-119.868909 57.499185-23.783302 25.479184-45.446753 59.392715-64.514154 100.969459-17.11345-5.294509-35.72411-8.054412-54.706511-8.054412-19.031558 0-37.644265 2.754783-54.716752 8.042123-19.069449-41.573671-40.729827-75.481058-64.511081-100.95717-35.615557-38.153234-75.943943-57.499185-119.864813-57.499185-77.72892 0-145.290745 52.34088-164.2967 127.28327-1.192033 4.699517-0.407585 9.682704 2.171056 13.788253 2.578641 4.105549 6.726177 6.977077 11.476898 7.944836 12.89218 2.625749 26.425436 6.186485 40.225978 10.582873 4.684155 1.493113 9.778968 0.972879 14.065779-1.435764 4.286811-2.408643 7.38159-6.48859 8.543924-11.265937 9.871136-40.558805 46.122648-68.885964 88.156133-68.885964 55.479694 0 97.333964 76.670018 119.09163 127.878262-3.066104 6.287869-5.029271 13.069347-5.858779 20.262505-0.098312 0.412705-0.183311 0.830531-0.252948 1.251429-0.247828 1.030227-0.650293 2.929901-0.650293 5.285292 0 8.050316 1.776784 15.914249 5.246377 23.433066-25.727012-0.641076-70.702687-10.009387-142.334217-49.166222C284.052714 168.690016 218.537007 149.286716 159.276399 149.286716c-96.788128 0-144.740812 51.962993-150.014839 58.040925-0.124938 0.142348-0.247828 0.287767-0.36867 0.434211-6.680093 8.138387-9.757462 18.377169-8.66579 28.832031 1.093721 10.46408 6.2254 19.853896 14.460051 26.446942 6.997559 5.595589 15.792383 8.677055 24.765398 8.677055 11.874242 0 23.001927-5.234088 30.541226-14.360715 1.476728-1.69793 27.368617-30.395806 87.911377-30.395806 45.805182 0 98.956111 16.367918 157.964795 48.641892 71.328402 39.079005 133.05705 58.892962 183.469581 58.892962 6.2254 0 12.604413-0.403489 19.568177-1.251429 2.877673 1.943709 6.318592 3.038454 9.925412 3.038454l49.222547 0 0 136.466222L178.781083 472.749461l0-111.231794c0-13.914215 11.567017-25.234428 25.785385-25.234428l144.292264 0c0.00512 0 0.011265-0.001024 0.017409 0 9.792281 0 17.730972-7.938691 17.730972-17.730972 0-7.363156-4.487531-13.677652-10.876785-16.357677-16.577855-7.68267-30.463396-14.64029-43.685331-21.891821-14.312583-7.804536-28.696852-14.717096-43.974122-21.130928-2.173104-0.912458-4.505965-1.382512-6.863404-1.382512L204.566468 257.789329c-57.72858 0-104.694048 46.532281-104.694048 103.728338l0 171.927142c0 9.792281 7.938691 17.730972 17.730972 17.730972l47.506184 0 0 369.091784c0 57.198105 46.966492 103.732434 104.695072 103.732434l695.545875 0c57.729604 0 104.695072-46.533305 104.695072-103.732434L1070.045595 551.387766l47.714073 0c4.708733 0 9.223915-1.873048 12.550137-5.205414 3.326221-3.332366 5.190052-7.852668 5.180836-12.561401L1135.142452 361.58628zM991.000729 551.241323l0 369.094857c0 13.915239-11.53527 25.234428-25.715747 25.234428L656.963304 945.570607 656.963304 551.241323 991.000729 551.241323zM1056.309571 361.58628l0 111.231794L657.03499 472.818074l0-136.465198 373.488173 0C1044.74153 336.352877 1056.309571 347.67309 1056.309571 361.58628zM652.285293 232.670622c-8.512177 2.07172-20.320878 3.739951-34.773761 3.739951-5.044633 0-10.108723-0.226322-15.126729-0.674871-1.922204-2.101418-4.027718-3.939647-6.311423-5.506494 6.261243-0.809026 13.444161-1.321067 21.438152-1.321067C631.962367 228.909166 643.773115 230.586614 652.285293 232.670622zM856.257015 78.012591c50.15139 0 90.953927 40.247484 90.953927 89.717859 0 49.468327-40.802537 89.713763-90.953927 89.713763L738.192539 257.444213c3.771698-7.893631 5.729744-16.221474 5.729744-24.753109 0-9.199337-2.292922-18.360783-6.695454-26.944647C759.002929 154.539238 800.831597 78.012591 856.257015 78.012591zM578.125302 551.241323l0 394.330309L269.804648 945.571631c-14.179453 0-25.715747-11.320213-25.715747-25.234428L244.088901 551.241323 578.125302 551.241323z" fill="#2c2c2c" p-id="31252"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">礼物</span>
                                </div>
                                <div class="tool-panel-item" data-tool="summary">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123339874" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1650"><path d="M211.2 1024c-51.2 0-160-32-160-140.8V198.4C51.2 64 134.4 6.4 211.2 6.4H768c96 0 160 64 160 166.4v230.4c0 19.2-12.8 44.8-38.4 44.8-32-6.4-44.8-19.2-44.8-44.8V179.2c0-70.4-64-96-89.6-96H217.6c-38.4 0-83.2 38.4-89.6 121.6v640c0 96 64 96 89.6 96h192c25.6-6.4 38.4 19.2 38.4 38.4s-12.8 44.8-38.4 44.8H211.2z" p-id="1651" fill="#2c2c2c"></path><path d="M268.8 172.8H704c19.2 0 32 12.8 32 32s-12.8 32-32 32H268.8c-19.2 0-32-12.8-32-32s12.8-32 32-32zM268.8 364.8H704c19.2 0 32 12.8 32 32s-12.8 32-32 32H268.8c-19.2 0-32-12.8-32-32s12.8-32 32-32zM268.8 550.4h185.6c19.2 0 32 12.8 32 32s-12.8 32-32 32H268.8c-19.2 0-32-12.8-32-32s12.8-32 32-32zM524.8 1017.6c-12.8 0-25.6-12.8-32-32v-147.2c0-6.4 0-12.8 6.4-19.2l294.4-294.4c19.2-12.8 38.4-19.2 64-19.2s44.8 6.4 57.6 25.6l70.4 70.4c19.2 19.2 25.6 38.4 25.6 57.6 0 25.6-6.4 44.8-25.6 57.6l-294.4 294.4c-6.4 6.4-12.8 6.4-19.2 6.4H524.8z m128-57.6l-102.4-102.4 6.4 102.4h96z m44.8-32l172.8-172.8-108.8-108.8-172.8 172.8 108.8 108.8z m217.6-217.6l32-32c12.8-12.8 12.8-25.6 0-38.4l-70.4-64c-6.4-6.4-12.8-6.4-19.2-6.4s-12.8 0-19.2 6.4l-32 32 108.8 102.4z" p-id="1652" fill="#2c2c2c"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">总结</span>
                                </div>
                                <div class="tool-panel-item" data-tool="music">
                                    <div class="tool-panel-icon-box">
                                        <svg t="1767123370328" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5101"><path d="M875.008 295.424a34.133333 34.133333 0 1 0-58.197333 35.669333c35.328 57.514667 53.930667 123.562667 53.930666 191.488 0 201.898667-164.352 366.250667-366.250666 366.250667S138.24 724.48 138.24 522.581333 302.592 156.330667 504.490667 156.330667c18.773333 0 34.133333-15.36 34.133333-34.133334s-15.36-34.133333-34.133333-34.133333C264.874667 88.064 69.973333 282.965333 69.973333 522.581333s194.901333 434.517333 434.517334 434.517334 434.517333-194.901333 434.517333-434.517334c0.170667-80.384-22.016-159.061333-64-227.157333z" fill="#2c2c2c" p-id="5102"></path><path d="M501.248 389.973333c-77.653333 0-140.8 63.146667-140.8 140.8s63.146667 140.8 140.8 140.8 140.8-63.146667 140.8-140.8V224.256c0-19.456 15.872-35.328 35.328-35.328 19.456 0 35.328 15.872 35.328 35.328 0 18.773333 15.36 34.133333 34.133333 34.133333s34.133333-15.36 34.133334-34.133333c0-57.173333-46.421333-103.594667-103.594667-103.594667s-103.594667 46.421333-103.594667 103.594667v186.026667a140.526933 140.526933 0 0 0-72.533333-20.309334z m0 213.333334a72.704 72.704 0 0 1-72.533333-72.533334 72.704 72.704 0 0 1 72.533333-72.533333 72.704 72.704 0 0 1 72.533333 72.533333 72.704 72.704 0 0 1-72.533333 72.533334z" fill="#2c2c2c" p-id="5103"></path></svg>
                                    </div>
                                    <span class="tool-panel-name">音乐</span>
                                </div>
                            </div>
                        </div>

            `;

            const messagesContainer = document.getElementById('chat-messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
             // --- 新增：工具面板交互逻辑 ---
            const toolToggleBtn = document.getElementById('chat-tool-toggle-btn');
            const toolPanel = document.getElementById('chat-tool-panel');

            if (toolToggleBtn && toolPanel) {
                // 点击加号按钮，展开/收起面板
                toolToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 阻止事件冒泡到聊天区，以防立即关闭
                    toolPanel.classList.toggle('visible');
                });
                
                // 点击聊天消息区域，如果面板是打开的，则关闭它
                messagesContainer.addEventListener('click', () => {
                    if (toolPanel.classList.contains('visible')) {
                        toolPanel.classList.remove('visible');
                    }
                });

                // 为面板本身添加事件委托，处理所有按钮的点击
                toolPanel.addEventListener('click', (e) => {
                    const toolItem = e.target.closest('.tool-panel-item');
                    if (toolItem) {
                        const toolName = toolItem.dataset.tool;
                        const toolText = toolItem.querySelector('.tool-panel-name').textContent;
                        // 这里只是一个提示，你可以根据 toolName 实现具体功能
                        alert(`点击了功能：${toolText} (tool: ${toolName})`);
                        // 点击功能后自动收起面板
                        toolPanel.classList.remove('visible');
                    }
                });
            }
           
            // --- 绑定新功能的事件 ---

            // [已修改] 此处的点击事件已通过事件委托移至全局，以提高稳定性。

            
            // 返回/取消多选 按钮
            document.getElementById('chat-back-btn').addEventListener('click', () => {
                if (isInMultiSelectMode) {
                    isInMultiSelectMode = false;
                    selectedMessageIds.clear();
                    renderChatRoom(contactId);
                } else {
                    renderContactList();
                }
            });
            
            document.getElementById('chat-settings-btn').addEventListener('click', () => openChatSettings(contactId));

            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const apiReplyBtn = document.getElementById('api-reply-btn');
            
            if (!isInMultiSelectMode) {
                const sendMessage = () => {
                    const text = chatInput.value.trim();
                    if (text) {
                        const latestAIRound = findLatestAIRound(chatAppData.messages[contactId]);
                        if (latestAIRound) {
                            const firstMessageOfRound = chatAppData.messages[contactId][latestAIRound.startIndex];
                            if (firstMessageOfRound.alternatives) {
                                delete firstMessageOfRound.alternatives;
                            }
                        }
                        const newMessage = { id: generateId(), text, sender: 'me', timestamp: Date.now(), quote: currentQuoteInfo };
                        chatAppData.messages[contactId].push(newMessage);
                        const contactToUpdate = chatAppData.contacts.find(c => c.id === contactId);
                        contactToUpdate.lastMessage = text;
                        currentQuoteInfo = null;
                        document.getElementById('quote-preview-container').style.display = 'none';
                        saveChatData();
                        renderChatRoom(contactId);
                        const apiSettings = chatAppData.contactApiSettings[contactId] || JSON.parse(localStorage.getItem('apiSettings')) || {};
                        if(apiSettings.autoReply) {
                            triggerApiReply(contactId);
                        }
                    }
                };

                sendBtn.addEventListener('click', sendMessage);
                chatInput.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) { // Shift+Enter 换行
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                apiReplyBtn.addEventListener('click', () => {
                     triggerApiReply(contactId);
                });
                
                const quotePreviewContainer = document.getElementById('quote-preview-container');
                const quotePreviewCloseBtn = document.getElementById('quote-preview-close');
                quotePreviewCloseBtn.addEventListener('click', () => {
                    quotePreviewContainer.style.display = 'none';
                    currentQuoteInfo = null;
                });
            } else {
                 // 多选模式下的工具栏事件
                document.getElementById('multi-collect-btn').addEventListener('click', () => {
                    alert(`功能开发中：收藏 ${selectedMessageIds.size} 条消息`);
                });
                document.getElementById('multi-delete-btn').addEventListener('click', () => {
                    if (selectedMessageIds.size === 0) return;
                    if (confirm(`确定要删除所选的 ${selectedMessageIds.size} 条消息吗？`)) {
                        chatAppData.messages[contactId] = chatAppData.messages[contactId].filter(
                            msg => !selectedMessageIds.has(msg.id)
                        );
                        saveChatData();
                        // 退出多选并刷新
                        isInMultiSelectMode = false;
                        selectedMessageIds.clear();
                        renderChatRoom(contactId);
                    }
                });
                updateMultiSelectToolbar();
            }
        };


        // --- App 主流程控制 ---

        // 打开 Chat App
        const openChatApp = () => {
            chatContainer.classList.add('visible');
            chatappFab.classList.add('visible'); // 显示 Chat App FAB
            renderContactList(); // 默认显示联系人列表
        };


        // 关闭 Chat App
        const closeChatApp = () => {
            chatContainer.classList.remove('visible');
            chatContent.innerHTML = ''; // 清空内容
            chatappFab.classList.remove('visible'); // 隐藏 Chat App FAB
            closeAddContactModal(); // 确保关闭添加联系人模态窗
        };


  // --- 设置侧边栏控制 ---
        // [修改] 用于暂存正在编辑的联系人数据
        let tempChatContact = null; 
        
        const openChatSettings = (contactId) => {
            const contact = chatAppData.contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            // [核心修改] 创建一个深拷贝的临时对象进行编辑
            tempChatContact = JSON.parse(JSON.stringify(contact));

            // [新增] 从 archiveData 获取最新的、权威的角色信息
            const archiveProfile = archiveData.characters.find(c => c.id === contactId) || tempChatContact;

            // 如果在档案里找不到（比如是系统消息），则使用contact自身的信息作为后备
            const authoritativeName = archiveProfile.name;
            // 同步 chatAppData 中的名字，以备档案被删除等边缘情况
            if (contact.name !== authoritativeName) {
                contact.name = authoritativeName;
                saveChatData(); // 保存同步后的名字
            }
            // 确保每个角色都有完整的设置项
            contact.remark = contact.remark || '';
            contact.contextLength = contact.contextLength || 20;
            contact.chatBgDay = contact.chatBgDay || '';
            contact.chatBgNight = contact.chatBgNight || '';
            contact.bubbleCss = contact.bubbleCss || '';
            contact.offlineMode = contact.offlineMode === true;
            contact.memorySummary = contact.memorySummary === true;
            contact.realtimePerception = contact.realtimePerception === true;
            contact.boundWorldBookItems = contact.boundWorldBookItems || [];
            
            chatAppData.contactApiSettings[contactId] = chatAppData.contactApiSettings[contactId] || {};
            const contactApiSettings = chatAppData.contactApiSettings[contactId];
            const globalApiSettings = JSON.parse(localStorage.getItem('apiSettings')) || {};
            const effectiveApiSettings = { ...globalApiSettings, ...contactApiSettings };
            const userAvatarDataUrl = localStorage.getItem('userProfileAvatar') 
                || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>`;
            const settingsBody = document.getElementById('chat-settings-body');
            settingsBody.innerHTML = `
                <!-- 角色信息 -->
                <div class="settings-group-glass">
                    <!-- [修改] 将姓名的 input 改为不可编辑的 span，并从权威数据源获取名字 -->
                    <div class="chat-setting-item">
                        <label>姓名</label>
                        <span class="setting-input" style="background: transparent; border-color: transparent; padding-left: 0; user-select: text;">${authoritativeName}</span>
                    </div>
                    <div class="chat-setting-item">
                        <label for="char-remark-input">备注</label>
                        <input type="text" id="char-remark-input" class="setting-input" value="${contact.remark}" placeholder="不会被AI读取">
                    </div>
                    <div class="chat-setting-item vertical">
                        <label>头像</label>
                        <div class="avatar-selection-container">
                            <div class="avatar-picker" id="char-avatar-picker">
                                <div class="avatar-preview-circle" style="background-image: url('${contact.avatar}')"></div>
                                <span class="avatar-picker-label">对方头像</span>
                                <input type="file" id="char-avatar-upload" accept="image/*" hidden>
                            </div>
                            <div class="avatar-picker" id="user-avatar-picker">
                                <div class="avatar-preview-circle" id="user-avatar-preview-in-settings" style="background-image: url('${userAvatarDataUrl}')"></div>
                                <span class="avatar-picker-label">我的头像</span>
                                <input type="file" id="user-avatar-upload" accept="image/*" hidden>
                            </div>
                        </div>
                    </div>
                    <div class="chat-setting-item vertical">
                        <label>绑定世界书</label>
                        <div id="worldbook-binder-container" class="worldbook-binder-container">
                            <button id="worldbook-binder-toggle" class="setting-action-button">未绑定</button>
                            <div id="worldbook-binder-tree" class="worldbook-binder-tree" style="display: none;">
                                <!-- 世界书内容将由JS动态渲染 -->
                            </div>
                        </div>
                    </div>
                    <div class="chat-setting-item">
                        <label for="char-context-input">上下文条数</label>
                        <input type="number" id="char-context-input" class="setting-input" value="${contact.contextLength}" style="flex-grow: 0; width: 70px; text-align: right;">
                    </div>
                </div>
                <!-- 聊天美化 -->
                <div class="settings-group-glass">
                    <div class="chat-setting-item vertical">
                         <label>聊天背景</label>
                         <div class="wallpaper-mockup-container">
                            <div class="wallpaper-mockup">
                                <div class="phone-frame">
                                    <div id="day-wallpaper-preview" class="phone-screen" style="background-image: url('${contact.chatBgDay || ''}')"></div>
                                </div>
                                <span class="wallpaper-mockup-label">昼间</span>
                                <input type="file" id="day-wallpaper-upload" accept="image/*" hidden>
                            </div>
                            <div class="wallpaper-mockup dark">
                                <div class="phone-frame">
                                    <div id="night-wallpaper-preview" class="phone-screen" style="background-image: url('${contact.chatBgNight || ''}')"></div>
                                </div>
                                <span class="wallpaper-mockup-label">夜间</span>
                                <input type="file" id="night-wallpaper-upload" accept="image/*" hidden>
                            </div>
                        </div>
                    </div>
                    <div class="chat-setting-item vertical">
                        <label for="bubble-css-input">气泡CSS</label>
                        <div class="preset-section" style="padding: 10px; width:100%; margin-bottom: 10px; background: rgba(0,0,0,0.02);">
                            <div class="modal-form-group" style="gap: 10px;">
                                <label style="font-size: 13px; opacity: 0.6;">预设管理</label>
                                <div class="preset-controls" style="grid-template-columns: 1fr auto auto;">
                                    <select id="bubble-preset-select" class="modal-select" style="width: 100%;"></select>
                                    <button id="save-bubble-preset-btn" class="modal-button" title="保存为新预设">保存</button>
                                    <button id="delete-bubble-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;" title="删除当前预设">删除</button>
                                </div>
                            </div>
                        </div>
                        <textarea id="bubble-css-input" class="setting-textarea" placeholder=".sent { ... }&#10;.received { ... }">${contact.bubbleCss}</textarea>
                    </div>
                </div>
                <!-- 玩法设置 etc. -->
                <div class="settings-group-glass">
                    <div class="chat-setting-item">
                        <label>线下模式</label>
                        <label class="switch-container">
                            <input type="checkbox" id="offline-mode-toggle" ${tempChatContact.offlineMode ? 'checked' : ''}>
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    
                    <!-- 新增：线下预设功能区 -->
                    <div id="offline-preset-section" style="display: ${tempChatContact.offlineMode ? 'block' : 'none'}; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                         <div class="modal-form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 13px; opacity: 0.8;">线下预设</label>
                            <div class="preset-controls" style="grid-template-columns: 1fr auto auto;">
                                <select id="offline-preset-select" class="modal-select"></select>
                                <button id="save-offline-preset-btn" class="modal-button" title="保存为新预设">保存</button>
                                <button id="delete-offline-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;" title="删除当前预设">删除</button>
                            </div>
                        </div>
                        <div class="modal-form-group" style="margin-bottom: 10px;">
                            <label for="offline-prompt-input">线下提示词</label>
                            <textarea id="offline-prompt-input" class="setting-textarea" rows="8"></textarea>
                        </div>
                        <div class="modal-form-group">
                            <label for="offline-style-input">文风</label>
                            <textarea id="offline-style-input" class="setting-textarea" rows="3" placeholder="默认留白，可自定义"></textarea>
                        </div>
                    </div>
                    
                    <div class="chat-setting-item">
                        <label>实时时间感知</label>
                        <label class="switch-container">
                            <input type="checkbox" id="realtime-perception-toggle" ${contact.realtimePerception ? 'checked' : ''}>
                            <span class="switch-slider"></span>
                        </label>                    
                    </div>
                </div>
                
                <div class="settings-group-glass">
                    <div class="chat-setting-item" style="gap: 10px;">
                        <button class="setting-action-button" style="flex: 1;">导入聊天记录</button>
                        <button class="setting-action-button" style="flex: 1;">导出聊天记录</button>
                    </div>
                     <div class="chat-setting-item" style="gap: 10px;">
                        <button class="setting-action-button danger" style="flex: 1;">拉黑对方</button>
                        <button id="clear-chat-btn" class="setting-action-button danger" style="flex: 1;">清空聊天</button>
                    </div>
                </div>
            `;
            
            chatSettingsOverlay.classList.add('visible');
            chatSettingsModal.classList.add('visible');

            const createAvatarUploader = (pickerId, inputId, onUpload) => {
                const picker = document.getElementById(pickerId);
                const input = document.getElementById(inputId);
                picker.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => onUpload(event.target.result);
                        reader.readAsDataURL(file);
                    }
                });
            };

            createAvatarUploader('char-avatar-picker', 'char-avatar-upload', (dataUrl) => {
                tempChatContact.avatar = dataUrl;
                // 使用更精确的上下文查找来更新预览
                document.getElementById('char-avatar-picker').querySelector('.avatar-preview-circle').style.backgroundImage = `url(${dataUrl})`;
            });

            // [修改] 我的头像更换逻辑，增加保存步骤
            createAvatarUploader('user-avatar-picker', 'user-avatar-upload', (dataUrl) => {
                localStorage.setItem('userProfileAvatar', dataUrl); // 保存到localStorage
                document.getElementById('avatar-box').style.backgroundImage = `url(${dataUrl})`;
                document.getElementById('user-avatar-preview-in-settings').style.backgroundImage = `url(${dataUrl})`;
                renderChatRoom(contactId);
            });

             const setupWallpaperUploader = (previewId, inputId, storageKey) => {
                const preview = document.getElementById(previewId);
                const input = document.getElementById(inputId);
                preview.closest('.wallpaper-mockup').addEventListener('click', () => input.click());
                input.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = event => {
                            const dataUrl = event.target.result;
                            // 核心修改：只更新临时对象和UI预览
                            tempChatContact[storageKey] = dataUrl;
                            preview.style.backgroundImage = `url('${dataUrl}')`;
                            // 移除这里的 saveChatData() 和 renderChatRoom()
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            setupWallpaperUploader('day-wallpaper-preview', 'day-wallpaper-upload', 'chatBgDay');
            setupWallpaperUploader('night-wallpaper-preview', 'night-wallpaper-upload', 'chatBgNight');

            const setupInputSaver = (elementId, propertyName, isNumber = false) => {
                const input = document.getElementById(elementId);
                if (!input) return; // 安全检查
                const eventType = input.type === 'checkbox' ? 'change' : 'blur';
                const valueGetter = () => {
                    if (input.type === 'checkbox') return input.checked;
                    if (isNumber) return parseInt(input.value, 10) || 0;
                    return input.value;
                };
                
                input.addEventListener(eventType, () => {
                    // [核心修改] 所有输入都只修改 tempChatContact
                    tempChatContact[propertyName] = valueGetter();
                    // 移除 saveChatData()
                });
            };

            setupInputSaver('char-remark-input', 'remark');
            setupInputSaver('char-context-input', 'contextLength', true);
            
            const bubbleCssInput = document.getElementById('bubble-css-input');
            bubbleCssInput.addEventListener('blur', () => {
                tempChatContact.bubbleCss = bubbleCssInput.value;
                 // 移除 saveChatData()
            });

            // setupInputSaver('offline-mode-toggle', 'offlineMode'); // 这个开关有联动效果，需要单独处理
            setupInputSaver('realtime-perception-toggle', 'realtimePerception');

            
            const bubblePresetSelect = document.getElementById('bubble-preset-select');
            const saveBubblePresetBtn = document.getElementById('save-bubble-preset-btn');
            const deleteBubblePresetBtn = document.getElementById('delete-bubble-preset-btn');
            const PRESET_KEY = 'chatBubbleCssPresets';

            const loadBubblePresets = () => {
                const presets = JSON.parse(localStorage.getItem(PRESET_KEY)) || {};
                bubblePresetSelect.innerHTML = '<option value="">选择预设...</option>';
                for (const name in presets) {
                    bubblePresetSelect.innerHTML += `<option value="${name}">${name}</option>`;
                }
            };
            
            bubblePresetSelect.addEventListener('change', () => {
                const presets = JSON.parse(localStorage.getItem(PRESET_KEY)) || {};
                const selectedName = bubblePresetSelect.value;
                if (selectedName && presets[selectedName]) {
                    bubbleCssInput.value = presets[selectedName];
                    bubbleCssInput.dispatchEvent(new Event('blur'));
                }
            });

            saveBubblePresetBtn.addEventListener('click', () => {
                const name = prompt("请输入预设名称：");
                if (name && name.trim()) {
                    const presets = JSON.parse(localStorage.getItem(PRESET_KEY)) || {};
                    presets[name.trim()] = bubbleCssInput.value;
                    localStorage.setItem(PRESET_KEY, JSON.stringify(presets));
                    loadBubblePresets();
                    bubblePresetSelect.value = name.trim();
                }
            });

            deleteBubblePresetBtn.addEventListener('click', () => {
                const selectedName = bubblePresetSelect.value;
                if (selectedName && confirm(`确定要删除预设 "${selectedName}" 吗？`)) {
                    const presets = JSON.parse(localStorage.getItem(PRESET_KEY)) || {};
                    delete presets[selectedName];
                    localStorage.setItem(PRESET_KEY, JSON.stringify(presets));
                    loadBubblePresets();
                } else if (!selectedName) {
                    alert("请先选择一个要删除的预设。");
                }
            });
                        // [新增] 聊天记录清空功能
            document.getElementById('clear-chat-btn').addEventListener('click', () => {
                // 使用备注或姓名进行确认提示
                const confirmName = contact.remark || contact.name;
                if (confirm(`确定要清空与 ${confirmName} 的所有聊天记录吗？此操作不可恢复。`)) {
                    // 清空对应联系人的消息数组
                    chatAppData.messages[contactId] = [];
                    // 更新联系人列表中的最后一条消息预览
                    contact.lastMessage = "聊天记录已清空";
                    // 保存数据
                    saveChatData();
                    // 关闭设置侧边栏并重新渲染聊天室以显示空状态
                    closeChatSettings();
                    renderChatRoom(contactId);
                }
            });

            loadBubblePresets();

            // [核心修复] 世界书绑定逻辑被移动到这里

            loadBubblePresets();

            // [核心修复] 世界书绑定逻辑被移动到这里
            const binderToggleBtn = document.getElementById('worldbook-binder-toggle');
            const binderTree = document.getElementById('worldbook-binder-tree');

            const updateBinderButtonText = () => {
                const count = tempChatContact.boundWorldBookItems.length;
                binderToggleBtn.textContent = count > 0 ? `已绑定 ${count} 个条目` : '点击以绑定条目';
            };
            
            // [修复] 初始加载时调用一次，以正确显示当前绑定数量
            updateBinderButtonText();

            const renderWorldBookBinder = () => {

                const worldBookData = JSON.parse(localStorage.getItem('worldBookData')) || [];
                if (worldBookData.length === 0) {
                    binderTree.innerHTML = `<div style="padding: 15px; text-align: center; opacity: 0.6; font-size: 14px;">世界书为空</div>`;
                    return;
                }

                binderTree.innerHTML = worldBookData.map(category => `
                    <details>
                        <summary>
                            <input type="checkbox" class="binder-checkbox group-checkbox" data-category-id="${category.id}">
                            <span>${category.name}</span>
                        </summary>
                        <div class="worldbook-binder-items">
                            ${category.items.map(item => `
                                <label class="worldbook-binder-item">
                                    <input type="checkbox" class="binder-checkbox item-checkbox" value="${item.id}" data-category-id="${category.id}" ${contact.boundWorldBookItems.includes(item.id) ? 'checked' : ''}>
                                    <span>${item.title}</span>
                                </label>
                            `).join('') || '<div style="font-size: 13px; opacity: 0.5; padding-left: 10px;">此分类下无条目</div>'}
                        </div>
                    </details>
                `).join('');

                binderTree.querySelectorAll('.group-checkbox').forEach(groupCheckbox => {
                    const categoryId = groupCheckbox.dataset.categoryId;
                    const itemCheckboxes = binderTree.querySelectorAll(`.item-checkbox[data-category-id="${categoryId}"]`);
                    if (itemCheckboxes.length > 0) {
                        groupCheckbox.checked = Array.from(itemCheckboxes).every(item => item.checked);
                    } else {
                        groupCheckbox.disabled = true;
                    }
                });
            };
            
            binderToggleBtn.addEventListener('click', () => {
                const isVisible = binderTree.style.display !== 'none';
                if (!isVisible) {
                    renderWorldBookBinder();
                }
                binderTree.style.display = isVisible ? 'none' : 'block';
            });

            binderTree.addEventListener('change', (e) => {
                const target = e.target;
                if (target.classList.contains('binder-checkbox')) {
                    const categoryId = target.dataset.categoryId;
                    if (target.classList.contains('group-checkbox')) {
                        binderTree.querySelectorAll(`.item-checkbox[data-category-id="${categoryId}"]`).forEach(item => {
                            item.checked = target.checked;
                        });
                    } else {
                        const groupCheckbox = binderTree.querySelector(`.group-checkbox[data-category-id="${categoryId}"]`);
                        const allItems = binderTree.querySelectorAll(`.item-checkbox[data-category-id="${categoryId}"]`);
                        groupCheckbox.checked = Array.from(allItems).every(item => item.checked);
                    }
                    
                    const allCheckedItems = Array.from(binderTree.querySelectorAll('.item-checkbox:checked'));
                    // [核心修改] 修改临时对象
                    tempChatContact.boundWorldBookItems = allCheckedItems.map(cb => cb.value);
                    // 移除 saveChatData()
                    updateBinderButtonText(); // updateBinderButtonText 内部逻辑也需要调整
                }
            });

            // [新增] 线下模式开关逻辑
            const offlineToggle = document.getElementById('offline-mode-toggle');
            const offlineSection = document.getElementById('offline-preset-section');
            offlineToggle.addEventListener('change', () => {
                tempChatContact.offlineMode = offlineToggle.checked;
                offlineSection.style.display = offlineToggle.checked ? 'block' : 'none';
            });
            
            // [新增] 线下预设管理逻辑
            const OFFLINE_PRESET_KEY = 'offlineModePresets';
            const offlinePresetSelect = document.getElementById('offline-preset-select');
            const offlinePromptInput = document.getElementById('offline-prompt-input');
            const offlineStyleInput = document.getElementById('offline-style-input');
            const defaultOfflinePrompt = `你现在正在扮演名为 {{char}} 的角色，与用户进行线下面对面聊天。严格遵循以下规则：
1.  **人称定义**：你（AI）是第三人称的 {{char}}，与你对话的用户是第二人称的“你”。
2.  **内容结构**：你的回复必须包含两部分——位于「」符号内的对话内容，和位于「」符号外的动作/表情/心理活动描写。
3.  **描写强制**：「」符号外的内容是**必须**的，不允许省略。这部分内容用于直接描写 {{char}} 的动作、表情、身体反应和内心想法，以增强场景感。
4.  **对话符号**：{{char}} 所说的每一句话都**必须**用「」括起来。
5.  **字数要求**：你的总回复（包括描写和对话）字数必须**大于300字**，以提供丰富、沉浸的场景体验。
6.  **禁止行为**：
    *   禁止代替用户（第二人称“你”）进行任何形式的回答或行为描写。
    *   禁止重复或引用用户的话。
    *   禁止使用比喻或隐喻，只进行直接描写。
7.  **人设核心**：严格遵循并深度扮演 {{char}} 的人设，确保所有生成内容（包括动作和对话）不脱离其性格设定。
8.  **场景感知**：牢记这是线下面对面场景，适当描写 {{char}} 在物理空间中的身体反应和与环境的互动。`;

            
            // [UI优化] 默认提示词作为placeholder
            offlinePromptInput.placeholder = "留空则使用默认线下提示词（包含人称、字数、描写风格等规则）";


            const applyOfflinePresetUI = (preset) => {
                if (preset && preset.prompt.trim()) {
                    offlinePromptInput.value = preset.prompt;
                } else {
                    offlinePromptInput.value = ''; // 如果是默认或空，则清空输入框，显示placeholder
                }
                offlineStyleInput.value = (preset && preset.style) ? preset.style : '';
            };

            const loadOfflinePresets = () => {
                const presets = JSON.parse(localStorage.getItem(OFFLINE_PRESET_KEY)) || {};
                offlinePresetSelect.innerHTML = '<option value="">选择或新建预设...</option>';
                for (const name in presets) {
                    offlinePresetSelect.innerHTML += `<option value="${name}">${name}</option>`;
                }
                
                // 应用当前角色已选择的预设
                const selectedPresetName = tempChatContact.selectedOfflinePreset;
                if (selectedPresetName && presets[selectedPresetName]) {
                    offlinePresetSelect.value = selectedPresetName;
                    applyOfflinePresetUI(presets[selectedPresetName]);
                } else {
                    applyOfflinePresetUI(null); // 没有选择预设，使用默认
                }
            };

            offlinePresetSelect.addEventListener('change', () => {
                const selectedName = offlinePresetSelect.value;
                const presets = JSON.parse(localStorage.getItem(OFFLINE_PRESET_KEY)) || {};
                applyOfflinePresetUI(presets[selectedName] || null);
                tempChatContact.selectedOfflinePreset = selectedName;
            });
            
            document.getElementById('save-offline-preset-btn').addEventListener('click', () => {
                const name = prompt("请输入新预设的名称：");
                if (name && name.trim()) {
                    const presets = JSON.parse(localStorage.getItem(OFFLINE_PRESET_KEY)) || {};
                    presets[name.trim()] = {
                        // [UI优化] 如果输入框为空，则保存一个空字符串，让后台逻辑使用默认值
                        prompt: offlinePromptInput.value.trim(),
                        style: offlineStyleInput.value
                    };
                    localStorage.setItem(OFFLINE_PRESET_KEY, JSON.stringify(presets));
                    tempChatContact.selectedOfflinePreset = name.trim();
                    loadOfflinePresets();
                    alert(`预设 "${name.trim()}" 已保存！`);
                }
            });

            document.getElementById('delete-offline-preset-btn').addEventListener('click', () => {
                const selectedName = offlinePresetSelect.value;
                if (selectedName && confirm(`确定要删除预设 "${selectedName}" 吗？`)) {
                    const presets = JSON.parse(localStorage.getItem(OFFLINE_PRESET_KEY)) || {};
                    delete presets[selectedName];
                    localStorage.setItem(OFFLINE_PRESET_KEY, JSON.stringify(presets));
                    if (tempChatContact.selectedOfflinePreset === selectedName) {
                        tempChatContact.selectedOfflinePreset = '';
                    }
                    loadOfflinePresets();
                } else if (!selectedName) {
                    alert("请先选择一个要删除的预设。");
                }
            });

            loadOfflinePresets();

            // [新增] 为总的保存按钮绑定事件
            const saveBtn = document.getElementById('chat-settings-save-btn');
            // 克隆并替换按钮，以移除之前可能存在的事件监听器
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.addEventListener('click', () => {
                const contactIndex = chatAppData.contacts.findIndex(c => c.id === contactId);
                if (contactIndex !== -1) {
                    chatAppData.contacts[contactIndex] = tempChatContact;
                    saveChatData();
                    closeChatSettings();
                    renderChatRoom(contactId); // 刷新聊天室以应用更改
                    // alert('设置已保存！'); // 可以选择性地移除这个打扰性的提示
                }
            });
        };


        const closeChatSettings = () => {
            chatSettingsOverlay.classList.remove('visible');
            chatSettingsModal.classList.remove('visible');
        };

        // --- 事件绑定 ---
        appChat.addEventListener('click', openChatApp);
        chatSettingsOverlay.addEventListener('click', closeChatSettings);
        
        // 重写主模态框的返回按钮逻辑，使其也能关闭Chat App
        // 这是为了确保在任何界面点击主返回按钮都能有正确的行为
        const originalModalCloseHandler = modalCloseBtn.onclick; // 保存可能存在的旧事件
        modalCloseBtn.addEventListener('click', () => {
            if (chatContainer.classList.contains('visible')) {
                closeChatApp();
            } else if(originalModalCloseHandler) {
                 // 如果聊天App未打开，执行原来的关闭逻辑（例如关闭世界书）
                 // 注意：这部分取决于你的代码如何绑定事件，如果之前没有用.onclick, 这可能需要调整
                 // 之前是通过addEventListener绑定的，所以之前的逻辑依然会执行，这里我们只需处理ChatApp的情况
            }
        });
 
        // ===================================
        // === 10. Chat App 完整逻辑 结束 ===
        // ===================================

        // 新增：Chat App FAB 和添加联系人模态窗元素
        const chatappFab = document.getElementById('chatapp-fab');
        const addContactModal = document.getElementById('add-contact-modal');
        const closeAddContactModalBtn = document.getElementById('close-add-contact-modal-btn');
        const addContactListContainer = document.getElementById('add-contact-list-container');

        // 打开添加联系人模态窗
        const openAddContactModal = () => {
            addContactModal.classList.add('visible');
            renderAvailableCharacters();
        };

        // 关闭添加联系人模态窗
        const closeAddContactModal = () => {
            addContactModal.classList.remove('visible');
        };

        // 渲染档案中可添加为联系人的 char 角色
        const renderAvailableCharacters = () => {
            const currentContactIds = chatAppData.contacts.map(c => c.id);
            const availableChars = archiveData.characters.filter(char => !currentContactIds.includes(char.id));

            if (availableChars.length === 0) {
                addContactListContainer.innerHTML = `<span class="empty-text" style="text-align:center; display:block; padding: 40px 0; font-size:14px;">暂无可用角色</span>`;
                return;
            }

            addContactListContainer.innerHTML = availableChars.map(char => `
                <div class="add-contact-item" data-char-id="${char.id}">
                    <div class="add-contact-avatar" style="background-image: url('${char.avatar}')"></div>
                    <div class="add-contact-name">${char.name}</div>
                </div>
            `).join('');

            // 绑定添加联系人事件
            addContactListContainer.querySelectorAll('.add-contact-item').forEach(item => {
                item.addEventListener('click', () => {
                    const charId = item.dataset.charId;
                    addCharacterToContacts(charId);
                });
            });
        };

        // 将角色添加到联系人列表
        const addCharacterToContacts = (charId) => {
            const charToAdd = archiveData.characters.find(char => char.id === charId);
            if (charToAdd) {
            // 将档案中的角色信息复制到联系人
            const newContact = {
                id: charToAdd.id,
                name: charToAdd.name,
                avatar: charToAdd.avatar,
                lastMessage: '嗨，很高兴认识你！',
                remark: '', // 默认空备注
                contextLength: 20, // 默认上下文长度
                chatBgDay: '', // 默认背景
                chatBgNight: '',
                bubbleCss: '',
                offlineMode: false,
                realtimePerception: true,
                boundWorldBookItems: [],
                persona: charToAdd.persona // 新增：将档案人设带入联系人
            };

                chatAppData.contacts.push(newContact);
                chatAppData.messages[newContact.id] = []; // 初始化空消息列表
                saveChatData();
                closeAddContactModal();
                renderContactList(); // 重新渲染联系人列表

                // 可以选择自动打开新联系人的聊天室
                // renderChatRoom(newContact.id);
                alert(`已添加 ${charToAdd.name} 到联系人！`);
            }
        };

        // 绑定 Chat App FAB 事件
        chatappFab.addEventListener('click', openAddContactModal);
        closeAddContactModalBtn.addEventListener('click', closeAddContactModal);


        // ===================================
        // === 大模型 API 接入逻辑 开始 ===
        // ===================================

        // [修改] AI回复状态、中断控制器，并新增replyingContactId
        let isApiReplying = false;
        let abortController = null;
        let replyingContactId = null; // 新增：记录正在回复的联系人ID

        // 辅助函数：将聊天记录转换为API所需的格式
        const formatChatMessagesForAPI = (contactId, messages, charPersona) => {
            const formattedMessages = [];
            const contact = chatAppData.contacts.find(c => c.id === contactId);
            let systemPrompt = '';
            const personaBase = `这是你的核心人设，你必须严格遵守：\n${charPersona.persona}`;

            if (contact.offlineMode) {
                 // --- 线下模式 ---
                const offlinePresets = JSON.parse(localStorage.getItem('offlineModePresets')) || {};
                const selectedPresetName = contact.selectedOfflinePreset;
                const selectedPreset = selectedPresetName ? offlinePresets[selectedPresetName] : null;
                let offlineRules;
                if (selectedPreset && selectedPreset.prompt.trim()) {
                    offlineRules = selectedPreset.prompt;
                } else {
                    offlineRules = `你现在正在扮演名为 ${charPersona.name} 的角色，与用户进行线下面对面聊天。严格遵循以下规则：1.  **人称定义**：在「」符号外的描写部分，必须使用第三人称来指代你自己（例如“他”，或者直接用角色名“${charPersona.name}”），并使用第二人称“你”来指代用户。2.  **内容结构**：你的回复必须包含两部分——位于「」符号内的对话内容，和位于「」符号外的动作/表情/心理活动描写。3.  **描写强制与风格**：「」符号外的内容是**必须**的，不允许省略。描写时禁止使用任何比喻，语言必须精准、直接、简练，避免繁复的修辞。4.  **对话符号**：{{char}} 所说的每一句话都**必须**用「」括起来。5.  **字数要求**：你的总回复（包括描写和对话）字数必须**大于300字**，以提供丰富、沉浸的场景体验。6.  **禁止行为**：禁止代替用户（第二人称“你”）进行任何形式的回答或行为描写。禁止重复或引用用户的话。7.  **场景感知**：牢记这是线下面对面场景，适当描写你在物理空间中的身体反应和与环境的互动。`;
                }
                systemPrompt = `${personaBase}\n\n${offlineRules}`;
                if (selectedPreset && selectedPreset.style) {
                    systemPrompt += `\n\n你的写作风格需要遵循以下要求：\n${selectedPreset.style}`;
                }
            } else {
                // --- 线上模式 (修复了模板字符串语法错误) ---
                let onlineRules = '你现在正扮演一个名为 ' + charPersona.name + ' 的角色，与用户进行手机聊天。\n\n' +
                '**【聊天风格规则】**\n' +
                '1.  **消息分段**: 你的回复必须拆分成多条简短、独立的聊天消息，每条消息之间用一个换行符(\\n)分隔。\n' +
                '2.  **人称与性格**: 严格保持 ' + charPersona.name + ' 的人称和性格，不允许OOC。\n' +
                '3.  **消息长度**: 单条消息通常不超过20字。\n' +
                '4.  **标点与表情**: 句末可不用句号，多使用表情符号(Emoji,颜文字)来表达情绪。\n' +
                '5.  **禁止**: 不得复述用户的话。\n\n' +
                '**【特殊功能指令】**\n' +
                '你可以根据情境，在回复的中**严格遵守格式**使用以下指令来触发特殊功能：\n' +
                '*   `[RETRACT: <想说但后悔的话> | <撤回时的心声>]`：先发送`<想说但后悔的话>`然后立刻撤回，并附带`<撤回时的心声>`。例如：`[RETRACT: 我喜欢你... | (糟糕，太冲动了！)]`\n' +
                '*   `[QUOTE: <要引用的消息ID> | <你的回复>]`：引用某条消息并回复。在历史消息中，每条消息前都有 (ID: xxx)，请将你想引用的ID填入指令中。\n' +
                '*   **默认行为**: 如果不使用任何指令，则视为常规回复。';
                
                systemPrompt = `${personaBase}\n\n${onlineRules}`;
            }
            
            // 添加世界书内容
            if (contact && contact.boundWorldBookItems && contact.boundWorldBookItems.length > 0) {
                const worldBookData = (JSON.parse(localStorage.getItem('worldBookData')) || []);
                const worldBookItems = worldBookData
                    .flatMap(cat => cat.items)
                    .filter(item => contact.boundWorldBookItems.includes(item.id));
                if (worldBookItems.length > 0) {
                    systemPrompt += `\n\n以下是与当前对话相关的背景信息，请在回复中自然地运用：\n`;
                    worldBookItems.forEach(item => {
                        systemPrompt += `  - ${item.title}: ${item.content}\n`;
                    });
                }
            }
            
            formattedMessages.push({ role: 'system', content: systemPrompt.trim() });

            // 将最近的消息附加到上下文中
            messages.forEach(msg => {
                if (msg.type !== 'retracted') { // 不将撤回提示计入上下文
                    formattedMessages.push({
                        role: msg.sender === 'me' ? 'user' : 'assistant',
                        // 将ID附加到消息内容中，供AI引用
                        content: `(ID: ${msg.id}) ${msg.text}`
                    });
                }
            });

            return formattedMessages;
        };

        // 模拟打字效果
        const simulateTyping = (messageText, contactId, charAvatar, messagesContainer) => {
            return new Promise(resolve => {
                if (messageText.length === 0) {
                    resolve();
                    return;
                }
                const typingDelay = 50;
                const messageLine = document.createElement('div');
                messageLine.className = 'message-line received';
                messageLine.innerHTML = `
                    <div class="chat-avatar" style="background-image: url('${charAvatar}')"></div>
                    <div class="chat-bubble received"></div>
                `;
                messagesContainer.appendChild(messageLine);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                const bubble = messageLine.querySelector('.chat-bubble');
                // [核心修改] 使用 innerHTML 而不是 textContent
                bubble.innerHTML = messageText;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                resolve();

                // 注意：由于一次性渲染长文本，逐字打字效果被暂时禁用，以保证<br>换行能正确显示。
                // 如果需要恢复逐字效果并支持HTML，需要更复杂的解析逻辑，目前优先保证功能正确性。
            });
        };

        // 大模型 API 调用函数
        const triggerApiReply = async (contactId, reAnswerInfo = null) => {
            if (isApiReplying) {
                if (reAnswerInfo) return;
                if (abortController) abortController.abort();
                return;
            }

            isApiReplying = true;
            replyingContactId = contactId;
            abortController = new AbortController();
            const signal = abortController.signal;

            const messages = chatAppData.messages[contactId] || [];
            let apiMessagesPayload;

            if (reAnswerInfo) {
                messages.splice(reAnswerInfo.startIndex, reAnswerInfo.roundMessages.length);
                apiMessagesPayload = messages.slice(0, reAnswerInfo.startIndex);
                renderChatRoom(contactId); 
            } else {
                apiMessagesPayload = messages;
                renderChatRoom(contactId);
            }

            const messagesContainer = document.getElementById('chat-messages-container');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            const contact = chatAppData.contacts.find(c => c.id === contactId);
            const globalApiSettings = JSON.parse(localStorage.getItem('apiSettings')) || {};
            const effectiveApiSettings = { ...globalApiSettings, ...chatAppData.contactApiSettings[contactId] };

            if (!effectiveApiSettings.url || !effectiveApiSettings.key || !effectiveApiSettings.model) {
                alert('请先在API设置中配置有效的 API URL, Key 和 Model！');
                isApiReplying = false;
                replyingContactId = null;
                renderChatRoom(contactId);
                return;
            }
            
            const charPersona = archiveData.characters.find(c => c.id === contactId) || { name: contact.name, persona: "一个普通的AI" };
            const apiMessages = formatChatMessagesForAPI(contactId, apiMessagesPayload.slice(-(contact.contextLength || 20)), charPersona);
            
            try {
                const response = await fetch(new URL('/v1/chat/completions', effectiveApiSettings.url).href, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${effectiveApiSettings.key}` },
                    body: JSON.stringify({ model: effectiveApiSettings.model, messages: apiMessages, temperature: parseFloat(effectiveApiSettings.temp || 0.7), stream: effectiveApiSettings.stream !== false }),
                    signal: signal
                });

                if (!response.ok) throw new Error(`API 请求失败! 状态: ${response.status}.`);
                
                let fullReplyContent = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done || signal.aborted) break;
                    const chunk = decoder.decode(value);
                    chunk.split('\n\n').forEach(line => {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') return;
                            try {
                                const json = JSON.parse(data);
                                fullReplyContent += json.choices[0].delta.content || '';
                            } catch (e) { /* 忽略解析错误 */ }
                        }
                    });
                }
                
                if (!signal.aborted && fullReplyContent.trim()) {
                    const retractMatch = fullReplyContent.match(/^\[RETRACT:\s*(.*?)\s*\|\s*(.*?)\]/s);
                    const quoteMatch = fullReplyContent.match(/^\[QUOTE:\s*(.*?)\s*\|\s*(.*?)\]/s);

                    if (retractMatch) {
                        const originalContent = retractMatch[1].trim();
                        const innerThought = retractMatch[2].trim();
                        
                        const retractedMessage = {
                            id: generateId(),
                            type: 'retracted',
                            senderType: 'char',
                            originalContent: originalContent,
                            innerThought: innerThought,
                            timestamp: Date.now()
                        };
                        messages.push(retractedMessage);
                        contact.lastMessage = `${contact.name} 撤回了一条消息`;

                    } else if (quoteMatch) { // <<<--- 新增的引用处理逻辑
                        const quotedMessageId = quoteMatch[1].trim();
                        const replyText = quoteMatch[2].trim();

                        const originalMessage = messages.find(m => m.id === quotedMessageId);

                        const replySegments = replyText.split('\n').filter(seg => seg.trim() !== '');
                        const newRoundMessages = replySegments.map((seg, i) => ({
                            id: generateId(),
                            text: seg.trim().replace(/\n/g, '<br>'),
                            sender: 'them',
                            timestamp: Date.now() + i
                        }));

                        if (newRoundMessages.length > 0 && originalMessage) {
                            // 将引用信息附加到新一轮回复的第一条消息上
                            newRoundMessages[0].quote = {
                                id: originalMessage.id,
                                text: originalMessage.text,
                                sender: originalMessage.sender
                            };
                        }
                        
                        if (newRoundMessages.length > 0) {
                            messages.push(...newRoundMessages);
                            contact.lastMessage = newRoundMessages[newRoundMessages.length - 1].text.substring(0, 50);
                        }

                    } else { // 默认常规回复
                        let textContent = fullReplyContent.trim().replace(/\(ID:.*?\)\s*/g, '');

                        const replySegments = textContent.split('\n').filter(seg => seg.trim() !== '');
                        const newRoundMessages = replySegments.map((seg, i) => ({
                            id: generateId(),
                            text: seg.trim().replace(/\n/g, '<br>'),
                            sender: 'them',
                            timestamp: Date.now() + i
                        }));

                        if (newRoundMessages.length > 0) {
                            if (reAnswerInfo) {
                                const oldRound = reAnswerInfo.roundMessages;
                                const firstMessageOfOldRound = oldRound[0];
                                const existingAlternatives = firstMessageOfOldRound.alternatives || [];
                                if (firstMessageOfOldRound.alternatives) delete firstMessageOfOldRound.alternatives;
                                existingAlternatives.unshift(oldRound);
                                newRoundMessages[0].alternatives = existingAlternatives;
                                messages.splice(reAnswerInfo.startIndex, oldRound.length, ...newRoundMessages);
                            } else {
                                messages.push(...newRoundMessages);
                            }
                            contact.lastMessage = newRoundMessages[newRoundMessages.length - 1].text.substring(0, 50);
                        }
                    }
                    saveChatData();
                }

            } catch (error) {
                if (error.name !== 'AbortError') console.error('API 回复失败:', error);
            } finally {
                isApiReplying = false;
                replyingContactId = null;
                abortController = null;
                if (document.querySelector('.chat-room-view')) {
                    renderChatRoom(contactId);
                } else if (document.querySelector('.chat-contact-list-view')) {
                    renderContactList();
                }
            }
        };

        // ===================================
        // === 大模型 API 接入逻辑 结束 ===
        // ===================================


        // ===================================
        // === 11. 档案 App 完整逻辑 开始 ===
        // ===================================


        // 默认头像 SVG (9:16比例占位) - [已修复] 彻底URL编码并使用单引号
        const DEFAULT_USER_AVATAR_SVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 9 16' fill='%2364748b'%3E%3Crect width='9' height='16' fill='%23f1f5f9'/%3E%3Ccircle cx='4.5' cy='6' r='3' fill='%2394a3b8'/%3E%3Cpath d='M0.5 12c0 2 8 2 8 0s-4-1-4-1-4 1-4 1z' fill='%2394a3b8'/%3E%3C/svg%3E`;
        const DEFAULT_CHAR_AVATAR_SVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 9 16' fill='%23a1a1aa'%3E%3Crect width='9' height='16' fill='%23fafafa'/%3E%3Ccircle cx='4.5' cy='6' r='3' fill='%23cbd5e1'/%3E%3Cpath d='M0.5 12c0 2 8 2 8 0s-4-1-4-1-4 1-4 1z' fill='%23cbd5e1'/%3E%3C/svg%3E`;


        // 从 localStorage 加载或初始化档案数据
        let archiveData = JSON.parse(localStorage.getItem('archiveData')) || {
            user: {
                id: 'user',
                avatar: DEFAULT_USER_AVATAR_SVG,
                name: '默认用户',
                codename: 'Player',
                age: '未知',
                ability: '尚未觉醒',
                survivalDays: 0,
                persona: '一个挣扎在无限世界中的普通人。'
            },
            characters: [
                {
                    id: 'char_1',
                    avatar: DEFAULT_CHAR_AVATAR_SVG,
                    name: '引导者',
                    codename: 'Guide',
                    age: '？？',
                    ability: '信息探知',
                    survivalDays: '∞',
                    persona: '提供基础引导的角色，身份成谜。'
                },
                {
                    id: 'char_2',
                    avatar: DEFAULT_CHAR_AVATAR_SVG,
                    name: '观测者',
                    codename: 'Observer',
                    age: '？？',
                    ability: '全知视角（受限）',
                    survivalDays: '∞',
                    persona: '记录着一切，但从不干涉。'
                }
            ]
        };

        const saveArchiveData = () => {
            localStorage.setItem('archiveData', JSON.stringify(archiveData));
        };
        
        // 获取档案详情模态框的元素
        const archiveModalOverlay = document.getElementById('archive-modal-overlay');
        const archiveDetailModal = document.getElementById('archive-detail-modal');
        const archiveDetailContent = document.getElementById('archive-detail-content');
        const archiveDetailCloseBtn = document.getElementById('archive-detail-close-btn');

        // 关闭档案详情模态框 (无论是详情模式还是编辑模式)
        const closeArchiveDetailModal = () => {
            archiveModalOverlay.classList.remove('visible');
            archiveDetailContent.innerHTML = '';
            // 关闭详情或编辑模式后，重新显示档案App的悬浮添加按钮
            archiveFab.classList.add('visible');
            // 【新增】返回档案App主页面
            modalTitle.textContent = '档案'; // 将通用模态框标题设回档案
            renderArchivePage(); // 重新渲染档案App的主页面
        };

        // 绑定档案详情模态框的关闭按钮
        archiveDetailCloseBtn.addEventListener('click', closeArchiveDetailModal);


        // 打开档案详情模态框 (显示模式)
        const openArchiveDetailModal = (profile) => {
            // 在详情模式下，隐藏档案App的悬浮添加按钮
            archiveFab.classList.remove('visible'); 
            
            // 将编辑图标的SVG定义移到这里，方便使用
            // (这里的 fill="#cdcdcd" 是淡灰色，为了和文本颜色搭配)
            const editIconSVG = `<svg t="1767094460951" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4994" width="16" height="16"><path d="M469.333333 128a42.666667 42.666667 0 0 1 0 85.333333H213.333333v597.333334h597.333334v-256l0.298666-4.992A42.666667 42.666667 0 0 1 896 554.666667v256a85.333333 85.333333 0 0 1-85.333333 85.333333H213.333333a85.333333 85.333333 0 0 1-85.333333-85.333333V213.333333a85.333333 85.333333 0 0 1 85.333333-85.333333z m414.72 12.501333a42.666667 42.666667 0 0 1 0 60.330667L491.861333 593.066667a42.666667 42.666667 0 0 1-60.330666-60.330667l392.192-392.192a42.666667 42.666667 0 0 1 60.330666 0z" fill="#cdcdcd" p-id="4995"></path></svg>`;

            // [修改] 移除条件判断，所有档案（包括 user）都显示编辑按钮
            const editButtonHTML = `<button class="edit-char-btn" data-action="edit" data-id="${profile.id}">${editIconSVG}</button>`;

            const contentHTML = `
                <div class="profile-detail-content">
                    <div class="profile-detail-header-section">
                        <div class="profile-detail-avatar-large" style="background-image: url('${profile.avatar}');"></div>
                        <div class="profile-detail-basic-info-display">
                            <span class="name">${profile.name} ${editButtonHTML}</span>
                            <span class="meta-info">代号: ${profile.codename}</span>
                            <span class="meta-info">年龄: ${profile.age}</span>
                        </div>
                    </div>
                    <div class="profile-detail-extended-info-display">
                        <div class="field-group">
                            <label>异能:</label>
                            <span>${profile.ability}</span>
                        </div>
                        <div class="field-group">
                            <label>存活天数:</label>
                            <span>${profile.survivalDays}</span>
                        </div>
                        <div class="field-group">
                            <label>人设:</label>
                            <span>${profile.persona}</span>
                        </div>
                    </div>
                </div>
            `;
            archiveDetailContent.innerHTML = contentHTML;
            archiveModalOverlay.classList.add('visible');

            // 为详情页中的编辑按钮添加事件监听
            const editBtn = archiveDetailContent.querySelector('.edit-char-btn[data-action="edit"]');
            if (editBtn) {
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const profileId = e.currentTarget.dataset.id;
                    // [修改] 对于用户档案，也调用 openCharEditModal，但需要 openCharEditModal 能够处理 "user" ID
                    // 目前 openCharEditModal 内部对 "user" 的处理是 alert 提示，这个逻辑不变。
                    openCharEditModal(profileId); 
                });
            }
        };


        // 渲染档案App主页
        const renderArchivePage = () => {
            modalBody.innerHTML = ''; // 清空内容
            const container = document.createElement('div');
            container.className = 'archive-page-container';

            // 1. 渲染用户卡片
            const user = archiveData.user;
            // 编辑图标 SVG (移动到详情页)
            const editIconSVG = `<svg t="1767094460951" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4994" width="16" height="16"><path d="M469.333333 128a42.666667 42.666667 0 0 1 0 85.333333H213.333333v597.333334h597.333334v-256l0.298666-4.992A42.666667 42.666667 0 0 1 896 554.666667v256a85.333333 85.333333 0 0 1-85.333333 85.333333H213.333333a85.333333 85.333333 0 0 1-85.333333-85.333333V213.333333a85.333333 85.333333 0 0 1 85.333333-85.333333z m414.72 12.501333a42.666667 42.666667 0 0 1 0 60.330667L491.861333 593.066667a42.666667 42.666667 0 0 1-60.330666-60.330667l392.192-392.192a42.666667 42.666667 0 0 1 60.330666 0z" fill="#cdcdcd" p-id="4995"></path></svg>`;

            const userCardHTML = `
                <div class="user-profile-card" data-id="user">
                    <div class="card-avatar" style="background-image: url('${user.avatar}');"></div>
                    <div class="card-info">
                        <div class="name">${user.name} <span style="font-size:12px; opacity:0.6; font-weight:500;">(User)</span>
                        </div>
                        <div class="bio">${user.persona}</div>
                    </div>
                </div>
            `;
            container.innerHTML += userCardHTML;

            // 2. 渲染角色卡片列表
            let charListHTML = '<div class="char-grid-container">';
            archiveData.characters.forEach(char => {
                charListHTML += `
                    <div class="char-card" data-id="${char.id}">
                        <div class="card-avatar" style="background-image: url("${char.avatar}");"></div>
                        <div class="card-info">
                            <div class="name">${char.name}
                            </div>
                            <div class="bio">${char.persona}</div>
                        </div>
                    </div>
                `;
            });
            charListHTML += '</div>';
            container.innerHTML += charListHTML;

            modalBody.appendChild(container);

            // 3. 绑定点击事件 (事件委托处理点击)
            modalBody.addEventListener('click', (e) => {
                // 如果点击的是卡片本身
                const card = e.target.closest('.user-profile-card, .char-card');
                if (card) {
                    const id = card.dataset.id;
                    if (id === 'user') {
                        openArchiveDetailModal(archiveData.user);
                    } else {
                        const character = archiveData.characters.find(c => c.id === id);
                        if (character) {
                            openArchiveDetailModal(character);
                        }
                    }
                }
            });
        };

        // 添加新角色
        const addCharacter = () => {
            const charName = prompt('请输入新角色的姓名：');
            if(charName && charName.trim() !== '') {
                const newChar = {
                    id: 'char_' + Date.now(),
                    avatar: DEFAULT_CHAR_AVATAR_SVG,
                    name: charName.trim(),
                    codename: '???',
                    age: '???',
                    ability: '???',
                    survivalDays: 0,
                    persona: '等待探索的角色。'
                };
                archiveData.characters.push(newChar);
                saveArchiveData();
                renderArchivePage(); // 重新渲染列表
            }
        };

        // 渲染档案编辑表单
        // 增加了一个 isUser 参数，用于区分用户档案和角色档案的保存/删除逻辑
        const renderCharEditForm = (profileData, isNew = false, isUser = false) => {
            const tempAvatar = profileData.avatar; // 临时存储头像，方便预览

            // 对于用户档案，代号和年龄可能不需要编辑（根据实际需求调整，这里暂时都显示）
            const formContent = `
                <div class="profile-detail-content profile-edit-form">
                    <div class="profile-detail-header-section">
                        <div class="profile-detail-avatar-large" id="char-edit-avatar-preview" style="background-image: url('${tempAvatar}');"></div>
                        <input type="file" id="char-edit-avatar-upload" accept="image/*" hidden>
                        <div class="profile-detail-basic-info-display">
                            <div class="modal-form-group">
                                <label for="char-edit-name">姓名</label>
                                <input type="text" id="char-edit-name" class="modal-input" value="${profileData.name || ''}">
                            </div>
                            <div class="modal-form-group">
                                <label for="char-edit-codename">代号</label>
                                <input type="text" id="char-edit-codename" class="modal-input" value="${profileData.codename || ''}" ${isUser ? '' : ''}>
                            </div>
                            <div class="modal-form-group">
                                <label for="char-edit-age">年龄</label>
                                <input type="text" id="char-edit-age" class="modal-input" value="${profileData.age || ''}" ${isUser ? '' : ''}>
                            </div>
                        </div>
                    </div>
                    <div class="profile-detail-extended-info-display">
                        <div class="modal-form-group">
                            <label for="char-edit-ability">异能</label>
                            <textarea id="char-edit-ability" class="modal-input">${profileData.ability || ''}</textarea>
                        </div>
                        <div class="modal-form-group">
                            <label for="char-edit-survivalDays">存活天数</label>
                            <input type="text" id="char-edit-survivalDays" class="modal-input" value="${profileData.survivalDays || ''}">
                        </div>
                        <div class="modal-form-group">
                            <label for="char-edit-persona">人设</label>
                            <textarea id="char-edit-persona" class="modal-input" style="min-height: 80px;">${profileData.persona || ''}</textarea>
                        </div>
                    </div>
                    <div class="button-container">
                        <button id="save-char-edit-btn" class="modal-button">保存档案</button>
                        ${!isNew && !isUser ? `<button id="delete-char-btn" class="modal-button danger" style="margin-left: 10px;">删除角色</button>` : ''}
                    </div>
                </div>
            `;
            
            archiveDetailContent.innerHTML = formContent;
            archiveModalOverlay.classList.add('visible');
            
            // 绑定头像上传
            const charEditAvatarPreview = document.getElementById('char-edit-avatar-preview');
            const charEditAvatarUpload = document.getElementById('char-edit-avatar-upload');
            
            charEditAvatarPreview.addEventListener('click', () => charEditAvatarUpload.click());
            charEditAvatarUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        charEditAvatarPreview.style.backgroundImage = `url(${event.target.result})`;
                        profileData.avatar = event.target.result; // 更新临时数据
                        // 如果是用户档案，同时更新主页面的头像
                        if (isUser) {
                             document.getElementById('avatar-box').style.backgroundImage = `url(${event.target.result})`;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 绑定保存按钮事件
            document.getElementById('save-char-edit-btn').addEventListener('click', () => {
                profileData.name = document.getElementById('char-edit-name').value.trim();
                profileData.codename = document.getElementById('char-edit-codename').value.trim();
                profileData.age = document.getElementById('char-edit-age').value.trim();
                profileData.ability = document.getElementById('char-edit-ability').value.trim();
                profileData.survivalDays = document.getElementById('char-edit-survivalDays').value.trim();
                profileData.persona = document.getElementById('char-edit-persona').value.trim();

                if (!profileData.name) {
                    alert('姓名不能为空！');
                    return;
                }
                
                if (isNew) { // 新增角色
                    profileData.id = 'char_' + generateId(); // 生成新的ID
                    archiveData.characters.push(profileData);
                } else if (isUser) { // 保存用户档案
                    archiveData.user = profileData; // profileData本身就是副本，直接替换
                } else { // [新增] 更新现有角色档案的逻辑
                    const charIndex = archiveData.characters.findIndex(c => c.id === profileData.id);
                    if (charIndex !== -1) {
                        archiveData.characters[charIndex] = profileData; // 用编辑后的副本替换原始数据
                    }
                }

                saveArchiveData();
                closeArchiveDetailModal();
                renderArchivePage(); // 重新渲染档案主页
            });

            // 绑定删除按钮事件 (仅限于非用户档案和非新建模式)
            if (!isNew && !isUser) {
                document.getElementById('delete-char-btn').addEventListener('click', () => {
                    if (confirm(`确定要删除角色 "${profileData.name}" 吗？此操作不可逆。`)) {
                        archiveData.characters = archiveData.characters.filter(char => char.id !== profileData.id);
                        saveArchiveData();
                        closeArchiveDetailModal();
                        renderArchivePage();
                    }
                });
            }
        };

        // 打开角色编辑模态框 (已兼容用户档案)
        const openCharEditModal = (profileId) => {
            let profile;
            let isUser = false;
            let isNew = profileId === null;

            if (isNew) { // 新建角色
                modalTitle.textContent = '添加新角色';
                profile = { // 直接创建一个新的临时对象
                    id: '',
                    avatar: DEFAULT_CHAR_AVATAR_SVG,
                    name: '新角色',
                    codename: '', age: '', ability: '', survivalDays: '', persona: ''
                };
                renderCharEditForm(profile, true, false);
                return;
            }

            // [修复] 对于编辑操作，创建数据副本，避免直接修改原始数据
            if (profileId === 'user') {
                profile = { ...archiveData.user }; // 创建用户档案的副本
                isUser = true;
            } else {
                const originalProfile = archiveData.characters.find(c => c.id === profileId);
                if (originalProfile) {
                    profile = { ...originalProfile }; // 创建角色档案的副本
                }
            }

            if (!profile) {
                alert('未找到档案信息，请刷新重试。');
                closeArchiveDetailModal();
                return;
            }
            
            modalTitle.textContent = `编辑${isUser ? '用户' : '角色'}：${profile.name}`;
            renderCharEditForm(profile, false, isUser);
        };

        // 打开档案App主界面
        const openArchiveApp = (e) => {
            const clickedElement = e ? e.currentTarget : document.getElementById('app-archive');
            
            // 使用通用模态框打开档案App的主列表
            openModal('档案', '', clickedElement);
            
            // 显示档案悬浮按钮
            archiveFab.classList.add('visible');
            
            renderArchivePage();
        };

        // 关闭档案App主界面 (新增逻辑)
        const closeArchiveApp = () => {
            archiveFab.classList.remove('visible');
            closeModal(); // 使用通用的关闭模态框函数
        };
        
        // 绑定档案App图标点击事件
        document.getElementById('app-archive').addEventListener('click', openArchiveApp);
        // 绑定档案悬浮按钮点击事件 (添加新角色)
        archiveFab.addEventListener('click', () => openCharEditModal(null)); // 传递null表示新建

        // ===================================
        // === 11. 档案 App 完整逻辑 结束 ===
        // ===================================
        // ===================================
        // === 12. 消息长按菜单逻辑 (新增) ===
        // ===================================
        // 新增：多选模式状态
        let isInMultiSelectMode = false;
        let selectedMessageIds = new Set();
        let longPressedMessageElement = null; // 新增：存储长按的消息元素
        // 新增：辅助函数，用于查找最新的AI回复轮次
        const findLatestAIRound = (messages) => {
            if (!messages || messages.length === 0) return null;

            // 如果最后一条是用户发的，则不存在最新的AI轮次
            if (messages[messages.length - 1].sender === 'me') {
                return null;
            }

            let endIndex = messages.length - 1;
            let startIndex = endIndex;

            // 从后往前找，直到找到一个不是AI发的消息或者到头
            for (let i = endIndex - 1; i >= 0; i--) {
                if (messages[i].sender === 'them') {
                    startIndex = i;
                } else {
                    break; // 遇到用户消息，停止查找
                }
            }

            const roundMessages = messages.slice(startIndex, endIndex + 1);
            return { startIndex, endIndex, roundMessages };
        };

        let currentQuoteInfo = null; // 新增：存储当前的引用信息 {id, text}

        const messageContextMenu = document.getElementById('message-context-menu');

        const contextMenuButtons = document.getElementById('context-menu-buttons');
        const chatMessagesContainer = document.getElementById('chat-app-content'); // 监听整个聊天内容区

        let longPressTimer = null;
        let pressStartX, pressStartY;

        const showContextMenu = (event) => {
            event.preventDefault();

            const messageId = longPressedMessageElement.dataset.messageId;
            let currentChattingId = null;
            for (const cId in chatAppData.messages) {
                if (chatAppData.messages[cId].find(m => m.id === messageId)) {
                    currentChattingId = cId;
                    break;
                }
            }
            if (!currentChattingId) return;

            const message = chatAppData.messages[currentChattingId].find(m => m.id === messageId);
            if (!message || message.type === 'retracted') return;

            // --- 按钮显隐控制 ---
            const editButton = contextMenuButtons.querySelector('[data-action="edit"]');
            const retractButton = contextMenuButtons.querySelector('[data-action="retract"]');
            const reAnswerButton = contextMenuButtons.querySelector('[data-action="re-answer"]');

            const isUserMessage = message.sender === 'me';
            
            // 需求2：编辑按钮始终显示
            editButton.style.display = 'flex'; 
            
            // 需求(上次的): 撤回按钮只对自己消息显示
            retractButton.style.display = isUserMessage ? 'flex' : 'none'; 
            
            // “重回”只对AI消息显示
            reAnswerButton.style.display = !isUserMessage ? 'flex' : 'none'; 

            const oldAlternatives = document.getElementById('alternative-replies-container');
            if (oldAlternatives) oldAlternatives.remove();
            
            messageContextMenu.classList.add('visible');
            
            const menuWidth = contextMenuButtons.offsetWidth;
            const menuHeight = contextMenuButtons.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const padding = 10;

            let finalLeft = pressStartX;
            let finalTop = pressStartY;

            if (finalLeft + menuWidth / 2 > windowWidth - padding) finalLeft = windowWidth - padding - menuWidth / 2;
            if (finalLeft - menuWidth / 2 < padding) finalLeft = padding + menuWidth / 2;
            if (finalTop + menuHeight / 2 > windowHeight - padding) finalTop = windowHeight - padding - menuHeight / 2;
            if (finalTop - menuHeight / 2 < padding) finalTop = padding + menuHeight / 2;

            contextMenuButtons.style.left = `${finalLeft}px`;
            contextMenuButtons.style.top = `${finalTop}px`;

            const latestAIRound = findLatestAIRound(chatAppData.messages[currentChattingId]);
            if (latestAIRound) {
                const firstMessageOfRound = chatAppData.messages[currentChattingId][latestAIRound.startIndex];
                if (firstMessageOfRound.alternatives && firstMessageOfRound.alternatives.length > 0) {
                    const alternativesContainer = document.createElement('div');
                    alternativesContainer.id = 'alternative-replies-container';
                    alternativesContainer.innerHTML = firstMessageOfRound.alternatives.map((altRound, index) => {
                        const linesHTML = altRound.map(msg => `<div class="alt-reply-line">${msg.text.replace(/<br>/g, ' ')}</div>`).join('');
                        return `<div class="alternative-reply-card" data-alt-index="${index}">${linesHTML}</div>`;
                    }).join('');
                    messageContextMenu.appendChild(alternativesContainer);
                    
                    const menuRect = contextMenuButtons.getBoundingClientRect();
                    alternativesContainer.style.width = `${menuRect.width}px`;
                    alternativesContainer.style.left = `${menuRect.left}px`;
                    alternativesContainer.style.transform = 'none';

                    const altContainerHeight = alternativesContainer.offsetHeight;
                    const spaceAbove = menuRect.top;
                    if (spaceAbove > altContainerHeight + padding) {
                        alternativesContainer.style.bottom = `${window.innerHeight - menuRect.top + 10}px`;
                    } else {
                        alternativesContainer.style.top = `${menuRect.bottom + 10}px`;
                    }
                }
            }
        };


        const hideContextMenu = () => {
            messageContextMenu.classList.remove('visible');
        };

        const handlePressStart = (e) => {
            // 只在聊天气泡上触发
            const targetBubble = e.target.closest('.chat-bubble');
            if (!targetBubble) return;

            // 新增：记录被长按的消息元素
            longPressedMessageElement = targetBubble.closest('.message-line');

            if (e.type === 'touchstart') {

                pressStartX = e.touches[0].clientX;
                pressStartY = e.touches[0].clientY;
            } else {
                pressStartX = e.clientX;
                pressStartY = e.clientY;
            }

            // 清除之前的计时器
            clearTimeout(longPressTimer);
            
            // 启动长按计时器
            longPressTimer = setTimeout(() => {
                showContextMenu(e);
            }, 500); // 500毫秒算作长按
        };

        const handlePressEndOrMove = () => {
            // 如果手指/鼠标移动或抬起，则取消长按
            clearTimeout(longPressTimer);
        };

        // 绑定事件到聊天内容区域（使用事件委托）
        chatMessagesContainer.addEventListener('mousedown', handlePressStart);
        chatMessagesContainer.addEventListener('touchstart', handlePressStart, { passive: true });

        // 移动或抬起时取消长按
        chatMessagesContainer.addEventListener('mouseup', handlePressEndOrMove);
        chatMessagesContainer.addEventListener('mouseleave', handlePressEndOrMove);
        chatMessagesContainer.addEventListener('touchend', handlePressEndOrMove);
        chatMessagesContainer.addEventListener('touchmove', handlePressEndOrMove, { passive: true });
        
        // [新增] 使用事件委托统一处理聊天区域的点击事件，修复多选功能
        chatMessagesContainer.addEventListener('click', (e) => {
            // 1. 处理多选模式下的消息点击
            if (isInMultiSelectMode) {
                const messageLine = e.target.closest('.message-line');
                if (messageLine) {
                    const msgId = messageLine.dataset.messageId;
                    // 如果点击的是已经被选中的消息，则取消选择，否则加入选择
                    if (selectedMessageIds.has(msgId)) {
                        selectedMessageIds.delete(msgId);
                        messageLine.classList.remove('selected');
                    } else {
                        selectedMessageIds.add(msgId);
                        messageLine.classList.add('selected');
                    }
                    updateMultiSelectToolbar(); // 更新顶部标题和底部按钮状态
                }
            }

            // 2. 处理“点击查看”撤回消息的事件
            const retractNotice = e.target.closest('[data-action="view-retracted"]');
            if (retractNotice) {
                showRetractedContent(retractNotice, e);
            }
        });

        
        // 阻止在长按菜单显示时，聊天内容区域的默认右键菜单（对桌面端更友好）
        chatMessagesContainer.addEventListener('contextmenu', (e) => {
            if (messageContextMenu.classList.contains('visible')) {
                e.preventDefault();
            }
        });


        // 点击空白处（遮罩层）关闭菜单
        messageContextMenu.addEventListener('click', (e) => {
            // 如果点击的是遮罩层本身，而不是按钮容器
            if (e.target === messageContextMenu) {
                hideContextMenu();
            }
        });

        // 点击菜单按钮
        contextMenuButtons.addEventListener('click', (e) => {
            const button = e.target.closest('.context-menu-button');
            const alternativeCard = e.target.closest('.alternative-reply-card');
            const messageId = longPressedMessageElement.dataset.messageId;

            let currentChattingId = null;
            for (const cId in chatAppData.messages) {
                if (chatAppData.messages[cId].some(m => m.id === messageId)) {
                    currentChattingId = cId;
                    break;
                }
            }
            if (!currentChattingId) return;

            const messages = chatAppData.messages[currentChattingId];
            const messageIndex = messages.findIndex(m => m.id === messageId);
            const message = messages[messageIndex];
            
            if (button) {
                const action = button.dataset.action;
                if (!message) return;

                if (action === 'copy') {
                    const textToCopy = message.text.replace(/<br\s*\/?>/gi, '\n');
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        alert('已复制到剪贴板');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        alert('复制失败');
                    });
                } else if (action === 'quote') {
                    currentQuoteInfo = { id: message.id, text: message.text.replace(/<br>/g, '\n') };
                    const previewContainer = document.getElementById('quote-preview-container');
                    document.getElementById('quote-preview-content').textContent = currentQuoteInfo.text;
                    previewContainer.style.display = 'block';
                    document.getElementById('chat-input').focus();
                } else if (action === 're-answer') {
                    const latestAIRound = findLatestAIRound(messages);
                    const isPartOfLatestRound = latestAIRound && messages.slice(latestAIRound.startIndex, latestAIRound.endIndex + 1).some(m => m.id === messageId);
                    if (isPartOfLatestRound) {
                        triggerApiReply(currentChattingId, latestAIRound);
                    } else {
                        alert('只能对最新一轮的AI回复使用此功能。');
                    }
                } else if (action === 'select-multiple') {
                    isInMultiSelectMode = true;
                    selectedMessageIds.clear();
                    selectedMessageIds.add(messageId);
                    renderChatRoom(currentChattingId);
                } else if (action === 'retract') {
                    handleRetract(currentChattingId, messageIndex);
                } else if (action === 'edit') {
                    // 需求2：允许编辑任何消息
                    showEditModal(currentChattingId, messageId);
                }
                
                hideContextMenu();
            
            } else if (alternativeCard) {
                const altIndex = parseInt(alternativeCard.dataset.altIndex, 10);
                const latestAIRound = findLatestAIRound(messages);
                if (latestAIRound) {
                    const firstMessageOfRound = messages[latestAIRound.startIndex];
                    const selectedAltRound = firstMessageOfRound.alternatives.splice(altIndex, 1)[0];
                    const newAlternatives = [...firstMessageOfRound.alternatives];
                    newAlternatives.push(latestAIRound.roundMessages);
                    selectedAltRound[0].alternatives = newAlternatives;
                    messages.splice(latestAIRound.startIndex, latestAIRound.roundMessages.length, ...selectedAltRound);
                    saveChatData();
                    renderChatRoom(currentChattingId);
                }
                hideContextMenu();
            }
        });

        // === 新增：处理新功能的辅助函数 ===

        // 更新多选工具栏状态
        function updateMultiSelectToolbar() {
            const toolbar = document.getElementById('multi-select-toolbar');
            const title = document.querySelector('.chat-room-view .chat-contact-title');
            const collectBtn = document.getElementById('multi-collect-btn');
            const deleteBtn = document.getElementById('multi-delete-btn');

            if (title) {
                title.textContent = `已选择 ${selectedMessageIds.size} 项`;
            }

            if (selectedMessageIds.size > 0) {
                collectBtn.classList.add('active');
                deleteBtn.classList.add('active');
            } else {
                collectBtn.classList.remove('active');
                deleteBtn.classList.remove('active');
            }
        }

        // 处理撤回逻辑
        function handleRetract(contactId, messageIndex) {
            const messages = chatAppData.messages[contactId];
            const messageToRetract = messages[messageIndex];
            const contact = chatAppData.contacts.find(c => c.id === contactId);

            let retractedMessage;
            if (messageToRetract.sender === 'me') {
                retractedMessage = {
                    id: generateId(),
                    type: 'retracted',
                    senderType: 'user',
                    timestamp: Date.now()
                };
            } else {
                // 简单的随机心声
                const innerThoughts = ["（糟糕，说错话了...）", "（这个表达好像不太对。）", "（换一种方式说会更好。）", "（刚才的回复有点偏离人设了。）"];
                retractedMessage = {
                    id: generateId(),
                    type: 'retracted',
                    senderType: 'char',
                    originalContent: messageToRetract.text,
                    innerThought: innerThoughts[Math.floor(Math.random() * innerThoughts.length)],
                    timestamp: Date.now()
                };
            }

            messages.splice(messageIndex, 1, retractedMessage);
            saveChatData();
            renderChatRoom(contactId);
        }

        // 显示被撤回的内容
        function showRetractedContent(element, event) {
            const popover = document.getElementById('retracted-content-popover');
            const contentEl = document.getElementById('popover-original-content');
            const thoughtEl = document.getElementById('popover-inner-thought');

            contentEl.innerHTML = unescape(element.dataset.content); // unescape data
            thoughtEl.textContent = unescape(element.dataset.thought);

            popover.classList.add('visible');
            
            // 定位
            const rect = element.getBoundingClientRect();
            const popoverHeight = popover.offsetHeight;
            const popoverWidth = popover.offsetWidth;
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;

            let top = rect.top - popoverHeight - 10;
            if (top < 10) {
                top = rect.bottom + 10;
            }

            let left = rect.left + (rect.width / 2) - (popoverWidth / 2);
            if (left < 10) left = 10;
            if (left + popoverWidth > windowWidth - 10) {
                left = windowWidth - popoverWidth - 10;
            }

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;
            
            // 点击外部关闭
            const closePopover = (e) => {
                if (!popover.contains(e.target)) {
                    popover.classList.remove('visible');
                    document.removeEventListener('click', closePopover, true);
                }
            };
            // 使用捕获阶段的事件监听器，确保它先于其他点击事件执行
            setTimeout(() => document.addEventListener('click', closePopover, true), 0);
        }

        // 显示编辑消息的模态窗
        function showEditModal(contactId, messageId) {
            const modal = document.getElementById('edit-message-modal');
            const textarea = document.getElementById('edit-message-textarea');
            const confirmBtn = document.getElementById('confirm-edit-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');

            const message = chatAppData.messages[contactId].find(m => m.id === messageId);
            if (!message) return;

            textarea.value = message.text.replace(/<br\s*\/?>/gi, '\n');
            modal.classList.add('visible');
            textarea.focus();

            const close = () => modal.classList.remove('visible');

            confirmBtn.onclick = () => {
                const newText = textarea.value.trim().replace(/\n/g, '<br>');
                if (newText) {
                    message.text = newText;
                    saveChatData();
                    renderChatRoom(contactId);
                }
                close();
            };

            cancelBtn.onclick = close;
        }

    </script>
<!-- === 新增：多选、编辑、撤回等功能的悬浮窗 === -->
<!-- 撤回内容悬浮窗 -->
<div id="retracted-content-popover">
    <div class="original-content" id="popover-original-content"></div>
    <div class="inner-thought" id="popover-inner-thought"></div>
</div>

<!-- 编辑消息悬浮窗 -->
<div id="edit-message-modal">
    <div class="edit-message-box">
        <textarea id="edit-message-textarea"></textarea>
        <div class="button-group">
            <button id="cancel-edit-btn" class="modal-button secondary">取消</button>
            <button id="confirm-edit-btn" class="modal-button">确定</button>
        </div>
    </div>
</div>
<!-- === 新增结束 === -->
</body>
</html>
