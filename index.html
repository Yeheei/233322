<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>水母终端</title>
        <!-- Web App Manifest -->
    <link rel="manifest" href="site.webmanifest">
    
    <!-- Favicons for various devices -->
    <link rel="icon" href="icons/favicon.ico" sizes="any">
    <link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    
    <!-- Specific sizes for different contexts -->
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icons/favicon-48x48.png">
    
    <!-- Apple Touch Icons with specific sizes (optional but recommended) -->
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180x180.png">
    
    <!-- Safari Pinned Tab Icon -->
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5"> <!-- 您可以把 color 改成您喜欢的主题色 -->
    
    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#ffffff">
    <!-- 引入localForage库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        :root {
            /* 主题色调 */
            --bg-color-start: #ffffff; /* White */
            --bg-color-end: #f0f0f0;   /* Light Gray */
            --glass-bg: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-color: #475569;
            --icon-color: #334155;
            --card-radius: 24px;
            --pill-radius: 999px; /* 胶囊形状圆角 */
            --app-radius: 16px; 
            --gap-size: 16px;
            --page-gap: 40px; 
            --accent-color: #334155; /* 主题强调色 */
            --accent-color-secondary: #64748b; /* 新增：次要强调色，默认为中性灰 */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* 解决方案：固定body，防止移动端键盘弹出时页面整体偏移 */
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(160deg, var(--bg-color-start) 0%, #e5e5e5 50%, var(--bg-color-end) 100%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 背景装饰 */
        body::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            width: 60%;
            height: 40%;
            background: rgba(200, 200, 200, 0.3); /* 调整为中性灰色光晕 */
            filter: blur(80px);
            border-radius: 50%;
            z-index: -1;
        }
        
        body::after {
            content: '';
            position: absolute;
            bottom: -10%;
            right: -10%;
            width: 60%;
            height: 40%;
            background: rgba(150, 150, 150, 0.3); /* 调整为中性灰色光晕 */
            filter: blur(80px);
            border-radius: 50%;
            z-index: -1;
        }


        /* 移动端限制容器 */
        #mobile-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            max-width: 520px; 
            max-height: 920px; 
            background: transparent;
            box-shadow: 0 0 0 0 rgba(0,0,0,0);
            transition: all 0.3s ease;
        }

        @media (min-width: 600px) {
            #mobile-wrapper {
                height: 90vh;
                border-radius: 40px;
                border: 1px solid rgba(255,255,255,0.4);
                box-shadow: 0 20px 50px rgba(0,0,0,0.15);
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
            }
        }

        #viewport {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* 修改：顶部增加padding让整体下沉一点点，底部padding加大 */
            padding: 40px 24px 60px 24px; 
            position: relative;
            overflow: hidden; 
        }

        #slider-container {
            display: flex;
            gap: var(--page-gap); 
            width: 100%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform;
        }

        .page {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 2px; 
        }

        /* === Grid 布局核心修改 === */
        .bento-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 修改：
               第一行 auto (给顶部胶囊自适应)
               第二行 1fr (App区域)
               第三行 1fr (App区域)
               不再使用固定比例填充整个高度
            */
            grid-template-rows: auto auto auto; 
            gap: var(--gap-size);
            width: 100%;
            /* 关键：内容向上对齐，底部自然留白 */
            align-content: start; 
        }

        /* === 顶部区域容器 === */
        .top-section-container {
            grid-column: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 底部留出一点距离给下面的App */
            margin-bottom: 20px; 
            gap: 12px;
        }

        /* 1. 顶部小状态栏 (胶囊) */
        .status-capsule {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--pill-radius);
            box-shadow: var(--glass-shadow);
            
            /* 尺寸设定 */
            width: 50%; /* 约半个屏幕宽 */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 简单纯CSS电池图标 */
        .battery-icon {
            width: 20px;
            height: 10px;
            border: 1.5px solid var(--text-color);
            border-radius: 2px;
            position: relative;
            padding: 1px;
        }
        .battery-icon::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 2px;
            width: 2px;
            height: 4px;
            background: var(--text-color);
            border-radius: 0 1px 1px 0;
        }
        .battery-level {
            height: 100%;
            background: var(--text-color);
            width: 80%; /* 默认电量 */
            border-radius: 0.5px;
        }

        /* 2. 个人信息大胶囊 */
        .profile-capsule {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50px; /* 较大的圆角 */
            box-shadow: var(--glass-shadow);
            
            width: 100%;
            height: 80px; /* 高度适中 */
            display: flex;
            align-items: center;
            padding: 8px;
            padding-right: 24px;
            gap: 16px;
        }

        /* 头像框 */
        .avatar-frame {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.5);
            /* [已修复] 彻底URL编码并使用单引号 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255,255,255,0.8);
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            flex-shrink: 0;
        }

        
        .avatar-frame:active {
            transform: scale(0.95);
            filter: brightness(0.9);
        }

.profile-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    flex-grow: 1; /* 新增：让信息区占据多余空间，将天气图标推到右侧 */
}
        .profile-name {
            font-size: 20px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 4px;
        }

        .profile-bio {
            font-size: 14px;
            color: #64748b;

            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        /* === 下方格子区域 === */
        
        /* 通用盒子样式 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            /* 关键：强制正方形 */
            aspect-ratio: 1 / 1; 
            width: 100%;
        }

        /* App 区域容器 */
        .app-grid-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            place-items: center; 
            padding: 4px;
            /* 关键：强制正方形 */
            aspect-ratio: 1 / 1; 
            width: 100%;
        }

        .area-mid-left {
            grid-column: 1 / 2;
            /* 移除 grid-row 强制设定，让它自动流式布局 */
        }

        .area-mid-right {
            grid-column: 2 / 3;
            background: rgba(255, 255, 255, 0.25);
            padding: 0;
        }
        
        .photo-placeholder {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            border-radius: var(--card-radius);
        }

        .area-bot-left {
            grid-column: 1 / 2;
            opacity: 0.6;
            /* 新增：为这个区域添加顶部内边距，使月历整体下移 */
            padding-top: 32px;
        }

        .area-bot-right {
            grid-column: 2 / 3;
            /* 新增：为这个区域添加顶部内边距，使其内部的四个App整体下移 */
            padding-top: 32px;
        }

        /* App 样式 */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            width: 100%; 
            height: 100%;
            cursor: pointer;
        }

        .app-icon-box {
            width: 56px; 
            height: 56px;
            aspect-ratio: 1 / 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--app-radius);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease, background-color 0.2s;
            flex-shrink: 0; 
        }

        .app-wrapper:active .app-icon-box {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.6);
        }

        .app-icon {
            width: 50%;
            height: 50%;
        }
        .app-icon path {
            fill: var(--icon-color) !important;
        }

        .app-name {
            font-size: 10px; 
            font-weight: 500;
            opacity: 0.9;


            margin-top: 5px;
            text-align: center;
            color: var(--text-color);
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        /* 底部导航点 */
        .pagination {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dot.active {
            background: #64748b;
            transform: scale(1.1);
            width: 16px;
            border-radius: 3px;
            opacity: 0.8;
        }
        
        .empty-text {
            font-size: 14px;
            color: #94a3b8;
            letter-spacing: 1px;
        }
        /* === 主屏幕卡片主题切换样式 === */

        /* --- 日间模式样式 --- */
        .photo-container-day {
            position: absolute;
            z-index: 1;
            /* 在这里修改 [日间] 图片框的大小和位置 */
            top: 41%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 97%;
            height: 72%;
            background-color: rgba(255, 255, 255, 0.4);
            border: 2px dashed rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            overflow: hidden; /* 确保内部图片不超出边框 */
        }
        
        .main-card-day {
            position: absolute;
            z-index: 2;
            pointer-events: none;
            /* 在这里修改 [日间] 卡片.PNG 的大小和位置 */
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 190%;
            height: 190%;
        }

        .photo-upload-placeholder-text {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 12px;
            pointer-events: none;
        }

        /* 默认隐藏夜间元素 */
        .main-card-night, .photo-container-night {
            display: none;
        }

        /* --- 夜间模式样式 --- */
        body.dark-mode .main-card-day,
        body.dark-mode .photo-container-day {
            display: none; /* 夜间模式下隐藏日间元素 */
        }

        body.dark-mode .main-card-night,
        body.dark-mode .photo-container-night {
            display: block; /* 夜间模式下显示夜间元素 */
        }
        
        body.dark-mode .photo-container-night {
            position: absolute;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            
            /* 【重要】在这里修改 [夜间] 图片框的大小和位置！ */
            top: 50%;    /* 例如: 调整到40% */
            left: 50%;
            transform: translate(-50%, -50%);
            width: 93%;   /* 例如: 宽度调整为90% */
            height: 84%;  /* 例如: 高度调整为80% */
            
            /* 夜间模式的边框和背景色 */
            background-color: rgba(39, 39, 42, 0.5); 
            border: 2px dashed rgba(63, 63, 70, 0.8);
            border-radius: 2px; /* 例如: 圆角调整为20px */
        }
        
        body.dark-mode .main-card-night {
            position: absolute;
            z-index: 2;
            pointer-events: none;

            /* 【重要】在这里修改 [夜间] 夜间卡片.PNG 的大小和位置！ */
            top: 50%;   /* 例如: 调整到50% */
            left: 50%;
            transform: translate(-50%, -50%);
            width: 122%;  /* 例如: 宽度调整为200% */
            height: 155%; /* 例如: 高度调整为200% */
        }

        body.dark-mode .photo-upload-placeholder-text {
            color: #d4d4d8; /* 夜间模式下，让提示文字更亮一些 */
        }

        /* === 全屏界面样式 (重构) === */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            /* 移除背景模糊，变为纯色背景 */
            background-color: var(--bg-color-end); 
            transition: opacity 0.3s ease;
        }

        #modal-overlay.visible {
            pointer-events: auto;
            opacity: 1;
        }

        #modal-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: transparent; /* 背景由 overlay 提供 */
            /* 核心动效：从点击位置放大 */
            transform-origin: 50% 50%; /* JS会动态修改这个值 */
            transform: scale(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0;
        }
        
        #modal-overlay.visible #modal-container {
            transform: scale(1);
        }
        /* 添加一个关闭时的动画类 */
        #modal-container.is-closing {
             transform: scale(0);
        }


        #modal-header {
            display: flex;
            /* 修改：让返回按钮在左，标题居中 */
            justify-content: flex-start; 
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
            position: relative; /* 为了标题绝对定位 */
        }

        #modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--icon-color);
            /* 绝对定位实现完美居中 */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            
        }

        #modal-close-btn {
            /* 修改：移除所有背景和边框，变为纯图标按钮 */
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            z-index: 1; /* 确保在标题上层，可点击 */
        }
        
        #modal-close-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
            transition: transform 0.2s;
        }

        #modal-close-btn:active svg {
            transform: scale(0.85);
        }

        #modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* 模态框内的表单样式 (通用) */
        .modal-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-form-group label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.7;
        }
        
        .modal-input, .modal-select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.5);
            /* 修改：将字体大小设置为16px可防止在iOS上自动缩放 */
            font-size: 16px;
            color: var(--text-color);
            /* 新增：允许在输入框中选择文字 */
            user-select: text;
            -webkit-user-select: text;
        }

        .modal-input::placeholder {
            color: #94a3b8;
        }
        
        .modal-button {
            padding: 14px 24px; /* 增加内边距 */
            border-radius: 12px; /* 相应增大圆角 */
            border: none;
            /* 使用 CSS 变量作为强调色 */
            background: var(--accent-color); 
            color: white;
            font-size: 15px; /* 增大字体 */
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            width: auto; /* 关键：让按钮宽度自适应内容 */
            flex-grow: 0; /* 关键：在flex布局中不拉伸 */
        }

        .modal-button:active {
            transform: scale(0.98);
        }
        
        .modal-button.secondary {
             background: var(--accent-color-secondary); /* 使用次要强调色 */
             color: white; /* 文本颜色设为白色以保证对比度 */
             border: none; /* 移除边框，使其与主按钮样式统一 */
        }


        /* 昼夜模式切换样式 */
        body.dark-mode {
            --bg-color-start: #27272a; /* Zinc 800 */
            --bg-color-end: #18181b;   /* Zinc 900 */
            --glass-bg: rgba(39, 39, 42, 0.45);
            --glass-border: rgba(63, 63, 70, 0.6);
            --text-color: #FFFFFF;
            --icon-color: #FFFFFF;
            /* --accent-color: #aab2be;  <-- 已移除此行，交由JS控制 */
        }

        body.dark-mode .profile-name {
            color: #f1f5f9;
        }
        body.dark-mode .profile-bio {
            color: #94a3b8;
        }
        body.dark-mode .app-name {
            text-shadow: none;
        }
        body.dark-mode .dot {
            background: rgba(255, 255, 255, 0.2);
        }
        body.dark-mode .dot.active {
            background: #cbd5e1;
        }
        body.dark-mode .modal-button {
            /* 暗黑模式下也使用强调色 */
             background: var(--accent-color, #4f46e5);
        }
        body.dark-mode .modal-button.secondary {
             /* 【核心修改】使用 CSS 变量，并确保文本颜色是白色以保证对比度 */
             background: var(--accent-color-secondary); 
             color: white; 
        }

        /* 预设区域样式 */
        .preset-section {
            padding: 16px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .preset-controls {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
        }
        .preset-controls .modal-select {
            grid-column: 1 / 2;
        }
        .preset-controls .modal-button {
            padding: 8px 12px; /* 调整为较小的内边距 */
            margin-top: 0;
            font-size: 13px; /* 保持较小的字体 */
            border-radius: 8px; /* 较小的圆角 */
            white-space: nowrap;
        }


        /* 表单组新样式 */
        .modal-form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 滑杆样式 */
        .slider-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .slider-group input[type="range"] {
            flex-grow: 1;
        }
        .slider-group .slider-value {
            font-size: 14px;
            font-weight: 500;
            min-width: 30px;
            text-align: right;
        }

        /* 开关样式 */
        .switch-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .switch-container {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            transition: .4s;
            border-radius: 34px;
        }
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .switch-slider {
            background-color: var(--accent-color);
        }

        input:checked + .switch-slider:before {
            transform: translateX(20px);
        }
        /* === 新增：副本内消息编辑悬浮窗样式 === */
        #instance-edit-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 2900; /* 需要比副本聊天界面高 */
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #instance-edit-message-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .instance-edit-message-box {
            background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #instance-edit-message-overlay.visible .instance-edit-message-box {
            transform: scale(1);
        }

        #instance-edit-message-textarea {
            width: 100%;
            min-height: 150px;
            max-height: 50vh;
            resize: vertical;
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(128,128,128,0.1);
            color: var(--text-color);
            user-select: text;
        }

        .instance-edit-message-box .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 在这里添加新样式 */

        /* 手机预览框样式 */
        .mockup-container {
            display: flex;
            justify-content: space-around;
            gap: 16px;
            margin: 20px 0;
        }
        .phone-mockup {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .phone-mockup label {
            font-size: 14px;
            font-weight: 600;
        }
        .phone-frame {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 9 / 19.5;
            background: #111;
            border: 8px solid #111;
            border-radius: 24px;
            padding: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0;
            border-radius: 16px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .phone-mockup.dark .phone-screen {
            background-color: #0f172a;
        }
        .phone-screen::before {
            content: '点击更换';
            position: absolute;
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .phone-screen:hover::before {
            opacity: 1;
        }
        .mockup-text {
            font-size: 10px;
            font-weight: bold;
            color: #334155;
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        .phone-mockup.dark .mockup-text {
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
        /* === 新增：副本内气泡长按菜单样式 === */
        #instance-message-context-menu {
            position: fixed;
            z-index: 2800; /* 需要比副本聊天界面(2600)高 */
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            padding: 6px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transform: scale(0.9);
            transform-origin: top left;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        #instance-message-context-menu.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .instance-context-menu-item {
            padding: 8px 14px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            border-radius: 8px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .instance-context-menu-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        body.dark-mode .instance-context-menu-item:hover {
            background-color: rgba(255,255,255,0.08);
        }
                /* === 新增：副本内消息编辑悬浮窗样式 === */
        #instance-edit-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 2900; /* 需要比副本聊天界面高 */
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #instance-edit-message-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .instance-edit-message-box {
            background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #instance-edit-message-overlay.visible .instance-edit-message-box {
            transform: scale(1);
        }

        #instance-edit-message-textarea {
            width: 100%;
            min-height: 150px;
            max-height: 50vh;
            resize: vertical;
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(128,128,128,0.1);
            color: var(--text-color);
            user-select: text;
        }

        .instance-edit-message-box .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* === 新增：副本内气泡长按菜单样式 === */
        #instance-message-context-menu {
            position: fixed;
            z-index: 2800; /* 需要比副本聊天界面(2600)高 */
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            padding: 6px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transform: scale(0.9);
            transform-origin: top left;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        #instance-message-context-menu.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .instance-context-menu-item {
            padding: 8px 14px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
            border-radius: 8px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .instance-context-menu-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        body.dark-mode .instance-context-menu-item:hover {
            background-color: rgba(255,255,255,0.08);
        }
        /* 在这里添加新样式 */


        /* 手机预览框样式 */
        .mockup-container {
            display: flex;
            justify-content: space-around;
            gap: 16px;
            margin: 20px 0;
        }
        .phone-mockup {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .phone-mockup label {
            font-size: 14px;
            font-weight: 600;
        }
        .phone-frame {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 9 / 16;
            background: #111;
            border: 3px solid #111;
            border-radius: 24px;
            padding: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0;
            border-radius: 16px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .phone-mockup.dark .phone-screen {
            background-color: #0f172a;
        }
        .phone-screen::before {
            content: '点击更换';
            position: absolute;
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .phone-screen:hover::before {
            opacity: 1;
        }
        .mockup-text {
            font-size: 10px;
            font-weight: bold;
            color: #334155;
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        .phone-mockup.dark .mockup-text {
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
        }
    /* === 新增：天气图标样式 === */
    #weather-icon-container {
        width: 48px;  /* 设置一个合适的尺寸，与头像大小协调 */
        height: 48px;
        flex-shrink: 0; /* 防止图标在空间不足时被压缩 */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 16px; /* 与文字区域保持一定间距 */
    }

    #weather-icon-container svg {
        width: 100%;
        height: 100%;
    }


        /* 主题色选择器样式 */
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .color-swatch-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }
        #theme-accent-color-picker, #theme-accent-color-picker-dark {
            opacity: 0;
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            cursor: pointer;
        }

        #theme-accent-color-swatch, #theme-accent-color-swatch-dark {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            background-color: var(--accent-color);
            cursor: pointer; /* 添加手型光标 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #theme-accent-color-hex {
            flex-grow: 1;
            /* 限制最大宽度以防超出屏幕 */
            max-width: 120px; 
        }

        /* 分隔线样式 */
        .subtle-divider {
            height: 1px;
            border: none;
            width: 80%;
            margin: 24px auto;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.1), transparent);
        }
        body.dark-mode .subtle-divider {
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
        }

        /* API模型选择器布局 */
        .model-selection-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .model-selection-group .modal-select {
            flex-grow: 1;
        }
        .model-selection-group .modal-button {
            padding: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 16px; /* 增加与上方内容的间距 */
        }
        /* 正在回复的加载动画 */
        @keyframes dot-pulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .loading-dots {
            display: flex;
            align-items: center;
            height: 1em; /* 确保高度足够显示点 */
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background-color: var(--text-color); /* 使用主题文本颜色 */
            border-radius: 50%;
            margin: 0 2px;
            animation: dot-pulse 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .message-line.loading {
            align-self: flex-start;
            pointer-events: none; /* 防止点击 */
        }

        .message-line.loading .chat-bubble {
            background-color: var(--glass-bg); /* 保持一致的背景 */
            backdrop-filter: blur(10px);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px; /* 确保能容纳三个点 */
            padding: 8px 12px;
        }

        .message-line.loading .chat-bubble .loading-dots span {
             background-color: var(--icon-color); /* 配合背景调整点颜色 */
        }

        /* === 世界书 App 样式 === */
        #world-book-fab {
            position: fixed;
            bottom: 25px;
            right: 20px;
            /* 修改：尺寸缩小约 1/3 */
            width: 38px;
            height: 38px;
            /* 修改：应用磨砂玻璃质感 */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s, background-color 0.2s;
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        #world-book-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #world-book-fab:active {
            transform: scale(0.95) !important;
        }
        #world-book-fab svg {
            /* 修改：图标尺寸相应缩小 */
            width: 20px;
            height: 20px;
            /* 修改：图标颜色跟随主题 */
            fill: var(--icon-color);
        }


        #modal-header-controls {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .world-book-category {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .world-book-category:hover {
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .world-book-category:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .category-title {
            font-weight: 600;
        }
        .category-arrow {
            width: 20px;
            height: 20px;
            transition: transform 0.3s;
        }
        .world-book-category.expanded .category-arrow {
            transform: rotate(90deg);
        }
        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            background-color: rgba(0,0,0,0.02);
            padding: 0 16px;
        }
        body.dark-mode .category-items {
             background-color: rgba(0,0,0,0.1);
        }
        .category-items.visible {
            max-height: 1000vh; /* 一个足够大的值 */
            padding: 10px 16px;
        }
        .world-book-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: var(--glass-shadow);
        }
        .item-title {
            font-weight: 500;
            margin-bottom: 6px;
        }
        .item-content {
            font-size: 14px;
            opacity: 0.8;
            /* 修改：实现单行文本溢出显示省略号 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* word-wrap 不再需要 */
        }


        .add-item-placeholder {
            padding: 12px;
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            text-align: center;
            color: var(--text-color);
            opacity: 0.6;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            margin-top: 10px;
        }
        .add-item-placeholder:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .add-item-placeholder:hover {
            background-color: rgba(255,255,255,0.05);
        }

        /* 编辑模式样式 */
        .edit-mode-controls {
            display: flex;
            gap: 8px;
        }
        .edit-mode-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }
        .edit-mode-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--text-color);
            opacity: 0.6;
        }
        .edit-mode-btn:hover svg {
            opacity: 1;
        }
        .world-book-category[draggable="true"] {
            cursor: grab;
        }
        .world-book-category.dragging {
            opacity: 0.5;
            background: rgba(0,0,0,0.1);
        }
        .drag-over {
            border-top: 2px solid var(--accent-color);
        }

        #world-book-add-item-form textarea {
            min-height: 120px;
            /* 限制最大高度为视口高度的45%，留下足够空间给标题、按钮和边距 */
            max-height: 45vh; 
            resize: vertical;
        }


        /* 按钮容器样式，用于居中 */
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 16px; /* 增加与上方内容的间距 */
        }
        .world-book-category.in-edit-mode {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .world-book-category.in-edit-mode {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        /* === 新增：注入位置选择器样式 === */
        .injection-position-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .injection-position-selector {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .injection-position-selector input[type="radio"] {
            /* 隐藏原生radio按钮 */
            display: none;
        }

        .injection-position-selector label {
            flex: 1; /* 让四个选项均分宽度 */
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.05);
            color: var(--text-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        body.dark-mode .injection-position-selector label {
            background-color: rgba(255,255,255,0.08);
        }

        /* 选中时的样式 */
        .injection-position-selector input[type="radio"]:checked + label {
            background-color: var(--accent-color);
            color: white;
            border-color: color-mix(in srgb, var(--accent-color) 80%, #000);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        .injection-position-selector label:hover {
            background-color: rgba(0,0,0,0.1);
        }
        
        body.dark-mode .injection-position-selector label:hover {
            background-color: rgba(255,255,255,0.15);
        }

/* === Chat App 样式 === */
body {
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE/Edge */
    user-select: none;         /* Standard */
}
        #chat-app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1500;
            opacity: 0;
            transform: scale(0); /* 修改：初始状态为缩小到0 */
            transition: opacity 0.3s ease, transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); /* 修改：使用与其他App一致的动画曲线 */
            pointer-events: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform-origin: 50% 50%; /* 新增：默认动画原点，JS会覆盖它 */
        }

        /* 【新增】聊天列表长按不选中文字 */
        .chat-contact-list {
            user-select: none;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
        }

        /* 【新增】置顶联系人背景效果 */
        .chat-contact-item-pinned {
            background-color: rgba(0, 0, 0, 0.05); /* 微信置顶色调偏暗 */
        }
        body.dark-mode .chat-contact-item-pinned {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* 【新增】聊天列表长按菜单模态框 */
        #chat-list-context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000; /* 确保在聊天列表之上 */
            /* 【核心修改】移除背景模糊，变为完全透明的点击捕捉层 */
            background-color: transparent;
            display: none; /* 默认隐藏 */
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }

        #chat-list-context-menu-overlay.visible {
            display: block; /* 改为 block 以便绝对定位 */
            opacity: 1;
        }

        #chat-list-context-menu {
            /* 【核心修改】改为绝对定位，并调整样式 */
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px; /* 【核心修改】减小圆角，更像右键菜单 */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* 标准阴影 */
            padding: 8px 0; /* 调整内边距 */
            min-width: 180px; /* 调整宽度 */
            /* 【核心修改】移除 transform，改为 opacity 动画 */
            opacity: 0;
            transform: scale(0.95);
            transform-origin: top left; /* 动画原点，JS会动态修改 */
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none; /* 隐藏时不可点击 */
        }

        #chat-list-context-menu-overlay.visible #chat-list-context-menu {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; /* 显示时可点击 */
        }

        .chat-list-context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            transition: background-color 0.15s ease;
        }

        .chat-list-context-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .chat-list-context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }


        #chat-app-container.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #chat-wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color-end); /* 提供一个背景色作为后备 */
            z-index: -1;
            transition: opacity 0.3s ease-in-out; /* 确保chat-wallpaper层本身的过渡平滑 */
        }

        /* 新增：壁纸图层样式 */
        .wallpaper-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0; /* 默认隐藏 */
            transition: opacity 0.5s ease-in-out; /* 平滑淡入淡出 */
            pointer-events: none; /* 不阻止下方元素的事件 */
        }
        .wallpaper-layer.current {
            opacity: 1; /* 当前显示的图层 */
        }


        #chat-app-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* --- 顶栏和底栏的模糊渐变效果 --- */
        .chat-header, .chat-footer {
            position: relative;
            z-index: 10;
        }

        .chat-header::before, .chat-footer::after {
            content: '';
            position: absolute;
            left: 0;
            width: 100%;
            z-index: -1;
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
        }

        .chat-header::before {
            top: -40px;
            height: calc(100% + 40px);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        .chat-footer::after {
            bottom: -10px;
            height: calc(100% + 10px);
            -webkit-mask-image: linear-gradient(to top, black 60%, transparent 100%);
            mask-image: linear-gradient(to top, black 60%, transparent 100%);
        }

        /* --- 联系人列表页 --- */
        .chat-contact-list-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .chat-main-header {
            display: flex;
            align-items: center;
            position: relative;
            padding: 12px 15px; /* 减小内边距，与其他顶栏对齐 */
            font-size: 18px; /* 减小字体大小 */
            font-weight: 600; /* 使用与modal-title一致的字重 */
            color: var(--text-color);
            background-color: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        
        body.dark-mode .chat-main-header {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .chat-contact-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 15px;
        }

        .chat-contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            /* 核心修改：添加磨砂玻璃效果 */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            /* 核心修改：将下边框改为完整的圆角边框 */
            border: 1px solid var(--glass-border);
            border-radius: 16px; /* 边缘圆润 */
            /* 核心修改：为每个卡片添加间距 */
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .chat-contact-item:last-child {
            border-bottom: none;
        }

        .chat-contact-item:hover {
            background-color: rgba(0,0,0,0.03);
        }
        
        body.dark-mode .chat-contact-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .chat-contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background-color: #ccc;
            margin-right: 15px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            /* 核心修改：添加下方阴影 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .chat-contact-info {
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-contact-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .chat-contact-last-msg {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }

        /* --- 聊天室页面 --- */
        .chat-room-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 10px;
            flex-shrink: 0;
            background: transparent; /* 背景由伪元素模糊层提供 */
        }
        
        .chat-header-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .chat-header-btn svg {
            width: 28px;
            height: 28px;
            fill: var(--icon-color);
        }
        
        .chat-contact-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px; /* 增加消息之间的间距 */
        }
        
        .message-line {
            display: flex;
            align-items: flex-start; /* 头像和气泡顶部对齐 */
            gap: 10px;
            max-width: 85%; /* 限制整行最大宽度，防止过长 */
        }

        .message-line.sent {
            align-self: flex-end;
            flex-direction: row-reverse; /* 我方消息，头像在右 */
        }

        .message-line.received {
            align-self: flex-start;
        }
        
        /* 确保撤回消息通知完全居中 */
        .message-line:has(.retracted-message-notice) {
            max-width: 100% !important;
            align-self: center !important;
            justify-content: center !important;
        }

        /* [修复] 确保时间戳和模式切换胶囊也能完全居中 */
        .message-line:has(.time-stamp-bubble),
        .message-line:has(.mode-switch-capsule) {
            max-width: 100%;
            justify-content: center;
        }

        /* === 新增：隐藏头像模式下的样式 === */
        .chat-messages.avatars-hidden .chat-avatar {
            display: none; /* 直接隐藏头像 */
        }
        .chat-messages.avatars-hidden .message-line {
            max-width: 75%; /* 减小最大宽度，使其在没有头像时也不会过宽 */
        }
        /* === 新增结束 === */

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            margin-top: -4px; /* 修改：增加顶部边距使气泡下移 */
        }

        
        .chat-bubble {
            max-width: 100%; /* 气泡现在可以撑满 .message-line 的可用空间 */
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
            /* 新增：使用CSS变量来控制字体，并设置一个回退值 */
            font-family: var(--bubble-font, inherit);
        }

        .chat-bubble.sent {
            /* 修改：使用新的CSS变量，并提供默认值 */
            background-color: var(--my-bubble-color, #D0D6E1);
            color: var(--text-color);
            border-radius: 22px;
            /* 新增：禁止长按时选中文字，与 received 气泡保持一致 */
            -webkit-user-select: none; /* Safari, Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;
        }

        .chat-bubble.received {
            /* 修改：使用新的CSS变量，并提供默认值 */
            background-color: var(--char-bubble-color, var(--glass-bg));
            backdrop-filter: blur(10px);
            color: var(--text-color);
            border-radius: 22px;
            -webkit-user-select: none; /* Safari, Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;
        }

        /* === 新增：线下模式聊天气泡样式 === */
        /* 1. 修改消息行的布局为垂直居中 */
        #offline-chat-container .message-line {
            flex-direction: column;   /* 垂直排列头像和气泡 */
            align-items: center;      /* 水平居中所有子元素 */
            gap: 0;                   /* 移除头像和气泡的间距 */
            max-width: 100%;          /* 允许行占满全宽以便居中 */
            margin-top: 25px;         /* 新增：为每条消息上方添加25px的垂直间距 */
        }

        /* 2. 重置线上模式的左右对齐和反向布局 */
        #offline-chat-container .message-line.sent,
        #offline-chat-container .message-line.received {
            align-self: initial; /* 移除 flex-start/flex-end 对齐，让其在父容器中自然居中 */
        }
        #offline-chat-container .message-line.sent {
             flex-direction: column; /* 强制覆盖线上模式的 row-reverse */
        }

        /* 3. 调整头像，使其位于气泡正上方并紧贴 */
        #offline-chat-container .chat-avatar {
            margin-top: 0;    /* 移除线上模式为对齐而设的负边距 */
            margin-bottom: 0; /* 确保头像底部紧贴气泡顶部 */
        }

        /* 4. 统一设置线下模式中 user 和 char 的气泡样式 */
        #offline-chat-container .chat-bubble {
            /* 要求：高斯模糊背景（无色） */
            background: rgba(255, 255, 255, 0.15); /* 使用非常淡的半透明白色作为模糊的基底，视觉上接近无色 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2); /* 添加一个微妙的边框增加质感 */
            
            /* 要求：固定宽度和内边距 */
            width: 80%;       /* 设置一个相对固定的宽度，使其在不同设备上表现一致 */
            max-width: 380px; /* 限制一个最大宽度，防止在大屏幕上过宽 */
            box-sizing: border-box; /* 确保 padding 不会撑大设定的 width */
            padding: 12px 10px; /* 垂直内边距12px，水平10px（满足要求） */
            
            /* 覆盖线上模式的特定样式 */
            color: var(--text-color); /* 确保文字颜色在模糊背景上可读 */
            border-radius: 16px; /* 统一圆角 */
        }

        /* 5. 确保 sent 和 received 气泡样式完全一致，覆盖线上模式的差异 */
        #offline-chat-container .chat-bubble.sent,
        #offline-chat-container .chat-bubble.received {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-color);
        }

        .chat-footer {
            display: flex;
            /* 修改：改为纵向布局，让工具栏显示在输入框下方 */
            flex-direction: column;
            /* padding 和 gap 移动到内部wrapper中 */
            padding: 0; 
            gap: 0;
            flex-shrink: 0;
        }

        /* 在 .chat-footer 样式下方添加 */
        .chat-footer-content-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-footer-input-row {
            display: flex;
            align-items: center;
            padding: 10px;
            gap: 10px;
        }

        .chat-input-area {
            flex-grow: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 22px;
            display: flex;
            align-items: center;
            padding: 0 5px 0 15px;
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 16px;
            padding: 10px 0;
            outline: none;
            /* 新增：允许在聊天输入框中选择文字 */
            user-select: text;
            -webkit-user-select: text;
        }


        #chat-input::placeholder {
            color: var(--text-color);
            opacity: 0.5;
        }
        
        .chat-action-btn {
            background: none;
            border: none; /* 明确移除边框 */
            padding: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .chat-action-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--icon-color);
        }

        /* [修改] 强制所有工具栏按钮的SVG路径都使用主题图标颜色 */
        .chat-footer .chat-action-btn svg path {
            fill: var(--icon-color);
        }
        
        /* 发送按钮和AI回复按钮，移除背景颜色和圆形样式，直接显示SVG */
        #send-btn, #api-reply-btn {
             background: none; /* 移除背景 */
             border: none;     /* 移除边框 */
             padding: 0;       /* 移除内边距 */
             margin-left: 5px;
             /* 调整为按钮的默认大小，让SVG居中 */
             width: 32px; /* 可以根据SVG大小调整 */
             height: 32px; /* 可以根据SVG大小调整 */
             display: flex;
             align-items: center;
             justify-content: center;
        }
        
        #send-btn svg, #api-reply-btn svg {
            fill: var(--icon-color); /* 调整填充色，使其与普通图标一致 */
            width: 24px; /* 调整SVG图标大小，使其与普通图标一致 */
            height: 24px; /* 调整SVG图标大小，使其与普通图标一致 */
        }


        /* --- 聊天设置侧边栏 --- */
        #chat-settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 1900;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #chat-settings-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #chat-settings-modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 320px;
            height: 100%;
            background-color: var(--bg-color-start);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 20px;
            /* 关键修改：移除这里的顶部内边距 */
            padding-top: 20px; 
            display: flex; /* 新增：使用flex布局 */
            flex-direction: column; /* 新增：垂直布局 */
        }
        
        body.dark-mode #chat-settings-modal {
             background-color: var(--bg-color-end);
        }

        #chat-settings-modal.visible {
            transform: translateX(0);
        }

        /* 新增：侧边栏保存按钮样式 */
        #chat-settings-save-btn {
            position: absolute;
            top: 18px;
            right: 20px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s, transform 0.1s;
        }


        #chat-settings-save-btn:active {
            transform: scale(0.95);
        }

        /* 设置界面的滚动容器 */
        #chat-settings-body {
            /* 关键修改：移除 height: 100%，让其在flex布局中自适应 */
            flex-grow: 1; /* 新增：使其填充剩余空间 */
            overflow-y: auto;
            padding-right: 10px; /* 防止滚动条遮挡内容 */
            margin-right: -10px;
            /* 关键修改：将顶部内边距移到这里，为按钮留出空间 */
            padding-top: 42px; /* 60px - 18px, 留出按钮所需空间 */
        }


        /* 磨砂玻璃质感的分组 */
        .settings-group-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* 设置项通用样式 */
        .chat-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chat-setting-item:last-child {
            margin-bottom: 0;
        }

        .chat-setting-item label {
            font-size: 15px;
            font-weight: 500;
            flex-shrink: 0;
            margin-right: 15px;
        }

        .chat-setting-item .setting-input,
        .chat-setting-item .setting-textarea {
            flex-grow: 1;
            background: rgba(128, 128, 128, 0.1);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-color);
            width: 100%; /* 确保在flex布局中能正确计算宽度 */
        }
        
        .chat-setting-item .setting-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .chat-setting-item.vertical {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
                   .chat-setting-item.vertical {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        /* === 新增：气泡颜色选择器样式 === */
        .bubble-color-selectors-container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: space-around; /* 居中两个选择器 */
            margin-top: 8px;
            padding: 0 10px;
        }
        .bubble-color-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .bubble-color-swatch-wrapper {
            position: relative;
            width: 40px;
            height: 40px;
        }
        .bubble-color-swatch-wrapper input[type="color"] {
            /* 【核心修复】增加 top: 0 和 left: 0，确保绝对定位的起点正确 */
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            /* 【核心修复】移除 input 的默认 padding 和 border，防止影响布局 */
            padding: 0;
            border: none;
        }
        .bubble-color-swatch {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            /* 【核心修复】移除这里的 cursor: pointer，因为点击事件由上层的 input 捕获 */
            /* cursor: pointer; */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            /* 【核心修复】确保色块不会捕获点击事件，让事件“穿透”到上层的 input */
            pointer-events: none;
        }
        .bubble-color-picker-label {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .avatar-selection-container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center; /* 居中两个头像 */
            margin-top: 8px;
        }
        .avatar-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .avatar-preview-circle {
            width: 60px; /* 稍微放大一点以突出 */
            height: 60px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 2px solid #d1d5db; /* 修改：日间模式下使用一个可见的深灰色边框 */
            transition: transform 0.2s;
        }
        /* 新增：在暗黑模式下，恢复头像边框为主题玻璃边框色 */
        body.dark-mode .avatar-preview-circle {
            border-color: var(--glass-border);
        }

        .avatar-picker:active .avatar-preview-circle {
            transform: scale(0.95);
        }
        .avatar-picker-label {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }
        /* === 添加结束 === */
        /* 角色头像设置 */
        .char-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #char-avatar-preview {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 2px solid var(--glass-border);
        }
        
        /* 数据操作按钮 */
        .setting-action-button {
            width: 100%;
            padding: 12px;
            font-size: 15px;
            font-weight: 500;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: rgba(128, 128, 128, 0.15);
            color: var(--text-color);
            text-align: left;
        }
        .setting-action-button.danger {
            color: #ef4444; /* 红色警告 */
        }
        .setting-action-button:active {
            transform: scale(0.98);
            background-color: rgba(128, 128, 128, 0.25);
        }
        /* 聊天设置中的手机壁纸预览 */
        .wallpaper-mockup-container {
            display: flex;
            /* 保持 justify-content: space-around; 确保间距 */
            justify-content: space-around; 
            gap: 16px; /* 增大间距 */
            margin-top: 8px;
            width: 100%; /* 确保容器撑满父元素 */
            padding: 0 10px; /* 左右留一点边距 */
        }
        .wallpaper-mockup {
            flex: 1; /* 自动填充可用宽度 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* 增大元素间距 */
            max-width: 150px; /* 限制每个模拟框的最大宽度 */
        }
        .wallpaper-mockup .phone-frame {
            width: 100%; /* 撑满 flex 项的宽度 */
            max-width: none; /* 移除原来的 max-width 限制 */
            aspect-ratio: 9 / 16; /* 确保 9:16 比例 */
            background: #111; /* 手机边框颜色 */
            border: 3px solid #111; /* 手机边框粗细 */
            border-radius: 24px; /* 手机圆角 */
            padding: 2px; /* 屏幕与边框的间距 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* 阴影效果 */
        }
        .wallpaper-mockup .phone-screen {
            width: 100%;
            height: 100%;
            background-color: #e2ebf0; /* 默认屏幕颜色 */
            border-radius: 16px; /* 内部屏幕圆角 */
            cursor: pointer;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }
        .wallpaper-mockup-label {
            font-size: 14px; /* 增大标签字体 */
            font-weight: 600; /* 增加字体粗细 */
            opacity: 1; /* 恢复不透明度 */
            color: var(--text-color); /* 继承主题文本颜色 */
        }

        /* 绑定下拉框样式 */
        .worldbook-binder-container {
            width: 100%;
        }
        .worldbook-binder-tree {
            width: 100%;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            max-height: 250px; /* 限制最大高度，出现滚动条 */
            overflow-y: auto;
            background: rgba(128, 128, 128, 0.05);
        }
        .worldbook-binder-tree details {
            border-bottom: 1px solid var(--glass-border);
        }
        .worldbook-binder-tree details:last-child {
            border-bottom: none;
        }
        .worldbook-binder-tree summary {
            padding: 10px 12px;
            cursor: pointer;
            list-style: none; /* 移除默认箭头 */
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .worldbook-binder-tree summary::-webkit-details-marker {
            display: none; /* 移除默认箭头 for Chrome */
        }
        .worldbook-binder-items {
            padding: 5px 12px 10px 40px; /* 左侧缩进 */
            background: rgba(128, 128, 128, 0.05);
        }
        .worldbook-binder-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            font-size: 14px;
        }
        .binder-checkbox {
            cursor: pointer;
            accent-color: var(--accent-color); /* 让checkbox颜色跟随主题 */
        }
        /* === 新增：分组列表项样式 === */
    .chat-app-group-item {
        display: flex;
        flex-direction: column;
        /* 移除所有背景、边框和圆角样式 */
        background-color: transparent; 
        border-radius: 0;
        margin-bottom: 10px;
        overflow: hidden;
        border: none;
    }


        body.dark-mode .chat-app-group-item {
            background-color: rgba(255, 255, 255, 0.04) !important;
        }

        .chat-app-group-header {
            display: flex;
            align-items: center;
            padding: 6px 15px; /* 垂直内边距减半以减小高度，左右内边距与联系人项保持一致 */
            cursor: pointer;
            /* 新增：左深右浅的渐变背景 */
            background: linear-gradient(to right, rgba(128, 128, 128, 0.15), transparent); /* 将0改为transparent以保证平滑过渡 */
            /* 关键修改：使用clip-path来创建左侧圆角，右侧直角的形状，实现视觉上的胶囊效果 */
            clip-path: inset(0 0 0 0 round 999px 0 0 999px);
            position: relative; 
        }


        .chat-app-group-name {
            font-size: 15px; /* 偏小的字 */
            color: #94a3b8;   /* 偏淡的灰字 */
            font-weight: 500;
        }
        body.dark-mode .chat-app-group-name {
            color: #94a3b8;
        }
        
    .group-members-container {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s ease-out, padding 0.35s ease-out, border 0.1s; /* 新增过渡效果 */
        background-color: transparent;
        padding: 0;
        /* 默认状态下无边框和圆角 */
        border-radius: 0; 
        border: 1px solid transparent; 
    }

    .group-members-container.expanded {
        max-height: 500px; /* 一个足够大的高度来显示成员 */
        /* 【核心修改】当展开时，应用磨砂玻璃卡片效果 */
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
    }


#world-book-fab {
    position: fixed;
    bottom: 25px;
    right: 20px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

#archive-fab {
    position: fixed;
    bottom: 40px; /* 往下挪动 */
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

/* === 新增：Chat App FAB 样式 === */
#chatapp-fab {
    position: fixed;
    bottom: 40px; /* 往下挪动 */
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1600;
    transition: transform 0.2s, background-color 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}

#chatapp-fab.visible {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}
#chatapp-fab:active {
    transform: scale(0.95) !important;
}
#chatapp-fab svg {
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
}

/* === 新增：Chat App 添加联系人悬浮窗样式 === */
#add-contact-modal {
    position: absolute; /* 相对于 chat-app-container */
    bottom: 85px; /* 位于FAB上方，避免遮挡 */
    right: 20px;
    width: 280px;
    max-height: 400px;
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    box-shadow: var(--glass-shadow);
    z-index: 1601;
    overflow: hidden;
    transform: scale(0.8);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
}

#add-contact-modal.visible {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}

#add-contact-modal h4 {
    margin: 0;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    border-bottom: 1px solid var(--glass-border);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#add-contact-modal h4 button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
}
#add-contact-modal h4 button svg {
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
    opacity: 0.6;
}
#add-contact-modal h4 button:hover svg {
    opacity: 1;
}

#add-contact-list-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 0;
}

.add-contact-item {
    display: flex;
    align-items: center;
    padding: 8px 20px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.add-contact-item:hover {
    background-color: rgba(0,0,0,0.03);
}
body.dark-mode .add-contact-item:hover {
    background-color: rgba(255,255,255,0.05);
}

.add-contact-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.add-contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background-color: #ccc;
    background-size: cover;
    background-position: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.add-contact-name {
    font-weight: 500;
    color: var(--text-color);
    flex-grow: 1;
}

        /* === 档案 App 样式 (重构) === */
        /* 模态框重写 */
        #archive-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            backdrop-filter: blur(8px); /* 模糊背景 */
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000; /* 比主模态框低 */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #archive-modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #archive-detail-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow);
            max-width: 90%; /* 增大宽度 */
            max-height: 90%; /* 增大高度 */
            width: 500px; /* 设定一个相对较大的固定宽度作为基准 */
            height: 700px; /* 设定一个相对较大的固定高度作为基准 */
            overflow-y: auto;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            position: relative; /* 用于放置关闭按钮 */
        }

        /* 响应式调整：小屏幕下恢复为最大95% */
        @media (max-width: 520px) {
            #archive-detail-modal {
                width: 90%;
                height: 90%;
            }
        }

        #archive-modal-overlay.visible #archive-detail-modal {
            transform: scale(1);
            opacity: 1;
        }

        #archive-detail-modal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            z-index: 10;
        }
        #archive-detail-modal .close-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
        }


        #archive-fab {
    position: fixed;
    bottom: 40px; /* 与世界书按钮一致 */
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001; /* 确保在其他内容之上 */
    /* 核心修改：为所有 transform 属性和背景色添加过渡动画 */
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), background-color 0.2s;
    transform: scale(0); /* 初始隐藏 */
    opacity: 0;
    pointer-events: none;
    /* 新增：禁止长按时选中文字或弹出菜单 */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE/Edge */
    user-select: none;         /* Standard */
}


        #archive-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #archive-fab:active {
            transform: scale(0.95) !important;
        }
        #archive-fab svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color); /* 图标颜色跟随主题 */
        }


        /* 档案页面布局容器 */
        .archive-page-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 20px; /* 底部留白 */
        }

        /* User 角色卡片 (高度缩小) */
        .user-profile-card {
            display: flex;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            
            /* 修改：高度缩小1/3，比例从 4/3 变为 4/2 (即 2/1) */
            width: 100%;
            aspect-ratio: 2 / 1; 
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
        }

        .user-profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .user-profile-card .card-avatar {
            width: 80px; /* 适配大卡片 */
            height: 80px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.7);
        }
        .user-profile-card .card-info {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .user-profile-card .card-info .name {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-profile-card .card-info .bio {
            font-size: 15px;
            opacity: 0.7;
            white-space: normal; /* 允许换行 */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 最多显示2行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Char 角色列表容器 */
        .char-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 每行两个 */
            gap: 16px;
        }

        /* Char 角色卡片 (4x3 纵向) */
        .char-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            
            /* 4x3 比例 (纵向): 宽度4，高度3 */
            width: 100%;
            aspect-ratio: 3 / 4; /* 高度是4，宽度是3 */
            display: flex;
            flex-direction: column; /* 垂直排列 */
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 10px;
        }
        .char-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .char-card .card-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.7);
        }
        .char-card .card-info .name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .char-card .card-info .bio {
            font-size: 12px;
            opacity: 0.6;
            white-space: normal;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .char-card .card-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* 角色详情展开效果 (信封/档案 - 模态框内部样式) */
        .profile-detail-content {
            padding: 24px;
            width: 100%; /* 模态框内部内容宽度自适应 */
            max-width: 500px; /* 限制最大宽度，与模态框一致 */
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 300px;
            max-height: calc(95vh - 48px); /* 减去上下padding */
        }
        @media (max-width: 520px) { /* 根据新的模态框尺寸调整媒体查询 */
            .profile-detail-content {
                max-width: 95vw; /* 小屏幕下宽度自适应 */
            }
        }
        /* 新增：角色编辑页面内的表单样式 */
        .profile-edit-form .modal-form-group {
            margin-bottom: 15px; /* 表单项之间增加间距 */
        }
        .profile-edit-form .modal-form-group label {
            margin-bottom: 8px;
        }
        .profile-edit-form .button-container {
            margin-top: 30px; /* 按钮上方增加间距 */
        }
        /* 角色卡片编辑按钮图标 */
        .edit-char-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            margin-left: 5px; /* 与名字保持一定距离 */
            opacity: 0.4; /* 很淡 */
            transition: opacity 0.2s;
            vertical-align: middle; /* 垂直居中对齐文本 */
            flex-shrink: 0; /* 防止被压缩 */
            display: inline-flex; /* 确保svg内部元素对齐 */
            align-items: center;
            justify-content: center;
        }
        .edit-char-btn:hover {
            opacity: 0.7;
        }
        .edit-char-btn svg {
            width: 14px; /* 小一点 */
            height: 14px;
            fill: #cdcdcd; /* 淡灰色 */
            /* 确保SVG的填充色直接应用到path上 */
        }
        body.dark-mode .edit-char-btn svg path {
            fill: #a1a1aa; /* 暗黑模式下的淡灰色 */
        }
        /* === 新增：角色档案编辑页特殊样式 === */
        .detail-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--glass-border);
        }
        .detail-section-header label {
            font-size: 16px !important;
            font-weight: 600 !important;
            opacity: 0.8;
            margin-bottom: 0 !important;
        }
        .dynamic-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .dynamic-list-item .modal-input {
            flex-grow: 1;
        }
        .dynamic-list-item .range-input {
            flex-grow: 0;
            width: 80px;
            text-align: center;
        }
        .delete-item-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            flex-shrink: 0;
        }
        .delete-item-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
            opacity: 0.5;
        }
        .delete-item-btn:hover svg {
            opacity: 1;
        }
        .delete-item-btn:hover svg {
            opacity: 1;
        }

        /* === 新增：阶段性人设范围输入框样式 === */
        .range-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }
        .range-input-container .modal-input {
            flex: 1; /* 让输入框在flex布局中平均分配空间 */
            text-align: center;
            min-width: 60px; /* 新增：保证一个最小宽度，防止被过度压缩 */
        }
        .range-input-separator {
            font-weight: bold;
        }

        /* 调整卡片名字的flex布局以便容纳编辑按钮 */
        .char-card .card-info .name {
            display: inline-block; 
            align-items: center; /* 垂直居中对齐 */
            max-width: calc(100% - 20px); 
            word-break: break-all; 
            white-space: normal; 
            line-height: 1.2;
            
            writing-mode: vertical-rl;
            letter-spacing: 2px; 
            max-height: 70px; 
            text-overflow: ellipsis; 
            overflow: hidden; 
            white-space: nowrap; 
        }

        .profile-detail-header-section {
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 20px;
        }

        .profile-detail-avatar-large {
            width: 90px; /* 立绘宽度 */
            aspect-ratio: 9 / 16;
            border-radius: 8px;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            box-shadow: var(--glass-shadow);
        }

        .profile-detail-basic-info-display {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .profile-detail-basic-info-display .name {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-color);
        }
        .profile-detail-basic-info-display .meta-info {
            font-size: 14px;
            opacity: 0.8;
            color: var(--text-color);
        }

        .profile-detail-extended-info-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .profile-detail-extended-info-display .field-group {
            display: flex;
            flex-direction: column;
        }
        .profile-detail-extended-info-display .field-group label {
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        .profile-detail-extended-info-display .field-group span {
            font-size: 15px;
            opacity: 0.9;
            line-height: 1.5;
            padding-left: 5px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            padding: 8px;
            white-space: pre-wrap;
        }
        
        /* 可折叠区域样式 */
        .field-group.collapsible {
            position: relative;
        }
        
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
        }
        
        .collapse-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .collapse-toggle:hover {
            opacity: 1;
        }
        
        .collapse-toggle::after {
            content: '▼';
            transition: transform 0.2s;
        }
        
        .collapse-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        /* 在这里添加新样式，紧接着 .field-group span { ... } 后面 */
        /* === 聊天框工具栏面板 (新增) === */
        #chat-tool-panel {
            /* 移除自身背景和边框，让它“浸入”父级的模糊效果中 */
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-top: none; 
            padding: 20px 10px;
            max-height: 0;
            /* 修改：允许垂直滚动 */
            overflow-y: auto; 
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
            /* 初始隐藏时移除padding */
            padding-top: 0;
            padding-bottom: 0;
        }

        #chat-tool-panel.visible {
            /* 设定一个固定高度，刚好可以容纳两行图标 + padding */
            max-height:180px; 
            padding-top: 10px;
            padding-bottom: 10px;
        }


        #chat-tool-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            row-gap: 16px; /* 修改：减小行间距，使整体更紧凑 */
        }

        .tool-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            cursor: pointer;
        }

        .tool-panel-icon-box {
            width: 52px; /* 修改：缩小宽度 */
            height: 52px; /* 修改：缩小高度 */
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 14px; /* 修改：为获得更好的视觉比例，轻微增加圆角 */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.1s ease;
            position: relative; /* 新增：为修复层级问题创建堆叠上下文 */
        }


        .tool-panel-item:active .tool-panel-icon-box {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 1);
        }

        body.dark-mode .tool-panel-icon-box {
            background-color: rgba(63, 63, 70, 0.8);
            border: 1px solid rgba(82, 82, 90, 0.7);
        }

        body.dark-mode .tool-panel-item:active .tool-panel-icon-box {
            background-color: rgba(82, 82, 90, 1);
        }

        .tool-panel-icon-box svg {
            width: 28px; /* 修改：缩小SVG图标宽度 */
            height: 28px; /* 修改：缩小SVG图标高度 */
            z-index: 1; /* 新增：确保SVG图标层级高于父元素的背景 */
        }

        .tool-panel-icon-box svg path {
            fill: var(--icon-color) !important;
        }

        .tool-panel-name {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.8;
        }


        /* === Message Context Menu Styles (新增) === */
        #message-context-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2500; /* 需要比所有聊天界面元素都高 */
            display: none; /* 默认隐藏 */
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            background-color: rgba(0, 0, 0, 0.1);
        }

        #message-context-menu.visible {
            display: block; /* 改为block以进行定位 */
            opacity: 1;
        }

        #context-menu-buttons {
            position: absolute;
            display: flex;
            gap: 8px; /* 减小间距 */
            padding: 7px; /* 减小内边距 */
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 999px; /* 圆弧形边框 */
            box-shadow: 0 0 20px 3px color-mix(in srgb, var(--accent-color) 30%, transparent); /* 主题色辉光 */
            
            /* 动画效果 */
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transform-origin: center center;
            transition: opacity 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            will-change: transform, opacity;
        }

        #message-context-menu.visible #context-menu-buttons {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .context-menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 48px; /* 减小宽度 */
            height: 48px; /* 减小高度 */
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .context-menu-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .context-menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .context-menu-button svg {
            width: 20px; /* 图标大小固定 */
            height: 20px;
        }

        .context-menu-button svg path {
            fill: var(--icon-color) !important; /* 颜色强制固定 */
        }

        .context-menu-button span {
            font-size: 10px; /* 小字解释 */
            font-weight: 500;
            color: var(--text-color);
            opacity: 0.8;
        }
        /* === 在这里添加新样式，紧接着 .field-group span { ... } 后面 === */

        /* === 引用功能样式 (新增) === */
        #quote-preview-container {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 8px 12px 8px 35px; /* 左侧留出关闭按钮位置 */
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            position: relative;
            display: none; /* 默认隐藏 */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        body.dark-mode #quote-preview-container {
             background-color: rgba(255, 255, 255, 0.08);
        }
        #quote-preview-close {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #quote-preview-close svg {
            width: 16px;
            height: 16px;
            fill: var(--text-color);
        }
        .quoted-message-in-bubble {
            background-color: rgba(0, 0, 0, 0.08);
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            border-left: 3px solid var(--accent-color);
            opacity: 0.8;
            white-space: pre-wrap; /* 保留换行 */
            word-break: break-all;
        }
        .chat-bubble.sent .quoted-message-in-bubble {
             background-color: rgba(255, 255, 255, 0.2);
             border-left-color: #fff;
        }
        /* 长按时不选中文字，但允许通过JS进行复制操作 */
        .chat-bubble.received {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }


        /* === 重回功能样式 (重构) === */
        #alternative-replies-container {
            position: absolute;
            /* 自动检测位置，JS会处理 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column; /* 改为正序排列 */
            gap: 8px;
            max-height: 40vh; /* 限制最大高度 */
            overflow-y: auto;
            align-items: center;
            /* 【需求1修改】移除固定宽度，由JS动态设置 */
            max-width: 90vw; /* 保留一个最大宽度以防意外 */
            z-index: 2600; /* 确保在菜单之上 */
        }

        .alternative-reply-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px; /* 圆角稍大 */
            padding: 10px; /* 内边距 */
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--glass-shadow);
            width: 100%; /* 宽度撑满容器 */
            opacity: 0.95;
            display: flex; /* 内部使用flex布局 */
            flex-direction: column;
            gap: 5px; /* 内部气泡的间距 */
        }
        .alternative-reply-card:hover {
            opacity: 1;
            border-color: color-mix(in srgb, var(--accent-color) 50%, transparent);
            transform: scale(1.01); /* 悬浮效果微调 */
        }

         /* 新增：卡片内部的单行回复气泡样式 */
        .alt-reply-line {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 999px;
            background-color: var(--accent-color);
            color: white;
            font-weight: 500;
            opacity: 0.6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: none;
            
            /* === 核心修改：实现自适应宽度 === */
            width: fit-content;      /* 宽度根据内容自适应 */
            max-width: 100%;         /* 最大宽度不超过父容器（卡片） */
            align-self: flex-start;  /* 从左侧开始排列 */
        }


        /* body.dark-mode .alt-reply-line 的样式不再需要，因为 accent-color 会自动适应主题 */

        /* === 新增：聊天框长按功能相关样式 === */

        /* --- 1. 多选模式 --- */
        #chat-messages-container.multi-select-mode {
            /* 新增：为底部工具栏留出空间，70px是一个安全距离 */
            padding-bottom: 70px;
        }

        #chat-messages-container.multi-select-mode .message-line {
            padding-left: 40px; /* 为选择框留出空间 */
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #chat-messages-container.multi-select-mode .message-line::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            background-color: #fff;
            transition: all 0.2s;
        }

        #chat-messages-container.multi-select-mode .message-line.selected {
            background-color: rgba(9, 132, 227, 0.1);
        }

        #chat-messages-container.multi-select-mode .message-line.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
            background-size: 14px;
        }

        /* --- 2. 多选工具栏 --- */
        #multi-select-toolbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            padding: 10px 20px;
            border-top: 1px solid var(--glass-border);
            display: none; /* 默认隐藏 */
            justify-content: space-between;
            align-items: center;
            z-index: 20;
        }
        
        #multi-select-toolbar.visible {
            display: flex;
        }

        #multi-select-toolbar .action-buttons button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            margin-left: 20px;
            opacity: 0.5;
            pointer-events: none;
        }
        
        #multi-select-toolbar .action-buttons button.active {
            opacity: 1;
            pointer-events: auto;
            font-weight: 600;
        }

        /* --- 3. 撤回消息样式 --- */
        .retracted-message-notice {
            align-self: center; /* 居中显示 */
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            opacity: 0.7;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap; /* 防止文字换行 */
            text-align: center;
        }
        
        .retracted-message-notice .clickable-retract {
            cursor: pointer;
            color: var(--accent-color);
            text-decoration: underline;
        }
        
        /* --- 4. 撤回内容悬浮窗 --- */
        #retracted-content-popover {
            position: fixed;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            max-width: 80vw;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            z-index: 3000;
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }

        #retracted-content-popover.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        #retracted-content-popover .original-content {
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        #retracted-content-popover .inner-thought {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--glass-border);
            font-size: 13px;
            font-style: italic;
            opacity: 0.7;
        }

        /* --- 5. 编辑消息悬浮窗 --- */
        #edit-message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 2800;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #edit-message-modal.visible {
            display: flex;
        }
        
        .edit-message-box {
            background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .edit-message-box textarea {
            width: 100%;
            min-height: 100px;
            max-height: 40vh;
            resize: vertical;
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: rgba(128,128,128,0.1);
            color: var(--text-color);
            user-select: text;
        }

        .edit-message-box .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* === 新增：内心声音悬浮窗样式 === */
        #inner-voice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* 核心修改：移除黑色背景，只保留模糊效果 */
            background-color: transparent; 
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            z-index: 2900;
            display: none; /* 默认隐藏 */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #inner-voice-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #inner-voice-modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow);
            width: 90%;
            max-width: 320px;
            /* [修改] 移除内边距，让头图可以贴合边框 */
            padding: 0; 
            display: flex;
            flex-direction: column;
            /* [修改] 移除gap，由内部wrapper控制 */
            /* gap: 18px; */
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* [新增] 隐藏溢出的头像部分以适配圆角 */
            overflow: hidden; 
        }

        #inner-voice-overlay.visible #inner-voice-modal {
            transform: scale(1);
        }

        /* [新增] 头像区域样式 */
        #inner-voice-avatar-area {
            width: 100%;
            aspect-ratio: 5 / 3; /* 5:3的宽高比 */
            background-size: cover;
            /* 截取中间偏上部分，可以微调 25% 这个值 */
            background-position: center 25%; 
            /* [核心] 使用遮罩实现底部渐变消失 */
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
        }

        /* [新增] 内容包裹器，用于控制内边距和布局 */
        #inner-voice-content-wrapper {
            padding: 12px 24px 24px; /* 顶部留白减少，左右下不变 */
            display: flex;
            flex-direction: column;
            gap: 18px; /* 恢复原有的项目间距 */
            text-align: center; /* 让内部的姓名居中 */
        }
        
        /* [新增] 角色姓名样式 */
        #inner-voice-char-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 6px; /* 与下方好感度拉开一点距离 */
        }

        .voice-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* [新增] 抵消父元素的居中对齐，让label和内容左对齐 */
            text-align: left;
        }


        .voice-section label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
        }

        .voice-content {
            font-size: 15px;
            color: var(--text-color);
            line-height: 1.5;
            background: rgba(0,0,0,0.04);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        body.dark-mode .voice-content {
            background: rgba(255,255,255,0.06);
        }

        #true-feeling-field .voice-content {
            font-style: italic;
            font-weight: bold;
            color: color-mix(in srgb, var(--accent-color) 80%, #000);
        }
        body.dark-mode #true-feeling-field .voice-content {
            color: color-mix(in srgb, var(--accent-color) 80%, #fff);
        }

        .favor-bar-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .favor-bar-track {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .favor-bar-progress {
            width: 0%; /* JS会控制这个宽度 */
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .favor-bar-text {
            font-size: 14px;
            font-weight: 500;
            min-width: 45px; /* 稍微加宽以容纳负号和三位数 */
            text-align: right;
        }
        @keyframes message-pop-in {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .message-line.received.new-message-animate {
            /* 应用动画，forwards 保持动画结束状态 */
            animation: message-pop-in 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        /* === 记忆 App 新增样式 === */
        .memory-nav-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            padding: 6px; /* 微调padding */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--pill-radius);
            box-shadow: var(--glass-shadow);
            z-index: 10;
            transition: all 0.3s ease; /* 为宽度变化增加过渡动画 */
        }


        .memory-nav-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--pill-radius);
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            transition: background-color 0.2s;
        }

        .memory-nav-btn.active {
            background-color: rgba(0,0,0,0.1);
        }
        body.dark-mode .memory-nav-btn.active {
            background-color: rgba(255,255,255,0.15);
        }

        .memory-nav-btn svg {
            width: 20px;
            height: 20px;
        }
        .memory-nav-btn svg path {
            fill: var(--icon-color) !important;
        }
        .memory-nav-btn span {
            /* --- 修改开始 --- */
            display: inline-block; /* 改为 inline-block 以应用宽度 */
            max-width: 0;          /* 初始最大宽度为0，实现隐藏 */
            opacity: 0;            /* 初始完全透明 */
            overflow: hidden;      /* 隐藏超出的内容 */
            white-space: nowrap;   /* 防止文字在动画过程中换行 */
            vertical-align: middle;/* 确保文字和图标垂直对齐 */
            transition: max-width 0.3s ease-out, opacity 0.2s ease-out, margin-left 0.3s ease-out; /* 添加过渡动画 */
            margin-left: 0;        /* 初始没有左边距 */
            /* --- 修改结束 --- */
        }
        .memory-nav-btn.active {
            background-color: rgba(0,0,0,0.1);
        }
        .memory-nav-btn.active span {
            /* --- 修改开始 --- */
            max-width: 50px;      /* 激活时给一个足够大的最大宽度，比如50px */
            opacity: 1;           /* 完全显示 */
            margin-left: 2px;     /* 激活时添加左边距，隔开图标 */
            /* 无需再设置 display 属性 */
            /* --- 修改结束 --- */
        }

        .memory-page {
            display: none; /* 默认所有页面隐藏 */
            height: calc(100% - 70px); /* 留出底部导航条空间 */
        }

        .memory-page.active {
            display: block; /* 激活的页面显示 */
        }
        
        /* 聊天收藏馆卡片样式 */
        .collection-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            /* 需求1: 禁用移动端长按选中文字 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .collection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }
        .collection-card-char-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }
        .collection-card-info {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
        }

        /* 收藏详情弹窗 */
        #collection-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000; /* 比通用模态框高 */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #collection-detail-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #collection-detail-modal {
            background: var(--bg-color-start);
            border-radius: var(--card-radius);
            width: 90%;
            max-width: 480px;
            height: 75%;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--glass-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #collection-detail-overlay.visible #collection-detail-modal {
             transform: scale(1);
             opacity: 1;
        }
        #collection-detail-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }
        #collection-detail-title {
            font-weight: 600;
        }
        #collection-detail-close-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
        }
        #collection-detail-close-btn svg {
            width: 24px; height: 24px; fill: var(--text-color);
        }

        #collection-detail-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* === 记忆App长按菜单样式 (新增) === */
        #memory-context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1500;
            background-color: transparent;
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        #memory-context-menu-overlay.visible {
            display: block;
            opacity: 1;
        }
        #memory-context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            min-width: 120px;
            opacity: 0;
            transform: scale(0.95);
            transform-origin: top left;
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none;
        }
        #memory-context-menu-overlay.visible #memory-context-menu {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .memory-context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            transition: background-color 0.15s ease;
        }
        .memory-context-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .memory-context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        /* === 在这里添加新样式 === */

        /* === 新增：副本App基础设置悬浮窗样式 === */
        #instance-base-settings-body {
            display: flex;
            flex-direction: column;
            gap: 20px; /* 各板块之间的间距 */
            max-height: 60vh; /* 限制内容最大高度，超出则滚动 */
            overflow-y: auto;
            padding: 10px 5px; /* 微调内边距 */
            margin: 0 -5px;
        }

        .instance-settings-section {
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        body.dark-mode .instance-settings-section {
            background: rgba(255,255,255,0.05);
        }

        .instance-settings-section h5 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
        }

        .placeholder-section-content {
            color: var(--text-color);
            opacity: 0.5;
            font-size: 14px;
            text-align: center;
            padding: 20px 0;
        }

        /* === 新增：副本App专属样式 === */

        /* 副本App模态框内右上角的设置按钮容器 */
        #instance-app-header-controls {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        #instance-settings-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            line-height: 1; /* 确保图标垂直居中 */
        }
        #instance-settings-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--icon-color);
        }
        #instance-settings-btn:active {
            opacity: 0.6;
        }

        /* 副本App设置侧边栏的遮罩层 */
        #instance-settings-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 1050; /* 比模态框高，比侧边栏低 */
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #instance-settings-sidebar-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* 副本App设置侧边栏本体 */
        #instance-settings-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 60px; /* 狭窄的宽度，只容纳一列图标 */
            height: 100%;
            background-color: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-left: 1px solid var(--glass-border);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            z-index: 1100; /* 最高层级 */
            transform: translateX(100%); /* 默认隐藏在屏幕右侧 */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 60px 0; /* 顶部留出空间 */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* 按钮之间的间距 */
        }
        #instance-settings-sidebar.visible {
            transform: translateX(0); /* 显示时移动到屏幕内 */
        }

        /* 侧边栏内的按钮样式 */
        .instance-sidebar-btn {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .instance-sidebar-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .instance-sidebar-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .instance-sidebar-btn svg {
            width: 24px; /* 图标大小 */
            height: 24px;
        }
        /* 确保SVG图标颜色能正确应用 */
        .instance-sidebar-btn svg path {
            fill: var(--icon-color) !important;
        }
                /* === 新增：副本App - 预设管理样式 === */
        .prompt-preset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }
        body.dark-mode .prompt-preset-list {
             background: rgba(255,255,255,0.04);
        }

        .prompt-preset-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .prompt-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .prompt-item-title {
            font-weight: 500;
            flex-grow: 1;
            margin-right: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .prompt-item-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--glass-border);
            font-size: 13px;
            opacity: 0.8;
            white-space: pre-wrap; /* 保持格式 */
            word-break: break-word;
            max-height: 120px;
            overflow-y: auto;
            background: rgba(0,0,0,0.02);
            padding: 8px;
            border-radius: 6px;
            display: none; /* 默认隐藏 */
        }
        .prompt-preset-item.expanded .prompt-item-content {
            display: block;
        }

        /* 添加条目按钮样式 */
        .add-prompt-entry-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            font-size: 14px;
        }
        
        /* 副本卡片列表容器 */
        #instance-list-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 10px 0;
            height: 100%;
            overflow-y: auto;
        }

        /* 副本卡片样式 */
        .instance-card {
            width: 100%;
            aspect-ratio: 16 / 7; /* 横向卡片比例 */
            border-radius: var(--card-radius);
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: flex-end; /* 标题置于底部 */
            transition: transform 0.2s ease;
        }
        .instance-card:hover {
            transform: scale(1.02);
        }

        /* 卡片标题蒙层 */
        .instance-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60%; /* 渐变蒙层高度 */
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            pointer-events: none;
        }

        .instance-card-title {
            position: relative;
            z-index: 2;
            color: white;
            font-size: 20px;
            font-weight: 700;
            padding: 16px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* 副本创建悬浮窗样式 */
        .instance-form-cover-preview {
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: 12px;
            background-color: #e2e8f0;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--glass-border);
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 16px;
        }
        .instance-form-cover-preview span {
            font-size: 14px;
        }
        body.dark-mode .instance-form-cover-preview {
            background-color: rgba(255,255,255,0.1);
        }

        /* AI生成区域样式 */
        .ai-generation-section {
            padding: 16px;
            margin-top: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
        }
        body.dark-mode .ai-generation-section {
            background: rgba(255,255,255,0.05);
        }

        /* === 副本详情页专属UI样式 (新增) === */
        #instance-popup-box.instance-detail-view {
            padding: 0; /* 移除内边距，让封面可以贴边 */
            overflow: hidden; /* 裁剪封面超出圆角的部分 */
        }
        
        .instance-detail-cover {
            width: 100%;
            aspect-ratio: 16 / 9; /* 封面比例 */
            background-size: cover;
            background-position: center;
            /* 核心：底部渐变遮罩 */
            -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }

        .instance-detail-body {
            padding: 24px; /* 为内容区添加内边距 */
            text-align: center; /* 方便标题居中 */
        }

        .instance-detail-main-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--icon-color);
        }

        /* 详情页的描述和开场白部分 */
        .instance-detail-body .modal-form-group {
            text-align: left; /* 确保label和pre左对齐 */
        }
        .instance-detail-body .modal-form-group pre {
            user-select: text; /* 允许用户选择复制文本 */
            -webkit-user-select: text;
        }

        /* 详情页底部按钮容器 */
        #instance-popup-footer.detail-footer {
            justify-content: space-between; /* 两端对齐 */
            align-items: center;
        }

        /* 删除按钮样式 */
        .instance-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px; /* 增加点击区域 */
        }
        .instance-delete-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .instance-delete-btn:hover svg {
            opacity: 1;
        }
                /* === 新增：副本App - 预设管理样式 === */
        .prompt-preset-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }
        body.dark-mode .prompt-preset-list {
             background: rgba(255,255,255,0.04);
        }

        .prompt-preset-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .prompt-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .prompt-item-title {
            font-weight: 500;
            flex-grow: 1;
            margin-right: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .prompt-item-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--glass-border);
            font-size: 13px;
            opacity: 0.8;
            white-space: pre-wrap; /* 保持格式 */
            word-break: break-word;
            max-height: 120px;
            overflow-y: auto;
            background: rgba(0,0,0,0.02);
            padding: 8px;
            border-radius: 6px;
            display: none; /* 默认隐藏 */
        }
        .prompt-preset-item.expanded .prompt-item-content {
            display: block;
        }

        /* 添加条目按钮样式 */
        .add-prompt-entry-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            font-size: 14px;
        }

        /* === 音乐 App 新增样式 (已修正) === */
        .music-app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .music-content-area {
            flex-grow: 1; /* 关键：让内容区占据所有可用空间 */
            overflow-y: auto; /* 关键：只让内容区滚动 */
            padding: 20px;
            /* 关键：为底部的悬浮条留出足够的空间，防止内容被遮挡 */
            padding-bottom: 100px;
        }

        .music-capsule-bar {
            position: fixed; /* 关键：相对于新的定位上下文（#modal-container）固定 */
            bottom: 30px; /* 关键：固定在屏幕底部 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--pill-radius);
            box-shadow: var(--glass-shadow);
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .music-capsule-btn {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: var(--pill-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            overflow: hidden;
            white-space: nowrap;
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
        }
        
        .music-capsule-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color);
            flex-shrink: 0;
        }

        .music-capsule-btn span {
            display: inline-block;
            max-width: 0;
            opacity: 0;
            transition: max-width 0.3s ease-out, opacity 0.2s ease-out, margin-left 0.3s ease-out;
            margin-left: 0;
            vertical-align: middle;
        }

        .music-capsule-btn.active {
            background-color: rgba(0, 0, 0, 0.08);
        }
        
        .music-capsule-btn.active span {
            max-width: 50px;
            opacity: 1;
            margin-left: 8px;
        }

        body.dark-mode .music-capsule-btn.active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* "我的" 页面专属样式 (保持不变) */
        .my-page-container {
            width: 100%;
        }

        .my-page-profile-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-page-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: rgba(128, 128, 128, 0.2);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .my-page-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .my-page-nickname {
            font-size: 20px;
            font-weight: 700;
            color: var(--icon-color);
        }
        
        .my-page-stats {
            font-size: 13px;
            color: var(--text-color);
            opacity: 0.8;
            display: flex;
            gap: 12px;
        }

        /* === 新增：全局顶部消息提示框样式 === */
        #global-message-banner-container {
            position: fixed;
            top: 20px; /* 距离屏幕顶部20px */
            left: 0;
            right: 0;
            z-index: 9999;
            display: flex;
            justify-content: center;
            pointer-events: none; /* 容器不捕获事件，让下层可交互 */
        }

        .global-message-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            width: 95%;
            max-width: 480px; /* 限制最大宽度 */
            
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px; /* 需求：圆角15px */
            box-shadow: var(--glass-shadow);
            
            color: var(--text-color);
            cursor: pointer;
            pointer-events: auto; /* 提示框本身可以捕获事件 */

            /* 默认隐藏，通过动画显示 */
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }

        /* 进入动画 */
        .global-message-banner.showing {
            animation: banner-pop-in 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }

        /* 离开动画 */
        .global-message-banner.hiding {
            animation: banner-pop-out 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes banner-pop-in {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes banner-pop-out {
            to {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
        }

        .banner-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px; /* 小圆角 */
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .banner-info {
            flex-grow: 1;
            overflow: hidden; /* 关键，让内部的省略号生效 */
        }

        .banner-name {
            font-weight: 600;
            font-size: 15px;
        }

        .banner-message {
            font-size: 14px;
            white-space: nowrap; /* 不换行 */
            overflow: hidden; /* 超出部分隐藏 */
            text-overflow: ellipsis; /* 显示省略号 */
            opacity: 0.8;
            margin-top: 2px;
        }


/* 自定义提示框样式 */
.custom-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
.custom-alert-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
.custom-alert-box {
    background: var(--bg-color-start);
    border-radius: 16px;
    padding: 24px;
    width: 90%;
    max-width: 320px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.custom-alert-overlay.visible .custom-alert-box {
    transform: scale(1);
}
.custom-alert-box p {
    margin: 0 0 20px 0;
    font-size: 16px;
    line-height: 1.5;
    color: var(--text-color);
}
.load-previous-btn {
    background-color: transparent;
    border: 1px solid transparent; /* 默认边框透明 */
    color: var(--text-color-secondary, #64748b);
    padding: 6px 12px;
    font-size: 13px; /* 字体变小 */
    border-radius: 999px; /* 胶囊形状 */
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
}

.load-previous-btn:active { /* 点击时触发 */
    background-color: rgba(128, 128, 128, 0.1);
    border-color: rgba(128, 128, 128, 0.2);
}


.custom-alert-box .modal-input {
    text-align: left; /* 确保输入框文本左对齐 */
    user-select: text;
}

/* GitHub 设置输入框的折叠容器 */
#github-credentials-container {
    display: flex;
    flex-direction: column;
    gap: 16px; /* 使用与 modal-form-group 类似的间距 */
    overflow: hidden;
    max-height: 500px; /* 一个足够大的初始高度 */
    transition: max-height 0.4s ease-out, margin-bottom 0.4s ease-out;
}

#github-credentials-container.collapsed {
    max-height: 0;
    margin-bottom: 0 !important; /* 折叠时移除底部间距 */
}

/* 最近同步时间小字样式 */
.last-sync-time {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.6;
    text-align: center;
    margin-top: 4px;
    margin-bottom: 16px;
}

/* 在这里添加新样式 */

/* 为危险操作按钮添加样式 */
.modal-button.danger {
    background-color: #ef4444; /* 醒目的红色 */
    color: white;
}
.modal-button.danger:hover {
    background-color: #dc2626; /* 悬浮时颜色加深 */
}


/* 同步间隔与手动同步按钮的容器 */
.sync-interval-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sync-interval-group .modal-input {
    flex-grow: 1;
}
.sync-interval-group .modal-button {
    flex-shrink: 0; /* 防止按钮被压缩 */
    padding: 10px 14px; /* 调整按钮大小 */
}

/* 导出/导入按钮容器样式 */
.backup-actions-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 10px;
}

/* === 新增：全局非阻塞式顶部提示框 (Toast) 样式 === */
#toast-container {
    position: fixed;
    top: 20px; /* 距离顶部一点距离 */
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000; /* 确保在最上层 */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: auto;
    max-width: 90%;
}

.toast {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 16px; /* 圆弧形胶囊边框 */
    box-shadow: var(--glass-shadow);
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateY(-20px);
    animation: toast-fade-in 0.3s ease-out forwards;
    position: relative; /* 为了倒计时条定位 */
    overflow: hidden; /* 隐藏超出部分的倒计时条 */
    min-width: 280px; /* 保证最小宽度 */
    justify-content: space-between;
}

@keyframes toast-fade-in {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes toast-fade-out {
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

.toast.hiding {
    animation: toast-fade-out 0.3s ease-in forwards;
}

/* 提示框内的按钮 */
.toast-buttons button {
    background: none;
    border: 1px solid var(--glass-border);
    color: var(--text-color);
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
}

.toast-buttons button:hover {
    background-color: rgba(0,0,0,0.05);
}

.toast-buttons button.confirm {
    background-color: var(--accent-color);
    color: white;
    border-color: transparent;
}
body.dark-mode .toast-buttons button:hover {
    background-color: rgba(255,255,255,0.08);
}


/* 倒计时条 */
.toast-countdown-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px; /* 细条 */
    width: 100%;
    background-color: var(--accent-color);
    transform-origin: left;
    animation: shrink-width 5s linear forwards;
}

@keyframes shrink-width {
    from {
        width: 100%;
    }
    to {
        width: 0%;
    }
}

/* 不同类型的图标/颜色 */
.toast.success {
    border-left: 4px solid #22c55e; /* Green-500 */
}

.toast.error {
    border-left: 4px solid #ef4444; /* Red-500 */
}
/* === 新增：聊天框表情包功能样式 === */

/* 表情包主面板，与工具面板平级 */
#emoji-panel {
    display: none; /* 默认隐藏 */
    flex-direction: column;
    width: 100%;
    /* 高度由JS控制，与工具面板一致 */
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
}
#emoji-panel.visible {
    display: flex;
    max-height: 240px; /* 设定一个合适的高度 */
    padding-top: 5px;
    padding-bottom: 5px;
}

/* 面板头部：返回和管理按钮 */
#emoji-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    margin-bottom: 10px;
    flex-shrink: 0;
}
#emoji-panel-header .header-btn {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    opacity: 0.7;
}
#emoji-panel-header .header-btn:hover {
    opacity: 1;
}
#emoji-panel-header .header-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
    vertical-align: middle;
}

/* 表情包网格 */
#emoji-grid {
    flex-grow: 1;
    overflow-y: auto;
    display: grid; /* 【修改】使用 grid 布局 */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* 【修改】自动填充，每项最小80px */
    gap: 15px; /* 网格间距 */
    padding: 10px 20px; /* 调整内边距 */
}
.emoji-item {
    display: flex;
    flex-direction: column; /* 【修改】改为垂直布局，图片在上文字在下 */
    align-items: center; /* 水平居中 */
    gap: 8px; /* 图片和文字的间距 */
    padding: 8px;
    background-color: transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease; /* 增加 transform 过渡 */
}

.emoji-item:hover {
    background-color: rgba(0,0,0,0.05);
}
.emoji-item:active {
    background-color: rgba(0,0,0,0.1);
    transform: scale(0.98); /* 轻微的点击反馈 */
}
.emoji-item .emoji-image-wrapper {
    width: 60px; /* 固定图片容器宽度 */
    height: 60px;
    flex-shrink: 0; /* 防止被压缩 */
    background-color: rgba(255,255,255,0.8);
    border-radius: 6px;
    overflow: hidden;
}
.emoji-item img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* 改为 contain 以完整显示表情 */
}
.emoji-item .emoji-desc {
    font-size: 12px; /* 【修改】缩小字体以适应网格 */
    font-weight: 500;
    color: var(--text-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center; /* 【修改】文本居中 */
    width: 100%; /* 确保文本溢出省略号生效 */
    opacity: 0.8;
}

body.dark-mode .emoji-item:hover {
    background-color: rgba(255,255,255,0.05);
}
body.dark-mode .emoji-item:active {
    background-color: rgba(255,255,255,0.1);
}
body.dark-mode .emoji-item .emoji-image-wrapper {
    background-color: rgba(63, 63, 70, 0.7);
}


/* 底部表情包分组导航条 */
#emoji-group-bar {
    flex-shrink: 0;
    border-top: 1px solid var(--glass-border);
    padding: 5px 10px;
    display: flex;
    gap: 5px;
    overflow-x: auto;
    /* 隐藏滚动条 */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
}
#emoji-group-bar::-webkit-scrollbar {
    display: none; /* Chrome, Safari, and Opera */
}
.emoji-group-tab {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    background-color: transparent;
    flex-shrink: 0;
}
.emoji-group-tab.active {
    background-color: rgba(0,0,0,0.1);
}
.emoji-group-tab img {
    height: 24px;
    width: 24px;
    object-fit: contain;
}
body.dark-mode .emoji-group-tab.active {
    background-color: rgba(255,255,255,0.15);
}

/* 话题功能悬浮窗样式 */
#topic-management-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.3);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
    z-index: 2100; /* 比聊天设置高 */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
}
#topic-management-modal-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
#topic-management-modal {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    height: 80%;
    max-height: 600px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

/* 话题设置折叠板块样式 */
#topic-settings-details {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    margin-bottom: 20px;
    padding: 5px 15px;
}
body.dark-mode #topic-settings-details {
    background: rgba(255,255,255,0.05);
}
#topic-settings-details[open] #topic-settings-form {
    padding-top: 15px; /* 展开时增加顶部间距 */
}
#topic-settings-form {
    background: rgba(0,0,0,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
}
body.dark-mode #topic-settings-form {
    background: rgba(255,255,255,0.05);
}

/* 表情包管理悬浮窗 */
#emoji-management-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.3);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
    z-index: 2100; /* 比聊天设置高 */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
}
#emoji-management-modal-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}
#emoji-management-modal {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    height: 80%;
    max-height: 600px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}
#emoji-management-modal-overlay.visible #emoji-management-modal {
    transform: scale(1);
}
.emoji-management-header {
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.emoji-management-header button {
    background: none; border:none; cursor: pointer; padding: 4px;
}
.emoji-management-header button svg {
    width: 24px; height: 24px; fill: var(--text-color);
}

.emoji-management-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
}
/* 管理悬浮窗内的分组样式 */
#add-emoji-group-details {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    margin-bottom: 20px;
    padding: 5px 15px;
}
body.dark-mode #add-emoji-group-details {
    background: rgba(255,255,255,0.05);
}
#add-emoji-group-details[open] #add-emoji-group-form {
    padding-top: 15px; /* 展开时增加顶部间距 */
}

/* 管理悬浮窗内的分组样式 */
#add-emoji-group-form {
    background: rgba(0,0,0,0.05);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
}
body.dark-mode #add-emoji-group-form {
    background: rgba(255,255,255,0.05);
}
#emoji-group-list details {
    border-bottom: 1px solid var(--glass-border);
}
#emoji-group-list summary {
    padding: 15px 10px;
    font-weight: 600;
    cursor: pointer;
    list-style: none; /* 移除默认箭头 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#emoji-group-list summary::-webkit-details-marker {
    display: none;
}
#emoji-group-list summary::after { /* 自定义箭头 */
    content: '›';
    font-size: 24px;
    transform: rotate(90deg);
    transition: transform 0.2s;
}
#emoji-group-list details[open] summary::after {
    transform: rotate(-90deg);
}
.emoji-group-content {
    padding: 10px 15px 20px 15px;
    background: rgba(0,0,0,0.03);
}
body.dark-mode .emoji-group-content {
    background: rgba(0,0,0,0.1);
}
.group-emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 10px;
}
.group-emoji-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.group-emoji-item img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer; /* 用于双击删除 */
}
.group-emoji-item span {
    font-size: 12px;
    opacity: 0.7;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    text-align: center;
}
#bulk-add-urls {
    min-height: 120px;
    resize: vertical;
}

/* === 在这里添加新样式 === */

/* --- 通用悬浮窗样式 (新增) --- */
.chatapp-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
    z-index: 2800; /* 需要比聊天设置侧边栏和副本界面还高 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.chatapp-popup-overlay.visible {
    display: flex;
    opacity: 1;
}

.chatapp-popup-box {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.chatapp-popup-overlay.visible .chatapp-popup-box {
    transform: scale(1);
}

.chatapp-popup-box h4 {
    margin: 0 0 10px 0;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
}

.chatapp-popup-box .button-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* --- 图片预览悬浮窗样式 --- */
#image-preview-area {
    width: 100%;
    max-height: 40vh;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
}

#image-preview-area img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
}

#image-description-input {
    width: 100%;
    min-height: 60px;
    resize: vertical;
}

/* --- 语音输入悬浮窗样式 --- */
#voice-text-input {
    width: 100%;
    min-height: 120px;
    resize: vertical;
}

/* --- API 切换悬浮窗样式 --- */
#api-preset-list {
    max-height: 60vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.api-preset-item {
    padding: 12px 16px;
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column; /* 核心修改：将主轴方向改为垂直 */
    align-items: flex-start; /* 让内容从左侧开始对齐 */
}

.api-preset-item:hover {
    background-color: rgba(0,0,0,0.05);
}

.api-preset-item.selected {
    background-color: color-mix(in srgb, var(--accent-color) 20%, transparent);
    border-color: var(--accent-color);
    font-weight: 600;
}

.api-preset-item .reconnect-btn {
    background: none;
    border: 1px solid var(--glass-border);
    color: var(--text-color);
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 6px;
    cursor: pointer;
}
.api-preset-item.selected .reconnect-btn {
    border-color: var(--accent-color);
}


/* --- 新消息类型样式 --- */
.chat-bubble .message-image {
    max-width: 150px;
    max-height: 200px;
    border-radius: 8px;
    cursor: pointer;
    display: block;
}
        /* === 新增：图片类消息气泡样式 === */
        .chat-bubble.image-bubble {
            background-color: transparent;
            padding: 0;
            border-radius: 8px; /* 给图片本身加一个轻微的圆角，避免过于尖锐 */
            box-shadow: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* === 核心修改：确保角色发送的表情包也移除气泡样式 === */
        .message-line.received .chat-bubble.image-bubble {
            background: transparent;
        }

        /* === 新增：表情包在聊天中的显示样式 === */
        .chat-bubble .message-sticker {
            max-width: 100px;  /* 限制最大宽度，比普通图片小 */
            max-height: 100px; /* 限制最大高度 */
            display: block;    /* 确保图片表现为块级元素 */
            cursor: pointer;
        }

.message-voice-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    min-width: 80px;
}

.message-voice-bar .play-icon {
    width: 24px;
    height: 24px;
}

.chat-bubble.sent .message-voice-bar .play-icon path {
    fill: #fff;
}

.chat-bubble.received .message-voice-bar .play-icon path {
    fill: var(--icon-color);
}

.message-voice-bar .duration {
    font-size: 14px;
}

.voice-text-description {
    font-size: 14px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(0,0,0,0.1);
    display: none; /* 默认隐藏 */
}
.chat-bubble.sent .voice-text-description {
    border-top-color: rgba(255,255,255,0.2);
}
/* === 新增：语音声波图标样式 === */
.voice-wave-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    gap: 2px;
}
.voice-wave-icon .wave-bar {
    width: 3px;
    background-color: var(--icon-color);
    border-radius: 2px;
    transition: height 0.3s ease;
}
.chat-bubble.sent .voice-wave-icon .wave-bar {
    background-color: #fff;
}
/* 默认静态声波高度 */
.voice-wave-icon .wave-bar:nth-child(1) { height: 6px; }
.voice-wave-icon .wave-bar:nth-child(2) { height: 12px; }
.voice-wave-icon .wave-bar:nth-child(3) { height: 18px; }
.voice-wave-icon .wave-bar:nth-child(4) { height: 10px; }
.voice-wave-icon .wave-bar:nth-child(5) { height: 6px; }

/* 播放动画 */
@keyframes voice-wave-animation {
    0% { transform: scaleY(0.3); }
    25% { transform: scaleY(1.0); }
    50% { transform: scaleY(0.5); }
    75% { transform: scaleY(0.8); }
    100% { transform: scaleY(0.3); }
}
.message-voice-bar.playing .wave-bar {
    animation: voice-wave-animation 1.2s infinite ease-in-out;
}
/* 为每个条设置不同的动画延迟，产生滚动效果 */
.message-voice-bar.playing .wave-bar:nth-child(2) { animation-delay: 0.2s; }
.message-voice-bar.playing .wave-bar:nth-child(3) { animation-delay: 0.4s; }
.message-voice-bar.playing .wave-bar:nth-child(4) { animation-delay: 0.6s; }
.message-voice-bar.playing .wave-bar:nth-child(5) { animation-delay: 0.8s; }
/* === 在这里添加新样式 === */
.message-voice-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    min-width: 80px;
}

.voice-wave-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    gap: 2px;
}
.voice-wave-icon .wave-bar {
    width: 3px;
    border-radius: 2px;
    transition: height 0.3s ease;
}
/* 根据发送/接收方设置声波颜色 */
.chat-bubble.sent .voice-wave-icon .wave-bar {
    background-color: #fff;
}
.chat-bubble.received .voice-wave-icon .wave-bar {
    background-color: var(--icon-color);
}
/* 默认静态声波高度 */
.voice-wave-icon .wave-bar:nth-child(1) { height: 6px; }
.voice-wave-icon .wave-bar:nth-child(2) { height: 12px; }
.voice-wave-icon .wave-bar:nth-child(3) { height: 18px; }
.voice-wave-icon .wave-bar:nth-child(4) { height: 10px; }
.voice-wave-icon .wave-bar:nth-child(5) { height: 6px; }

/* 播放动画 */
@keyframes voice-wave-animation {
    0% { transform: scaleY(0.3); }
    25% { transform: scaleY(1.0); }
    50% { transform: scaleY(0.5); }
    75% { transform: scaleY(0.8); }
    100% { transform: scaleY(0.3); }
}
.message-voice-bar.playing .wave-bar {
    transform-origin: bottom;
    animation: voice-wave-animation 1.2s infinite ease-in-out;
}
/* 为每个条设置不同的动画延迟，产生滚动效果 */
.message-voice-bar.playing .wave-bar:nth-child(2) { animation-delay: 0.2s; }
.message-voice-bar.playing .wave-bar:nth-child(3) { animation-delay: 0.4s; }
.message-voice-bar.playing .wave-bar:nth-child(4) { animation-delay: 0.6s; }
.message-voice-bar.playing .wave-bar:nth-child(5) { animation-delay: 0.8s; }

.message-voice-bar .duration {
    font-size: 14px;
}

.voice-text-description {
    font-size: 14px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(0,0,0,0.1);
    display: none; /* 默认隐藏 */
    white-space: pre-wrap; /* 保持文字换行 */
    word-break: break-word; /* 防止长单词溢出 */
}
.chat-bubble.sent .voice-text-description {
    border-top-color: rgba(255,255,255,0.2);
}


/* === 新增：总结功能悬浮窗样式 === */
#summary-display-area {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    margin-top: 10px;
}
body.dark-mode #summary-display-area {
    background: rgba(255,255,255,0.05);
}
#summary-display-area summary {
    padding: 12px 16px;
    font-weight: 600;
    cursor: pointer;
    list-style: none; /* 移除默认箭头 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#summary-display-area summary::-webkit-details-marker {
    display: none;
}
#summary-display-area summary::after {
    content: '▶';
    font-size: 14px;
    transform: rotate(0deg);
    transition: transform 0.2s;
}
#summary-display-area[open] summary::after {
    transform: rotate(90deg);
}

#summary-list-container {
    padding: 0 16px 16px 16px;
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.summary-list-item {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
}
.summary-list-item .summary-content {
    line-height: 1.5;
    margin-bottom: 6px;
}
.summary-list-item .summary-meta {
    font-size: 12px;
    opacity: 0.6;
    text-align: right;
}

/* --- API 切换悬浮窗（新） --- */
#api-preset-list {
    max-height: 60vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 5px; /* 为列表增加一些内边距 */
    margin: 0 -5px; /* 抵消内边距对宽度的影响 */
}

.api-preset-item {
    padding: 12px 16px;
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease-out;
    background-color: rgba(0,0,0,0.02);
}
body.dark-mode .api-preset-item {
    background-color: rgba(255,255,255,0.04);
}

.api-preset-item:hover {
    background-color: rgba(0,0,0,0.05);
}

.api-preset-item.selected {
    background-color: color-mix(in srgb, var(--accent-color) 15%, transparent);
    border-color: var(--accent-color);
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.api-preset-item .api-preset-details {
    max-height: 0;
    overflow: hidden;
    padding-top: 0;
    margin-top: 0;
    transition: all 0.4s ease-out;
}

.api-preset-item.expanded .api-preset-details {
    max-height: 200px; /* 一个足够大的高度 */
    padding-top: 15px;
    margin-top: 15px;
    border-top: 1px solid var(--glass-border);
}

.api-preset-details .model-selection-group {
    margin-bottom: 15px;
}

.api-preset-details .save-preset-container {
    text-align: right;
}

/* === 在这里添加新样式 === */

/* === 新增：总结消息样式 === */
.summary-message-notice {
    align-self: center;
    background-color: rgba(125, 125, 125, 0.1);
    color: var(--text-color);
    opacity: 0.85;
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 13px;
    max-width: 90%;
    text-align: left;
    margin: 5px 0;
    border-left: 3px solid var(--accent-color);
    line-height: 1.6;
    white-space: pre-wrap; /* 保留总结内容中的换行 */
}
.summary-message-notice::before {
    content: "【本段对话总结】";
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
    opacity: 0.9;
}


/* === 新增：总结功能悬浮窗样式 === */
#summary-display-area {
    background: rgba(0,0,0,0.05);
    border-radius: 12px;
    margin-top: 10px;
}
body.dark-mode #summary-display-area {
    background: rgba(255,255,255,0.05);
}
#summary-display-area summary {
    padding: 12px 16px;
    font-weight: 600;
    cursor: pointer;
    list-style: none; /* 移除默认箭头 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#summary-display-area summary::-webkit-details-marker {
    display: none;
}
#summary-display-area summary::after {
    content: '▶';
    font-size: 14px;
    transform: rotate(0deg);
    transition: transform 0.2s;
}
#summary-display-area[open] summary::after {
    transform: rotate(90deg);
}

#summary-list-container {
    padding: 0 16px 16px 16px;
    max-height: 200px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.summary-list-item {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
}
.summary-list-item .summary-content {
    line-height: 1.5;
    margin-bottom: 6px;
}
.summary-list-item .summary-meta {
    font-size: 12px;
    opacity: 0.6;
    text-align: right;
}

/* --- API 切换悬浮窗（新） --- */


#api-preset-list .api-preset-item .api-preset-details {
    display: none;
    padding: 15px 0 5px 0;
    margin-top: 10px;
    border-top: 1px solid var(--glass-border);
}
#api-preset-list .api-preset-item.expanded .api-preset-details {
    display: block;
}

.api-preset-details .model-selection-group {
    margin-bottom: 15px;
}

.api-preset-details .save-preset-container {
    text-align: right;
}
/* === 新增：消息角标样式 === */
.chat-contact-avatar-wrapper {
    position: relative;
    flex-shrink: 0; /* 防止在flex布局中被压缩 */
}

.message-badge {
    position: absolute;
    top: -5px;
    right: 5px; /* 修改：聊天列表角标的右边距 */
    background-color: #ef4444; /* 醒目的红色 */
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border: 2px solid var(--bg-color-end);
    box-sizing: content-box; 
    z-index: 2; /* 确保角标在头像上层 */
}

/* 新增：专门为主屏幕App图标角标设置样式 */
#chatapp-main-badge {
    right: -5px; /* 主屏幕App角标的右边距 */
}

body.dark-mode .message-badge {
    border-color: var(--bg-color-start); /* 暗黑模式下边框颜色调整 */
}
        /* 新增：用于“清除”等操作的次要按钮样式 */
        .clear-btn-subtle {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            opacity: 0.6;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .clear-btn-subtle:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .clear-btn-subtle:hover {
             background-color: rgba(255,255,255,0.05);
        }
 /* === 新增：聊天存档悬浮窗样式 === */
        #archive-list-container {
            max-height: 40vh; /* 限制最大高度，出现滚动条 */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 5px; /* 内部留一点边距 */
        }
        .archive-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .archive-card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden; /* 防止长标题溢出 */
        }
        .archive-card-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .archive-card-timestamp {
            font-size: 12px;
            opacity: 0.6;
        }
        .archive-card-actions {
            display: flex;
            gap: 8px;
            margin-left: 15px; /* 与左侧信息拉开距离 */
            flex-shrink: 0; /* 防止被压缩 */
        }
        .archive-load-btn, .archive-delete-btn {
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
        }
        .archive-delete-btn {
            background-color: #ef4444; /* 红色警告 */
            color: white;
            border-color: transparent;
        }
        .archive-delete-btn:hover {
            background-color: #dc2626 !important;
        }
/* === 新增：视频通话功能样式 === */
#video-call-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #1a1a1a;
    z-index: 3000;
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    overflow: hidden; /* 隐藏放大的背景图溢出部分 */
}
#video-call-overlay.visible {
    display: block; /* 改为block，让内部绝对定位生效 */
    opacity: 1;
}

.video-call-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    transition: filter 0.5s ease;
}

.video-state-view {
    display: none; /* 默认所有状态视图都隐藏 */
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
}

#video-call-overlay.calling #video-call-calling-state,
#video-call-overlay.connected #video-call-connected-state {
    display: flex; /* 改为flex布局 */
}

/* 呼叫中样式 */
#video-call-calling-state {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
}
.char-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    margin-top: -20vh; /* 向上偏移更多一点 */
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    border: 2px solid rgba(255,255,255,0.3);
}
.status-text {
    color: rgba(255, 255, 255, 0.7);
    font-size: 16px;
}
.rejection-notice {
    position: absolute;
    bottom: 25vh;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.4);
    color: white;
    font-size: 14px;
    padding: 8px 16px;
    border-radius: 8px;
}


/* 已接通样式 */
#video-call-connected-state {
    flex-direction: column;
    justify-content: flex-end; /* 内容靠下对齐 */
}

.user-self-view {
    position: absolute;
    top: 60px;
    right: 20px;
    width: 100px;
    height: 160px; /* 模拟手机摄像头比例 */
    background-color: #333;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.video-chat-dialogue-area {
    /* 【核心修正】使用 left 和 right 替代 width 和 margin，对绝对定位更友好 */
    position: absolute;
    left: 20px;
    right: 20px;
    bottom: 90px; /* 与输入栏保持90px的底部距离 */
    max-height: 33.33vh; /* 限制最大高度为屏幕的1/3 */
    overflow-y: auto;
    color: white;
    font-size: 15px;
    line-height: 1.6;
    padding: 10px;
    -webkit-mask-image: linear-gradient(to top, black 80%, transparent 100%);
    mask-image: linear-gradient(to top, black 80%, transparent 100%);
    /* 移除 top 相关的属性，避免冲突 */
}


.video-chat-dialogue-area p {
    margin: 0 0 10px 0;
}

.video-chat-input-bar {
    /* 【核心修改】改为绝对定位，放在屏幕最底部 */
    position: absolute;
    bottom: 25px; /* 距离屏幕底部的间距 */
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 40px); /* 左右留出20px的边距 */
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 8px;
    border-radius: 26px; /* 胶囊形状 */
}

.video-chat-input-bar .chat-action-btn svg {
    fill: white;
}

.video-chat-input-bar .chat-input-area {
    flex-grow: 1;
    background: rgba(255,255,255,0.2);
    border-radius: 18px;
    padding: 0 15px;
    display: flex;
    align-items: center;
}
.video-chat-input-bar .chat-input-area input {
    flex-grow: 1;
    border: none;
    background: transparent;
    color: white;
    font-size: 16px;
    padding: 10px 0;
    outline: none;
}
.video-chat-input-bar .chat-input-area input::placeholder {
    color: rgba(255,255,255,0.6);
}
.video-call-hang-up-btn {
    width: 60px;
    height: 60px;
    background: none; /* 移除背景色 */
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none; /* 移除阴影 */
    transition: transform 0.2s; /* 仅保留 transform 过渡 */
}
.video-call-hang-up-btn:active {
    transform: scale(0.9); /* 调整按下时的缩放效果 */
}
.video-call-hang-up-btn svg {
    width: 28px;
    height: 28px;
    fill: white;
}
/* 新增：为呼叫中状态下的图标单独设置尺寸 */
#video-call-calling-state .video-call-hang-up-btn svg {
    width: 42px; /* 增大图标尺寸以适配新容器 */
    height: 42px;
}

/* 呼叫中界面的挂断按钮位置 */
#video-call-calling-state .video-call-hang-up-btn {
    position: absolute;
    bottom: 15vh;
    left: 50%;
    transform: translateX(-50%);
    width: 80px; /* 增大按钮容器尺寸 */
    height: 80px;
}


/* 接通后界面的挂断按钮位置（此规则不再需要，可以删除或注释掉） */
/* .video-call-controls-wrapper { ... } */

.video-chat-input-bar {
    /* 【核心修改】改为绝对定位，放在屏幕最底部 */
    position: absolute;
    bottom: 25px; /* 距离屏幕底部的间距 */
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 40px); /* 左右留出20px的边距 */
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 8px;
    border-radius: 26px; /* 胶囊形状 */
}

/* 【新增】为输入栏内的挂断按钮设置样式 */
#video-chat-hang-up-in-bar-btn {
    flex-shrink: 0; /* 防止被压缩 */
    background-color: #ef4444; /* 红色背景 */
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background-color 0.2s;
}

#video-chat-hang-up-in-bar-btn:active {
    transform: scale(0.95);
    background-color: #dc2626; /* 按下时颜色加深 */
}

#video-chat-hang-up-in-bar-btn svg {
    width: 24px; /* 调整图标大小 */
    height: 24px;
    fill: white;
}
/* 【新增】区分视频通话中“重回”和“AI回复”按钮的样式 */
#video-re-answer-btn svg {
    opacity: 0.6; /* 降低“重回”按钮的图标透明度，使其看起来是次要操作 */
}
/* 【新增】为输入栏内的挂断按钮设置样式 */
#video-chat-hang-up-in-bar-btn {
    flex-shrink: 0; /* 防止被压缩 */
    background: none; /* 移除背景色 */
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    /* 尺寸调整，使其与其他按钮(40px)一致 */
    width: 40px;
    height: 40px;
}

#video-chat-hang-up-in-bar-btn:active {
    transform: scale(0.9); /* 调整按下时的缩放效果 */
}

#video-chat-hang-up-in-bar-btn svg {
    width: 24px; /* 调整图标大小 */
    height: 24px;
    fill: white;
}

/* 【新增】区分视频通话中“重回”和“AI回复”按钮的样式 */
#video-re-answer-btn svg, #video-api-reply-btn svg {
    fill: #fff; /* 确保图标是白色 */
}

#video-re-answer-btn svg {
    opacity: 0.7; /* 降低“重回”按钮的图标透明度，使其看起来是次要操作 */
}
/* === 在这里添加新样式 === */

/* === 新增：开场白选择悬浮窗样式 === */
.chatapp-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
    z-index: 2200; /* 需要比聊天设置侧边栏还高 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.chatapp-popup-overlay.visible {
    display: flex;
    opacity: 1;
}

.chatapp-popup-box {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* === 新增：为定位悬浮窗定制的“隐形”容器样式 === */
.chatapp-popup-box-location-wrapper {
    /* 移除所有视觉样式 */
    background: none !important;
    padding: 0 !important;
    border: none !important;
    box-shadow: none !important;
    gap: 0 !important;

    /* 重新定义尺寸以适应定位卡片 */
    width: 95%;
    height: 90%;
    max-width: 520px; /* 与主应用容器类似的最大宽度 */
    max-height: 920px;

    /* 允许内部的iframe内容溢出并显示其自身的阴影和圆角 */
    overflow: visible;
}

.chatapp-popup-box-location-wrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
    /* 预设圆角，即使iframe加载慢也能先看到框架 */
    border-radius: 0.75rem; /* 12px, 对应 Tailwind 的 rounded-xl */
}

.chatapp-popup-overlay.visible .chatapp-popup-box {
    transform: scale(1);
}

.chatapp-popup-box h4 {
    margin: 0 0 10px 0;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
}

.chatapp-popup-box .button-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

#opening-remark-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 50vh;
    overflow-y: auto;
    padding: 5px;
}

.opening-remark-item {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    font-weight: 500;
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    background-color: rgba(128, 128, 128, 0.05);
    color: var(--text-color);
    text-align: left;
}
.opening-remark-item:hover {
    background-color: rgba(128, 128, 128, 0.1);
}
.opening-remark-item:active {
    transform: scale(0.98);
}
.opening-remark-item.blank {
    background-color: transparent;
    border-style: dashed;
    text-align: center;
    opacity: 0.7;
}


/* === 新增：修复总结悬浮窗按钮过大的问题 === */
#summary-popup-overlay .button-group .modal-button {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 10px;
}
        /* === 新增：月历小组件样式 === */
        #calendar-container {
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: none;
            box-shadow: none;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative; /* 为了渐变背景 */
            color: var(--text-color);
            cursor: pointer;
        }

        #calendar-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%; /* 扩大范围以获得柔和边缘 */
            height: 200%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, var(--accent-color) 0%, transparent 60%);
            opacity: 0.15; /* 降低不透明度，使效果更微妙 */
            filter: blur(20px); /* 进一步模糊边缘 */
            pointer-events: none; /* 确保不影响点击 */
            z-index: -1;
        }

        #calendar-widget {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto auto repeat(5, 1fr); /* 1行月头, 1行星期, 5行日期 */
            gap: 4px;
            text-align: center;
        }

        .calendar-header {
            grid-column: 1 / -1;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .calendar-weekday {
            font-size: 10px;
            font-weight: 500;
            opacity: 0.6;
        }

        .calendar-day {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* 关键：为打卡小点定位 */
            aspect-ratio: 1/1;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            /* 给当天加点特殊样式，使其更突出 */
            color: var(--accent-color);
            font-weight: 800;
        }

        .check-in-dot {
            position: absolute;
            bottom: 2px; /* 调整小点的位置，使其浮在数字中下部 */
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--accent-color); /* 加一点辉光效果，更精致 */
        }
        /* === 新增：快捷回复功能样式 === */
        #quick-reply-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 2200;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #quick-reply-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #quick-reply-popup {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            height: 70%;
            max-height: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #quick-reply-overlay.visible #quick-reply-popup {
            transform: scale(1);
        }

        #quick-reply-header {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #add-quick-reply-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }
        #add-quick-reply-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--icon-color);
        }

        #quick-reply-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .quick-reply-card {
            background: rgba(255,255,255,0.5);
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        body.dark-mode .quick-reply-card {
             background: rgba(0,0,0,0.1);
        }
        
        .quick-reply-card:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .quick-reply-card:active {
            transform: scale(0.98);
        }
        
        .quick-reply-title {
            font-weight: 500;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 15px;
        }

        .quick-reply-actions button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .quick-reply-actions svg {
            width: 18px;
            height: 18px;
            fill: var(--icon-color);
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .quick-reply-actions button:hover svg {
            opacity: 1;
        }
        
        /* 快捷回复编辑表单的样式 */
        #quick-reply-form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        /* === 新增：音乐App搜索页面样式 === */
        .music-search-bar-wrapper { /* 新增：包裹层样式 */
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .music-search-input {
            flex-grow: 1;
            padding: 12px 50px 12px 18px; /* 增加右侧内边距给按钮留出空间 */
            border-radius: var(--pill-radius);
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            color: var(--text-color);
            user-select: text;
            -webkit-user-select: text;
            /* 确保在输入时不会被按钮遮挡 */
            padding-right: 50px; 
        }
        body.dark-mode .music-search-input {
            background: rgba(0,0,0,0.2);
        }

        .music-search-button-icon { /* 修改：图标按钮样式 */
            position: absolute; /* 绝对定位到输入框内部 */
            right: 8px; /* 距离右侧的距离 */
            top: 50%;
            transform: translateY(-50%);
            background: transparent; /* 背景透明 */
            border: none;
            cursor: pointer;
            padding: 8px; /* 增加点击区域 */
            line-height: 1; /* 确保SVG垂直居中 */
            transition: opacity 0.2s, transform 0.1s;
            color: var(--icon-color); /* 继承主题图标颜色 */
        }
        .music-search-button-icon:hover {
            opacity: 0.8;
        }
        .music-search-button-icon:active {
            transform: translateY(-50%) scale(0.9);
        }
        .music-search-button-icon svg {
            width: 20px; /* 图标大小 */
            height: 20px;
            fill: currentColor; /* 使用 currentColor 继承父级的 color */
        }
        
        .music-results-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* 为底部播放条留出空间 */
            padding-bottom: 80px;
        }

        .music-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        .music-result-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .music-result-item:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .result-item-cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .result-item-info {
            overflow: hidden;
            flex-grow: 1;
        }

        .result-item-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-item-artist {
            font-size: 13px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }
        /* === 在这里添加新样式，紧接着 .result-item-artist { ... } 后面 === */
        /* === 音乐App "我的" 页面新增样式 === */
        #my-page-playlists {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .playlist-card {
            background: var(--glass-bg);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .playlist-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.05);
        }

        .playlist-cover {
            width: 100%;
            height: 70%; /* 封面占大部分空间 */
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .playlist-cover svg { /* 默认封面图标 */
            width: 30%;
            height: 30%;
            fill: var(--icon-color);
            opacity: 0.3;
        }
        
        .playlist-info {
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-grow: 1;
        }

        .playlist-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-song-count {
            font-size: 12px;
            opacity: 0.6;
        }

        .add-playlist-card {
            border-style: dashed;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            opacity: 0.7;
        }
        .add-playlist-card:hover {
            opacity: 1;
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .add-playlist-card:hover {
            background-color: rgba(255,255,255,0.05);
        }

        .add-playlist-card svg {
            width: 40px;
            height: 40px;
            fill: currentColor;
        }
        
        /* === 音乐App "搜索" 页面新增样式 === */
        .collect-song-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-left: auto; /* 将按钮推到最右侧 */
            flex-shrink: 0;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .collect-song-btn:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }
        .collect-song-btn svg {
            width: 22px;
            height: 22px;
            fill: #ef4444; /* 红色爱心 */
        }
        
        /* === 收藏到歌单模态框样式 === */
        #collect-to-playlist-modal-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .collect-playlist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .collect-playlist-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .collect-playlist-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .collect-playlist-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .collect-playlist-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
/* === 在这里添加新样式 === */

/* === 新增：音乐App 歌单编辑/详情/收藏 悬浮窗样式 === */
.music-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    z-index: 1100; /* 比主模态框更高 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.music-popup-overlay.visible {
    display: flex;
    opacity: 1;
}

.music-popup-box {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.music-popup-overlay.visible .music-popup-box {
    transform: scale(1);
}

.music-popup-box h4 {
    margin: 0 0 10px 0;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
}

.music-popup-box .button-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* 歌单封面设置样式 */
.playlist-cover-setter {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}

#playlist-cover-preview {
    width: 100px;
    height: 100px;
    border-radius: 12px;
    background-color: #e2e8f0;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed var(--glass-border);
    color: var(--text-color);
    opacity: 0.8;
}

#playlist-cover-preview span {
    font-size: 12px;
}

/* 歌单详情歌曲列表样式 */
.playlist-song-list {
    max-height: 50vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin: -5px;
    padding: 5px;
}
        /* 收藏按钮爱心样式 (空心) */
        .collect-song-btn svg path {
            fill: none;
            stroke: #ef4444; /* 红色边框 */
            stroke-width: 2;
        }

        /* 已收藏的按钮爱心样式 (实心) */
        .collect-song-btn.collected svg path,
        .collect-song-btn:hover svg path {
            fill: #ef4444; /* 填充红色 */
            stroke: none;
        }
/* === 新增：音乐App 播放器页面样式 === */
/* === 新增：音乐App 播放器页面样式 (已修复遮挡问题) === */
.music-player-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    /* 核心修改：使用 space-around 将内容在垂直方向上均匀分布，自然避开顶部和底部 */
    justify-content: space-around; 
    align-items: center;
    /* 移除固定的 padding-bottom，让布局更具弹性 */
    /* padding-bottom: 80px; */ 
    /* 新增：为内容区添加一些内边距，确保在小屏幕上不贴边 */
    padding: 10px 0;
}

.music-player-card {
    width: 100%;
    max-width: 380px;
    padding: 24px;
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border);
    border-radius: 32px; /* 更大的圆角 */
    box-shadow: var(--glass-shadow);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.player-album-art {
    width: 85%; /* 专辑封面宽度 */
    aspect-ratio: 1 / 1;
    border-radius: 24px;
    background-color: rgba(128, 128, 128, 0.2);
    background-size: cover;
    background-position: center;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.player-info {
    text-align: center;
    width: 100%;
    overflow: hidden;
}

.player-song-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--icon-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.player-song-artist {
    font-size: 14px;
    color: var(--text-color);
    opacity: 0.7;
    margin-top: 6px;
}

.player-progress-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

#player-progress-bar {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: rgba(0,0,0,0.1);
    border-radius: 3px;
    outline: none;
}
#player-progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent-color);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px var(--accent-color);
}
body.dark-mode #player-progress-bar {
    background: rgba(255,255,255,0.1);
}

.player-time-display {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    opacity: 0.6;
    padding: 0 4px;
}

.player-controls {
    width: 100%; /* 确保容器占满父级宽度 */
    display: grid;
    /* 创建一个五列的网格，中间一列固定给播放按钮，其余列自适应填充 */
    grid-template-columns: 1fr 1fr auto 1fr 1fr;
    align-items: center;
    justify-items: center; /* 让网格项（按钮）在各自的单元格内居中 */
    gap: 0; /* 移除固定的gap，间距由grid自动分配 */
}


.player-control-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 10px;
    border-radius: 50%;
    transition: background-color 0.2s, transform 0.1s;
}
.player-control-btn:active {
    transform: scale(0.9);
}
.player-control-btn.main-btn {
    background: var(--accent-color);
}
.player-control-btn.main-btn svg {
    fill: white;
}

.player-control-btn svg {
    /* 核心修改：将默认图标大小调整为与底部导航栏一致的 20px */
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
}
.player-control-btn.main-btn svg {
    width: 32px;
    height: 32px;
    /* 修正播放/暂停图标在按钮内的位置 */
    transform: translateX(1px);
    /* 新增：确保上一首/下一首的SVG颜色能被正确应用 */
}

/* 新增：确保上一首/下一首按钮的SVG路径颜色能正确应用 */
#player-prev-btn svg path,
#player-next-btn svg path {
    fill: var(--icon-color) !important;
}
#player-pause-icon {
    display: none; /* 默认隐藏暂停图标 */
}
        /* === 新增：副本NPC库专属样式 === */

        /* NPC库的悬浮添加按钮 */
        #instance-npc-fab {
            position: fixed;
            bottom: 40px; 
            right: 25px;
            width: 38px;
            height: 38px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1002; /* 比通用模态框（1000）高 */
            transition: transform 0.2s, background-color 0.2s;
            transform: scale(0); /* 初始隐藏 */
            opacity: 0;
            pointer-events: none;
        }

        #instance-npc-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #instance-npc-fab:active {
            transform: scale(0.95) !important;
        }
        #instance-npc-fab svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color);
        }

        /* NPC卡片网格布局 */
        .npc-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 每行两个 */
            gap: 16px;
        }

        /* NPC卡片样式 (参考档案App的char-card) */
        .npc-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            aspect-ratio: 3 / 4; /* 纵向卡片 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 10px;
        }
        .npc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }
        .npc-card .card-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.7);
            /* 添加一个默认的占位符图标 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E");
        }
        .npc-card .card-info .name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* 确保省略号生效 */
        }
        
        /* 人设输入框的特定样式 */
        .npc-persona-textarea {
            min-height: 120px; /* 设置最小高度 */
            resize: vertical; /* 允许用户垂直调整大小 */
        }

        /* NPC详情和编辑页面的编辑按钮样式 (参考档案App) */
        .npc-detail-content .edit-char-btn {
             background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            margin-left: 8px; /* 与名字保持一定距离 */
            opacity: 0.5; /* 很淡 */
            transition: opacity 0.2s;
            vertical-align: middle;
        }
        .npc-detail-content .edit-char-btn:hover {
            opacity: 1;
        }
        .npc-detail-content .edit-char-btn svg {
            width: 16px; /* 小一点 */
            height: 16px;
            fill: var(--text-color);
        }

        /* === 副本NPC库专属样式 结束 === */
        /* === 在这里添加新样式 === */

/* === 新增：进入副本悬浮窗样式 === */
#enter-instance-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    z-index: 2500; /* 确保在其他弹窗之上 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#enter-instance-overlay.visible {
    display: flex;
    opacity: 1;
}

#enter-instance-popup {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 420px;
    max-height: 85vh; /* 限制最大高度 */
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    overflow: hidden; /* 隐藏内部滚动条溢出 */
}

#enter-instance-overlay.visible #enter-instance-popup {
    transform: scale(1);
}

#enter-instance-header {
    padding: 16px 20px;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

#close-enter-instance-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
    color: var(--text-color);
    opacity: 0.6;
}
#close-enter-instance-btn:hover {
    opacity: 1;
}

#enter-instance-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.selection-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.selection-section h5 {
    margin: 0;
    font-size: 16px;
    opacity: 0.8;
}

.selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
}

.selection-card {
    position: relative;
    aspect-ratio: 3 / 4;
    cursor: pointer;
}

.selection-card .card-avatar {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    background-size: cover;
    background-position: center;
    transition: transform 0.2s;
}

.selection-card .card-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 6px 6px;
    font-size: 13px;
    font-weight: 500;
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    text-align: center;
    background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
    border-radius: 0 0 12px 12px;
}

.selection-card input[type="checkbox"] {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    accent-color: var(--accent-color); /* 让勾选框颜色跟随主题 */
    cursor: pointer;
}

/* 选中时的视觉反馈 */
.selection-card input:checked + .card-avatar {
    transform: scale(0.95);
    box-shadow: 0 0 0 3px var(--accent-color);
}

#enter-instance-footer {
    flex-shrink: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
}

#confirm-entry-button-wrapper {
    position: relative;
    width: 64px; /* 容器大小，比按钮稍大以容纳进度圈 */
    height: 64px;
    display: flex;
    justify-content: center;
    align-items: center;
}

#confirm-entry-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 32px; /* 按钮图标大小 */
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 关键：强制SVG图标颜色为主题强调色 */
#confirm-entry-button svg path {
    fill: var(--accent-color) !important;
}

/* 进度圈SVG样式 */
#progress-ring {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg); /* 让动画从顶部开始 */
    pointer-events: none; /* 让点击事件穿透 */
}

#progress-ring-circle {
    stroke: var(--accent-color);
    stroke-width: 2.5; /* 细线 */
    fill: transparent;
    transition: stroke-dashoffset 3s linear; /* 3秒线性动画 */
    /* 圆周长 C = 2 * PI * r。假设半径r=30 (容器64/2 - stroke-width/2) -> C ≈ 188.5 */
    stroke-dasharray: 188.5; 
    stroke-dashoffset: 188.5; /* 初始状态，偏移量等于周长，完全隐藏 */
}

/* 长按时触发的动画状态 */
#confirm-entry-button-wrapper.holding #progress-ring-circle {
    stroke-dashoffset: 0; /* 动画目标，偏移量为0，完全显示 */
}
/* === 在这里添加新样式 === */

/* === 新增：副本聊天界面样式 === */
#instance-chat-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2600; /* 比“进入副本”悬浮窗更高 */
    opacity: 0;
    pointer-events: none;
    background-color: var(--bg-color-end);
    display: flex;
    flex-direction: column;
    transform: scale(1.1); /* 初始稍微放大 */
    transition: opacity 0.3s ease, transform 0.3s ease;
}
/* === 新增：副本聊天界面工具栏样式 === */
#instance-chat-toolbar {
    display: flex;
    justify-content: space-around; /* 让按钮均匀分布 */
    align-items: center;
    /* 修改：进一步减小垂直内边距以降低高度 */
    padding: 0 10px; 
    /* 移除：将边框样式移到新的div中 */
    /* border-bottom: 1px solid var(--glass-border); */
}
/* 新增：渐变分界线样式 */
.toolbar-divider {
    height: 1px;
    width: 80%; /* 线的长度 */
    margin: 1px auto; /* 减小上下边距 */
    background: linear-gradient(to right, transparent, var(--glass-border), transparent);
    border: none;
}
.instance-toolbar-btn {
    background: none;
    border: none;
    cursor: pointer;
    /* 修改：进一步减小按钮的内边距 */
    padding: 2px; 
    border-radius: 50%;
    transition: background-color 0.2s;
}
.instance-toolbar-btn:hover {
    background-color: rgba(0,0,0,0.05);
}
body.dark-mode .instance-toolbar-btn:hover {
    background-color: rgba(255,255,255,0.08);
}
.instance-toolbar-btn svg {
    /* 修改：缩小SVG图标尺寸 */
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
    display: block; /* 解决某些浏览器下SVG对齐问题 */
}
/* 修复部分SVG路径未应用fill颜色的问题 */
.instance-toolbar-btn svg path {
    fill: var(--icon-color) !important;
}

#instance-chat-container.visible {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}

#instance-chat-header {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 7px 20px;
    /* border-bottom: 1px solid var(--glass-border); */ /* 移除下边框 */
    flex-shrink: 0;
    position: relative;
}

#instance-chat-title {
    display: none; /* 直接隐藏标题 */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    font-weight: 600;
}

#instance-chat-back-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    z-index: 1;
}
#instance-chat-back-btn svg {
    width: 24px;
    height: 24px;
    fill: var(--text-color);
}

#instance-chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.instance-message-line {
    display: flex;
    justify-content: center; /* 核心：让气泡居中 */
    width: 100%;
}

.instance-chat-bubble {
    max-width: 80%; /* 限制气泡最大宽度 */
    padding: 12px 18px; /* 稍微增大内边距以获得更好的视觉效果 */
    border-radius: 18px;
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--text-color);
    font-size: 16px;
    line-height: 1.6; /* 略微增加行高，提升可读性 */
    word-wrap: break-word;
    /* white-space: pre-line; */ /* 移除此行，让 <br> 标签完全控制换行 */
}
/* AI回复时的加载动画气泡 */
.instance-chat-bubble.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
}
.instance-chat-bubble.loading .loading-dots span {
    background-color: var(--icon-color);
}


/* 输入栏样式，复用chatapp样式 */
#instance-chat-footer {
    flex-shrink: 0;
    padding: 10px;
    border-top: 1px solid var(--glass-border);
    background: color-mix(in srgb, var(--bg-color-end) 70%, transparent); /* 轻微的背景色以区分 */
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}

#instance-chat-footer .chat-footer-input-row {
    display: flex;
    align-items: center;
    gap: 10px;
}
#instance-chat-footer .chat-input-area {
    flex-grow: 1;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 22px;
    display: flex;
    align-items: center;
    padding: 0 5px 0 15px;
}
#instance-chat-footer #instance-chat-input {
    flex-grow: 1;
    border: none;
    background: transparent;
    color: var(--text-color);
    font-size: 16px;
    padding: 10px 0;
    outline: none;
    user-select: text;
    -webkit-user-select: text;
}
/* === 新增：强制线下聊天底栏按钮颜色跟随主题 === */
#offline-chat-footer .chat-action-btn svg path,
#offline-chat-footer #send-btn svg path,
#offline-chat-footer #api-reply-btn svg path {
    fill: var(--accent-color) !important;
}
        /* === 新增：副本氛围设置 - 音乐列表样式 === */
        .atmosphere-music-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .atmosphere-music-section h5 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
        }

        .atmosphere-playlist-details {
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0,0,0,0.02);
        }
        body.dark-mode .atmosphere-playlist-details {
            background: rgba(255,255,255,0.03);
        }

        .atmosphere-playlist-details summary {
            padding: 12px 16px;
            font-weight: 600;
            cursor: pointer;
            list-style: none; /* 移除默认箭头 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
        }

        .atmosphere-playlist-details summary::-webkit-details-marker {
            display: none;
        }

        .atmosphere-playlist-details[open] summary {
            border-bottom: 1px solid var(--glass-border);
        }

        .song-list-container {
            max-height: 150px; /* 限制歌曲列表最大高度 */
            overflow-y: auto;
            padding: 8px;
        }
        
        .atmosphere-song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .atmosphere-song-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .atmosphere-song-item:hover {
             background-color: rgba(255,255,255,0.08);
        }

        .song-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .song-item-info {
            overflow: hidden;
        }

        .song-item-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-item-artist {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* === 新增：副本聊天界面的壁纸层 === */
        #instance-chat-wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1;
            transition: background-image 0.5s ease-in-out;
        }
        /* === 新增：副本App内悬浮窗的独立样式 === */
        #instance-api-switch-overlay,
        #instance-atmosphere-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            /* 核心修改：设置比副本界面(2600)更高的 z-index */
            z-index: 2800; 
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #instance-api-switch-overlay.visible,
        #instance-atmosphere-overlay.visible {
            display: flex;
            opacity: 1;
        }

        /* 内部弹窗盒子的动画效果，可以复用 chatapp-popup-box 的样式 */
        #instance-api-switch-overlay .chatapp-popup-box,
        #instance-atmosphere-overlay .chatapp-popup-box {
             background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #instance-api-switch-overlay.visible .chatapp-popup-box,
        #instance-atmosphere-overlay.visible .chatapp-popup-box {
            transform: scale(1);
        }

        /* === 新增：副本行动选项悬浮框样式 === */
        #action-options-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2700; /* 比副本聊天界面高 */
            display: none; /* 默认隐藏 */
            justify-content: center;
            align-items: flex-end; /* 底部对齐 */
            padding-bottom: 120px; /* 距离底部的距离 */
            background-color: transparent; /* 背景透明，以便点击穿透 */
        }
        #action-options-overlay.visible {
            display: flex;
        }

        #action-options-box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 16px;
            width: 90%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 12px; /* 选项之间的垂直间距 */
            box-shadow: var(--glass-shadow);
        }

        .action-option-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.2s;
        }

        .action-option-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        body.dark-mode .action-option-btn:hover {
            background-color: rgba(255,255,255,0.08);
        }
    /* === 新增：副本状态悬浮窗样式 (重构) === */
    #instance-status-overlay {
        z-index: 2850; /* 提高层级，确保在其他副本悬浮窗之上 */
        align-items: flex-end; /* 让悬浮窗从底部滑出 */
        padding-bottom: 0; /* 确保悬浮窗贴底 */
    }
    /* === 新增：副本状态悬浮窗样式 (重构) === */
    #instance-status-overlay {
        z-index: 2850; /* 提高层级，确保在其他副本悬浮窗之上 */
        align-items: flex-end; /* 让悬浮窗从底部滑出 */
        padding-bottom: 0; /* 确保悬浮窗贴底 */
    }

    #instance-status-popup {
        height: 40vh; /* 悬浮窗高度为视口的40% */
        max-height: 350px; /* 最大高度限制 */
        width: 100%;
        max-width: 100%; /* 占满手机宽度 */
        border-radius: 20px 20px 0 0; /* 顶部圆角 */
        bottom: 0;
        margin: 0;
        padding: 0; /* 移除内边距，让内容区自己控制 */
        position: relative; /* 确保是绝对定位的容器 */
        transform: translateY(100%); /* 初始状态在屏幕外 */
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    #instance-status-overlay.visible #instance-status-popup {
        transform: translateY(0); /* 滑入屏幕 */
    }

    #instance-status-header {
        height: 40px; /* 给一个拖动条的高度 */
        width: 100%;
        position: relative;
        flex-shrink: 0;
    }
    #instance-status-header::after { /* 模拟顶部的拖动横条 */
        content: '';
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 5px;
        background-color: var(--glass-border);
        border-radius: 2.5px;
    }

    #instance-status-content-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px 20px;
        text-align: center;
    }
    .instance-status-page {
        display: none;
    }
    .instance-status-page.active {
        display: block;
    }

    #instance-status-footer {
        flex-shrink: 0;
        padding: 10px 20px 20px;
        display: flex;
        justify-content: center;
    }
    
    #instance-status-nav-bar {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: var(--pill-radius);
        box-shadow: var(--glass-shadow);
    }

    .instance-status-nav-item {
        background-color: transparent;
        border: none;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: var(--pill-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
        overflow: hidden;
        white-space: nowrap;
        color: var(--text-color);
        font-size: 14px;
        font-weight: 600;
    }

    .instance-status-nav-item svg {
        width: 22px; /* 强制统一图标大小 */
        height: 22px;
        flex-shrink: 0;
    }
    .instance-status-nav-item svg path {
        fill: var(--icon-color) !important;
        stroke: none !important;
    }

    .instance-status-nav-item span {
        display: inline-block;
        max-width: 0;
        opacity: 0;
        transition: max-width 0.3s ease-out, opacity 0.2s ease-out, margin-left 0.3s ease-out;
        margin-left: 0;
        vertical-align: middle;
    }

    .instance-status-nav-item.active {
        background-color: rgba(0, 0, 0, 0.08);
    }
    body.dark-mode .instance-status-nav-item.active {
        background-color: rgba(255, 255, 255, 0.15);
    }
    
    .instance-status-nav-item.active span {
        max-width: 50px;
        opacity: 1;
        margin-left: 8px;
    }

    /* === 新增：状态面板卡片样式 === */
    .status-card-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .status-card {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        text-align: left;
    }
    .status-card-avatar {
        width: 60px;
        height: 80px;
        border-radius: 8px;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
        background-color: rgba(0,0,0,0.05);
    }
    .status-card-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
        font-size: 13px;
    }
    .status-card-info .name {
        font-size: 16px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
    }
    .status-card-info .points,
    .status-card-info .favor {
        font-weight: bold;
    }
    .status-card-info .meta-item {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .status-card-info .meta-item svg {
        width: 14px;
        height: 14px;
        opacity: 0.6;
    }

    #instance-status-popup {
        height: 40vh; /* 悬浮窗高度为视口的40% */
        max-height: 350px; /* 最大高度限制 */
        width: 100%;
        max-width: 100%; /* 占满手机宽度 */
        border-radius: 20px 20px 0 0; /* 顶部圆角 */
        bottom: 0;
        margin: 0;
        padding: 0; /* 移除内边距，让内容区自己控制 */
        position: relative; /* 确保是绝对定位的容器 */
        transform: translateY(100%); /* 初始状态在屏幕外 */
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    #instance-status-overlay.visible #instance-status-popup {
        transform: translateY(0); /* 滑入屏幕 */
    }

    #instance-status-header {
        height: 40px; /* 给一个拖动条的高度 */
        width: 100%;
        position: relative;
        flex-shrink: 0;
    }
    #instance-status-header::after { /* 模拟顶部的拖动横条 */
        content: '';
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 5px;
        background-color: var(--glass-border);
        border-radius: 2.5px;
    }

    #instance-status-content-area {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px 20px;
        text-align: center;
    }
    .instance-status-page {
        display: none;
    }
    .instance-status-page.active {
        display: block;
    }

    #instance-status-footer {
        flex-shrink: 0;
        padding: 10px 20px 20px;
        display: flex;
        justify-content: center;
    }
    
    #instance-status-nav-bar {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: var(--pill-radius);
        box-shadow: var(--glass-shadow);
    }

    .instance-status-nav-item {
        background-color: transparent;
        border: none;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: var(--pill-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s, color 0.2s;
        overflow: hidden;
        white-space: nowrap;
        color: var(--text-color);
        font-size: 14px;
        font-weight: 600;
    }

    .instance-status-nav-item svg {
        width: 22px; /* 强制统一图标大小 */
        height: 22px;
        flex-shrink: 0;
    }
    .instance-status-nav-item svg path {
        fill: var(--icon-color) !important;
        stroke: none !important;
    }

    .instance-status-nav-item span {
        display: inline-block;
        max-width: 0;
        opacity: 0;
        transition: max-width 0.3s ease-out, opacity 0.2s ease-out, margin-left 0.3s ease-out;
        margin-left: 0;
        vertical-align: middle;
    }

    .instance-status-nav-item.active {
        background-color: rgba(0, 0, 0, 0.08);
    }
    body.dark-mode .instance-status-nav-item.active {
        background-color: rgba(255, 255, 255, 0.15);
    }
    
    .instance-status-nav-item.active span {
        max-width: 50px;
        opacity: 1;
        margin-left: 8px;
    }
/* === 新增：副本任务列表美化样式 === */
.task-list-item {
    background: rgba(0, 0, 0, 0.03);
    border: 1px solid transparent;
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: transform 0.1s ease, background-color 0.2s ease, opacity 0.3s;
    cursor: pointer;
    font-size: 15px;
}
body.dark-mode .task-list-item {
    background: rgba(255, 255, 255, 0.05);
}
.task-list-item:active {
    transform: scale(0.98);
    background-color: rgba(0, 0, 0, 0.05);
}
.task-list-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--accent-color);
    flex-shrink: 0;
    animation: breathing-glow 2s infinite ease-in-out;
    transition: background-color 0.3s, box-shadow 0.3s;
}
@keyframes breathing-glow {
    0%, 100% {
        box-shadow: 0 0 5px 0px var(--accent-color);
        opacity: 0.7;
    }
    50% {
        box-shadow: 0 0 12px 3px var(--accent-color);
        opacity: 1;
    }
}
/* === 新增：已完成任务的样式 === */
.task-list-item.completed {
    opacity: 0.6;
    text-decoration: line-through;
    cursor: default; /* 已完成的任务不可再点击 */
}
.task-list-item.completed .task-list-dot {
    background-color: #94a3b8; /* 将点变为灰色 */
    animation: none; /* 移除呼吸辉光动画 */
    box-shadow: none;
}
/* === 在这里添加新样式 === */

/* === 新增：副本内手机模拟器样式 === */
#instance-phone-simulator-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    /* backdrop-filter: blur(5px); */ /* 已移除 */
    /* -webkit-backdrop-filter: blur(5px); */ /* 已移除 */
    z-index: 2900; /* 比副本聊天界面高，但比其他弹窗低 */
    display: none;
    /* 移除: justify-content 和 align-items，因为我们将使用绝对定位 */
    opacity: 0;
    transition: opacity 0.3s ease;
}

#instance-phone-simulator-overlay.visible {
    display: block; /* 改为 block 以支持绝对定位 */
    opacity: 1;
}

#phone-simulator-frame {
    /* 新增：绝对定位，用于拖拽 */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9); /* 保持初始居中和动画 */
    
    /* 修复溢出问题的关键 */
    box-sizing: border-box; 

    width: 300px; /* 调整了基础宽度以便计算 */
    aspect-ratio: 3 / 5; /* 核心修改：设置3:5的宽高比 */
    background: #111;
    border: 8px solid #111; /* 核心修改：黑边变细 */
    border-radius: 40px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    /* padding: 2px; */ /* 核心修改：移除内边距，让屏幕贴紧黑边内沿 */
    /* 修改：transition 不再包含 transform，因为拖动时不需要动画 */
    transition: opacity 0.3s ease; 
    cursor: grab; /* 顶部拖拽手势 */
}

#instance-phone-simulator-overlay.visible #phone-simulator-frame {
    transform: translate(-50%, -50%) scale(1);
}

/* 新增：右下角缩放把手样式 */
#phone-resize-handle {
    position: absolute;
    right: -5px;
    bottom: -5px;
    width: 20px;
    height: 20px;
    cursor: se-resize; /* 右下角缩放手势 */
    z-index: 10;
}


#phone-simulator-screen {
    width: 100%;
    height: 100%;
    background-color: var(--bg-color-end);
    border-radius: 32px; /* 核心修改：调整圆角以匹配新边框 */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* 隐藏内部溢出内容 */
    position: relative;
}

/* 复用 chatapp 的联系人列表样式 */
#phone-simulator-screen .chat-contact-list-view,
#phone-simulator-screen .chat-room-view {
    width: 100%;
    height: 100%;
    background: transparent; /* 背景由屏幕提供 */
}

/* 手机模拟器内的顶栏微调 */
#phone-simulator-screen .chat-main-header,
#phone-simulator-screen .chat-header {
    background-color: transparent; /* 改为完全透明 */
    -webkit-backdrop-filter: none; /* 移除模糊效果 */
    backdrop-filter: none; /* 移除模糊效果 */
    padding: 4px 10px; /* 进一步减小垂直内边距以降低高度 */
}
body.dark-mode #phone-simulator-screen .chat-main-header,
body.dark-mode #phone-simulator-screen .chat-header {
    background-color: rgba(0,0,0,0.1);
}
#phone-simulator-screen .chat-contact-title,
#phone-simulator-screen .chat-main-header span {
    font-size: 16px; /* 减小字体 */
}
#phone-simulator-screen .chat-header-btn svg {
    width: 24px;
    height: 24px;
}

/* 手机模拟器内的联系人列表项 */
#phone-simulator-screen .chat-contact-item {
    padding: 10px;
}
#phone-simulator-screen .chat-contact-avatar {
    width: 45px;
    height: 45px;
}
#phone-simulator-screen .chat-contact-last-msg {
    font-size: 13px;
}

/* 手机模拟器内的聊天界面 */
#phone-simulator-screen .chat-messages {
    padding: 10px;
    gap: 12px;
}
#phone-simulator-screen .chat-avatar {
    width: 36px;
    height: 36px;
}
#phone-simulator-screen .chat-bubble {
    padding: 8px 14px;
    font-size: 15px;
}

/* 手机模拟器内专用的新工具栏 */
#phone-chat-footer {
    flex-shrink: 0;
    padding: 8px;
    border-top: 1px solid var(--glass-border);
    background: color-mix(in srgb, var(--bg-color-end) 70%, transparent);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    gap: 8px;
}

#phone-chat-footer .chat-action-btn {
    padding: 6px;
}
#phone-chat-footer .chat-action-btn svg {
    width: 22px;
    height: 22px;
}

        #phone-chat-footer .chat-input-area {
            flex-grow: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            padding: 0 10px;
            /* 新增：确保在flex布局中可以被正确压缩 */
            min-width: 0;
            display: flex; /* 让内部的输入框也能自适应 */
        }


        #phone-chat-footer input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--text-color);
            /* font-size: calc(15px * var(--phone-scale)); */ /* 移除，由 JS 动态字体大小取代，避免冲突 */
            font-size: 15px; /* 恢复一个基础字体大小 */
            padding: 8px 0; /* 简化 padding */
            outline: none;
            user-select: text;
            -webkit-user-select: text;
            min-width: 0; /* 核心新增：允许输入框在flex布局中被压缩 */
        }

/* === 新增：手机模拟器内部内容响应式缩放 === */
#phone-simulator-frame {
    /* 定义一个缩放变量，JS会更新它，默认值为1 */
    --phone-scale: 1;
}

#phone-simulator-screen .chat-main-header,
#phone-simulator-screen .chat-header {
    padding-top: calc(8px * var(--phone-scale));
    padding-bottom: calc(8px * var(--phone-scale));
    padding-left: calc(10px * var(--phone-scale));
    padding-right: calc(10px * var(--phone-scale));
    font-size: calc(16px * var(--phone-scale));
}

#phone-simulator-screen .chat-header-btn svg {
    width: calc(24px * var(--phone-scale));
    height: calc(24px * var(--phone-scale));
}

#phone-simulator-screen .chat-contact-item {
    padding: calc(10px * var(--phone-scale));
}

#phone-simulator-screen .chat-contact-avatar {
    width: calc(45px * var(--phone-scale));
    height: calc(45px * var(--phone-scale));
    margin-right: calc(15px * var(--phone-scale));
    border-radius: calc(12px * var(--phone-scale));
}

#phone-simulator-screen .chat-contact-name {
    font-size: calc(15px * var(--phone-scale));
}

#phone-simulator-screen .chat-contact-last-msg {
    font-size: calc(13px * var(--phone-scale));
    margin-top: calc(4px * var(--phone-scale));
}

#phone-simulator-screen .chat-messages {
    padding: calc(10px * var(--phone-scale));
    gap: calc(12px * var(--phone-scale));
}

#phone-simulator-screen .chat-avatar {
    width: calc(36px * var(--phone-scale));
    height: calc(36px * var(--phone-scale));
}

#phone-simulator-screen .chat-bubble {
    padding: calc(8px * var(--phone-scale)) calc(14px * var(--phone-scale));
    font-size: calc(15px * var(--phone-scale));
    border-radius: calc(18px * var(--phone-scale));
}

#phone-chat-footer {
    padding: calc(8px * var(--phone-scale));
    gap: calc(8px * var(--phone-scale));
}

#phone-chat-footer .chat-action-btn {
    padding: calc(6px * var(--phone-scale));
}

#phone-chat-footer .chat-action-btn svg {
    width: calc(22px * var(--phone-scale));
    height: calc(22px * var(--phone-scale));
}

#phone-chat-footer .chat-input-area {
    padding-left: calc(10px * var(--phone-scale));
    padding-right: calc(10px * var(--phone-scale));
    border-radius: calc(18px * var(--phone-scale));
}

#phone-chat-footer input {
    font-size: calc(15px * var(--phone-scale));
    padding-top: calc(8px * var(--phone-scale));
    padding-bottom: calc(8px * var(--phone-scale));
}
/* === 新增：状态面板折叠展开样式 === */
.status-card {
    position: relative; /* 为了定位箭头 */
}
.status-card-arrow {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%) rotate(0deg);
    width: 24px;
    height: 24px;
    fill: var(--icon-color);
    opacity: 0.5;
    transition: transform 0.3s ease;
}
.status-card.expanded .status-card-arrow {
    transform: translateY(-50%) rotate(180deg);
}

.progress-details-container {
    background-color: rgba(0,0,0,0.03);
    border-radius: 12px;
    margin-top: -8px; /* 与上方卡片稍微重叠 */
    padding: 20px 15px 10px;
    display: none; /* 默认隐藏 */
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid var(--glass-border);
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}
body.dark-mode .progress-details-container {
    background-color: rgba(255,255,255,0.04);
}

.progress-list-item {
    font-size: 14px;
    padding: 6px 0;
    border-bottom: 1px dashed var(--glass-border);
    color: var(--text-color);
    opacity: 0.8;
}
.progress-list-item:last-child {
    border-bottom: none;
}
        /* 在这里添加新样式 */
        .font-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .font-input-wrapper .modal-input {
            flex-grow: 1;
        }
        .font-input-wrapper #font-preview-btn {
            flex-shrink: 0;
            padding: 10px; /* 使按钮接近方形 */
            line-height: 1;
        }
        .font-input-wrapper #font-preview-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        #font-preview-box {
            margin-top: 12px;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.03);
            font-size: 16px;
            line-height: 1.6;
            transition: font-family 0.3s ease;
            user-select: text; /* 允许选择预览文字 */
            text-align: center; /* 新增：使文本居中显示 */
        }
        body.dark-mode #font-preview-box {
             background: rgba(255,255,255,0.05);
        }
/* === 新增：副本结算加载动画样式 === */
#instance-settlement-loading-overlay,
#instance-settlement-result-overlay {
    z-index: 3000; /* 设置一个非常高的层级，确保在副本聊天界面(z-index: 2600)之上 */
}
.settlement-loader {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.2);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
/* === 新增：副本结算结果悬浮窗样式 === */
.settlement-section {
    background: rgba(0,0,0,0.03);
    border-radius: 12px;
    padding: 12px 16px;
}
body.dark-mode .settlement-section {
    background: rgba(255,255,255,0.05);
}
.settlement-section h5 {
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 600;
    opacity: 0.7;
    border-bottom: 1px solid var(--glass-border);
    padding-bottom: 8px;
}
/* 通关者卡片样式 */
.participants-container {
    display: flex;
    gap: 12px;
    justify-content: center;
}
.participant-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 10px;
    width: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
.participant-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
}
.participant-name {
    font-size: 14px;
    font-weight: 600;
}
/* 结局与成就 */
.settlement-ending-achievement {
    text-align: center;
    padding: 10px 0;
}
#settlement-ending-result {
    font-size: 18px;
    font-weight: bold;
    display: block;
    margin-bottom: 8px;
}
#settlement-achievement-title {
    display: inline-block;
    background: linear-gradient(135deg, gold, #ffeb3b);
    color: #422a00;
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4);
}
/* 故事梗概 */
.story-summary-box {
    font-size: 15px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 250px;
    overflow-y: auto;
    padding: 8px;
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    user-select: text;
}
body.dark-mode .story-summary-box {
     background: rgba(255,255,255,0.04);
}
/* 结算奖励 */
.rewards-container {
    display: flex;
    justify-content: space-around;
    text-align: center;
}
.reward-item {
    font-size: 16px;
}
.reward-item .value {
    font-size: 20px;
    font-weight: bold;
    color: var(--accent-color);
    display: block;
    margin-top: 4px;
}
        /* === 新增：音乐App图库入口及悬浮窗样式 === */
        .music-gallery-entry-bar {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 12px 16px;
            margin-top: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .music-gallery-entry-bar:hover {
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .music-gallery-entry-bar:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .music-gallery-entry-bar span {
            font-weight: 500;
        }

        .music-gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
        }
        body.dark-mode .music-gallery-grid {
            background: rgba(255,255,255,0.05);
        }
        
        .music-gallery-item {
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            position: relative;
        }

        .music-gallery-item.add-btn {
            border: 2px dashed var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .music-gallery-item.add-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .music-gallery-item.add-btn svg {
            width: 40%;
            height: 40%;
            fill: var(--icon-color);
            opacity: 0.6;
        }
        
        .music-gallery-item:not(.add-btn)::after {
            content: '双击删除';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 4px 0;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 10px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .music-gallery-item:not(.add-btn):hover::after {
            opacity: 1;
        }
        /* === 新增：正则 App 专属样式 === */
        #regex-app-fab {
            /* 直接复用 world-book-fab 的样式 */
            position: fixed;
            bottom:25px;
            right: 20px;
            width: 38px;
            height: 38px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s, background-color 0.2s;
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        #regex-app-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #regex-app-fab:active {
            transform: scale(0.95) !important;
        }
        #regex-app-fab svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color);
        }

        .regex-scope-options {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .regex-scope-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        #chatapp-scope-details {
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            overflow: hidden;
        }

        #chatapp-scope-details summary {
            padding: 10px 15px;
            font-weight: 500;
            cursor: pointer;
            list-style: none;
            background: rgba(0,0,0,0.02);
        }
        
        #chatapp-scope-details summary::-webkit-details-marker {
            display: none;
        }

        .regex-scope-contact-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.01);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        body.dark-mode .regex-scope-contact-list {
             background: rgba(255,255,255,0.03);
        }

        .regex-scope-contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .regex-scope-contact-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        body.dark-mode .regex-scope-contact-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        
        .regex-scope-contact-item span {
            font-size: 14px;
        }
        /* === 新增：每日情话卡片样式 === */
        #sweet-words-card {
            cursor: pointer;
            /* 默认的淡蓝色辐射渐变背景 */
            background: radial-gradient(circle at center, rgba(173, 216, 230, 0.4) 0%, transparent 80%), var(--glass-bg);
            transition: background 0.3s ease; /* 为背景切换添加过渡 */
        }
        #sweet-words-text {
            transition: opacity 0.3s ease;
        }
        #sweet-words-card.loading #sweet-words-text {
            opacity: 0.5;
        }
                /* === 新增：每日情话卡片样式 === */
        #sweet-words-card {
            cursor: pointer;
            /* Flex布局，让内容垂直居中 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* 新增：禁止长按时选中文字 */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;         /* Standard */
        }

        .sweet-words-container {
            width: 100%;
            transition: filter 0.5s ease;
        }

        /* 模糊效果 */
        .sweet-words-container.blurred {
            filter: blur(8px);
            /* 对于不支持filter的浏览器，可以设置透明度作为后备 */
            opacity: 0.8;
        }

        /* 情话内容：居中 */
        .sweet-words-content {
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            text-align: center;
            margin: 0;
        }

        /* 角色署名：新起一行，居中偏右 */
        .sweet-words-char {
            display: block; /* 确保占满一行以便对齐 */
            text-align: right; /* 文本右对齐 */
            font-size: 14px;
            font-weight: 600;
            opacity: 0.8;
            margin-top: 12px; /* 与情话内容拉开距离 */
            padding-right: 10%; /* 向右偏移一点，实现“偏右”效果 */
        }

        /* === 新增：每日情话卡片上下文菜单样式 === */
        #sweet-words-context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background-color: transparent;
            display: none;
        }
        #sweet-words-context-menu-overlay.visible {
            display: block;
        }
        #sweet-words-context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            min-width: 120px;
            transform: scale(0.95);
            transform-origin: top left;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
            pointer-events: none;
            opacity: 0;
        }
        #sweet-words-context-menu-overlay.visible #sweet-words-context-menu {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .sw-context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-color);
            transition: background-color 0.15s ease;
        }
        .sw-context-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .sw-context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
        /* === 新增：查手机 App 样式 === */
#modal-body.phone-view-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            /* 核心新增：让这个容器占据父元素(modal-container)的所有剩余空间 */
            flex-grow: 1;
        }

.phone-simulator-frame {
    width: 100%;
    height: 100%;
    /* 需求3.1：边框加粗 */
    border: 6px solid #1c1c1c; 
    border-radius: 24px;
    background-color: var(--bg-color-end);
    padding: 0;
    box-sizing: border-box;
    overflow: hidden;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    /* 新增：为灵动岛定位创建相对容器 */
    position: relative; 
}

/* 查手机-联系人列表项样式 (复用聊天列表样式) */
.check-phone-contact-list {
    display: flex;
    flex-direction: column;
}

.check-phone-contact-item {
    display: flex;
    align-items: center;
    padding: 12px 10px;
    cursor: pointer;
    border-bottom: 1px solid var(--glass-border);
    transition: background-color 0.2s;
}

.check-phone-contact-item:last-child {
    border-bottom: none;
}

.check-phone-contact-item:hover {
    background-color: rgba(0,0,0,0.03);
}

body.dark-mode .check-phone-contact-item:hover {
    background-color: rgba(255,255,255,0.05);
}

.check-phone-avatar {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    background-color: #ccc;
    margin-right: 15px;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}

.check-phone-name {
    font-weight: 600;
    color: var(--text-color);
}
        /* === 新增：查手机 App 内部样式 === */
        .phone-main-content {
            flex-grow: 1; /* 占据所有剩余空间 */
            overflow-y: auto; /* 内容超出时可滚动 */
            padding: 10px; /* 为内容添加内边距 */
        }

.phone-dock-container {
    flex-shrink: 0; 
    /* 修改：增加底部内边距，使图标整体上移 */
    padding: 12px 8px 40px; 
    background: transparent; /* 保持透明背景 */
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    /* border-top: 1px solid var(--glass-border); */
    border-radius: 0 0 20px 20px;

    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px;
    /* 修改：增大行间距 */
    row-gap: 16px; 
}

        /* 需求3.2：新增灵动岛样式 */
        .phone-dynamic-island {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 30px;
            background-color: #000;
            border-radius: 99px;
            z-index: 10;
        }
        /* 需求2.1：新增锁屏时钟样式 */
        #phone-lock-screen-time {
            font-size: 65px;
            font-weight: 200;
            color: var(--text-color);
            opacity: 0.9;
            /* 新增：通过底部外边距将时钟向上推移 */
            margin-bottom: 150px;
        }
        /* 强制覆盖“查手机”App内图标颜色 */
        .phone-dock-container .icon * {
            fill: var(--icon-color) !important;
        }
        
        /* 微调 Dock 内的 App 尺寸和样式 */
        .phone-dock-container .app-wrapper {
            /* 移除可能存在的transform影响 */
            transform: none;
        }
        .phone-dock-container .app-icon-box {
            width: 44px; /* 缩小图标框尺寸 */
            height: 44px;
            border-radius: 12px; /* 相应减小圆角 */
        }
        .phone-dock-container .icon { /* 修正选择器为 .icon */
            width: 55%; /* 图标占图标框的比例 */
            height: 55%;
        }
        .phone-dock-container .app-name {
            font-size: 9px; /* 缩小字体 */
            margin-top: 4px;
        }
        /* 新增：查手机-灵动岛长按不选中文字 */
        .phone-dynamic-island {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 30px;
            background-color: #000;
            border-radius: 99px;
            z-index: 10;
            /* 需求2：添加移动端不触发选中文字的代码 */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE/Edge */
            user-select: none;         /* Standard */
            cursor: pointer; /* 提示用户这里可以交互 */
        }
/* === 新增：图库管理模态框样式 === */
/* 折叠区域样式 */
#add-gallery-section {
    background: rgba(0,0,0,0.03);
    border-radius: 12px;
    padding: 5px 15px;
    margin-bottom: 20px;
    border: 1px solid var(--glass-border);
}
body.dark-mode #add-gallery-section {
    background: rgba(255,255,255,0.05);
}
#add-gallery-section summary {
    font-weight: 600;
    cursor: pointer;
    padding: 10px 0;
    list-style: none; /* 移除默认箭头 */
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#add-gallery-section summary::-webkit-details-marker {
    display: none;
}
#add-gallery-section summary .gallery-arrow {
    width: 24px;
    height: 24px;
    fill: var(--text-color);
    opacity: 0.6;
    transition: transform 0.2s;
}
#add-gallery-section[open] summary .gallery-arrow {
    transform: rotate(180deg);
}
#add-gallery-section .modal-form-section {
    padding-top: 15px;
    border-top: 1px dashed var(--glass-border);
    margin-top: 5px;
}

#gallery-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    padding: 10px;
    border-radius: 12px;
    background: rgba(0,0,0,0.03);
    border: 1px solid var(--glass-border);
    max-height: 40vh;
    overflow-y: auto;
}
body.dark-mode #gallery-grid-container {
    background: rgba(255,255,255,0.04);
}

.gallery-item {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    overflow: hidden;
    background-color: rgba(128,128,128,0.1);
}
.gallery-item-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.gallery-item-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    color: white;
    font-size: 12px;
    font-weight: 500;
    padding: 10px 6px 4px 6px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.gallery-delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: rgba(0,0,0,0.5);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s;
}
.gallery-item:hover .gallery-delete-btn {
    opacity: 1;
}

/* === 新增：聊天气泡中的图库图片样式 === */
.message-gallery-image {
    max-width: 150px;
    max-height: 200px;
    border-radius: 8px;
    cursor: pointer;
    display: block; /* 确保图片表现为块级元素，避免下方出现空隙 */
}

/* === 新增：为图片类消息移除气泡背景和内边距 === */
.chat-bubble.image-bubble {
    background-color: transparent;
    padding: 0;
    border-radius: 8px; /* 给图片本身加一个轻微的圆角 */
    box-shadow: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}
.message-line.received .chat-bubble.image-bubble {
    background: transparent;
}
        /* === 新增：档案App悬浮按钮抽屉菜单样式 === */
        #archive-fab.open {
            transform: scale(1) rotate(180deg); /* 打开时旋转180度 */
        }

        #archive-fab-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000; /* 比FAB低，确保FAB在最上层 */
            background-color: rgba(255, 255, 255, 0.1); /* 轻微的背景，用于承载模糊效果 */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #archive-fab-drawer-overlay.visible {
            opacity: 1;
            pointer-events: auto; /* 可见时可以捕捉点击事件 */
        }

        #archive-fab-drawer {
            position: absolute;
            bottom: 90px; /* 位于FAB上方，留出一些间距 */
            right: 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* 按钮靠右对齐 */
            gap: 12px;
        }
        
        .fab-drawer-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--glass-shadow);
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease;
            pointer-events: none;
        }

        #archive-fab-drawer-overlay.visible .fab-drawer-button {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        /* 为按钮设置不同的动画延迟，产生依次弹出的效果 */
        #archive-fab-drawer-overlay.visible #archive-add-btn {
            transition-delay: 0.05s;
        }
        #archive-fab-drawer-overlay.visible #archive-import-btn {
            transition-delay: 0.1s;
        }

        .fab-drawer-button svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color);
        }
        /* === “印象”功能悬浮窗样式 (V2 - 卡片化) === */
        #impression-modal {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow);
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            /* 核心修改1：移除左右内边距，让列表容器可以贴边 */
            padding: 20px 0; 
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        #impression-overlay.visible #impression-modal {
            transform: scale(1);
        }
        
        #impression-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            z-index: 10;
        }

        #impression-close-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--text-color);
        }

        .impression-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
            /* 核心修改1：为头部内容添加左右内边距 */
            padding: 0 20px;
        }

        .impression-avatars {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .impression-avatar-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .impression-relationship {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-color);
            text-shadow: 0 0 8px rgba(255, 192, 203, 0.7), 
                         0 0 16px rgba(255, 192, 203, 0.5), 
                         0 0 24px rgba(255, 192, 203, 0.3);
            border: none;
        }
        
        body.dark-mode .impression-relationship {
            color: #fff;
            text-shadow: 0 0 8px rgba(255, 105, 180, 0.8), 
                         0 0 16px rgba(255, 105, 180, 0.6), 
                         0 0 24px rgba(255, 105, 180, 0.4);
        }

        .impression-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px; /* 减小卡片间距 */
            /* 核心修改1：调整列表容器内边距，让卡片左右有边距，光点辉光有空间 */
            padding: 0 20px; 
        }

        /* 核心修改2：将列表项变为卡片 */
        .impression-list-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-color);
            /* --- 卡片化样式 --- */
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* --- 交互动效 --- */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: default; /* 因为是纯展示，所以用默认光标 */
        }

        body.dark-mode .impression-list-item {
            background: rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .impression-list-item:hover {
            transform: scale(1.03); /* 微微放大 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* 阴影加深 */
        }

        .impression-list-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ffc0cb;
            flex-shrink: 0;
            margin-top: 6px;
            position: relative;
            animation: breathing-pink-glow 2.5s infinite ease-in-out;
        }

        @keyframes breathing-pink-glow {
            0%, 100% {
                transform: scale(0.8);
                box-shadow: 0 0 4px 2px rgba(255, 192, 203, 0.6),
                            0 0 8px 4px rgba(255, 192, 203, 0.4);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 8px 4px rgba(255, 192, 203, 0.8),
                            0 0 16px 8px rgba(255, 192, 203, 0.6);
            }
        }
        /* ============================================= */
        /* === 新增：全局悬浮窗背景透明化 === */
        /* ============================================= */
        /* 
         * 这是一个综合性规则，用于将所有相关悬浮窗的背景遮罩
         * 设置为透明，只保留高斯模糊效果，以提升UI的通透感。
         */
        #inner-voice-overlay,
        #impression-overlay,
        #image-preview-overlay,
        #voice-input-overlay,
        #api-switch-overlay,
        #offline-confirm-overlay,
        #offline-settings-popup-overlay,
        #summary-popup-overlay,
        #chat-archive-overlay,
        #opening-remark-overlay,
        #quick-reply-overlay,
        #quick-reply-form-overlay,
        #gallery-management-overlay,
        #enter-instance-overlay,
        #instance-chat-container, /* 副本聊天界面本身也应用此效果 */
        #instance-api-switch-overlay,
        #instance-atmosphere-overlay,
        #instance-status-overlay,
        #instance-phone-simulator-overlay,
        #instance-settlement-loading-overlay,
        #instance-settlement-result-overlay,
        #sweet-words-settings-overlay,
        #collection-detail-overlay,
        #emoji-management-modal-overlay,
        #custom-alert-overlay,
        #custom-confirm-overlay,
        #custom-prompt-overlay,
        #message-context-menu {
            background-color: transparent !important;
        }
/* === 新增：分组管理悬浮窗样式 === */
#group-list-container details[open] .group-item-details {
    max-height: 200px; /* 给一个足够展开的高度 */
    overflow-y: auto;  /* 如果内容超高，则滚动 */
    padding-top: 10px;
    padding-bottom: 10px;
}
#group-list-container .group-item-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: rgba(0,0,0,0.03);
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}
body.dark-mode #group-list-container .group-item-summary {
    background: rgba(255,255,255,0.05);
}
#group-list-container .group-item-summary:hover {
    background: rgba(0,0,0,0.05);
}
.group-item-name {
    font-weight: 500;
}
.group-item-count {
    font-size: 13px;
    color: #94a3b8; /* 偏淡偏小的灰字 */
}
.group-item-details {
    padding: 10px;
    border-top: 1px solid var(--glass-border);
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
    padding-top: 0;
    padding-bottom: 0;
}
.group-item-details.visible {
    max-height: 200px;
    overflow-y: auto;
    padding-top: 10px;
    padding-bottom: 10px;
}
.add-member-card {
    border: 2px dashed var(--glass-border);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    color: var(--text-color);
    opacity: 0.7;
    cursor: pointer;
    transition: opacity 0.2s;
}
.add-member-card:hover {
    opacity: 1;
}
/* 联系人选择列表样式 (复用) */
#group-contact-selector-list .group-member-selection-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
}
#group-contact-selector-list .group-member-selection-item:hover {
    background-color: rgba(0,0,0,0.03);
}
#create-group-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 2200; /* 比聊天列表上下文菜单更高 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#create-group-popup-overlay.visible {
    display: flex;
    opacity: 1;
}

.create-group-popup-box {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 360px;
    max-height: 70vh;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 15px;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

#create-group-popup-overlay.visible .create-group-popup-box {
    transform: scale(1);
}

.create-group-popup-box h4 {
    margin: 0 0 10px 0;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
}

/* 群聊头像设置 */
.create-group-avatar-setter {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

#group-avatar-preview {
    width: 80px;
    height: 80px;
    border-radius: 12px; /* 方形圆角头像 */
    background-color: #e2e8f0;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    border: 2px dashed var(--glass-border);
    display: flex;
    align-items: center;
    justify-content: center;
}
#group-avatar-preview span {
    font-size: 12px;
    color: var(--text-color);
    opacity: 0.6;
}

/* 成员选择列表 */
#group-member-selection-list {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px;
    background: rgba(0,0,0,0.02);
}
body.dark-mode #group-member-selection-list {
    background: rgba(255,255,255,0.03);
}

.group-member-selection-item {
    display: flex;
    align-items: center;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.group-member-selection-item:hover {
    background-color: rgba(0,0,0,0.03);
}

.group-member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    margin-right: 12px;
    background-size: cover;
    background-position: center;
}

.group-member-name {
    flex-grow: 1;
    font-weight: 500;
}

.group-member-checkbox {
    width: 20px;
    height: 20px;
    accent-color: var(--accent-color); /* 让勾选框颜色跟随主题 */
    margin-left: 10px;
    flex-shrink: 0;
}

/* 按钮组 */
.create-group-popup-box .button-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}
    /* 新增：针对分组内联系人的特定样式 */
    .group-members-container .chat-contact-item {
        margin-bottom: 0;
        border-radius: 0;
        border: none; 
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        position: relative;
        /* 【核心修改】添加左右内边距，使内容不会贴边 */
        padding-left: 15px;
        padding-right: 15px;
    }


        /* 新增：为分组内除最后一个外的所有联系人添加底部分割线 */
        .group-members-container .chat-contact-item:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%; /* 分割线从左侧10%处开始 */
            right: 10%; /* 分割线到右侧10%处结束 */
            height: 1px;
            /* 实现两端淡出的淡淡灰线 */
            background: linear-gradient(to right, transparent, rgba(128, 128, 128, 0.2), transparent);
        }
        
        /* 新增：暗黑模式下的分割线颜色 */
        body.dark-mode .group-members-container .chat-contact-item:not(:last-child)::after {
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.15), transparent);
        }

        /* === 新增：移动分组悬浮窗卡片样式 === */
        #move-to-group-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .move-group-item {
            padding: 14px 18px;
            font-weight: 500;
            border-radius: 12px;
            cursor: pointer;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
            text-align: center; /* 文本居中 */
        }
        
        .move-group-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .move-group-item.current {
            border-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
            pointer-events: none; /* 当前分组不可点击 */
            opacity: 0.8; /* 视觉上弱化 */
        }

        .move-group-item.remove-option {
            background-color: rgba(239, 68, 68, 0.1); /* 淡红色背景 */
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444; /* 红色字体 */
        }

        .move-group-item.remove-option:hover {
            background-color: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }


    /* === 提及悬浮窗样式 === */
    .mention-suggestions {
        position: absolute;
        bottom: calc(100% + 8px);
        left: 0;
        right: 0;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: var(--card-radius);
        box-shadow: var(--glass-shadow);
        padding: 8px;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .mention-suggestions-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .mention-suggestion-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .mention-suggestion-item:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .mention-suggestion-item:hover {
        background-color: rgba(255, 255, 255, 0.08);
    }
    
    .mention-suggestion-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 1px solid var(--glass-border);
    }
    
    .mention-suggestion-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
        flex-grow: 1;
    }
        /* === 新增：手机模拟器-日记App样式 === */
    .diary-full-screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color-start);
        display: flex;
        flex-direction: column;
        z-index: 15; /* 比主屏幕图标层级高 */
        animation: diary-fade-in 0.3s ease-out;
    }
    @keyframes diary-fade-in {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }
    .diary-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
    }
    .diary-header-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
    }
    .diary-header-btn svg {
        width: 24px;
        height: 24px;
        fill: var(--icon-color);
    }
    
    .diary-header .title {
        font-weight: 600;
        font-size: 17px;
    }
    .diary-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* === 新增：日记设置悬浮窗样式 === */
    #diary-settings-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(3px);
        -webkit-backdrop-filter: blur(3px);
        z-index: 25; /* 比日记界面层级更高 */
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease-in-out;
    }
    #diary-settings-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    #diary-settings-popover {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        width: 90%;
        max-width: 280px;
        box-shadow: var(--glass-shadow);
        display: flex;
        flex-direction: column;
        gap: 20px;
        transform: scale(0.95);
        transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    #diary-settings-overlay.visible #diary-settings-popover {
        transform: scale(1);
    }
    .diary-settings-section h5 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 600;
        opacity: 0.8;
        border-bottom: 1px solid var(--glass-border);
        padding-bottom: 8px;
    }
    
    /* 文风预设输入框和按钮 */
    .writing-style-input-group {
        display: flex;
        gap: 8px;
    }
    /* 文风预设多选列表 */
    #writing-style-presets-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 120px;
        overflow-y: auto;
        margin-top: 12px;
        padding: 10px;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
    }
    body.dark-mode #writing-style-presets-list {
        background: rgba(255,255,255,0.04);
    }
    .preset-checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        cursor: pointer;
    }
    .preset-checkbox-item input[type="checkbox"] {
        accent-color: var(--accent-color);
    }
            /* === 新增：日记App专属样式 === */
        .diary-header {
            position: relative; /* 为按钮绝对定位提供容器 */
        }
        
        .diary-generate-btn {
            position: absolute;
            right: 60px; /* 放置在设置按钮左侧 */
            top: 50%;
            transform: translateY(-50%);
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .diary-generate-btn.generating svg {
            animation: spin 1s linear infinite;
        }

        #diary-cards-container {
            display: grid;
            grid-template-columns: 1fr; /* 每行一个卡片 */
            gap: 16px;
            padding: 10px;
        }

        .diary-card {
            width: 100%;
            aspect-ratio: 16 / 7; /* 横向卡片比例 */
            border-radius: 16px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }

        .diary-card-title {
            font-size: 28px; /* 很大的字体 */
            font-weight: 700;
            text-align: center;
            color: var(--text-color);
            /* 防止文字溢出 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        #diary-writing-style-textarea {
            min-height: 100px;
            resize: vertical;
            margin-bottom: 12px;
        }
                /* === 日记卡片样式 (修改后) === */
        
        .diary-card {
            width: 100%;
            aspect-ratio: 16 / 7;
            border-radius: 16px;
            padding: 20px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            
            /* 新增：磨砂玻璃效果 */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .diary-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        /* 移除之前用于渐变的伪元素 */
        /* .diary-card::before { ... } */

        .diary-card-title {
            font-size: 28px; /* 稍微减小字体以适应非深色背景 */
            font-weight: 700;
            text-align: center;
            color: var(--text-color); /* 文字颜色跟随主题 */
            text-shadow: none; /* 移除文字阴影 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        
        /* 日记内容全屏详情页 */
        .diary-detail-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color-start);
            z-index: 20; /* 比日记列表层级高 */
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .diary-detail-view.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .diary-detail-header {
            /* 与其他头部样式保持一致 */
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--glass-border);
            flex-shrink: 0;
            position: relative;
        }
        
        #diary-detail-back-btn { /* 返回按钮 */
             background: none; border: none; cursor: pointer; padding: 4px; z-index: 1;
        }
        #diary-detail-back-btn svg { width: 24px; height: 24px; fill: var(--icon-color); }
        
        #diary-detail-title { /* 标题居中 */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            font-size: 17px;
        }

        .diary-detail-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-color);
        }
        
        .diary-detail-body p {
            margin: 0 0 1em 0;
        }

        .diary-detail-body p:first-of-type {
            text-indent: 2em; /* 首行缩进 */
        }

        /* === 新增：使包含转账卡片的聊天气泡透明化 === */
        .chat-bubble:has(.transfer-card) {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            padding: 0 !important;
            box-shadow: none !important;
        }
        
        /* 轻拟态转账卡片样式 (V2) */
        .transfer-card {
          width: 100%;
          max-width: 320px; /* 宽度增加 */
          background: #f8f5f0;
          border-radius: 24px; /* 圆角稍减小，更协调 */
          padding: 20px 24px;  /* 垂直内边距减小，降低整体高度 */
          position: relative;
          box-shadow:
            8px 8px 16px rgba(0, 0, 0, 0.06),
            -8px -8px 16px rgba(255, 255, 255, 0.8);
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
          border: none;
        }
        
        .transfer-card.sent {
            align-self: flex-end;
        }
        
        .transfer-card.received {
            align-self: flex-start;
        }

        .transfer-card::after {
          content: "转账";
          position: absolute;
          left: 24px;
          bottom: 8px;
          font-size: 14px;
          color: #999;
        }

        /* 卡片内容区 - 使用Grid布局实现2/3 + 1/3的布局 */
        .card-content {
          display: grid;
          grid-template-columns: 2fr 1fr; /* 2:1 的比例 */
          align-items: center;
          width: 100%; /* 确保grid容器撑满 */
        }

        /* 左侧内容区（图标+金额） */
        .transfer-left-content {
          display: flex;
          align-items: center;
          gap: 12px; /* 减小图标和文字的间距 */
          grid-column: 1 / 2; /* 占据第一列 */
        }

        /* 图标样式 - 变窄 */
        .transfer-icon {
          width: 40px; /* 减小图标宽度 */
          height: 40px; /* 减小图标高度 */
          flex-shrink: 0; /* 防止被压缩 */
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .transfer-icon svg {
          width: 100%; /* SVG撑满容器 */
          height: 100%;
          fill: #333333;
        }

        /* 金额与备注 */
        .card-info {
          display: flex;
          flex-direction: column;
          gap: 4px; /* 减小金额和说明的间距 */
          text-align: left;
          /* 新增：让文字部分可以被压缩，防止溢出 */
          min-width: 0;
          overflow: hidden;
        }

        .transfer-amount {
          font-size: 28px; /* 金额字体减小 */
          font-weight: 700;
          color: #333;
          margin-bottom: 0;
          white-space: nowrap; /* 防止金额数字换行 */
        }

        .transfer-description {
          font-size: 14px; /* 说明字体减小 */
          color: #666;
          margin-bottom: 0;
          word-break: break-word;
          white-space: nowrap; /* 防止换行 */
          overflow: hidden;      /* 溢出隐藏 */
          text-overflow: ellipsis; /* 显示省略号 */
        }

        /* 轻拟态分割线 */
        .divider {
          width: 100%;
          height: 1px;
          background: rgba(0, 0, 0, 0.05);
          margin-top: 16px; /* 减小与上方内容的间距 */
        }

                /* === 新增：使包含转账卡片的聊天气泡透明化 === */
        .chat-bubble:has(.transfer-card) {
            background: transparent !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            padding: 0 !important;
            box-shadow: none !important;
        }
        /* === 新增：转账卡片处理后样式 === */
        .transfer-card.processed {
            background: #ededed; /* 更淡的背景 */
            box-shadow:
                4px 4px 8px rgba(0, 0, 0, 0.03),
                -4px -4px 8px rgba(255, 255, 255, 0.4);
            pointer-events: none; /* 使其不可点击 */
        }
        
        .transfer-card.processed .transfer-amount,
        .transfer-card.processed .transfer-description,
        .transfer-card.processed .transfer-icon svg {
            color: #b0b0b0; /* 文字变灰 */
            fill: #b0b0b0;  /* 图标变灰 */
        }
        
        .transfer-card .card-status {
            grid-column: 2 / 3;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            align-self: center;
        }

        body.dark-mode .transfer-card.processed {
             background: #2a2a2a; /* 暗黑模式下的已处理背景 */
        }
        /* === 新增：游戏App卡片样式 === */
        .game-app-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 每行两列 */
            gap: 16px;
            padding: 8px;
        }

        .game-card {
            /* 核心：横向4:3比例 */
            aspect-ratio: 4 / 3; 

            /* 复用现有的磨砂玻璃质感变量 */
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            
            /* 内部布局：Flex垂直居中 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px; /* 图标和文字的间距 */
            padding: 12px;
            
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
        }

        .game-card-icon {
            width: 40%;
            height: auto;
            max-height: 45%;
        }

        .game-card-icon path {
            fill: var(--icon-color);
        }

        .game-card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            text-align: center;
        }

        /* === 新增：小剧场专属悬浮按钮和创建弹窗样式 === */
        #little-theater-fab {
            position: fixed;
            bottom: 40px; /* 与其他 FAB 按钮对齐 */
            right: 25px;
            width: 38px;
            height: 38px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            box-shadow: var(--glass-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001; /* 确保在模态框内容之上 */
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }
        #little-theater-fab.visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #little-theater-fab:active {
            transform: scale(0.95) !important;
        }
        #little-theater-fab svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-color);
        }
        #create-theater-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 2800; /* 确保在所有内容之上 */
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #create-theater-overlay.visible {
            display: flex;
            opacity: 1;
        }
        #create-theater-popup {
            background: var(--bg-color-start);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 20px; /* 增大项目间距 */
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            max-height: 80vh; /* 限制最大高度 */
        }
        #create-theater-overlay.visible #create-theater-popup {
            transform: scale(1);
        }
        #theater-theme-textarea, #theater-writing-style-textarea {
            min-height: 80px;
            max-height: 25vh; /* 限制最大拉伸高度 */
            resize: vertical;
            line-height: 1.6;
        }
        #theater-writing-style-presets-list {
            max-height: 20vh; /* 限制预设列表高度 */
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        body.dark-mode #theater-writing-style-presets-list {
            background: rgba(255,255,255,0.03);
        }
        .preset-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .preset-checkbox-item:hover {
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .preset-checkbox-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .preset-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
            flex-shrink: 0;
        }
        #theater-character-list {
            max-height: 30vh; /* 限制角色列表高度 */
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 10px;
            background: rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        body.dark-mode #theater-character-list {
            background: rgba(255,255,255,0.03);
        }
        .theater-character-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .theater-character-item:hover {
            background-color: rgba(0,0,0,0.03);
        }
        body.dark-mode .theater-character-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .theater-char-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .theater-char-name {
            flex-grow: 1;
            font-weight: 500;
        }
        .theater-char-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-color);
            margin-left: 10px;
            flex-shrink: 0;
        }

        /* === 新增：修复小剧场创建弹窗溢出和布局问题 === */
        #create-theater-popup .create-theater-body {
            flex-grow: 1; /* 让这个区域占据所有可用垂直空间 */
            overflow-y: auto; /* 当内容超出时，只在这个区域显示垂直滚动条 */
            padding: 0 5px;   /* 为滚动条留出一点空间 */
            margin: 0 -5px;   /* 抵消内边距对宽度的影响 */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #create-theater-popup .button-group {
            flex-shrink: 0; /* 防止按钮组在空间不足时被压缩 */
            margin-top: 15px; /* 与上方内容保持间距 */
            justify-content: flex-end; /* 确保按钮靠右对齐 */
        }
/* === 新增：游戏App卡片样式 === */
.game-app-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 每行两列 */
    gap: 16px;
    padding: 8px;
}
.game-card {
    /* 核心：横向4:3比例 */
    aspect-ratio: 4 / 3; 
    /* 复用现有的磨砂玻璃质感变量 */
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: var(--card-radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    
    /* 内部布局：Flex垂直居中 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px; /* 图标和文字的间距 */
    padding: 12px;
    
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.game-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.1);
}
.game-card-icon {
    width: 40%;
    height: auto;
    max-height: 45%;
}
.game-card-icon path {
    fill: var(--icon-color);
}
.game-card-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
    text-align: center;
}
/* === 新增：小剧场专属样式 === */
#little-theater-fab {
    position: fixed;
    bottom: 40px; /* 与其他 FAB 按钮对齐 */
    right: 25px;
    width: 38px;
    height: 38px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 50%;
    box-shadow: var(--glass-shadow);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1001; /* 确保在模态框内容之上 */
    transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
    transform: scale(0);
    opacity: 0;
    pointer-events: none;
}
#little-theater-fab.visible {
    transform: scale(1);
    opacity: 1;
    pointer-events: auto;
}
#little-theater-fab:active {
    transform: scale(0.95) !important;
}
#little-theater-fab svg {
    width: 20px;
    height: 20px;
    fill: var(--icon-color);
}
#create-theater-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
    z-index: 2800; /* 确保在所有内容之上 */
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
#create-theater-overlay.visible {
    display: flex;
    opacity: 1;
}
#create-theater-popup {
    background: var(--bg-color-start);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    gap: 20px; 
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    max-height: 80vh;
}
#create-theater-overlay.visible #create-theater-popup {
    transform: scale(1);
}
#create-theater-popup .create-theater-body {
    flex-grow: 1; 
    overflow-y: auto; 
    padding: 0 5px;   
    margin: 0 -5px;   
    display: flex;
    flex-direction: column;
    gap: 20px;
}
#create-theater-popup .button-group {
    flex-shrink: 0; 
    margin-top: 15px; 
    justify-content: flex-end; 
}
#theater-theme-textarea {
    min-height: 80px;
    max-height: 25vh; 
    resize: vertical;
    line-height: 1.6;
}
#theater-character-list {
    max-height: 30vh;
    overflow-y: auto;
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px;
    background: rgba(0,0,0,0.02);
    display: flex;
    flex-direction: column;
    gap: 8px;
}
body.dark-mode #theater-character-list {
    background: rgba(255,255,255,0.03);
}
.theater-character-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.theater-character-item:hover {
    background-color: rgba(0,0,0,0.03);
}
body.dark-mode .theater-character-item:hover {
    background-color: rgba(255,255,255,0.05);
}
.theater-char-avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}
.theater-char-name {
    flex-grow: 1;
    font-weight: 500;
}
.theater-char-checkbox {
    width: 20px;
    height: 20px;
    accent-color: var(--accent-color);
    margin-left: 10px;
    flex-shrink: 0;
}
/* 小剧场展示卡片样式 */
#little-theater-list {
    display: flex;
    gap: 20px;
    padding: 10px;
    overflow-x: auto; /* 横向滚动 */
    /* 隐藏滚动条样式 */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none;  /* IE and Edge */
}
#little-theater-list::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}
.little-theater-card {
    flex: 0 0 100%; /* 减小基础宽度，让卡片在横向排列中显得更小 */
    max-width: 380px; /* 相应减小最大宽度 */
    aspect-ratio: 16 / 5; /* 设置一个横向长方形的比例，高度约为宽度的一半 */
    background: var(--glass-bg);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: var(--card-radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--glass-shadow);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* 让标题和头像分居上下 */
    align-items: center; /* 新增：水平居中卡片内的所有内容 */
    cursor: pointer;
    transition: transform 0.2s ease-out; /* 添加一个轻微的悬浮效果 */
}
.little-theater-card:hover {
    transform: translateY(-3px);
}
.little-theater-title {
    font-size: 20px; /* 修改：增大字体 */
    font-weight: 600;
    text-align: center; /* 新增：使文本居中 */
    width: 100%; /* 新增：确保标题容器占满宽度以便居中生效 */
    margin-bottom: 15px;
    /* 可选：限制标题行数 */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}
.little-theater-actors {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: -8px; /* 头像部分重叠 */
}
.little-theater-actor-avatar {
    width: 28px; /* 很小的头像尺寸 */
    height: 28px;
    border-radius: 50%;
    background-size: cover;
    background-position: center top; /* 截取中上半部分 */
    border: 2px solid var(--glass-border);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
/* 小剧场详情页样式 */
.little-theater-detail-view {
    padding: 20px;
    height: 100%;
    overflow-y: auto;
}
        /* 小剧场展示卡片样式 (新增长按不选中文字) */
        #little-theater-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            overflow-y: auto; /* 纵向滚动 */
            /* 隐藏滚动条样式 */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        #little-theater-list::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .little-theater-card {
            flex-shrink: 0; /* 防止卡片被压缩 */
            width: calc(100% - 20px); /* 留出一点边距 */
            margin: 0 auto;
            max-width: 380px; 
            aspect-ratio: 16 / 6; /* 调整比例让卡片更扁长一些 */
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: var(--card-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease-out; 
            /* 关键：新增禁止长按选中文字 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* === 新增：小剧场上下文菜单样式 === */
        #little-theater-context-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background-color: transparent;
            display: none;
        }
        #little-theater-context-menu-overlay.visible {
            display: block;
        }
        #little-theater-context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            min-width: 120px;
            transform: scale(0.95);
            transform-origin: top left;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
            pointer-events: none;
            opacity: 0;
        }
        #little-theater-context-menu-overlay.visible #little-theater-context-menu {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .lt-context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-color);
            transition: background-color 0.15s ease;
        }
        .lt-context-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .lt-context-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }
/* === 新增：线下聊天界面样式 === */
#offline-chat-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--bg-color-end);
    z-index: 1800; /* 层级高于主聊天App(1500)，但低于设置侧边栏等 */
    display: none; /* 默认隐藏 */
    flex-direction: column;
    opacity: 0;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}

#offline-chat-container.visible {
    display: flex;
    opacity: 1;
    transform: translateX(0);
}

#offline-chat-header {
    display: flex;
    align-items: center;
    padding: 12px 10px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--glass-border);
}

#offline-chat-back-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
}

#offline-chat-back-btn svg {
    width: 28px;
    height: 28px;
    fill: var(--icon-color);
}

#offline-chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
}

#offline-chat-footer {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    padding: 0;
    gap: 0;
    position: relative;
    z-index: 10;
}

#offline-chat-footer::after {
    content: '';
    position: absolute;
    left: 0;
    width: 100%;
    z-index: -1;
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
    bottom: -10px;
    height: calc(100% + 10px);
    -webkit-mask-image: linear-gradient(to top, black 60%, transparent 100%);
    mask-image: linear-gradient(to top, black 60%, transparent 100%);
}

/* === 新增：线下模式入口胶囊样式 === */
.mode-switch-capsule {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 85%;
    margin: 10px auto;
    padding: 4px 8px 4px 16px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: var(--pill-radius);
    box-shadow: var(--glass-shadow);
}

.mode-switch-text {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-color);
}

.mode-switch-button {
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: var(--pill-radius);
    padding: 6px 16px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}
/* === 新增：线下模式入口图标按钮样式 === */
.mode-switch-icon-button {
    background-color: transparent;
    border: none;
    cursor: pointer;
    padding: 8px; /* 增加点击区域 */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    color: var(--accent-color); /* 关键：设置按钮的颜色为主题强调色 */
}

.mode-switch-icon-button:hover {
    background-color: rgba(0,0,0,0.05);
}

body.dark-mode .mode-switch-icon-button:hover {
    background-color: rgba(255,255,255,0.08);
}

.mode-switch-icon-button svg {
    width: 20px;
    height: 20px;
}

/* 关键：让SVG的路径填充色继承按钮的color属性 */
.mode-switch-icon-button svg path {
    fill: currentColor;
}

.mode-switch-button:active {
    transform: scale(0.95);
}
/* 新增：时间戳气泡样式 */
.time-stamp-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-color, #333); /* 适配深色模式 */
    opacity: 0.8;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
    user-select: none;
}
.dark-mode .time-stamp-bubble {
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--text-color-dark, #fff);
}

    </style>

</head>
<body>
    <!-- === 新增：全局消息提示框容器 === -->
    <div id="global-message-banner-container"></div>

    <div id="mobile-wrapper">
        <div id="viewport">
            <div id="slider-container">
                <!-- 第一页 -->
                <div class="page" id="page-1">
                    <div class="bento-grid">
                        
                        <!-- 1. 顶部区域：状态栏 + 个人信息 -->
                        <div class="top-section-container">
                            <!-- 小胶囊状态栏 -->
                            <div class="status-capsule">
                                <span id="clock">12:00</span>
                                <div class="status-right">
                                    <span id="battery-text" style="font-size:12px; opacity:0.6;">100%</span>
                                    <div class="battery-icon">
                                        <div class="battery-level" id="battery-level"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 大胶囊个人卡片 -->
                            <div class="profile-capsule">
                                <div class="avatar-frame" id="avatar-box" title="点击更换头像">
                                    <!-- 隐藏的文件上传 Input -->
                                    <input type="file" id="avatar-upload" accept="image/*" hidden>
                                </div>
                                <div class="profile-info">
                                    <span class="profile-name" id="profile-name" title="点击编辑">Administrator</span>
                                    <span class="profile-bio" id="profile-bio" title="点击编辑">Reality is just a simulation.</span>
                                </div>
                                <!-- === 新增：天气图标容器 === -->
                                <div id="weather-icon-container">
                                    <!-- 天气图标将由JS动态插入 -->
                                </div>
                            </div>
                        </div>

                        <!-- 2. 中间行: 4个设置类 App (左) + 相册 (右) -->
                        <div class="app-grid-area area-mid-left">
                            <!-- API设置 -->
                            <div class="app-wrapper" id="app-api">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M975.657 96.914l-48.457-48.457c-1.829-1.829-4.114-2.629-6.514-2.629s-4.686 0.915-6.514 2.629l-86.972 86.971a227.737 227.737 0 0 0-128.114-39.2c-58.514 0-117.029 22.286-161.714 66.972L420.914 279.657a9.177 9.177 0 0 0 0 12.914L731.429 603.086c1.828 1.828 4.114 2.628 6.514 2.628s4.686-0.914 6.514-2.628l116.457-116.457c78.743-78.857 88-200.8 27.772-289.715l86.971-86.971c3.543-3.657 3.543-9.486 0-13.029zM805.829 431.657l-67.886 67.886-213.486-213.486 67.886-67.886c28.457-28.457 66.4-44.229 106.743-44.229 40.343 0 78.171 15.657 106.743 44.229 28.457 28.457 44.229 66.4 44.229 106.743 0 40.343-15.771 78.171-44.229 106.743z m-217.372 120a9.177 9.177 0 0 0-12.914 0L499.429 627.771 396.229 524.571l76.228-76.228c3.543-3.543 3.543-9.372 0-12.914L430.857 393.829a9.177 9.177 0 0 0-12.914 0L341.714 470.057l-49.143-49.143a8.971 8.971 0 0 0-6.514-2.629c-2.286 0-4.686 0.915-6.514 2.629L163.2 537.371c-78.743 78.857-88 200.8-27.771 289.715l-86.972 86.971a9.177 9.177 0 0 0 0 12.914l48.457 48.457c1.829 1.829 4.114 2.629 6.515 2.629s4.686-0.915 6.514-2.629l86.971-86.971c38.514 26.171 83.314 39.2 128.114 39.2 58.514 0 117.029-22.286 161.714-66.971l116.457-116.457c3.543-3.543 3.543-9.372 0-12.915l-49.143-49.143 76.229-76.228c3.543-3.543 3.543-9.372 0-12.914l-41.829-41.372zM431.657 805.829a150.08 150.08 0 0 1-106.743 44.229c-40.343 0-78.171-15.657-106.743-44.229a150.08 150.08 0 0 1-44.229-106.743c0-40.343 15.657-78.171 44.229-106.743l67.886-67.886 213.486 213.486-67.886 67.886z"></path></svg>
                                </div>
                                <span class="app-name">API</span>
                            </div>
                            <!-- 美化设置 -->
                            <div class="app-wrapper" id="app-beautify">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M511.787 0c282.634 0 511.787 229.153 511.787 511.787v4.905l-0.043 2.559-0.128 5.16-0.17 5.374-0.213 5.544-0.299 5.63-0.341 5.8-0.682 8.914-0.512 6.056-0.597 6.184-0.682 6.27-0.768 6.397-0.426 3.156-0.853 6.44-0.981 6.525-1.024 6.525-1.152 6.568-1.237 6.611-0.64 3.284-1.365 6.61c-0.597 2.858-1.279 5.673-1.919 8.53l-1.365 5.63-0.725 2.857-1.493 5.63a388.105 388.105 0 0 1-3.199 11.131l-1.706 5.544c-17.06 53.098-45.805 99.116-92.378 111.058-30.409 7.805-67.94 5.118-107.688-1.535l-7.975-1.365-8.018-1.493-8.103-1.535-8.103-1.62-8.103-1.706-8.146-1.706-15.012-3.284-32.285-7.165-13.733-2.985-6.781-1.407-10.108-2.09-6.653-1.28-6.61-1.28-6.568-1.151-6.483-1.109-6.397-1.024-6.312-0.938a416.253 416.253 0 0 0-12.368-1.535l-5.971-0.597c-32.925-2.985-61.116-0.512-80.478 12.88-13.562 9.383-13.648 24.651-7.378 42.734l1.151 3.199 0.64 1.62 1.322 3.327 0.725 1.663 1.535 3.37 2.431 5.117 1.706 3.455 1.791 3.497 3.838 7.122 3.924 7.165 12.752 22.519 2.9 5.246 2.815 5.203 1.322 2.474 2.559 4.904c8.274 16.292 14.33 31.774 14.33 44.782v2.004l-0.128 4.094c-0.128 4.095-0.426 8.189-0.853 12.24l-0.426 4.052c-5.544 42.521-27.509 81.033-71.949 81.033-282.634 0-511.787-229.153-511.787-511.787S229.153 0 511.787 0z m0 79.753C273.166 79.753 79.753 273.166 79.753 511.787c0 233.844 185.779 424.271 417.789 431.777l4.691 0.128 0.17-0.64c1.322-4.393 2.346-10.065 2.772-16.42l0.128-2.687-0.298-0.853-0.725-1.748-0.853-2.09-0.938-2.005-1.535-3.241-1.791-3.54-2.815-5.374-2.559-4.648-5.118-9.212-8.274-14.543-3.327-5.971-4.563-8.36-2.772-5.203a219.13 219.13 0 0 1-19.277-47.212c-12.368-46.061-2.218-92.932 40.943-122.786 36.294-25.12 79.071-31.39 131.188-26.869 2.687 0.213 5.374 0.47 8.018 0.768l7.847 0.853 5.8 0.725 5.928 0.81 6.014 0.896 4.137 0.682 6.397 1.066 6.653 1.194 6.994 1.322 7.378 1.45 7.847 1.62 11.302 2.346 9.127 1.962 23.883 5.246 20.983 4.691 11.942 2.559 6.824 1.45 9.894 1.962 6.312 1.28 6.099 1.109 5.928 1.066 5.715 0.981 5.502 0.896 5.288 0.853 7.592 1.023 4.819 0.64 4.649 0.512 6.61 0.64 4.18 0.341 4.052 0.256 1.919 0.085 3.753 0.128 3.625 0.043h1.706l3.412-0.043 6.227-0.341 2.9-0.341 2.772-0.341a60.988 60.988 0 0 0 6.227-1.28c10.108-2.559 24.31-21.026 36.294-58.343 12.24-38.129 18.68-87.43 18.68-129.27 0-238.62-193.413-432.033-432.033-432.033z m-305.75 372.197a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z m564.97-152.854a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937zM299.097 219.343a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z m252.567-86.407a66.447 66.447 0 1 1 0 132.937 66.447 66.447 0 0 1 0-132.937z"></path></svg>
                                </div>
                                <span class="app-name">美化</span>
                            </div>
                            <!-- 预设 -->
                            <div class="app-wrapper" id="app-preset">
                                <div class="app-icon-box">
                                    <svg t="1769870289541" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2071"><path d="M192 298.666667h213.333333c34.133333 0 64 29.866667 64 64S439.466667 426.666667 405.333333 426.666667h-213.333333C157.866667 426.666667 128 396.8 128 362.666667S157.866667 298.666667 192 298.666667z m384 341.333333h213.333333c34.133333 0 64 29.866667 64 64s-29.866667 64-64 64h-213.333333c-34.133333 0-64-29.866667-64-64s29.866667-64 64-64z" opacity=".4" p-id="2072"></path><path d="M725.333333 469.333333c-72.533333 0-128-55.466667-128-128s55.466667-128 128-128 128 55.466667 128 128-55.466667 128-128 128zM256 810.666667c-72.533333 0-128-55.466667-128-128s55.466667-128 128-128 128 55.466667 128 128-55.466667 128-128 128z" p-id="2073"></path></svg>
                                </div>
                                <span class="app-name">预设</span>
                            </div>
                            <!-- 数据管理 -->
                            <div class="app-wrapper" id="app-data">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M528 504a16 16 0 0 1 16 16v208h66.112c12.8 0 20.416 14.272 13.312 24.896l-98.112 147.136a16 16 0 0 1-26.624 0l-98.112-147.2a16 16 0 0 1 13.312-24.832H480v-208a16 16 0 0 1 16-16z m-16-384a256.384 256.384 0 0 1 254.08 224.384 240.32 240.32 0 0 1 225.92 240.768c-0.64 132.672-110.912 238.848-243.648 238.848h-28.352a16 16 0 0 1-16-16v-32a16 16 0 0 1 16-16h28.864c98.496 0 180.8-80.64 179.136-179.072a176.192 176.192 0 0 0-176-172.928h-32a16 16 0 0 1-16-16v-12.8c0-105.088-83.2-193.152-188.288-195.2a192.192 192.192 0 0 0-195.712 192v16a16 16 0 0 1-16 16h-32A176.192 176.192 0 0 0 96 580.928c-1.664 98.496 80.64 179.072 179.136 179.072h28.864a16 16 0 0 1 16 16v32a16 16 0 0 1-16 16h-28.352C142.912 824 32.64 717.824 32 585.152a240.32 240.32 0 0 1 225.92-240.768A256.384 256.384 0 0 1 512 120z"></path></svg>
                                </div>
                                <span class="app-name">数据</span>
                            </div>
                        </div>

                        <!-- 右侧: 相册 (替换为图片框) -->
                        <div class="glass-card area-mid-right" style="position: relative; overflow: visible; background: transparent; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none; padding: 0;">
                            <!-- [日间模式] 底层：图片上传显示框 -->
                            <div id="photo-upload-container-day" class="photo-container-day">
                                <span class="photo-upload-placeholder-text">点击上传图片</span>
                                <input type="file" class="photo-upload-input" accept="image/*" hidden>
                            </div>
                            <!-- [日间模式] 顶层：卡片.PNG 框架 -->
                            <img src="卡片.PNG" alt="日间卡片" class="main-card-day">

                            <!-- [夜间模式] 底层：图片上传显示框 (新增) -->
                            <div id="photo-upload-container-night" class="photo-container-night">
                                <span class="photo-upload-placeholder-text">点击上传图片</span>
                                <input type="file" class="photo-upload-input" accept="image/*" hidden>
                            </div>
                            <!-- [夜间模式] 顶层：夜间卡片.PNG 框架 (新增) -->
                            <img src="夜间卡片.PNG" alt="夜间卡片" class="main-card-night">
                        </div>
                        <!-- 3. 底部行: 留白 (左) + 4个功能 App (右) -->
                        <div class.="glass-card area-bot-left" id="calendar-container">
                            <!-- 月历将由 JavaScript 动态生成并填充到这里 -->
                        </div>

                        <div class="app-grid-area area-bot-right">
                        <!-- Chat -->
                        <div class="app-wrapper" id="app-chat">
                            <div class="app-icon-box" style="position: relative;">
                                <!-- 新增：主屏幕应用角标 -->
                                <span class="message-badge" id="chatapp-main-badge" style="display: none;"></span>
                                <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M381.7 985.3c-10.2 0-20.4-3.9-28.3-11.7-15.6-15.6-15.6-40.9 0-56.5L496 774.5c39-39 90.9-60.5 146.1-60.5h136.2c91.4 0 165.7-74.3 165.8-165.7V284.4c0-91.4-74.4-165.8-165.8-165.8H245.7c-91.4 0-165.8 74.4-165.8 165.8v263.9c0 91.4 74.4 165.7 165.8 165.7h74.4c22.1 0 40 17.9 40 40s-17.9 40-40 40h-74.4C110.2 793.9 0 683.7 0 548.3V284.4C0 148.9 110.2 38.7 245.7 38.7h532.6c135.5 0 245.7 110.2 245.7 245.7v263.9C1024 683.8 913.8 794 778.3 794H642.2c-33.8 0-65.7 13.2-89.6 37.1L410 973.6c-7.8 7.8-18 11.7-28.3 11.7z"></path><path d="M322.965 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path><path d="M512.065 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path><path d="M701.165 425.019m-50.6 0a50.6 50.6 0 1 0 101.2 0 50.6 50.6 0 1 0-101.2 0Z"></path></svg>
                            </div>
                            <span class="app-name">Chat</span>
                        </div>
                            <!-- 档案 -->
                            <div class="app-wrapper" id="app-archive">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M768 96H320c-88 0-160 72-160 160v96h-32c-17.6 0-32 14.4-32 32s14.4 32 32 32h32v192h-32c-17.6 0-32 14.4-32 32s14.4 32 32 32h32v96c0 88 72 160 160 160h448c88 0 160-72 160-160V256c0-88-72-160-160-160z m96 672c0 52.8-43.2 96-96 96H320c-52.8 0-96-43.2-96-96v-96h32c17.6 0 32-14.4 32-32s-14.4-32-32-32h-32V416h32c17.6 0 32-14.4 32-32s-14.4-32-32-32h-32v-96c0-52.8 43.2-96 96-96h448c52.8 0 96 43.2 96 96v512z" fill="#2c2c2c" p-id="1335"></path><path d="M659.2 464c17.6-22.4 28.8-49.6 28.8-80 0-70.4-57.6-128-128-128s-128 57.6-128 128c0 30.4 11.2 57.6 28.8 80C387.2 496 336 577.6 336 672c0 52.8 43.2 96 96 96h256c52.8 0 96-43.2 96-96 0-94.4-51.2-176-124.8-208zM560 320c35.2 0 64 28.8 64 64s-28.8 64-64 64-64-28.8-64-64 28.8-64 64-64z m128 384H432c-17.6 0-32-14.4-32-32 0-88 59.2-160 131.2-160h56c72 0 131.2 72 131.2 160 1.6 17.6-12.8 32-30.4 32z" fill="#2c2c2c" p-id="1336"></path></svg>
                                </div>
                                <span class="app-name">档案</span>
                            </div>
                            <!-- 副本 -->
                            <div class="app-wrapper" id="app-instance">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M598.1 392.7m-56.8 0a56.8 56.8 0 1 0 113.6 0 56.8 56.8 0 1 0-113.6 0Z" fill="#2c2c2c" p-id="1337"></path><path d="M434.6 392.7m-33.8 0a33.8 33.8 0 1 0 67.6 0 33.8 33.8 0 1 0-67.6 0Z" fill="#2c2c2c" p-id="1338"></path><path d="M236.6 828.1c-68.7 0-123.9-20.2-152.4-67.5-37.3-62-14.6-148.9 63.9-244.8 4.6-5.4 19.2-21.7 37-30 22.4-10.5 49-0.8 59.5 21.6 10.4 22.4 0.8 49-21.6 59.5-0.7 0.6-4.7 4.6-6 6.2-59.9 73.2-67.7 122-56 141.3 28.6 47.6 208 33.8 423.7-96.2 99.8-60.2 184-131.7 237-201.2 41.8-54.9 59.9-105.4 45.9-128.6-12.7-21.1-57.8-29.5-117.6-22-12.1 1.5-25 3.7-38.1 6.5-24.3 5.1-47.9-10.4-53-34.6-5.1-24.2 10.4-47.9 34.6-53 15.6-3.3 30.8-5.8 45.4-7.7 127.9-16.1 182.3 26.3 205.4 64.7 35.1 58.2 16.8 139.6-51.4 229-59.7 78.3-152.8 157.6-262.1 223.5-129.9 78.3-280.7 133.3-394.2 133.3z" fill="#2c2c2c" p-id="1339"></path><path d="M529.8 874.7c-200.4 0-363.5-163.1-363.5-363.5s163.1-363.5 363.5-363.5 363.5 163.1 363.5 363.5-163 363.5-363.5 363.5z m0-637.5c-151.1 0-274 122.9-274 274s122.9 274 274 274 274-122.9 274-274-122.9-274-274-274z" fill="#2c2c2c" p-id="1340"></path></svg>
                                </div>
                                <span class="app-name">副本</span>
                            </div>
                            <!-- 记忆 -->
                            <div class="app-wrapper" id="app-memory">
                                <div class="app-icon-box">
                                    <svg class="app-icon" viewBox="0 0 1024 1024"><path d="M512 958.9c-246.7 0-447.3-200.7-447.3-447.3S265.3 64.3 512 64.3c246.7 0 447.3 200.7 447.3 447.3S758.7 958.9 512 958.9z m0-805.2c-197.3 0-357.9 160.5-357.9 357.9S314.7 869.5 512 869.5c197.3 0 357.9-160.5 357.9-357.9S709.3 153.7 512 153.7z" fill="#333333" p-id="7813"></path><path d="M758.7 518.1c-21.7 0-40.8-15.8-44.2-37.9-13.4-87-80.7-155.5-167.4-170.4-24.3-4.2-40.7-27.3-36.5-51.7 4.2-24.3 27.2-40.8 51.7-36.5 124.7 21.5 221.4 120 240.6 245 3.8 24.4-13 47.3-37.4 51-2.3 0.3-4.6 0.5-6.8 0.5zM475.1 803.3c-2.2 0-4.4-0.2-6.6-0.5-127.4-18.9-229.3-121.1-247.8-248.6-3.5-24.4 13.4-47.1 37.9-50.7 24.5-3.4 47.2 13.4 50.7 37.9C322.1 630 393 701.1 481.6 714.3c24.4 3.6 41.3 26.4 37.7 50.8-3.3 22.2-22.4 38.2-44.2 38.2z" fill="#333333" p-id="7814"></path><path d="M512 654.6c-78.8 0-143-64.1-143-143s64.1-143 143-143 143 64.1 143 143-64.2 143-143 143z m0-196.5c-29.5 0-53.5 24-53.5 53.5s24 53.5 53.5 53.5 53.5-24 53.5-53.5-24-53.5-53.5-53.5z" fill="#333333" p-id="7815"></path></svg>
                                </div>
                                <span class="app-name">记忆</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 第二页 -->
                <div class="page" id="page-2">
                    <div class="bento-grid">
                        <!-- 1. 每日情话卡片 -->
                        <div class="glass-card" id="sweet-words-card" style="grid-column: 1 / 3; aspect-ratio: 2 / 1;">
                            <div id="sweet-words-text-container" class="sweet-words-container" data-revealed="false">
                                <p class="sweet-words-content empty-text" id="sweet-words-content"></p>
                                <p class="sweet-words-char" id="sweet-words-char"></p>
                            </div>
                        </div>
                
                        <!-- 2. 第二排左侧：稍短的长方形卡片 -->
                        <div class="glass-card" style="grid-column: 1 / 2; grid-row: 2 / 3; justify-content: start; align-items: start; padding: 16px;">
                             <span class="empty-text" style="opacity: 0.5;">单格卡片</span>
                        </div>
                
                        <!-- 3. 第二排右侧：纵向排列的两个App -->
                         <div class="app-grid-area" style="grid-column: 2 / 3; grid-row: 2 / 3; grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; background: transparent; padding: 0 0 0 calc(100% - 80px);">
                            <!-- 生活 -->
                            <div class="app-wrapper" id="app-alive">
                                <div class="app-icon-box">
                                    <svg t="1770122513739" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1385" width="32" height="32"><path d="M913.23 849.84h-3.79V662.66c0-73.58-59.85-133.44-133.43-133.44h-36.22v-44.73c0-45.91-24.36-89.25-63.58-113.13l-95.41-58.03c-7.77-4.73-15.89-8.58-24.22-11.57v-68.49h30.16c24.62 0 44.58-19.96 44.58-44.58 0-24.62-19.96-44.58-44.58-44.58h-30.16v-14.52C556.58 104.96 536.62 85 512 85s-44.58 19.96-44.58 44.58v14.52h-30.17c-24.62 0-44.58 19.96-44.58 44.58 0 24.62 19.96 44.58 44.58 44.58h30.17v68.5c-8.34 2.99-16.45 6.84-24.23 11.56l-95.41 58.03c-39.23 23.88-63.58 67.22-63.58 113.13v44.73h-36.22c-73.58 0-133.43 59.86-133.43 133.44v187.18h-3.78c-24.62 0-44.58 19.96-44.58 44.58 0 24.62 19.96 44.58 44.58 44.58h802.46c24.62 0 44.58-19.96 44.58-44.58 0-24.61-19.96-44.57-44.58-44.57zM203.71 662.66c0-24.42 19.85-44.28 44.27-44.28h36.22v231.46h-80.49V662.66z m169.65-88.86v-89.31c0-15 7.96-29.15 20.77-36.94l95.4-58.03c13.87-8.45 31.1-8.45 44.94 0l95.4 58.03c12.81 7.79 20.77 21.94 20.77 36.94v365.35h-95.35V660.5c0-24.62-19.96-44.58-44.58-44.58-24.62 0-44.58 19.96-44.58 44.58v189.34h-92.75V573.8z m366.43 276.04V618.38h36.22c24.41 0 44.27 19.85 44.27 44.28v187.18h-80.49z" fill="currentColor" p-id="1386"></path></svg>
                                </div>
                                <span class="app-name">生活</span>
                            </div>
                            <!-- 游戏 -->
                            <div class="app-wrapper" id="app-games">
                                <div class="app-icon-box">
                                    <svg t="1767694539616" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4336" width="32" height="32"><path d="M725.333333 149.333333c141.376 0 256 114.624 256 256v298.666667a170.666667 170.666667 0 1 1-341.333333 0v-42.666667H383.978667L384 704a170.666667 170.666667 0 1 1-341.333333 0V405.333333C42.666667 263.957333 157.290667 149.333333 298.666667 149.333333h426.666666z m-21.333333 64H320c-115.84 0-210.090667 92.309333-213.248 207.36L106.666667 426.666667v277.333333a106.666667 106.666667 0 0 0 213.226666 4.629333L320 704v-85.333333a21.333333 21.333333 0 0 1 21.333333-21.333334h341.333334a21.333333 21.333333 0 0 1 21.333333 21.333334v85.333333a106.666667 106.666667 0 0 0 213.226667 4.629333L917.333333 704V426.666667c0-117.824-95.509333-213.333333-213.333333-213.333334z m10.666667 256a32 32 0 1 1 0 64 32 32 0 0 1 0-64z m-405.333334-128a32 32 0 0 1 32 32V405.333333h32a32 32 0 0 1 0 64H341.333333v32a32 32 0 0 1-64 0V469.333333h-32a32 32 0 0 1 0-64H277.333333v-32a32 32 0 0 1 32-32z m469.333334 64a32 32 0 1 1 0 64 32 32 0 0 1 0-64z m-128 0a32 32 0 1 1 0 64 32 32 0 0 1 0-64z m64-64a32 32 0 1 1 0 64 32 32 0 0 1 0-64z" p-id="4337"></path></svg>
                                </div>
                                <span class="app-name">游戏</span>
                            </div>
                        </div>

                        <!-- 4. 第三排左侧：四宫格 App -->
                        <div class="app-grid-area" style="grid-column: 1 / 2; grid-row: 3 / 4; padding: 0;">
                             <!-- 商城 -->
                             <div class="app-wrapper">
                                <div class="app-icon-box">
                                    <svg t="1767281558206" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1207"><path d="M856.192 992H167.808c-39.488 0-71.552-35.968-71.552-80.064V480h64v431.936c0 10.368 5.696 16.064 7.552 16.064h688.384c1.856 0 7.616-5.696 7.616-16.064V480h64v431.936c0 44.096-32.128 80.064-71.616 80.064z"></path><path d="M679.424 741.696H344.512c-39.424 0-71.552-34.368-71.552-76.672V486.592h64v178.432c0 7.616 4.544 12.672 7.552 12.672h334.912c3.072 0 7.552-4.928 7.552-12.672V486.592h64v178.432c0 42.304-32.128 76.672-71.552 76.672z"></path><path d="M897.984 526.464c-38.4 0-73.152-17.28-96.512-44.928a126.144 126.144 0 0 1-193.152 0.064c-23.232 27.52-57.92 44.8-96.256 44.864h-0.384a125.952 125.952 0 0 1-96-44.864 126.336 126.336 0 0 1-193.152-0.064 126.144 126.144 0 0 1-96.576 44.928A127.04 127.04 0 0 1 0.192 413.888l2.368-35.968c0.256-3.2 1.024-6.4 2.24-9.344L101.312 130.56c1.664-4.224 17.088-41.024 43.712-68.608C168.896 37.184 206.848 32 234.496 32c8 0 13.12 0.448 13.12 0.448l530.88-0.128c0.512-0.064 4.928-0.32 11.008-0.32 27.648 0 65.6 5.184 89.408 29.888 26.688 27.648 42.048 64.448 43.712 68.544l96.576 238.016c1.28 3.008 1.984 6.208 2.24 9.408l2.432 29.632c-7.616 70.592-61.696 118.976-125.888 118.976z m-99.008-148.672c16.256 0 34.88 12.16 36.736 28.352a63.04 63.04 0 0 0 62.272 56.256 63.104 63.104 0 0 0 62.272-56l-1.984-17.92-94.912-233.92c-0.128-0.256-12.096-29.12-30.528-48.192-4.864-5.184-20.288-10.368-43.328-10.368l-7.616 0.192-537.088 0.128-10.304-0.32c-23.04 0-38.4 5.184-43.392 10.368-18.368 19.072-30.4 48-30.528 48.256L65.984 388.032l-2.112 24.768c3.648 25.536 30.4 49.664 62.08 49.664a63.04 63.04 0 0 0 62.336-56.256c1.792-16.192 15.488-28.416 31.744-28.416s34.88 12.224 36.736 28.416a62.976 62.976 0 0 0 62.272 56.256c32 0 58.752-24.256 62.272-56.448 1.792-16.256 15.552-28.544 31.872-28.544s34.88 12.288 36.672 28.544a62.912 62.912 0 0 0 62.208 56.448c31.872 0 58.624-24.32 62.144-56.512 1.792-16.192 15.488-28.48 31.808-28.48s34.816 12.288 36.608 28.48a63.04 63.04 0 0 0 62.336 56.512 62.976 62.976 0 0 0 62.272-56.256 31.936 31.936 0 0 1 31.744-28.416z"></path></svg>
                                </div>
                                <span class="app-name">商城</span>
                            </div>
                            <!-- 论坛 -->
                            <div class="app-wrapper">
                                <div class="app-icon-box">
                                    <svg t="1767281697149" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1233"><path d="M1024 475.2c0-4.8-0.8-8.8-2.4-12.8C996.8 203.2 778.4 0 512 0S27.2 203.2 2.4 462.4c-1.6 4-2.4 8-2.4 12.8 0 3.2 0 6.4 0.8 8.8C0 493.6 0 502.4 0 512c0 282.4 229.6 512 512 512s512-229.6 512-512c0-9.6 0-18.4-0.8-27.2 0.8-3.2 0.8-6.4 0.8-9.6z m-75.2-0.8c-3.2 3.2-8 6.4-16.8 11.2-20 11.2-51.2 21.6-92.8 31.2-21.6 4.8-46.4 9.6-72 13.6v-19.2c0-135.2-25.6-260-68-351.2-9.6-20.8-20.8-40.8-32.8-59.2 156 59.2 268 202.4 282.4 373.6zM633.6 191.2c36.8 80 60.8 193.6 60.8 320.8 0 9.6 0 18.4-0.8 28-56 5.6-117.6 8.8-182.4 8.8-64.8 0-126.4-3.2-182.4-8.8 0-9.6-0.8-18.4-0.8-28 0-127.2 24-240.8 60.8-320.8C428.8 108 474.4 72.8 512 72.8s83.2 35.2 121.6 118.4zM356 101.6c-12 18.4-23.2 38.4-32.8 59.2C281.6 252 256 376.8 256 512v19.2c-26.4-4-50.4-8.8-72-13.6-41.6-9.6-72.8-20.8-92.8-31.2-8.8-4.8-13.6-8.8-16.8-11.2C89.6 303.2 201.6 160 356 101.6zM76 560c25.6 11.2 56.8 20.8 92 28.8 28 6.4 59.2 12 92.8 16.8 8.8 98.4 31.2 188 63.2 258.4 9.6 20.8 20.8 40.8 32.8 59.2-152-58.4-263.2-196.8-280.8-363.2z m314.4 272.8c-26.4-58.4-46.4-133.6-55.2-219.2 55.2 4.8 115.2 8 177.6 8 62.4 0 122.4-2.4 177.6-8-8.8 85.6-28.8 160.8-55.2 219.2-38.4 83.2-84 118.4-121.6 118.4s-84.8-35.2-123.2-118.4z m277.6 89.6c12-18.4 23.2-38.4 32.8-59.2 32.8-70.4 54.4-159.2 63.2-258.4 33.6-4.8 64.8-10.4 92.8-16.8 35.2-8 66.4-17.6 92-28.8-18.4 167.2-129.6 305.6-280.8 363.2z" fill="#E48FAD"></path></svg>
                                </div>
                                <span class="app-name">论坛</span>
                            </div>
                            <!-- 音乐 -->
                            <div class="app-wrapper" id="app-music">
                                <div class="app-icon-box">
                                    <svg t="1767123370328" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5101"><path d="M875.008 295.424a34.133333 34.133333 0 1 0-58.197333 35.669333c35.328 57.514667 53.930667 123.562667 53.930666 191.488 0 201.898667-164.352 366.250667-366.250666 366.250667S138.24 724.48 138.24 522.581333 302.592 156.330667 504.490667 156.330667c18.773333 0 34.133333-15.36 34.133333-34.133334s-15.36-34.133333-34.133333-34.133333C264.874667 88.064 69.973333 282.965333 69.973333 522.581333s194.901333 434.517333 434.517334 434.517334 434.517333-194.901333 434.517333-434.517334c0.170667-80.384-22.016-159.061333-64-227.157333z"></path><path d="M501.248 389.973333c-77.653333 0-140.8 63.146667-140.8 140.8s63.146667 140.8 140.8 140.8 140.8-63.146667 140.8-140.8V224.256c0-19.456 15.872-35.328 35.328-35.328 19.456 0 35.328 15.872 35.328 35.328 0 18.773333 15.36 34.133333 34.133333 34.133333s34.133333-15.36 34.133334-34.133333c0-57.173333-46.421333-103.594667-103.594667-103.594667s-103.594667 46.421333-103.594667 103.594667v186.026667a140.526933 140.526933 0 0 0-72.533333-20.309334z m0 213.333334a72.704 72.704 0 0 1-72.533333-72.533334 72.704 72.704 0 0 1 72.533333-72.533333 72.704 72.704 0 0 1 72.533333 72.533333 72.704 72.704 0 0 1-72.533333 72.533334z"></path></svg>
                                </div>
                                <span class="app-name">音乐</span>
                            </div>
                            <!-- 查手机 -->
                            <div class="app-wrapper" id="app-check-phone">
                                <div class="app-icon-box">
                                    <svg t="1767281986601" class="app-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2320"><path d="M717.91 19.36H305.16c-97.66 0-177.09 79.43-177.09 177.09v633.44c0 97.64 79.43 177.07 177.09 177.07h412.75c97.66 0 177.09-79.43 177.09-177.07V196.45c0-97.66-79.43-177.09-177.09-177.09zM594.19 89.88l-30.79 52.18H459.66l-30.81-52.18h165.34z m230.29 740.01c0 58.75-47.8 106.54-106.57 106.54H305.16c-58.77 0-106.57-47.8-106.57-106.54V196.45c0-58.77 47.8-106.57 106.57-106.57h41.81l72.43 122.71h184.28l72.41-122.71h41.82c58.77 0 106.57 47.8 106.57 106.57v633.44z"></path><path d="M655.95 815.68H367.1c-19.47 0-35.26 15.79-35.26 35.26s15.79 35.26 35.26 35.26h288.85c19.47 0 35.26-15.79 35.26-35.26s-15.8-35.26-35.26-35.26z"></path></svg>
                                </div>
                                <span class="app-name">查手机</span>
                            </div>
                        </div>

                        <!-- 5. 第三排右侧：方形卡片 -->
                        <div class="glass-card" style="grid-column: 2 / 3; grid-row: 3 / 4; justify-content: start; align-items: start; padding: 16px;">
                            <span class="empty-text" style="opacity: 0.5;">方形卡片</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pagination">
                <div class="dot active" data-index="0"></div>
                <div class="dot" data-index="1"></div>
            </div>

    </div>
    </div>
    <!-- === 通用模态框结构 开始 === -->
    <div id="modal-overlay">
        <div id="modal-container">
            <div id="modal-header">
                <span id="modal-title"></span>
                <button id="modal-close-btn" title="返回">
                    <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
                </button>
                <!-- 这里移除了档案App的头部控制，将由右下角悬浮按钮替代 -->
            </div>
            <div id="modal-body">
                <!-- 内容将由JS动态填充 -->
            </div>
        </div>
    </div>
    <!-- === 通用模态框结构 结束 === -->
    <!-- === 档案详情模态框结构 开始 === -->
    <div id="archive-modal-overlay">
        <div id="archive-detail-modal">
            <button class="close-btn" id="archive-detail-close-btn" title="关闭">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
            <div id="archive-detail-content">
                <!-- 档案详情内容将由JS填充 -->
            </div>
        </div>
    </div>
    <!-- === 档案详情模态框结构 结束 === -->
    <!-- 世界书悬浮添加按钮 -->
    <div id="world-book-fab" title="添加分类">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
    </div>
    <!-- 档案App悬浮添加角色按钮 -->
<div id="archive-fab" title="添加角色">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
    </div>
<!-- === 新增：副本NPC库悬浮添加按钮 === -->
<div id="instance-npc-fab" title="添加NPC">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
</div>
<!-- === 新增：档案App悬浮按钮抽屉菜单 === -->
<div id="archive-fab-drawer-overlay">
    <div id="archive-fab-drawer">
        <button class="fab-drawer-button" id="archive-import-btn">
            <svg t="1768396392429" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="30455"><path d="M484.266667 630.186667l-109.226667-109.226667a32.170667 32.170667 0 0 1 0-45.226667c12.373333-12.373333 32.853333-12.373333 45.226667 0l86.613333 86.613334 86.613333-86.613334c12.373333-12.373333 32.853333-12.373333 45.226667 0 12.373333 12.373333 12.373333 32.853333 0 45.226667l-109.226667 109.226667c-6.4 6.4-14.506667 9.386667-22.613333 9.386666s-16.213333-2.986667-22.613333-9.386666z" p-id="30456"></path><path d="M474.88 604.586667V170.666667c0-17.493333 14.506667-32 32-32s32 14.506667 32 32v433.92c0 17.493333-14.506667 32-32 32s-32-14.506667-32-32z" p-id="30457"></path><path d="M138.666667 519.68c0-17.493333 14.506667-32 32-32s32 14.506667 32 32c0 182.186667 127.146667 309.333333 309.333333 309.333333s309.333333-127.146667 309.333333-309.333333c0-17.493333 14.506667-32 32-32s32 14.506667 32 32c0 219.733333-153.6 373.333333-373.333333 373.333333s-373.333333-153.6-373.333333-373.333333z" p-id="30458"></path></svg>
            <span>导入</span>
        </button>
        <button class="fab-drawer-button" id="archive-add-btn">
            <svg t="1768396317498" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="24904"><path d="M0 511.844735A511.996612 511.996612 0 0 1 743.43949 55.337012a36.713553 36.713553 0 0 1-14.86879 70.317815 36.155475 36.155475 0 0 1-18.017944-4.743662l-0.279039 0.43849a437.931702 437.931702 0 1 0 191.620034 190.902505 36.593965 36.593965 0 0 1 31.571264-55.568614 37.11218 37.11218 0 0 1 33.006322 20.290118A511.877024 511.877024 0 1 1 0 511.844735z m476.957292 184.006256v-146.296135H330.621294a36.434514 36.434514 0 0 1 0-72.869029h146.455586V330.50928a36.434514 36.434514 0 0 1 72.869029 0v146.21641h146.056959a36.434514 36.434514 0 0 1 0 72.869029H550.10536v146.296135a36.51424 36.51424 0 0 1-73.02848 0zM827.151175 210.36308a36.474377 36.474377 0 0 1 0-63.421567 36.992592 36.992592 0 0 1 36.873004 0 36.51424 36.51424 0 0 1 0 63.421567 36.833141 36.833141 0 0 1-36.873004 0z" p-id="24905"></path></svg>
            <span>添加</span>
        </button>
    </div>
</div>
<!-- === Chat App 结构 开始 === -->
<div id="chat-app-container">
    <!-- 壁纸层 -->
<div id="chat-wallpaper">
    <div class="wallpaper-layer current"></div>
    <div class="wallpaper-layer next"></div>
</div>
    <!-- 内容层 -->
    <div id="chat-app-content">
        <!-- 联系人列表 或 聊天界面 将被JS注入这里 -->
    </div>
</div>

<!-- Chat App 设置侧边栏 -->
<div id="chat-settings-overlay"></div>
<div id="chat-settings-modal">
    <!-- 新增：保存按钮 -->
    <button id="chat-settings-save-btn">保存</button>
    <!-- 这个div用于实现内部滚动 -->
    <div id="chat-settings-body">
        <!-- 内容将由JS动态填充 -->
    </div>
</div>
<!-- === Chat App 结构 结束 === -->

<!-- === 新增：副本App设置侧边栏 === -->
<div id="instance-settings-sidebar-overlay"></div>
<div id="instance-settings-sidebar">
    <button class="instance-sidebar-btn" title="基础设置">
        <svg t="1767347078088" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5044"><path d="M1072.147851 406.226367c-6.331285-33.456782-26.762037-55.073399-52.047135-55.073399-0.323417 0-0.651455 0.003081-0.830105 0.009241l-4.655674 0c-73.124722 0-132.618162-59.491899-132.618162-132.618162 0-23.731152 11.447443-50.336101 11.546009-50.565574 13.104573-29.498767 3.023185-65.672257-23.427755-84.127081l-1.601687-1.127342-134.400039-74.661726-1.700252-0.745401c-8.753836-3.805547-18.334698-5.735272-28.479231-5.735272-20.789593 0-41.235746 8.344174-54.683758 22.306575-14.741683 15.216028-65.622973 58.649474-104.721083 58.649474-39.450789 0-90.633935-44.286652-105.438762-59.784516-13.518857-14.247316-34.128258-22.753199-55.127302-22.753199-9.945862 0-19.354234 1.861961-27.958682 5.531982l-1.746455 0.74078-139.141957 76.431283-1.643269 1.139662c-26.537186 18.437884-36.675557 54.579032-23.584845 84.062398 0.115506 0.264895 11.579891 26.725075 11.579891 50.634877 0 73.126262-59.491899 132.618162-132.618162 132.618162l-4.581749 0c-0.318797-0.00616-0.636055-0.01078-0.951772-0.01078-25.260456 0-45.672728 21.618157-52.002472 55.0811-0.462025 2.453354-11.313456 60.622322-11.313456 106.117939 0 45.494078 10.85143 103.659965 11.314996 106.119479 6.334365 33.458322 26.758957 55.076479 52.036353 55.076479 0.320337 0 0.651455-0.00616 0.842426-0.012321l4.655674 0c73.126262 0 132.618162 59.491899 132.618162 132.616622 0 23.760413-11.444363 50.333021-11.546009 50.565574-13.093793 29.474125-3.041666 65.646075 23.395414 84.151722l1.569346 1.093459 131.838879 73.726895 1.675611 0.7377c8.750757 3.84251 18.305437 5.790715 28.397607 5.790715 21.082208 0 41.676209-8.706094 55.0888-23.290689 18.724339-20.347588 69.527086-62.362616 107.04815-62.362616 40.625872 0 92.72537 47.100385 107.759669 63.583903 13.441852 14.831008 34.176001 23.689571 55.470741 23.695731l0.00616 0c9.895039 0 19.27877-1.883523 27.893999-5.598205l1.711034-0.73924 136.659342-75.531873 1.617088-1.128882c26.492523-18.456365 36.601633-54.600594 23.538642-84.016195-0.115506-0.267974-11.595291-27.082374-11.595291-50.67646 0-73.124722 59.49344-132.616622 132.618162-132.616622l4.517066-0.00154c0.300316 0.00616 0.599092 0.009241 0.899409 0.009241 25.331299-0.00154 45.785153-21.619697 52.107197-55.054918 0.112426-0.589852 11.325776-59.507301 11.325776-106.14104C1083.464388 466.640776 1072.609877 408.67356 1072.147851 406.226367zM377.486862 945.656142l-115.32764-64.487932c5.082277-13.052211 15.437801-43.51815 15.437801-75.017486 0-109.382917-84.176364-199.816642-192.587488-208.134635-2.647404-15.427021-8.873963-54.967133-8.873963-85.667166 0-30.65691 6.223479-70.232445 8.869343-85.671786 108.415744-8.311832 192.592108-98.745557 192.592108-208.134635 0-31.416171-10.300081-61.797405-15.371577-74.854236l122.721583-67.40331c0.003081 0 0.00462 0.00154 0.007701 0.00154 4.423121 4.518606 22.121764 22.080182 46.558275 39.493911 39.929754 28.46229 77.952885 42.894416 113.014434 42.894416 34.716571 0 72.437845-14.151831 112.115025-42.06431 24.282503-17.07953 41.896442-34.302288 46.308782-38.74543 0.009241-0.00154 0.018481-0.00462 0.026182-0.00616l118.301542 65.726159c-5.077657 13.055291-15.416239 43.499669-15.416239 74.958962 0 109.389077 84.174824 199.822802 192.590568 208.134635 2.645865 15.462442 8.872423 55.107281 8.872423 85.671786 0 30.687711-6.223479 70.241685-8.869343 85.673326C890.042174 606.334084 805.86427 696.767809 805.86427 806.158426c0 31.450053 10.317022 61.851309 15.393138 74.903519l-119.783103 66.198965c-5.168521-5.490399-22.603811-23.363073-46.740005-41.288109-40.701336-30.224145-79.662378-45.549521-115.800446-45.549521-35.79155 0-74.458435 15.038919-114.927219 44.694774C400.22004 922.554885 382.666163 940.255068 377.486862 945.656142zM731.271848 511.646647c0-105.803762-86.081448-191.88059-191.888289-191.88059-105.803762 0-191.88059 86.076827-191.88059 191.88059 0 105.803762 86.076827 191.882129 191.88059 191.882129C645.19194 703.528777 731.271848 617.450409 731.271848 511.646647zM539.383558 395.903184c63.825696 0 115.751164 51.922387 115.751164 115.743463 0 63.825696-51.925468 115.751164-115.751164 115.751164-63.821076 0-115.743463-51.925468-115.743463-115.751164C423.640095 447.824031 475.562482 395.903184 539.383558 395.903184z" fill="#272636" p-id="5045"></path></svg>
    </button>
    <button class="instance-sidebar-btn" title="创建副本">
        <svg t="1767347150000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7390"><path d="M785.066667 113.777778a125.155556 125.155556 0 0 1 124.928 117.532444L910.222222 238.933333v275.000889h-68.266666V238.933333a56.888889 56.888889 0 0 0-51.086223-56.604444L785.066667 182.044444H238.933333a56.888889 56.888889 0 0 0-56.604444 51.086223L182.044444 238.933333v546.133334a56.888889 56.888889 0 0 0 51.086223 56.604444l5.802666 0.284445h347.818667V910.222222H238.933333a125.155556 125.155556 0 0 1-124.928-117.532444L113.777778 785.066667V238.933333a125.155556 125.155556 0 0 1 117.532444-124.928L238.933333 113.777778h546.133334z" fill="#2c2c2c" p-id="7391"></path><path d="M557.511111 750.933333h316.757333V682.666667H557.511111z" fill="#2c2c2c" p-id="7392"></path><path d="M682.666667 875.52h68.266666V557.511111H682.666667zM352.711111 329.955556h318.577778c15.189333 0 22.755556 7.566222 22.755555 22.755555s-7.566222 22.755556-22.755555 22.755556H352.711111c-15.189333 0-22.755556-7.566222-22.755555-22.755556s7.566222-22.755556 22.755555-22.755556zM352.711111 466.488889h318.577778c15.189333 0 22.755556 7.566222 22.755555 22.755555s-7.566222 22.755556-22.755555 22.755556H352.711111c-15.189333 0-22.755556-7.566222-22.755555-22.755556s7.566222-22.755556 22.755555-22.755556zM352.711111 603.022222h136.533333c15.189333 0 22.755556 7.566222 22.755556 22.755556s-7.566222 22.755556-22.755556 22.755555H352.711111c-15.189333 0-22.755556-7.566222-22.755555-22.755555s7.566222-22.755556 22.755555-22.755556z" fill="#2c2c2c" p-id="7393"></path></svg>
    </button>
    <button class="instance-sidebar-btn" title="NPC库">
        <svg t="1767347192532" class="icon" viewBox="0 0 1418 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="9565"><path d="M1183.516614 635.417257A324.877438 324.877438 0 0 0 996.801698 100.200414 54.580713 54.580713 0 0 0 977.576252 207.569637a216.204795 216.204795 0 0 1 65.985639 402.105074 54.580713 54.580713 0 0 0 26.231327 102.318472 58.328046 58.328046 0 0 0 14.174693-1.955131 384.834759 384.834759 0 0 1 228.098502 230.053633 54.743641 54.743641 0 0 0 51.322163 36.169905 54.743641 54.743641 0 0 0 51.322163-72.99152A496.114243 496.114243 0 0 0 1183.516614 635.417257z" fill="#4D4D4D" p-id="9566"></path><path d="M385.497711 708.24585a373.755689 373.755689 0 0 0 344.428739 0A466.787292 466.787292 0 0 1 1010.161753 987.829443a54.417786 54.417786 0 0 0 51.322163 36.169905 54.906568 54.906568 0 0 0 48.87825-31.28208 54.580713 54.580713 0 0 0 2.118058-41.70944 576.926284 576.926284 0 0 0-282.516288-318.197411 374.733254 374.733254 0 1 0-544.503711 0A576.926284 576.926284 0 0 0 3.269792 951.007828a54.417786 54.417786 0 0 0 32.5855 69.73297 55.558278 55.558278 0 0 0 18.410808 3.25855 54.580713 54.580713 0 0 0 51.648018-36.169905 466.29851 466.29851 0 0 1 279.583593-279.583593z m172.214369-66.963203A266.223538 266.223538 0 1 1 823.772691 374.733254a266.386465 266.386465 0 0 1-266.060611 266.549393z" fill="#4D4D4D" p-id="9567"></path></svg>
    </button>
    <button class="instance-sidebar-btn" title="归档副本">
        <svg t="1767347229547" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11505"><path d="M462.272 312.896l0 298.624 248.896 0L711.168 528.576 541.952 528.576l0-215.68L462.272 312.896zM512 64C403.776 64 304.448 102.4 227.008 166.336l21.376-82.048L175.168 64l-40.96 157.056L113.856 299.52l73.28 20.224 155.712 42.88 20.416-78.528-90.56-24.96C335.168 200.064 419.264 163.52 512 163.52c192.448 0 348.48 156.032 348.48 348.48S704.448 860.416 512 860.416 163.648 704.448 163.648 512c0-9.856 2.048-19.136 2.88-28.8L65.92 474.816C64.96 487.104 64 499.456 64 512c0 247.424 200.576 448 448 448s448-200.576 448-448S759.424 64 512 64z" fill="#2c2c2c" p-id="11506"></path></svg>
    </button>
</div>


<!-- ============================================= -->
<!-- === 新增：消息长按上下文菜单 (Message Context Menu) === -->
<!-- ============================================= -->
<div id="message-context-menu">
    <div id="context-menu-buttons">
        <div class="context-menu-button" data-action="re-answer">
            <svg t="1767115092714" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15983" width="16" height="16"><path d="M512 82c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="15984" fill="#2c2c2c"></path><path d="M512 72C268.995 72 72 268.995 72 512l0.017 3.868c1.075 123.712 53.693 240.24 145.233 322.825l1.247 1.114-66.97 79.814a30.18 30.18 0 0 0-7.06 19.182c-0.118 16.666 13.296 30.272 29.962 30.39l243.649 1.735a30.288 30.288 0 0 0 5.666-0.497c16.392-3.01 27.24-18.74 24.228-35.131l-44.015-239.647a30.176 30.176 0 0 0-10.283-17.665l-0.385-0.318c-12.762-10.36-31.523-8.602-42.129 4.037l-70.41 83.91-1.394-1.273C208.845 699.358 168.786 608.439 168.786 512c0-189.552 153.662-343.214 343.214-343.214S855.214 322.448 855.214 512c0 101.661-44.508 197.103-122.127 262.532l-2.363 1.973c-10.786 8.931-12.29 24.916-3.36 35.703l29.383 35.486c8.931 10.787 24.916 12.291 35.702 3.36C893.72 767.204 952 643.547 952 512c0-243.005-196.995-440-440-440z m0 10c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="15985" fill="#2c2c2c"></path></svg>
            <span>重回</span>
        </div>
        <div class="context-menu-button" data-action="quote">
            <svg t="1767115166619" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11056" width="16" height="16"><path d="M344.09546581 867.21961711L123.37647922 867.21961711C71.64546642 867.21961711 30.26065757 822.38607407 30.26065756 770.65506126l0-220.7189852c0-51.7310128 41.38481023-93.11582166 93.11582166-93.11582305l220.71898659 0c51.7310128 0 93.11582165 41.38481023 93.11582165 93.11582305L437.21128746 770.65506126c0 51.7310128-41.38481023 96.56455585-93.11582165 96.56455585zM895.89293018 867.21961711l-220.71898658 0c-51.7310128 0-93.11582166-41.38481023-93.11582167-93.11582168l0-220.7189852c0-51.7310128 41.38481023-93.11582166 93.11582167-93.11582303l220.71898658 0c51.7310128 0 93.11582166 41.38481023 93.11582165 93.11582303L989.00875183 770.65506126c3.4487342 51.7310128-41.38481023 96.56455585-93.11582165 96.56455585z" fill="#2c2c2c" p-id="11057"></path><path d="M26.81192338 684.43670797S-35.26529198 149.88291453 233.73597181 149.88291453l0 113.80822677s-82.7696191-41.38481023-82.76961909 251.7575929c10.34620256 200.02658146-124.15442932 168.98797378-124.15442934 168.98797377zM582.05812192 684.43670797S519.98090656 149.88291453 788.98217038 149.88291453l0 113.80822677s-82.7696191-41.38481023-82.7696191 251.7575929c3.4487342 200.02658146-124.15442932 168.98797378-124.15442936 168.98797377z" fill="#2c2c2c" p-id="11058"></path></svg>
            <span>引用</span>
        </div>
        <div class="context-menu-button" data-action="select-multiple">
            <svg t="1767117252981" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11037" width="16" height="16"><path d="M430.8992 492.1344a32.2048 32.2048 0 0 1-23.8592-10.5472L261.12 321.5872a32.256 32.256 0 0 1 47.6672-43.4688l125.4912 137.5744 341.504-275.1488a32.256 32.256 0 0 1 40.448 50.2272L451.1232 484.9664a32.1536 32.1536 0 0 1-20.224 7.168zM802.5088 912.7424H378.0096a33.536 33.536 0 1 1 0-67.072h424.4992a43.9296 43.9296 0 0 0 43.8784-43.8784V475.3408a33.536 33.536 0 1 1 67.072 0v326.4512a111.104 111.104 0 0 1-110.9504 110.9504z" p-id="11038" fill="#2c2c2c"></path><path d="M615.424 725.6576H232.192a111.104 111.104 0 0 1-110.9504-110.9504V231.4752a111.104 111.104 0 0 1 110.9504-110.9504H501.76a33.536 33.536 0 0 1 0 67.1232H232.192a43.9296 43.9296 0 0 0-43.8784 43.8784v383.232a43.9296 43.9296 0 0 0 43.8784 43.8784h383.232a43.9296 43.9296 0 0 0 43.8784-43.8784V475.3408a33.536 33.536 0 0 1 67.1232 0v139.3664a111.104 111.104 0 0 1-111.0016 110.9504z" p-id="11039" fill="#2c2c2c"></path></svg>
            <span>多选</span>
        </div>
        <div class="context-menu-button" data-action="edit">
            <svg t="1767122817601" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15640" width="16" height="16"><path d="M526.41 117.029v58.514a7.314 7.314 0 0 1-7.315 7.314H219.429a36.571 36.571 0 0 0-35.987 29.989l-0.585 6.583V804.57a36.571 36.571 0 0 0 29.989 35.987l6.583 0.585H804.57a36.571 36.571 0 0 0 35.987-29.989l0.585-6.583v-317.44a7.314 7.314 0 0 1 7.314-7.314h58.514a7.314 7.314 0 0 1 7.315 7.314v317.44a109.714 109.714 0 0 1-99.182 109.203l-10.533 0.512H219.43a109.714 109.714 0 0 1-109.203-99.182l-0.512-10.533V219.43a109.714 109.714 0 0 1 99.182-109.203l10.533-0.512h299.666a7.314 7.314 0 0 1 7.314 7.315z m307.345 31.817l41.4 41.399a7.314 7.314 0 0 1 0 10.313L419.985 655.726a7.314 7.314 0 0 1-10.313 0l-41.399-41.4a7.314 7.314 0 0 1 0-10.312l455.168-455.168a7.314 7.314 0 0 1 10.313 0z" p-id="15641" fill="#2c2c2c"></path></svg>
            <span>编辑</span>
        </div>
        <div class="context-menu-button" data-action="retract">
            <svg t="1767117153317" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1821" width="16" height="16"><path d="M581.056 288.32H232.96l108.352-102.208c15.552-15.744 19.456-31.104 4.16-46.208-16.064-15.872-32.576-15.808-48.64 0l-145.92 144.768c-8.768 8.832-23.488 20.608-22.08 32.448l0.64 4.8-0.64 4.864c-1.344 11.776 6.4 18.24 14.848 26.816l147.648 145.216c16.064 15.808 38.08 20.992 54.144 5.12 15.296-15.104 3.84-38.208-11.328-53.504L233.152 353.6 581.056 352c126.464 0 250.944 111.488 250.944 236.16C832 712.832 707.52 832 581.056 832H246.4c-22.592 0-29.696 9.6-29.696 32.256s7.04 31.744 29.696 31.744H581.12C755.136 896 896 757.696 896 588.16c0-169.408-140.8-299.84-314.944-299.84z" fill="#2c2c2c" p-id="1822"></path><path d="M323.392 192a32 32 0 1 1 0-64 32 32 0 0 1 0 64zM320.192 514.048a32 32 0 1 1 0-64 32 32 0 0 1 0 64zM237.824 896a32 32 0 1 1 0-64 32 32 0 0 1 0 64z" fill="#2c2c2c" p-id="1823"></path></svg>
            <span>撤回</span>
        </div>
        <div class="context-menu-button" data-action="copy">
            <svg t="1767115731853" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12940" width="16" height="16"><path d="M96.1 575.7a32.2 32.1 0 1 0 64.4 0 32.2 32.1 0 1 0-64.4 0Z" fill="#2c2c2c" p-id="12941"></path><path d="M742.1 450.7l-269.5-2.1c-14.3-0.1-26 13.8-26 31s11.7 31.3 26 31.4l269.5 2.1c14.3 0.1 26-13.8 26-31s-11.7-31.3-26-31.4zM742.1 577.7l-269.5-2.1c-14.3-0.1-26 13.8-26 31s11.7 31.3 26 31.4l269.5 2.1c14.3 0.2 26-13.8 26-31s-11.7-31.3-26-31.4z" fill="#2c2c2c" p-id="12942"></path><path d="M736.1 63.9H417c-70.4 0-128 57.6-128 128h-64.9c-70.4 0-128 57.6-128 128v128c-0.1 17.7 14.4 32 32.2 32 17.8 0 32.2-14.4 32.2-32.1V320c0-35.2 28.8-64 64-64H289v447.8c0 70.4 57.6 128 128 128h255.1c-0.1 35.2-28.8 63.8-64 63.8H224.5c-35.2 0-64-28.8-64-64V703.5c0-17.7-14.4-32.1-32.2-32.1-17.8 0-32.3 14.4-32.3 32.1v128.3c0 70.4 57.6 128 128 128h384.1c70.4 0 128-57.6 128-128h65c70.4 0 128-57.6 128-128V255.9l-193-192z m0.1 63.4l127.7 128.3H800c-35.2 0-64-28.8-64-64v-64.3h0.2z m64 641H416.1c-35.2 0-64-28.8-64-64v-513c0-35.2 28.8-64 64-64H671V191c0 70.4 57.6 128 128 128h65.2v385.3c0 35.2-28.8 64-64 64z" fill="#2c2c2c" p-id="12943"></path></svg>
            <span>复制</span>
        </div>
        <div class="context-menu-button" data-action="delete">
            <svg t="1769000954047" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5322" width="16" height="16"><path d="M371.2 234.666667h264.533333V298.666667h64V226.133333c0-29.866667-25.6-55.466667-55.466666-55.466666H366.933333c-34.133333 0-55.466667 25.6-55.466666 55.466666v68.266667h64l-4.266667-59.733333zM810.666667 294.4H200.533333c-17.066667 0-29.866667 12.8-29.866666 29.866667v29.866666c0 4.266667 4.266667 8.533333 8.533333 8.533334h51.2L251.733333 810.666667c0 29.866667 25.6 51.2 55.466667 51.2h392.533333c29.866667 0 55.466667-21.333333 55.466667-51.2l21.333333-452.266667h51.2c4.266667 0 8.533333-4.266667 8.533334-8.533333v-25.6c0-17.066667-12.8-29.866667-25.6-29.866667z m-115.2 507.733333h-384L294.4 358.4h422.4l-21.333333 443.733333z" p-id="5323" fill="#2c2c2c"></path><path d="M550.4 716.8v-251.733333c0-17.066667 12.8-29.866667 29.866667-29.866667 17.066667 0 29.866667 12.8 29.866666 25.6v256c0 17.066667-12.8 29.866667-25.6 29.866667h-4.266666c-17.066667 0-29.866667-12.8-29.866667-29.866667z m-149.333333 0v-251.733333c0-17.066667 12.8-29.866667 29.866666-29.866667 17.066667 0 29.866667 12.8 29.866667 25.6v256c0 17.066667-12.8 29.866667-25.6 29.866667h-4.266667c-17.066667 0-29.866667-12.8-29.866666-29.866667z" p-id="5324" fill="#2c2c2c"></path></svg>
            <span>删除</span>
        </div>
    </div>
</div>

<!-- 新增：Chat App 添加联系人按钮 -->
<div id="chatapp-fab" title="添加联系人">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
</div>
<!-- 新增：Chat App 添加联系人悬浮窗 -->
<div id="add-contact-modal">
    <h4>添加联系人 <button id="close-add-contact-modal-btn" title="关闭"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></h4>
    <div id="add-contact-list-container">
        <!-- 角色列表将由JS动态填充 -->
        <span class="empty-text" style="text-align:center; display:block; padding: 40px 0; font-size:14px;">暂无可用角色</span>
    </div>
</div>

<!-- 【新增】聊天列表长按菜单模态框 -->
<div id="chat-list-context-menu-overlay">
    <div id="chat-list-context-menu">
        <div class="chat-list-context-menu-item" data-action="pin">置顶</div>
            <div class="chat-list-context-menu-item" data-action="move-group">移动分组</div>
        <div class="chat-list-context-menu-item" data-action="create-group">拉群</div>
        <div class="chat-list-context-menu-item" data-action="delete">删除</div>
    </div>
</div>

<!-- === Chat App 结构 结束 === -->
    <script>
            let globalAudioPlayer = new Audio(); // 创建一个全局唯一的Audio播放器实例，用于播放歌曲、语音等长音频
        let sfxPlayer = new Audio(); // 新增：专门用于播放UI音效的播放器
        // 新增：用于跟踪已动态加载的聊天字体，避免重复加载
        window.loadedChatFonts = window.loadedChatFonts || new Set();
                    // --- 移动端音频解锁逻辑 (已增强) ---
        let isMobileAudioUnlocked = false;

        function unlockMobileAudio() {
            if (isMobileAudioUnlocked) {
                return;
            }
            isMobileAudioUnlocked = true; // 无论成功与否，只尝试一次

            // 1. 解锁主播放器 (歌曲、语音)
            const mainPromise = globalAudioPlayer.play();
            if (mainPromise !== undefined) {
                mainPromise.then(() => globalAudioPlayer.pause()).catch(() => {});
            }

            // 2. 解锁音效播放器
            const sfxPromise = sfxPlayer.play();
            if (sfxPromise !== undefined) {
                sfxPromise.then(() => sfxPlayer.pause()).catch(() => {});
            }
            
            console.log("音频播放权限已尝试解锁。");
        }

        // 监听用户的首次触摸或点击事件，执行解锁函数，并且只执行一次。
        document.body.addEventListener('touchstart', unlockMobileAudio, { once: true });
        document.body.addEventListener('click', unlockMobileAudio, { once: true });
        // --- 新增代码结束 ---

        /**
         * 新增：请求浏览器通知权限
         */
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log("此浏览器不支持桌面通知");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("通知权限已授予！");
                } else {
                    console.log("通知权限被拒绝。");
                }
            });
        }

        /**
         * 新增：发送系统级通知
         * @param {string} title - 通知标题 (角色名)
         * @param {string} body - 通知内容 (消息文本)
         * @param {string} icon - 通知的图标 URL
         */
        function sendSystemNotification(title, body, icon) {
            if ('Notification' in window && Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon,
                    tag: `chat-message-${Date.now()}` // 使用tag防止通知堆叠
                });

                // 可选：点击通知时，聚焦到网页
                notification.onclick = function() {
                    window.focus();
                    this.close();
                };
            }
        }

        /**
         * 音效播放函数 (已修正)
         * @param {string} url - 音效文件的URL
         */
        async function playSoundEffect(url) {
            // 从localForage读取音效开关状态
            const soundEnabled = await localforage.getItem('soundEffectsEnabled') === 'true';
            if (!soundEnabled || !isMobileAudioUnlocked) {
                return; // 如果开关关闭或音频未解锁，则不播放
            }
            
            // 使用专用的、已解锁的sfxPlayer来播放音效
            // 这种方式可以覆盖正在播放的短音效，实现快速响应
            sfxPlayer.src = url;
            sfxPlayer.play().catch(error => {
                // 即使解锁后，某些极端情况或浏览器bug也可能导致播放失败
                console.error(`Error playing sound effect ${url}:`, error);
            });
        }
        /**
         * 新增：净化文本，仅保留用于语音朗读的核心内容。
         * @param {string} text - 原始文本.
         * @returns {string} - 净化后的文本.
         */
        const sanitizeForSpeech = (text) => {
            if (typeof text !== 'string') return '';
            // 移除所有中英文括号、方括号、引号及其内容
            return text.replace(/[(（「【].*?[)）」。】]/g, '').trim();
        };

        /**
         * 播放指定URL的歌曲
         * @param {string} url - 歌曲的播放链接

        // 新增：监听音频播放结束或暂停事件，以移除播放动画
        globalAudioPlayer.addEventListener('pause', () => {
            const playingId = globalAudioPlayer.dataset.playingMessageId;
            if (playingId) {
                const voiceBar = document.querySelector(`.message-voice-bar[data-message-id="${playingId}"]`);
                if (voiceBar) {
                    voiceBar.classList.remove('playing');
                }
            }
            globalAudioPlayer.dataset.playingMessageId = ''; // 清空ID
        });

        globalAudioPlayer.addEventListener('ended', () => {
             const playingId = globalAudioPlayer.dataset.playingMessageId;
            if (playingId) {
                const voiceBar = document.querySelector(`.message-voice-bar[data-message-id="${playingId}"]`);
                if (voiceBar) {
                    voiceBar.classList.remove('playing');
                }
            }
            globalAudioPlayer.dataset.playingMessageId = ''; // 清空ID
        });
        /**
         * 新增：将字符串中的HTML特殊字符转义，防止XSS攻击并按原样显示文本。
         * @param {string} str - 需要转义的字符串。
         * @returns {string} - 转义后的安全字符串。
         */
        const escapeHTML = (str) => {
            // 确保输入是字符串，避免null或undefined导致错误
            if (typeof str !== 'string') return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };


        // 1. 更新时钟
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // 2. 获取电量
        async function getBatteryStatus() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    
                    function updateBatteryUI() {
                        const level = Math.floor(battery.level * 100);
                        document.getElementById('battery-level').style.width = `${level}%`;
                        document.getElementById('battery-text').textContent = `${level}%`;
                    }
                    
                    updateBatteryUI();
                    battery.addEventListener('levelchange', updateBatteryUI);
                } catch (e) {
                    console.log("Battery API error");
                }
            }
        }
        getBatteryStatus();

        // 3. 头像与卡片图片上传逻辑 (已重构)
        // 3.1 主头像上传
        const avatarBox = document.getElementById('avatar-box');
        const avatarFileInput = document.getElementById('avatar-upload');

        avatarBox.addEventListener('click', () => {
            avatarFileInput.click();
        });

        avatarFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file).then(async (compressedDataUrl) => {
                    avatarBox.style.backgroundImage = `url(${compressedDataUrl})`;
                    await localforage.setItem('homeScreenAvatar', compressedDataUrl);
                }).catch(error => {
                    console.error("主头像压缩失败:", error);
                    showCustomAlert("图片压缩失败，请换张图片或稍后再试。");
                });
            }
        });
        
        // 3.2 卡片图片上传 (日间和夜间)
        function setupPhotoUpload(containerId, storageKey) {
            const container = document.getElementById(containerId);
            const fileInput = container.querySelector('.photo-upload-input');
            const placeholder = container.querySelector('.photo-upload-placeholder-text');

            if (!container || !fileInput || !placeholder) return;

            // 加载已保存的图片
            localforage.getItem(storageKey).then(savedImage => {
                if (savedImage) {
                    container.style.backgroundImage = `url(${savedImage})`;
                    placeholder.style.display = 'none'; // 隐藏提示文字
                }
            });

            container.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    compressImage(file).then(async (compressedDataUrl) => {
                        container.style.backgroundImage = `url(${compressedDataUrl})`;
                        placeholder.style.display = 'none';
                        await localforage.setItem(storageKey, compressedDataUrl);
                    }).catch(error => {
                        console.error("卡片图片压缩失败:", error);
                        showCustomAlert("图片压缩失败，请换张图片或稍后再试。");
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 为日间和夜间分别初始化上传功能
            setupPhotoUpload('photo-upload-container-day', 'cardImageDay');
            setupPhotoUpload('photo-upload-container-night', 'cardImageNight');
        });

        // 4. 页面切换逻辑 (保持不变)
        const slider = document.getElementById('slider-container');
        const dots = document.querySelectorAll('.dot');
        let currentPage = 0;
        const totalPages = 2;
        const gapSize = 40; 

        function goToPage(index) {
            if (index < 0 || index >= totalPages) return;
            currentPage = index;
            slider.style.transform = `translateX(calc(-100% * ${currentPage} - ${gapSize * currentPage}px))`;
            
            dots.forEach((dot, idx) => {
                if (idx === currentPage) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                goToPage(index);
            });
        });

        // 触摸滑动逻辑
        let startX = 0;
        let startY = 0; // 新增：记录起始Y坐标
        let isDragging = false;
        let isSwipeHandled = false; // 新增：标记是否已处理为滑动

        document.getElementById('mobile-wrapper').addEventListener('touchstart', (e) => {
            // 关键修复：检查是否有任何模态框处于可见状态，如果是，则不处理滑动
            if (document.querySelector('#modal-overlay.visible, #archive-modal-overlay.visible, #chat-app-container.visible')) {
                isDragging = false;
                return;
            }
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY; // 记录Y坐标
            isDragging = true;
            isSwipeHandled = false; // 重置标记
        }, { passive: true });

        document.getElementById('mobile-wrapper').addEventListener('touchmove', (e) => {
            if (!isDragging) return;

            // 关键修复：区分水平滑动和垂直滑动，防止误触
            const diffX = Math.abs(e.touches[0].clientX - startX);
            const diffY = Math.abs(e.touches[0].clientY - startY);

            // 如果垂直移动更显著，则判定为滚动意图（即使滚动被禁用），取消本次滑动判断
            if (diffY > diffX && diffY > 10) { 
                isDragging = false;
            } else if (diffX > 10) {
                // 标记为滑动，这可以用于阻止某些默认行为（如果需要）
                isSwipeHandled = true;
            }

        }, { passive: true });

        document.getElementById('mobile-wrapper').addEventListener('touchend', (e) => {
            // 如果不是一次有效的拖动或滑动，则直接返回，确保点击事件能正常触发
            if (!isDragging || !isSwipeHandled) {
                isDragging = false;
                return;
            }

            const endX = e.changedTouches[0].clientX;
            const diff = startX - endX;

            if (Math.abs(diff) > 50) { // 保持滑动阈值
                if (diff > 0) {
                    if (currentPage < totalPages - 1) goToPage(currentPage + 1);
                } else {
                    if (currentPage > 0) goToPage(currentPage - 1);
                }
            }
            isDragging = false;
            isSwipeHandled = false;
        });

        // === 5. 新增功能：个人信息编辑 ===
        async function makeEditable(elementId, storageKey) {
            const element = document.getElementById(elementId);
            
            // 从 localForage 加载数据
            const savedValue = await localforage.getItem(storageKey);
            if (savedValue) {
                element.textContent = savedValue;
            }

            element.addEventListener('click', () => {
                const oldValue = element.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = oldValue;
                input.className = element.className; // 继承样式
                input.style.width = '100%';
                input.style.border = 'none';
                input.style.background = 'transparent';
                
                element.replaceWith(input);
                input.focus();

                const save = async () => {
                    const newValue = input.value.trim();
                    element.textContent = newValue || oldValue; // 如果输入为空，则恢复旧值
                    input.replaceWith(element);
                    await localforage.setItem(storageKey, element.textContent);
                };

                input.addEventListener('blur', save);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur(); // 触发 blur 事件来保存
                    }
                });
            });
        }

        makeEditable('profile-name', 'profileName');
        makeEditable('profile-bio', 'profileBio');
        // [新增] 页面加载时，从独立的 localForage 加载主屏幕信息
        const loadHomeScreenProfile = async () => {
            const avatar = await localforage.getItem('homeScreenAvatar');
            if (avatar) {
                document.getElementById('avatar-box').style.backgroundImage = `url(${avatar})`;
            }
            // 名字和简介已由 makeEditable 函数处理加载
        };
        loadHomeScreenProfile();


        // === 6. 新增功能：通用模态框逻辑 (重构) ===
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        let lastClickedElement = null; // 用于记录点击的元素以计算动效原点

        function openModal(title, contentHTML, clickedElement) {
            lastClickedElement = clickedElement; // 保存点击的元素
            
            // 计算动效原点
            if (lastClickedElement) {
                const rect = lastClickedElement.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                modalContainer.style.transformOrigin = `${x}px ${y}px`;
            } else {
                modalContainer.style.transformOrigin = '50% 50%'; // 默认居中
            }
            
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHTML;

            // 执行模态框内容中的JavaScript代码
            const scripts = modalBody.getElementsByTagName('script');
            for (let i = 0; i < scripts.length; i++) {
                const script = document.createElement('script');
                script.type = scripts[i].type || 'text/javascript';
                if (scripts[i].innerHTML) {
                    script.innerHTML = scripts[i].innerHTML;
                } else if (scripts[i].src) {
                    script.src = scripts[i].src;
                }
                document.head.appendChild(script);
                document.head.removeChild(script);
            }

            // 移除可能存在的关闭动画类
            modalContainer.classList.remove('is-closing');
            modalOverlay.classList.add('visible');
        }

        function closeModal() {
            // 计算关闭动画的原点
            if (lastClickedElement) {
                const rect = lastClickedElement.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                modalContainer.style.transformOrigin = `${x}px ${y}px`;
            }
            
            modalContainer.classList.add('is-closing');

            // 监听动画结束事件，结束后再隐藏 overlay
            modalContainer.addEventListener('transitionend', () => {
                modalOverlay.classList.remove('visible');
                modalContainer.classList.remove('is-closing');

                // --- 新增：清理模态框内容和所有动态添加的元素 ---
                modalBody.innerHTML = '';
                modalTitle.textContent = '';
                
                // 移除世界书、副本等App可能添加的头部控件
                const headerControls = document.getElementById('modal-header-controls');
                if (headerControls) headerControls.remove();
                
                const instanceHeaderControls = document.getElementById('instance-app-header-controls');
                if (instanceHeaderControls) instanceHeaderControls.remove();
                
                // 隐藏所有可能存在的悬浮按钮
                document.getElementById('world-book-fab')?.classList.remove('visible');
                document.getElementById('archive-fab')?.classList.remove('visible');
                document.getElementById('instance-npc-fab')?.classList.remove('visible');
                document.getElementById('little-theater-fab')?.classList.remove('visible'); // 新增：隐藏小剧场FAB

                // 隐藏副本App的侧边栏及其遮罩层
                document.getElementById('instance-settings-sidebar')?.classList.remove('visible');
                document.getElementById('instance-settings-sidebar-overlay')?.classList.remove('visible');
                // --- 清理逻辑结束 ---

            }, { once: true }); // 事件只执行一次
        }

        modalCloseBtn.addEventListener('click', closeModal);
        // 注意：我们不再通过点击 overlay 来关闭，因为现在它是全屏的

        // === 7. 新增功能：App 功能实现 ===

         // 7.1 API 设置功能 (重构版)
        document.getElementById('app-api').addEventListener('click', async function() {
            const currentSettings = JSON.parse(await localforage.getItem('apiSettings')) || { temp: 0.7, stream: true };
            
            const content = `
                <div class="preset-section">
                    <div class="modal-form-group">
                        <label>预设管理</label>
                        <div class="preset-controls">
                            <select id="api-preset-select" class="modal-select"></select>
                            <button id="save-preset-btn" class="modal-button">保存</button>
                            <button id="update-preset-btn" class="modal-button secondary">更新</button>
                            <button id="delete-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;">删除</button>
                        </div>
                    </div>
                </div>

                <div class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="api-url">API URL</label>
                        <input type="text" id="api-url" class="modal-input" placeholder="例如: https://api.openai.com/v1" value="${currentSettings.url || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="api-key">密钥 (Key)</label>
                        <input type="password" id="api-key" class="modal-input" value="${currentSettings.key || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="api-model">模型</label>
                        <div class="model-selection-group">
                            <select id="api-model-select" class="modal-select">
                                <!-- 模型列表将由JS填充 -->
                                ${currentSettings.model ? `<option value="${currentSettings.model}">${currentSettings.model}</option>` : '<option value="">请先拉取模型</option>'}
                            </select>
                            <button id="fetch-models-btn" class="modal-button secondary">拉取</button>
                        </div>
                    </div>

                    <div class="modal-form-group">
                        <label for="api-temp">温度</label>
                        <div class="slider-group">
                            <input type="range" id="api-temp" min="0" max="1" step="0.1" value="${currentSettings.temp}">
                            <span id="api-temp-value" class="slider-value">${currentSettings.temp}</span>
                        </div>
                    </div>
                    <div class="modal-form-group">
                         <div class="switch-group">
                            <label>流式传输</label>
                            <label class="switch-container">
                                <input type="checkbox" id="api-stream" ${currentSettings.stream ? 'checked' : ''}>
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <hr class="subtle-divider">

                <div class="modal-form-section">
                    <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 16px;">Minimax 语音设置</h3>
                    <div class="modal-form-group">
                        <label for="minimax-group-id">Group ID</label>
                        <input type="text" id="minimax-group-id" class="modal-input" placeholder="请输入你的 Group ID">
                    </div>
                    <div class="modal-form-group">
                        <label for="minimax-api-key">API 密钥</label>
                        <input type="password" id="minimax-api-key" class="modal-input" placeholder="请输入你的 API 密钥">
                    </div>
                    <div class="modal-form-group">
                        <label for="minimax-voice-model">语音模型</label>
                        <select id="minimax-voice-model" class="modal-select">
                            <option value="speech-01">speech-01</option>
                        </select>
                    </div>
                </div>

                <div class="button-container" style="margin-top: 24px;">
                    <button id="save-api-btn" class="modal-button">应用并保存当前设置</button>
                </div>


            `;
            openModal('API 设置', content, this);

            // --- 绑定事件和逻辑 ---
            
            // 新增：加载已保存的 Minimax 设置
            const savedMinimaxSettings = JSON.parse(await localforage.getItem('minimaxApiSettings')) || {};
            document.getElementById('minimax-group-id').value = savedMinimaxSettings.groupId || '';
            document.getElementById('minimax-api-key').value = savedMinimaxSettings.apiKey || '';
            document.getElementById('minimax-voice-model').value = savedMinimaxSettings.model || 'speech-01';

            const tempSlider = document.getElementById('api-temp');
            const tempValue = document.getElementById('api-temp-value');
            tempSlider.addEventListener('input', () => {
                tempValue.textContent = tempSlider.value;
            });

            const getFormValues = () => ({
                url: document.getElementById('api-url').value,
                key: document.getElementById('api-key').value,
                model: document.getElementById('api-model-select').value,
                temp: parseFloat(document.getElementById('api-temp').value), // 显式转换为浮点数
                stream: document.getElementById('api-stream').checked,
            });


            
            const setFormValues = (settings) => {
                 document.getElementById('api-url').value = settings.url || '';
                 document.getElementById('api-key').value = settings.key || '';
                 const modelSelect = document.getElementById('api-model-select');
                 // 如果预设里有模型，确保它在选项中并被选中
                 if (settings.model) {
                     let optionExists = false;
                     for(let i=0; i<modelSelect.options.length; i++){
                         if(modelSelect.options[i].value === settings.model){
                             optionExists = true;
                             break;
                         }
                     }
                     if(!optionExists){
                         modelSelect.innerHTML = `<option value="${settings.model}">${settings.model}</option>` + modelSelect.innerHTML;
                     }
                     modelSelect.value = settings.model;
                 }
                 document.getElementById('api-temp').value = settings.temp || 0.7;
                 document.getElementById('api-temp-value').textContent = settings.temp || 0.7;
                 document.getElementById('api-stream').checked = settings.stream !== false; // 默认为 true
            };


            const presetSelect = document.getElementById('api-preset-select');
            const loadPresets = async () => {
                const presets = JSON.parse(await localforage.getItem('apiPresets')) || {};
                presetSelect.innerHTML = '<option value="">选择一个预设...</option>';
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    presetSelect.appendChild(option);
                }
            };

            presetSelect.addEventListener('change', async () => {
                const presets = JSON.parse(await localforage.getItem('apiPresets')) || {};
                const selectedName = presetSelect.value;
                if (selectedName && presets[selectedName]) {
                    setFormValues(presets[selectedName]);
                }
            });

            document.getElementById('save-preset-btn').addEventListener('click', () => {
                showCustomPrompt('请输入新预设的名称:', '', async (name) => {
                    if (name) {
                        const presets = JSON.parse(await localforage.getItem('apiPresets')) || {};
                        presets[name] = getFormValues();
                        await localforage.setItem('apiPresets', JSON.stringify(presets));
                        loadPresets();
                        presetSelect.value = name;
                    }
                });
            });

            document.getElementById('update-preset-btn').addEventListener('click', () => {
                const selectedName = presetSelect.value;
                if (selectedName) {
                    showCustomConfirm(`确定要更新预设 "${selectedName}" 吗？`, async () => {
                        const presets = JSON.parse(await localforage.getItem('apiPresets')) || {};
                        presets[selectedName] = getFormValues();
                        await localforage.setItem('apiPresets', JSON.stringify(presets));
                        showGlobalToast('预设已更新！', { type: 'success' });
                    });
                } else {
                    showCustomAlert('请先选择一个要更新的预设。');
                }
            });

            document.getElementById('delete-preset-btn').addEventListener('click', () => {
                const selectedName = presetSelect.value;
                if (selectedName) {
                    showCustomConfirm(`确定要删除预设 "${selectedName}" 吗？此操作不可逆！`, async () => {
                        const presets = JSON.parse(await localforage.getItem('apiPresets')) || {};
                        delete presets[selectedName];
                        await localforage.setItem('apiPresets', JSON.stringify(presets));
                        loadPresets();
                    });
                } else {
                    showCustomAlert('请先选择一个要删除的预设。');
                }
            });
            
            document.getElementById('save-api-btn').addEventListener('click', async () => {
                // 保存主 API 设置
                const settings = getFormValues();
                await localforage.setItem('apiSettings', JSON.stringify(settings));

                // 新增：保存 Minimax 设置
                const minimaxSettings = {
                    groupId: document.getElementById('minimax-group-id').value,
                    apiKey: document.getElementById('minimax-api-key').value,
                    model: document.getElementById('minimax-voice-model').value
                };
                await localforage.setItem('minimaxApiSettings', JSON.stringify(minimaxSettings));

                showGlobalToast('所有API设置已应用并保存！', { type: 'success' });
                closeModal();
            });

            loadPresets(); // 初始化时加载预设列表
            // 在 loadPresets(); 后面添加
            document.getElementById('fetch-models-btn').addEventListener('click', async () => {
                const apiUrl = document.getElementById('api-url').value;
                const apiKey = document.getElementById('api-key').value;
                const fetchBtn = document.getElementById('fetch-models-btn');

                if (!apiUrl || !apiKey) {
                    showCustomAlert('请先输入有效的 API URL 和密钥。');
                    return;
                }

                
                fetchBtn.textContent = '拉取中...';
                fetchBtn.disabled = true;

                try {
                    // 兼容 OpenAI 的 API，端点通常是 /v1/models
                    const response = await fetch(new URL('/v1/models', apiUrl).href, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP 错误! 状态: ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data; // OpenAI 格式
                    
                    if (!models || !Array.isArray(models)) {
                         throw new Error('API返回的数据格式不正确，无法解析模型列表。');
                    }

                    const modelSelect = document.getElementById('api-model-select');
                    const currentVal = modelSelect.value;
                    modelSelect.innerHTML = ''; // 清空

                    const modelIds = models.map(m => m.id).sort();
                    
                    modelIds.forEach(modelId => {
                        const option = document.createElement('option');
                        option.value = modelId;
                        option.textContent = modelId;
                        modelSelect.appendChild(option);
                    });
                    
            // 尝试保留之前的选择
            if (modelIds.includes(currentVal)) {
                modelSelect.value = currentVal;
            }

            currentSettings.modelList = modelIds;
            await localforage.setItem('apiSettings', JSON.stringify(currentSettings)); // 更新apiSettings
            
            showGlobalToast(`成功拉取 ${modelIds.length} 个模型！`, { type: 'success' });

        } catch (error) {
            console.error('拉取模型失败:', error);
            showCustomAlert(`拉取模型失败: ${error.message}`);
        } finally {
            fetchBtn.textContent = '拉取';
            fetchBtn.disabled = false;
        }
    });

});

        // 7.2 美化功能 (重构版)
        document.getElementById('app-beautify').addEventListener('click', async function() {
            const currentSettings = JSON.parse(await localforage.getItem('themeSettings')) || {};
            
            const content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 0 4px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin: 0;">主屏幕设置</h3>
                    <button id="clear-beautify-btn" class="clear-btn-subtle">恢复默认</button>
                </div>


                <div class="modal-form-section">
                    <div class="modal-form-group">
                        <label>主题强调色</label>
                        <div style="display: flex; justify-content: space-around; gap: 16px;">
                            <!-- 昼间颜色组 (带标签) -->
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-size: 14px; text-align: center; opacity: 0.7;">昼间</label>
                                <div class="color-picker-group" style="justify-content: center;">
                                    <div class="color-swatch-wrapper">
                                        <div id="theme-accent-color-swatch"></div>
                                        <input type="color" id="theme-accent-color-picker" value="${currentSettings.accentColor || '#334155'}">
                                    </div>
                                    <input type="text" id="theme-accent-color-hex" class="modal-input" value="${currentSettings.accentColor || '#334155'}">
                                </div>
                            </div>
                            <!-- 夜间颜色组 (带标签并修复样式) -->
                            <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                                <label style="font-size: 14px; text-align: center; opacity: 0.7;">夜间</label>
                                <div class="color-picker-group" style="justify-content: center;">
                                    <div class="color-swatch-wrapper">
                                        <div id="theme-accent-color-swatch-dark"></div>
                                        <input type="color" id="theme-accent-color-picker-dark" value="${currentSettings.accentColorDark || '#aab2be'}">
                                    </div>
                                    <input type="text" id="theme-accent-color-hex-dark" class="modal-input" value="${currentSettings.accentColorDark || '#aab2be'}">
                                </div>
                            </div>
                        </div>
                        <!-- 新增：主题色选择提示 -->
                        <div style="font-size: 12px; opacity: 0.6; text-align: center; margin-top: 8px; padding: 0 10px;">
                            昼间建议选用深色，夜间建议选用浅色，以获得最佳视觉效果。
                        </div>


                        <div class="mockup-container" style="margin-top: 0;">
                            <!-- 昼间模式预览 -->
                            <div class="phone-mockup">
                                <label>昼间壁纸</label>
                                <div class="phone-frame">
                                    <div id="day-screen" class="phone-screen" style="background-image: url('${currentSettings.bgDay || ''}')"></div>
                                </div>
                                <input type="file" id="day-upload" accept="image/*" hidden>
                            </div>
                            <!-- 夜间模式预览 -->
                            <div class="phone-mockup dark">
                                <label>夜间壁纸</label>
                                <div class="phone-frame">
                                    <div id="night-screen" class="phone-screen" style="background-image: url('${currentSettings.bgNight || ''}')"></div>
                                </div>
                                <input type="file" id="night-upload" accept="image/*" hidden>
                            </div>
                        </div>
                    </div>

                    <hr class="subtle-divider">

                    <div class="preset-section" style="padding-top:0; margin-bottom: 20px;">
                        <div class="modal-form-group">
                            <label>字体管理</label>
                            <div class="preset-controls">
                                <select id="theme-preset-select" class="modal-select"></select>
                                <button id="save-theme-preset-btn" class="modal-button">保存</button>
                                <button id="update-theme-preset-btn" class="modal-button secondary">更新</button>
                                <button id="delete-theme-preset-btn" class="modal-button secondary" style="background-color:#be123c; color:white;">删除</button>
                            </div>
                        </div>
                    </div>
                
                    <div class="modal-form-section" style="gap: 10px;">
                        <div class="modal-form-group">
                            <label for="theme-font">字体链接</label>
                            <div class="font-input-wrapper">
                                <input type="text" id="theme-font" class="modal-input" placeholder="留空则使用系统默认字体" value="${currentSettings.fontUrl || ''}">
                                <button id="font-preview-btn" class="modal-button secondary" title="预览字体">
                                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
                                </button>
                            </div>
                            <div id="font-preview-box">Everything wins.<br>万事顺意。</div>
                        </div>
                    </div>

                    <hr class="subtle-divider">

                    <!-- === 修改：通知与音效设置板块 === -->
                    <div class="modal-form-section">
                        <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 16px 4px;">通知与音效</h3>
                        <div class="modal-form-group">
                             <div class="switch-group">
                                <label for="system-notifications-toggle">系统通知横幅</label>
                                <label class="switch-container">
                                    <input type="checkbox" id="system-notifications-toggle">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-form-group">
                            <div class="switch-group">
                                <label>开启音效</label>
                                <label class="switch-container">
                                    <input type="checkbox" id="sound-effects-toggle">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- === 修改结束 === -->

                </div>
                <div class="button-container">
                    <button id="save-theme-btn" class="modal-button">应用并保存当前主题</button>
                </div>
            `;

            openModal('美化设置', content, this); 
            // 在 openModal(...) 之后，添加颜色选择器逻辑

            // --- 昼间颜色选择器逻辑 ---
            const colorPickerDay = document.getElementById('theme-accent-color-picker');
            const colorHexInputDay = document.getElementById('theme-accent-color-hex');
            const colorSwatchDay = document.getElementById('theme-accent-color-swatch');

            const syncColorDay = (color) => {
                if (!/^#([0-9a-f]{3}){1,2}$/i.test(color)) return;
                colorSwatchDay.style.backgroundColor = color;
                colorPickerDay.value = color;
                colorHexInputDay.value = color;
                if (!document.body.classList.contains('dark-mode')) {
                    document.documentElement.style.setProperty('--accent-color', color);
                }
            };
            
            colorSwatchDay.addEventListener('click', () => colorPickerDay.click());
            colorPickerDay.addEventListener('input', () => syncColorDay(colorPickerDay.value));
            colorHexInputDay.addEventListener('input', () => syncColorDay(colorHexInputDay.value));

            // --- 夜间颜色选择器逻辑 ---
            const colorPickerDark = document.getElementById('theme-accent-color-picker-dark');
            const colorHexInputDark = document.getElementById('theme-accent-color-hex-dark');
            const colorSwatchDark = document.getElementById('theme-accent-color-swatch-dark');

            const syncColorDark = (color) => {
                if (!/^#([0-9a-f]{3}){1,2}$/i.test(color)) return;
                colorSwatchDark.style.backgroundColor = color;
                colorPickerDark.value = color;
                colorHexInputDark.value = color;
                if (document.body.classList.contains('dark-mode')) {
                    document.documentElement.style.setProperty('--accent-color', color);
                }
            };

            colorSwatchDark.addEventListener('click', () => colorPickerDark.click());
            colorPickerDark.addEventListener('input', () => syncColorDark(colorPickerDark.value));
            colorHexInputDark.addEventListener('input', () => syncColorDark(colorHexInputDark.value));

            // 初始化颜色
            syncColorDay(colorHexInputDay.value);
            syncColorDark(colorHexInputDark.value);

            // --- 绑定事件和逻辑 ---
            let tempBgDay = currentSettings.bgDay || '';
            let tempBgNight = currentSettings.bgNight || '';

            const createUploader = (screenId, inputId, tempVarCallback) => {
                const screen = document.getElementById(screenId);
                const input = document.getElementById(inputId);
                screen.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        compressImage(file).then(compressedDataUrl => {
                            screen.style.backgroundImage = `url(${compressedDataUrl})`;
                            tempVarCallback(compressedDataUrl);
                        }).catch(error => {
                            console.error("壁纸压缩失败:", error);
                            showCustomAlert("图片压缩失败，请换张图片或稍后再试。");
                        });
                    }
                });
            };

            createUploader('day-screen', 'day-upload', (data) => tempBgDay = data);
            createUploader('night-screen', 'night-upload', (data) => tempBgNight = data);
            
            const getThemeFormValues = () => ({
                fontUrl: document.getElementById('theme-font').value,
                bgDay: tempBgDay,
                bgNight: tempBgNight,
                accentColor: document.getElementById('theme-accent-color-hex').value,
                accentColorDark: document.getElementById('theme-accent-color-hex-dark').value, // 新增
            });
            // 在 const getThemeFormValues = () => ({...}); 的下方，添加以下新函数
            const getFontPresetValues = () => ({
                fontUrl: document.getElementById('theme-font').value
            });

            const setThemeFormValues = (settings) => {
                document.getElementById('theme-font').value = settings.fontUrl || '';
                document.getElementById('day-screen').style.backgroundImage = `url(${settings.bgDay || ''})`;
                document.getElementById('night-screen').style.backgroundImage = `url(${settings.bgNight || ''})`;
                
                // 更新颜色选择器
                syncColorDay(settings.accentColor || '#334155');
                syncColorDark(settings.accentColorDark || '#aab2be');
                
                tempBgDay = settings.bgDay || '';
                tempBgNight = settings.bgNight || '';
            };

            // 字体预设逻辑
            const themePresetSelect = document.getElementById('theme-preset-select');
            const loadThemePresets = async () => {
                const presets = JSON.parse(await localforage.getItem('fontPresets')) || {}; // 修正：从 'fontPresets' 加载
                themePresetSelect.innerHTML = '<option value="">选择一个字体预设...</option>';
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    themePresetSelect.appendChild(option);
                }
            };

            themePresetSelect.addEventListener('change', async () => {
                const presets = JSON.parse(await localforage.getItem('fontPresets')) || {}; // 修正：从 'fontPresets' 加载
                const selectedName = themePresetSelect.value;
                if (selectedName && presets[selectedName]) {
                    // 核心修复：只更新字体URL输入框，不调用 setThemeFormValues
                    document.getElementById('theme-font').value = presets[selectedName].fontUrl || '';
                }
            });

            document.getElementById('save-theme-preset-btn').addEventListener('click', () => {
                showCustomPrompt('请输入新字体预设的名称:', '', async (name) => {
                    if (name) {
                        // 修正：预设应保存在独立的 'fontPresets' 中
                        const presets = JSON.parse(await localforage.getItem('fontPresets')) || {};
                        presets[name] = getFontPresetValues(); // 调用新函数
                        await localforage.setItem('fontPresets', JSON.stringify(presets));
                        loadThemePresets(); // 函数内部会调整为加载 'fontPresets'
                        themePresetSelect.value = name;
                    }
                });
            });

            document.getElementById('update-theme-preset-btn').addEventListener('click', () => {
                 const selectedName = themePresetSelect.value;
                if (selectedName) {
                    showCustomConfirm(`确定要更新字体预设 "${selectedName}" 吗？`, async () => {
                        const presets = JSON.parse(await localforage.getItem('fontPresets')) || {};
                        presets[selectedName] = getFontPresetValues(); // 调用新函数
                        await localforage.setItem('fontPresets', JSON.stringify(presets));
                        showGlobalToast('字体预设已更新！', { type: 'success' });
                    });
                } else {
                    showCustomAlert('请先选择一个要更新的预设。');
                }
            });

             document.getElementById('delete-theme-preset-btn').addEventListener('click', () => {
                const selectedName = themePresetSelect.value;
                if (selectedName) {
                    showCustomConfirm(`确定要删除字体预设 "${selectedName}" 吗？此操作不可逆！`, async () => {
                        const presets = JSON.parse(await localforage.getItem('fontPresets')) || {}; // 修正：从 'fontPresets' 删除
                        delete presets[selectedName];
                        await localforage.setItem('fontPresets', JSON.stringify(presets));
                        loadThemePresets();
                    });
                } else {
                    showCustomAlert('请先选择一个要删除的预设。');
                }
            });
            // --- 新增：字体预览逻辑 (修正版) ---
            const fontPreviewBtn = document.getElementById('font-preview-btn');
            const fontInput = document.getElementById('theme-font');
            const fontPreviewBox = document.getElementById('font-preview-box');

            fontPreviewBtn.addEventListener('click', () => {
                const fontUrl = fontInput.value.trim();
                if (!fontUrl) {
                    showCustomAlert('请输入字体链接后再预览。');
                    return;
                }

                // 移除旧的预览样式，以防多次点击
                const oldPreviewStyle = document.getElementById('font-preview-style-tag');
                if (oldPreviewStyle) {
                    oldPreviewStyle.remove();
                }

                const styleTag = document.createElement('style');
                styleTag.id = 'font-preview-style-tag';
                
                // 智能判断链接类型
                if (fontUrl.endsWith('.css')) {
                    // 1. 如果是CSS文件，使用 @import
                    styleTag.textContent = `@import url('${fontUrl}');`;
                    document.head.appendChild(styleTag);
                    
                    // 尝试从Google Fonts等规范链接中解析字体名
                    let fontName = '';
                    try {
                        const url = new URL(fontUrl);
                        if (url.hostname.includes('fonts.googleapis.com')) {
                            const familyParam = url.searchParams.get('family');
                            if (familyParam) {
                                fontName = familyParam.split(':')[0].replace(/\+/g, ' ');
                            }
                        }
                    } catch (e) {
                         showCustomAlert("无法从此链接自动解析字体名称。请确保CSS文件内部已定义字体。");
                    }
                    
                    if (fontName) {
                        fontPreviewBox.style.fontFamily = `'${fontName}', sans-serif`;
                    } else {
                        // 对于其他CSS文件，我们无法知道字体名，只能寄希望于CSS文件本身会作用于全局或特定元素
                        fontPreviewBox.style.fontFamily = 'inherit'; // 尝试继承
                    }

                } else {
                    // 2. 如果是字体文件 (ttf, woff2, etc.), 动态创建 @font-face
                    const fontPreviewName = 'DynamicFontPreview'; // 定义一个临时的字体族名
                    styleTag.textContent = `
                        @font-face {
                            font-family: '${fontPreviewName}';
                            src: url('${fontUrl}');
                        }
                    `;
                    document.head.appendChild(styleTag);
                    
                    // 将这个临时字体应用到预览框
                    fontPreviewBox.style.fontFamily = `'${fontPreviewName}', sans-serif`;
                }
                
                showGlobalToast('正在加载预览...', { type: 'info', duration: 1500 });
            });

            document.getElementById('save-theme-btn').addEventListener('click', async () => {
                const settings = getThemeFormValues();
                await localforage.setItem('themeSettings', JSON.stringify(settings));
                await applyThemeSettings();
                showGlobalToast('主题已应用并保存！', { type: 'success' });
                closeModal();
            });


            loadThemePresets();

            // --- 新增：系统通知开关逻辑 ---
            const notificationsToggle = document.getElementById('system-notifications-toggle');
            const notificationsEnabled = await localforage.getItem('systemNotificationsEnabled') === 'true';
            
            // 1. 初始化开关状态
            notificationsToggle.checked = notificationsEnabled && 'Notification' in window && Notification.permission === 'granted';

            // 2. 如果权限已被永久拒绝，则禁用开关
            if ('Notification' in window && Notification.permission === 'denied') {
                notificationsToggle.disabled = true;
                notificationsToggle.closest('.switch-group').title = '您已禁止系统通知权限，请在浏览器设置中重新开启。';
            }

            // 3. 监听开关变化
            notificationsToggle.addEventListener('change', async () => {
                if (notificationsToggle.checked && 'Notification' in window) {
                    // 用户尝试开启
                    if (Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            await localforage.setItem('systemNotificationsEnabled', 'true');
                            showGlobalToast('系统通知已开启！', { type: 'success' });
                        } else {
                            notificationsToggle.checked = false; // 用户拒绝，开关弹回
                            await localforage.setItem('systemNotificationsEnabled', 'false');
                            showCustomAlert('您已拒绝通知权限。如需开启，请前往浏览器设置。');
                        }
                    } else if (Notification.permission === 'granted') {
                        await localforage.setItem('systemNotificationsEnabled', 'true');
                        showGlobalToast('系统通知已开启！', { type: 'success' });
                    }
                } else {
                    // 用户关闭开关
                    await localforage.setItem('systemNotificationsEnabled', 'false');
                    showGlobalToast('系统通知已关闭。', { type: 'info' });
                }
            });

            // --- 音效开关逻辑 (已修复) ---
            const soundToggle = document.getElementById('sound-effects-toggle');
            const soundEnabled = await localforage.getItem('soundEffectsEnabled') === 'true';
            soundToggle.checked = soundEnabled;
            soundToggle.addEventListener('change', async () => {
                // [核心修复] 将布尔值转换为字符串再保存，以匹配读取时的逻辑
                await localforage.setItem('soundEffectsEnabled', String(soundToggle.checked));
            });


            document.getElementById('clear-beautify-btn').addEventListener('click', () => {
                showCustomConfirm('确定要恢复所有美化设置为默认值吗？', async () => {
                    await localforage.removeItem('themeSettings');
                    // 清空临时变量
                    tempBgDay = '';
                    tempBgNight = '';
                    // 重新应用默认主题
                    await applyThemeSettings();
                    // 重置表单内的值
                    setThemeFormValues({});
                    showGlobalToast('已恢复默认美化设置', { type: 'success' });
                });
            });

        });

        /**
         * 显示自定义提示框 (Alert)
         * @param {string} message - 要显示的消息
         * @param {function} [onOk] - 点击“好的”按钮后的回调函数
         */
        function showCustomAlert(message, onOk) {
            const overlay = document.getElementById('custom-alert-overlay');
            const messageEl = document.getElementById('custom-alert-message');
            const okBtn = document.getElementById('custom-alert-ok');
            messageEl.textContent = message;
            overlay.classList.add('visible');
            
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            function handleOk() {
                overlay.classList.remove('visible');
                if (typeof onOk === 'function') {
                    onOk();
                }
            }
            newOkBtn.addEventListener('click', handleOk);
        }

        /**
         * 显示自定义确认框 (Confirm)
         * @param {string} message - 要显示的消息
         * @param {function} [onConfirm] - 点击“确认”按钮后的回调
         * @param {function} [onCancel] - 点击“取消”按钮后的回调
         */
        function showCustomConfirm(message, onConfirm, onCancel) {
            const overlay = document.getElementById('custom-confirm-overlay');
            const messageEl = document.getElementById('custom-confirm-message');
            const okBtn = document.getElementById('custom-confirm-ok');
            const cancelBtn = document.getElementById('custom-confirm-cancel');
            
            messageEl.textContent = message;
            overlay.classList.add('visible');

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            const close = () => overlay.classList.remove('visible');

            newOkBtn.onclick = () => {
                close();
                if (typeof onConfirm === 'function') onConfirm();
            };

            newCancelBtn.onclick = () => {
                close();
                if (typeof onCancel === 'function') onCancel();
            };
        }

        /**
         * 显示自定义输入框 (Prompt)
         * @param {string} message - 提示消息
         * @param {string} [defaultValue=''] - 输入框的默认值
         * @param {function} onConfirm - 点击“确定”的回调，参数为输入的值
         * @param {function} [onCancel] - 点击“取消”的回调
         */
        function showCustomPrompt(message, defaultValue = '', onConfirm, onCancel) {
            const overlay = document.getElementById('custom-prompt-overlay');
            const messageEl = document.getElementById('custom-prompt-message');
            const inputEl = document.getElementById('custom-prompt-input');
            const okBtn = document.getElementById('custom-prompt-ok');
            const cancelBtn = document.getElementById('custom-prompt-cancel');

            messageEl.textContent = message;
            inputEl.value = defaultValue;
            overlay.classList.add('visible');
            setTimeout(() => inputEl.focus(), 100);

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            const close = () => overlay.classList.remove('visible');

            newOkBtn.onclick = () => {
                const value = inputEl.value;
                close();
                if (typeof onConfirm === 'function') onConfirm(value);
            };
            
            newCancelBtn.onclick = () => {
                close();
                if (typeof onCancel === 'function') onCancel();
            };
        }

        // 7.3 数据功能 (修正版 - 恢复折叠功能并确保保存)
        document.getElementById('app-data').addEventListener('click', async function() {
            const settings = JSON.parse(await localforage.getItem('githubSyncSettings')) || {};
            const lastSyncTimestamp = await localforage.getItem('lastSyncTimestamp');
            const lastSyncTimeText = lastSyncTimestamp ? `最近一次同步: ${new Date(parseInt(lastSyncTimestamp)).toLocaleString()}` : '暂无同步记录';

            const content = `
                <div id="github-credentials-container" class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="github-user">GitHub 用户名</label>
                        <input type="text" id="github-user" class="modal-input" value="${settings.user || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="github-repo">仓库名</label>
                        <input type="text" id="github-repo" class="modal-input" value="${settings.repo || ''}">
                    </div>
                    <div class="modal-form-group">
                        <label for="github-token">Personal Access Token (PAT)</label>
                        <input type="password" id="github-token" class="modal-input" value="${settings.token || ''}">
                    </div>
                </div>

                <div class="button-container" style="justify-content: center; gap: 10px;">
                    <button id="check-github-path" class="modal-button secondary">连接测试</button>
                    <button id="save-github-btn" class="modal-button">保存并折叠</button>
                </div>

                <hr class="subtle-divider">

                <div class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="github-interval">自动同步间隔 (分钟, 0为关闭)</label>
                        <div class="sync-interval-group">
                            <input type="number" id="github-interval" class="modal-input" min="0" value="${settings.interval || 0}">
                            <button id="manual-sync-btn" class="modal-button">保存设置</button>
                        </div>
                        <p class="last-sync-time" id="last-sync-time-display">${lastSyncTimeText}</p>
                    </div>
                    <!-- 新增的手动操作按钮容器 -->
                    <div class="button-container" style="display: flex; gap: 10px; justify-content: center;">
                        <button id="manual-sync-now-btn" class="modal-button secondary">手动同步</button>
                        <button id="manual-pull-btn" class="modal-button danger">手动拉取</button>
                    </div>
                </div>
                
                <hr class="subtle-divider">

                <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 16px 4px;">数据备份</h3>
                <div class="backup-actions-container">
                    <button id="export-backup-btn" class="modal-button">导出备份</button>
                    <button id="import-backup-btn" class="modal-button secondary">导入备份</button>
                    <input type="file" id="import-file-input" accept=".json" hidden>
                </div>

                <!-- 新增：危险操作区域 -->
                <hr class="subtle-divider">
                <h3 style="font-size: 16px; font-weight: 700; margin: 0 0 16px 4px; color: #ef4444;">危险操作</h3>
                <div class="backup-actions-container">
                    <button id="clear-all-data-btn" class="modal-button danger">清空所有数据</button>
                </div>
            `;
            openModal('数据管理', content, this);

            // --- 逻辑绑定 ---

            const credentialsContainer = document.getElementById('github-credentials-container');
            const saveBtn = document.getElementById('save-github-btn');

            // 检查 GitHub 设置折叠状态
            const isGithubCollapsed = await localforage.getItem('githubSettingsCollapsed') === 'true';
            if (isGithubCollapsed) {
                credentialsContainer.classList.add('collapsed');
                saveBtn.textContent = '展开/修改';
            }

            // **保存设置并切换折叠状态 (优化版)**
            saveBtn.addEventListener('click', async () => {
                const isCurrentlyCollapsed = credentialsContainer.classList.contains('collapsed');

                if (isCurrentlyCollapsed) {
                    // --- 仅展开，不保存，不提示 ---
                    credentialsContainer.classList.remove('collapsed');
                    saveBtn.textContent = '保存并折叠';
                    await localforage.setItem('githubSettingsCollapsed', 'false');
                } else {
                    // --- 保存、提示并折叠 ---
                    // 1. 保存所有设置
                    const githubSyncSettings = {
                        user: document.getElementById('github-user').value.trim(),
                        repo: document.getElementById('github-repo').value.trim(),
                        token: document.getElementById('github-token').value.trim(),
                        interval: document.getElementById('github-interval').value,
                    };
                    await localforage.setItem('githubSyncSettings', JSON.stringify(githubSyncSettings));
                    
                    // 2. 重新初始化自动同步
                    initializeAutoSync();

                    // 3. 折叠并更新状态
                    credentialsContainer.classList.add('collapsed');
                    saveBtn.textContent = '展开/修改';
                    await localforage.setItem('githubSettingsCollapsed', 'true');

                    // 4. 提示用户保存成功
                    showGlobalToast('GitHub 设置已保存!', { type: 'success', duration: 2000 });
                }
            });

            // **保存同步间隔设置**
            document.getElementById('manual-sync-btn').addEventListener('click', async () => {
                const settings = JSON.parse(await localforage.getItem('githubSyncSettings')) || {};
                settings.interval = document.getElementById('github-interval').value;
                await localforage.setItem('githubSyncSettings', JSON.stringify(settings));
                
                // 重新初始化自动同步定时器以应用新间隔
                initializeAutoSync(); 
                
                // 给予用户明确的成功反馈
                showGlobalToast('同步间隔已保存！', { type: 'success' });
            });


            // **连接测试** (真实 API 实现)
            document.getElementById('check-github-path').addEventListener('click', async () => {
                const btn = document.getElementById('check-github-path');
                const originalText = btn.textContent;
                btn.textContent = '测试中...';
                btn.disabled = true;

                const user = document.getElementById('github-user').value.trim();
                const repo = document.getElementById('github-repo').value.trim();
                const token = document.getElementById('github-token').value.trim();

                if (!user || !repo || !token) {
                    showCustomAlert('连接失败！\n请先填写完整的 GitHub 用户名、仓库名和 Personal Access Token。');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }

                const apiUrl = `https://api.github.com/repos/${user}/${repo}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        // 2xx 状态码表示成功
                        showCustomAlert('连接成功！\n仓库可访问，Token有效。');
                    } else {
                        // 处理 4xx, 5xx 错误
                        let errorMessage = `HTTP 错误: ${response.status} ${response.statusText}`;
                        if (response.status === 401) {
                            errorMessage = '连接失败！\n原因：Personal Access Token (PAT) 无效或已过期，请检查权限。';
                        } else if (response.status === 404) {
                            errorMessage = '连接失败！\n原因：找不到指定的仓库，请检查用户名和仓库名是否正确。';
                        } else {
                            // 尝试解析更详细的错误信息
                            const errorData = await response.json().catch(() => null);
                            if (errorData && errorData.message) {
                                errorMessage = `连接失败！\n原因：${errorData.message}`;
                            }
                        }
                        showCustomAlert(errorMessage);
                    }
                } catch (error) {
                    // 捕获网络错误等
                    console.error("GitHub 连接测试失败:", error);
                    showCustomAlert(`连接失败！\n原因：网络请求失败，请检查网络连接或浏览器控制台的CORS策略。`);
                } finally {
                    // 无论成功或失败，都恢复按钮状态
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            // **导出备份** (保持不变)
            document.getElementById('export-backup-btn').addEventListener('click', async () => {
                 try {
                    const backupData = {};
                    // 使用localforage的迭代API获取所有数据
                    await localforage.iterate((value, key) => {
                        backupData[key] = value;
                    });
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date();
                    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    a.href = url;
                    a.download = `jellyfish_backup_${dateString}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showCustomAlert('备份文件已完成下载。');
                } catch (error) {
                    console.error("导出备份失败:", error);
                    showCustomAlert(`导出备份失败：${error.message}`);
                }
            });

            // **导入备份** (已使用 FileReader API 优化)
            const importFileInput = document.getElementById('import-file-input');
            document.getElementById('import-backup-btn').addEventListener('click', () => {
                importFileInput.click();
            });
            importFileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // 使用自定义确认框提示用户
                showCustomConfirm('警告：导入备份将覆盖当前所有数据和设置，此操作不可逆！确定要继续吗？', 
                async () => {
                    // 用户确认后，执行导入逻辑
                    
                    // 1. 创建一个 FileReader 实例来异步读取文件
                    const reader = new FileReader();

                    // 2. 定义文件读取成功后的回调函数
                    reader.onload = async (e) => {
                        try {
                            // 读取到的文件内容在 e.target.result 中
                            const fileContent = e.target.result;
                            const importedData = JSON.parse(fileContent);
                            
                            await localforage.clear();
                            
                            // 遍历导入的数据并写入 localforage
                            for (const key in importedData) {
                                if (Object.hasOwnProperty.call(importedData, key)) {
                                    await localforage.setItem(key, importedData[key]);
                                }
                            }
                            
                            showCustomAlert('数据导入成功！页面即将刷新以应用所有更改。', () => {
                                location.reload();
                            });
                        } catch (error) {
                            // 处理JSON解析错误或其它意外
                            showCustomAlert(`导入失败：文件格式无效或已损坏。\n错误: ${error.message}`);
                        } finally {
                            // 无论成功与否，都清空文件输入框的值，以便用户可以再次选择同一个文件
                            event.target.value = '';
                        }
                    };
                    
                    // 定义文件读取失败的回调
                    reader.onerror = () => {
                        showCustomAlert('读取文件失败，请检查文件是否损坏或浏览器权限。');
                        event.target.value = '';
                    };

                    // 3. 开始以文本格式读取文件。这是一个异步操作。
                    reader.readAsText(file);
                    
                }, 
                () => {
                    // 用户点击取消后的回调
                    event.target.value = ''; // 仅重置文件输入框
                    showGlobalToast('导入操作已取消', { duration: 2000 });
                });
            });
             document.getElementById('manual-sync-now-btn').addEventListener('click', () => {
                // 直接调用现有的同步函数
                syncDataToGithub();
            });
            document.getElementById('manual-pull-btn').addEventListener('click', () => {
                // 调用新增的拉取函数
                pullAndOverwriteData();
            });

            // 新增：清空所有数据按钮的事件监听器
            document.getElementById('clear-all-data-btn').addEventListener('click', () => {
                showCustomConfirm(
                    '确定要清空所有数据吗？此操作将删除包括API密钥、角色档案、聊天记录、主题设置在内的全部本地信息，且无法恢复！',
                    async () => {
                        // 用户确认后执行
                        await localforage.clear();
                        showCustomAlert('所有数据已清空。页面即将刷新。', () => {
                            location.reload();
                        });
                    }
                );
            });
        });

        // === 8. 新增功能：页面加载时应用设置 ===
        async function applyThemeSettings() {
            const settings = JSON.parse(await localforage.getItem('themeSettings')) || {};
            const root = document.documentElement;

            // 1. 应用字体 (重构)
            const oldFontLink = document.getElementById('custom-font-link');
            if (oldFontLink) oldFontLink.remove();
            
            const oldFontStyleTag = document.getElementById('custom-font-override');
            if (oldFontStyleTag) oldFontStyleTag.remove();

            // 重置为默认字体，以便在清除设置时生效
            document.body.style.fontFamily = '';

            if (settings.fontUrl && settings.fontUrl.trim() !== '') {
                const fontUrl = settings.fontUrl.trim();
                const styleTag = document.createElement('style');
                styleTag.id = 'custom-font-override';

                if (fontUrl.endsWith('.css')) {
                    // 方案A: 处理 Google Fonts 等 CSS 链接
                    const fontLink = document.createElement('link');
                    fontLink.id = 'custom-font-link';
                    fontLink.rel = 'stylesheet';
                    fontLink.href = fontUrl;
                    document.head.appendChild(fontLink);
                    
                    try {
                        const url = new URL(fontUrl);
                        const familyParam = url.searchParams.get('family');
                        if (familyParam) {
                            const fontName = familyParam.split(':')[0].replace(/\+/g, ' ');
                            styleTag.textContent = `body, html { font-family: "${fontName}", sans-serif; }`;
                            document.head.appendChild(styleTag);
                        }
                    } catch (e) {
                        console.warn("未能从CSS链接中自动解析字体名称。将依赖CSS文件自身。", e);
                    }
                } else {
                    // 方案B: 处理 .ttf, .woff2 等直接字体文件链接
                    const fontName = 'CustomGlobalFont'; // 定义一个统一的自定义字体族名
                    styleTag.textContent = `
                        @font-face {
                            font-family: '${fontName}';
                            src: url('${fontUrl}');
                        }
                        body, html {
                            font-family: '${fontName}', sans-serif;
                        }
                    `;
                    document.head.appendChild(styleTag);
                }
            }

            // 2. 检测并应用深色模式
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const body = document.body;
            let bgImage = '';

            // 3. 应用强调色 (主色和次要色)
            const accentColorDay = settings.accentColor || '#334155'; // 昼间默认
            const accentColorDark = settings.accentColorDark || '#aab2be'; // 夜间默认

            if (prefersDark) {
                body.classList.add('dark-mode');
                bgImage = settings.bgNight || '';
                
                root.style.setProperty('--accent-color', accentColorDark);
                root.style.setProperty('--accent-color-secondary', accentColorDay); 
            } else {
                body.classList.remove('dark-mode');
                bgImage = settings.bgDay || '';

                root.style.setProperty('--accent-color', accentColorDay);
                root.style.setProperty('--accent-color-secondary', accentColorDark); 
            }

            // 4. 应用背景图片
            if (bgImage) {
                 body.style.backgroundImage = `url('${bgImage}')`;
                 body.style.backgroundSize = 'cover';
                 body.style.backgroundPosition = 'center';
            } else {
                 body.style.backgroundImage = ''; 
                 body.style.background = 'linear-gradient(160deg, var(--bg-color-start) 0%, #cbd5e1 50%, var(--bg-color-end) 100%)';
            }
        }

    // ===================================
    // === 12. 角色卡导入核心逻辑 (最终修复版) ===
    // ===================================

    // 1. 导入处理总入口
    async function handleCharacterImport(file) {
        if (!file) return;
        showGlobalToast('正在导入角色卡...', { type: 'info' });

        try {
            let parsedData, avatarDataUrl;

            if (file.name.toLowerCase().endsWith(".png")) {
                const result = await parseCharPng(file);
                parsedData = result.characterData; 
                avatarDataUrl = result.avatarDataUrl;
            } else if (file.name.toLowerCase().endsWith(".json")) {
                parsedData = await parseCharJson(file);
                avatarDataUrl = DEFAULT_CHAR_AVATAR_SVG;
            } else {
                throw new Error('不支持的文件格式。请选择 .png 或 .json 文件。');
            }

            if (parsedData) {
                await createCharacterFromData(parsedData, avatarDataUrl);
            } else {
                throw new Error('未能从文件中解析出有效的角色数据。');
            }
        } catch (error) {
            console.error("角色卡导入失败:", error);
            showCustomAlert(`导入失败: ${error.message}`);
        }
    }

    // 2. 解析PNG文件 (此部分已验证，无需修改)
    function parseCharPng(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const arrayBuffer = e.target.result;
                const dataView = new DataView(arrayBuffer);
                if (dataView.getUint32(0) !== 0x89504E47) return reject(new Error("文件不是一个有效的PNG图片。"));
                let offset = 8;
                let characterJson = null;
                while (offset < dataView.byteLength) {
                    const length = dataView.getUint32(offset);
                    const type = String.fromCharCode(dataView.getUint8(offset + 4), dataView.getUint8(offset + 5), dataView.getUint8(offset + 6), dataView.getUint8(offset + 7));
                    if (type === "tEXt") {
                        const chunkData = new Uint8Array(arrayBuffer, offset + 8, length);
                        let keywordIndex = -1;
                        for (let i = 0; i < chunkData.length; i++) { if (chunkData[i] === 0) { keywordIndex = i; break; } }
                        if (keywordIndex > 0) {
                            const keyword = new TextDecoder("utf-8").decode(chunkData.slice(0, keywordIndex));
                            if (keyword === "chara") {
                                try {
                                    const base64Data = new TextDecoder("utf-8").decode(chunkData.slice(keywordIndex + 1));
                                    const binaryString = atob(base64Data);
                                    const bytes = new Uint8Array(binaryString.length);
                                    for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
                                    const decodedJsonString = new TextDecoder("utf-8").decode(bytes);
                                    characterJson = JSON.parse(decodedJsonString);
                                    break;
                                } catch (e) { return reject(new Error("解析图片内嵌的角色数据失败。")); }
                            }
                        }
                    }
                    if (type === "IEND") break;
                    offset += 12 + length;
                }
                if (characterJson) {
                    const imageReader = new FileReader();
                    imageReader.onload = (imgEvent) => resolve({ characterData: characterJson, avatarDataUrl: imgEvent.target.result });
                    imageReader.onerror = () => reject(new Error("读取图片作为头像失败。"));
                    imageReader.readAsDataURL(file);
                } else { reject(new Error("在这张PNG图片中没有找到角色数据。")); }
            };
            reader.onerror = () => reject(new Error("读取PNG文件失败。"));
            reader.readAsArrayBuffer(file);
        });
    }

    // 3. 解析JSON文件 (此部分已验证，无需修改)
    function parseCharJson(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonString = new TextDecoder("utf-8").decode(e.target.result);
                    resolve(JSON.parse(jsonString));
                } catch (error) { reject(new Error("解析JSON文件失败。")); }
            };
            reader.onerror = () => reject(new Error("读取JSON文件失败。"));
            reader.readAsArrayBuffer(file);
        });
    }

    // 4. 为世界书和正则提供独立的加载/保存函数 (此部分已验证，无需修改)
    async function loadWorldBookData() {
        const data = await localforage.getItem('worldBookData');
        window.worldBookData = data ? JSON.parse(data) : [];
    }
    async function saveWorldBookDataForImport() {
        await localforage.setItem('worldBookData', JSON.stringify(window.worldBookData));
    }
    async function loadRegexData() {
        const data = await localforage.getItem('regexAppData');
        window.regexAppData = data ? JSON.parse(data) : [];
    }
    async function saveRegexData() {
        await localforage.setItem('regexAppData', JSON.stringify(window.regexAppData));
    }

    // 5. 根据解析的数据创建所有内容 (已加入UI刷新逻辑)
    async function createCharacterFromData(data, avatarDataUrl) {
        const charData = data.data || data;

        if (!charData || !charData.name) {
            throw new Error('角色卡数据无效或缺少角色名称。');
        }

        // --- A. 创建档案角色 ---
        const newChar = {
            id: 'char_' + generateId(),
            avatar: avatarDataUrl || DEFAULT_CHAR_AVATAR_SVG,
            name: charData.name.trim(),
            age: charData.age || '',
            persona: [charData.description, charData.personality, charData.scenario, charData.mes_example].filter(Boolean).join('\n\n').trim(),
            favorability: charData.favorability || 0,
            openingLines: [],
            phasedPersonas: [],
            phasedPersonasEnabled: false
        };
        window.archiveData.characters.push(newChar);
        saveArchiveData();
        showGlobalToast(`角色 "${newChar.name}" 已成功导入档案！`, { type: 'success' });
        
        if (document.getElementById('modal-title')?.textContent === '档案') {
            renderArchivePage();
        }

        // --- B. 导入世界书 (已加入UI刷新) ---
        let worldBookEntries = [];
        if (data.character_book?.entries?.length > 0) worldBookEntries = data.character_book.entries;
        else if (charData.character_book?.entries?.length > 0) worldBookEntries = charData.character_book.entries;
        else if (charData.world_entries?.length > 0) worldBookEntries = charData.world_entries;

        if (worldBookEntries.length > 0) {
            await loadWorldBookData(); // 加载
            const newWorldBookGroup = {
                id: 'wb_cat_' + generateId(),
                name: `[导入] ${newChar.name}`,
                items: worldBookEntries
                    .filter(entry => (typeof entry.enabled === 'undefined' || entry.enabled) && entry.content) // 增加过滤，只导入有效条目
                    .map(entry => {
                        // 优先使用 comment 作为标题，其次是 keys 拼接，最后是默认值
                        const entryTitle = (entry.comment && entry.comment.trim())
                            ? entry.comment.trim()
                            : (entry.keys && entry.keys.length > 0)
                                ? entry.keys.join(', ')
                                : '未命名条目';
                        
                        return {
                            id: 'wb_item_' + generateId(),
                            title: entryTitle,
                            content: entry.content || '',
                            injectionPosition: entry.position || 'middle'
                        };
                    })
            };
            window.worldBookData.unshift(newWorldBookGroup);
            await saveWorldBookDataForImport(); // 保存
            
            // 新增：如果当前正打开着世界书App，则立即刷新视图
            if (document.getElementById('modal-title')?.textContent === '预设') {
                await renderWorldBook(); 
            }

            setTimeout(() => showGlobalToast(`已为 "${newChar.name}" 导入 ${newWorldBookGroup.items.length} 条世界书条目。`, { type: 'info' }), 1000);
        }

        // --- C. 导入正则 (已加入UI刷新) ---
        let regexRules = [];
        if (data.extensions?.regex_scripts?.length > 0) regexRules = data.extensions.regex_scripts;
        else if (charData.extensions?.regex_scripts?.length > 0) regexRules = charData.extensions.regex_scripts;
        
        if (regexRules.length > 0) {
            await loadRegexData();
            const newRegexGroup = {
                id: 'regex_cat_' + generateId(),
                name: `[导入] ${newChar.name}`,
                items: regexRules.map((rule, index) => ({
                    id: 'regex_item_' + generateId(),
                    name: rule.scriptName || `规则 #${index + 1}`,
                    pattern: rule.findRegex,
                    replacement: rule.replaceString,
                    scope: { global: false, instance: false, chatapp: [newChar.id] } 
                }))
            };
            window.regexAppData.unshift(newRegexGroup);
            await saveRegexData();
            setTimeout(() => showGlobalToast(`已为 "${newChar.name}" 导入 ${newRegexGroup.items.length} 条正则规则。`, { type: 'info' }), 2000);

            if (document.getElementById('modal-title')?.textContent === '正则替换') {
                renderRegexApp(); // 假设您的正则渲染函数叫这个名字
            }
        }
        
        return Promise.resolve();
    }
    
    // ===================================
    // === 12. 角色卡导入核心逻辑 结束 ===
    // ===================================

        // 页面加载时就应用主题
        applyThemeSettings();
                // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);


        // 监听模态框头部的动态按钮
        document.getElementById('modal-header').addEventListener('click', e => {
            if(e.target.id === 'world-book-edit-btn') {
                toggleEditMode();
            }
        });

        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);


        // 监听系统主题变化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeSettings);


        /**
         * 公共API：将消息添加到 Banner 显示队列
         * @param {string} contactId - 消息来源的联系人ID
         * @param {string} messageText - 要显示的消息内容
         */
        function showGlobalMessageBanner(contactId, messageText, forceShow = false) {
            // 条件检查：如果正在当前聊天界面，并且不是强制显示，则不显示
            const chatRoomView = document.querySelector('.chat-room-view');
            if (chatRoomView && !forceShow) {
                const titleEl = chatRoomView.querySelector('.chat-contact-title');
                if (titleEl && titleEl.dataset.contactId === contactId) {
                    return; // 正在聊天，不打扰
                }
            }
            
            // 将新消息通知加入队列
            globalBannerQueue.push({ contactId, messageText });
            
            // 尝试处理队列
            processBannerQueue();
        }


        // 1. 收集并分类所有需要同步的数据 (重构版)
        async function gatherAndCategorizeData() {
            const files = [];
            const settingsData = {};
            const profileData = {};
            const otherData = {};

            // 定义不应被同步的密钥
            const excludedKeys = new Set([
                'githubSyncSettings',
                'githubSettingsCollapsed',
                'lastSyncTimestamp',
                'lastSyncCommitSha'
            ]);

            // --- 显式处理各大模块的数据 ---

            // 1. Chat App
            const rawChatAppData = JSON.parse(await localforage.getItem('chatAppData') || '{}');
            if (rawChatAppData.contacts && rawChatAppData.contacts.length > 0) {
                files.push({ path: 'data/apps/chat/contacts.json', content: JSON.stringify(rawChatAppData.contacts, null, 2) });
            }
            if (rawChatAppData.messages) {
                for (const contactId in rawChatAppData.messages) {
                    if (rawChatAppData.messages[contactId].length > 0) {
                        files.push({ path: `data/apps/chat/messages/${contactId}.json`, content: JSON.stringify(rawChatAppData.messages[contactId], null, 2) });
                    }
                }
            }
            if (rawChatAppData.contactApiSettings) {
                 for (const contactId in rawChatAppData.contactApiSettings) {
                    const setting = { ...rawChatAppData.contactApiSettings[contactId] }; // 克隆
                    delete setting.key; // 移除密钥
                    if (Object.keys(setting).length > 0) {
                         files.push({ path: `data/apps/chat/settings/${contactId}.json`, content: JSON.stringify(setting, null, 2) });
                    }
                }
            }
            if (rawChatAppData.archives) {
                 for (const contactId in rawChatAppData.archives) {
                    if (rawChatAppData.archives[contactId].length > 0) {
                        files.push({ path: `data/apps/chat/archives/${contactId}.json`, content: JSON.stringify(rawChatAppData.archives[contactId], null, 2) });
                    }
                }
            }

            // 2. Archive App (档案)
            const rawArchiveData = JSON.parse(await localforage.getItem('archiveData') || '{}');
            if (rawArchiveData.user) {
                files.push({ path: 'data/apps/archive/user.json', content: JSON.stringify(rawArchiveData.user, null, 2) });
            }
            if (rawArchiveData.characters && rawArchiveData.characters.length > 0) {
                rawArchiveData.characters.forEach(char => {
                     files.push({ path: `data/apps/archive/characters/${char.id}.json`, content: JSON.stringify(char, null, 2) });
                });
            }

            // 3. World Book App (世界书)
            const worldBookData = await localforage.getItem('worldBookData');
            if (worldBookData) {
                files.push({ path: 'data/apps/worldbook/data.json', content: worldBookData });
            }

            // 4. Music App
            const musicPlaylists = await localforage.getItem('musicPlaylists');
            if (musicPlaylists) {
                files.push({ path: 'data/apps/music/playlists.json', content: musicPlaylists });
            }
            const lastPlayedSong = await localforage.getItem('lastPlayedSong');
            if (lastPlayedSong) {
                files.push({ path: 'data/apps/music/lastPlayedSong.json', content: lastPlayedSong });
            }
            
            // 5. Emoji App (假设数据存储在 'emojiData' 中)
            const emojiData = await localforage.getItem('emojiData');
            if(emojiData) {
                files.push({ path: 'data/apps/emoji/data.json', content: emojiData });
            }
            
            // 6. Quick Reply App (假设数据存储在 'quickReplyData' 中)
            const quickReplyData = await localforage.getItem('quickReplyData');
            if(quickReplyData) {
                files.push({ path: 'data/apps/quickreply/data.json', content: quickReplyData });
            }

            // [新增] 7. Instance App (副本App)
            const instanceData = await localforage.getItem('instanceData');
            if (instanceData) {
                files.push({ path: 'data/apps/instance/data.json', content: instanceData });
            }

            // [新增] 8. Memory App (记忆App)
            const memoryCollections = await localforage.getItem('memoryCollections');
            if (memoryCollections) {
                files.push({ path: 'data/apps/memory/collections.json', content: memoryCollections });
            }

            const handledKeys = new Set([
                'chatAppData', 'archiveData', 'worldBookData', 'musicPlaylists', 'lastPlayedSong', 'emojiData', 'quickReplyData',
                // [新增] 将新处理的键名加入，防止被重复打包
                'instanceData', 'memoryCollections',
                ...excludedKeys
            ]);
            
            // 使用localforage迭代器遍历所有键值对
            await localforage.iterate((value, key) => {
                if (handledKeys.has(key)) return;
                
                // API 设置
                if (key === 'apiSettings' || key === 'apiPresets') {
                    if (!settingsData.api) settingsData.api = {};
                     try {
                        const parsedValue = JSON.parse(value);
                        // 对每个预设或设置移除 key
                        if (key === 'apiPresets') {
                            for (const presetName in parsedValue) {
                                if (parsedValue[presetName].key) delete parsedValue[presetName].key;
                            }
                        } else {
                            if(parsedValue.key) delete parsedValue.key;
                        }
                        settingsData.api[key] = JSON.stringify(parsedValue);
                    } catch (e) { console.error(`解析 ${key} 失败:`, e); }
                } 
                // 美化设置
                else if (key.startsWith('themeSettings') || key.startsWith('themePresets') || key.startsWith('chatBubbleCssPresets') || key.startsWith('offlineModePresets')) {
                    if (!settingsData.beautify) settingsData.beautify = {};
                    settingsData.beautify[key] = value;
                }
                // 个人信息/主屏设置
                // [新增] 将 homeScreenWidgetImage 也加入到 profile.json 的同步范畴
                else if (key.startsWith('userProfile') || key.startsWith('homeScreenAvatar') || key.startsWith('homeScreenWidgetImage') || key.startsWith('checkin-') || key.startsWith('profileName') || key.startsWith('profileBio')) {
                    profileData[key] = value;
                }
                // 其他所有未分类的
                else {
                    otherData[key] = value;
                }
            });

            // 将分类好的数据打包成文件
            for (const settingName in settingsData) {
                if (Object.keys(settingsData[settingName]).length > 0) {
                    files.push({ path: `data/settings/${settingName}.json`, content: JSON.stringify(settingsData[settingName], null, 2) });
                }
            }

            if (Object.keys(profileData).length > 0) {
                 files.push({ path: 'data/profile.json', content: JSON.stringify(profileData, null, 2) });
            }
            
            if (Object.keys(otherData).length > 0) {
                 files.push({ path: 'data/other.json', content: JSON.stringify(otherData, null, 2) });
            }

            return files;
        }


        // === 新增：GitHub API 交互辅助函数 ===

        /**
         * 封装的 GitHub API 请求函数
         * @param {string} url - 完整的 API URL
         * @param {string} token - Personal Access Token
         * @param {object} options - Fetch API 的配置对象
         * @returns {Promise<object>} - 解析后的 JSON 数据
         */
        async function githubApiRequest(url, token, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    ...options.headers,
                }
            });

            if (!response.ok) {
                throw new Error(`GitHub API Error: ${response.status}`);
            }
            // 有些请求（如删除）成功时返回204 No Content，没有body
            if (response.status === 204) {
                return null;
            }
            return response.json();
        }

        /**
         * 获取指定分支最新的 commit SHA
         * @param {object} settings - 包含 user, repo, token 的设置对象
         * @param {string} branch - 分支名, e.g., 'main'
         * @returns {Promise<{commitSha: string, treeSha: string}>}
         */
        async function getLatestCommitInfo(settings, branch = 'main') {
            const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/git/refs/heads/${branch}`;
            const refData = await githubApiRequest(url, settings.token);
            const commitUrl = refData.object.url;
            const commitData = await githubApiRequest(commitUrl, settings.token);
            return {
                commitSha: commitData.sha,
                treeSha: commitData.tree.sha
            };
        }


        /**
         * 为文件内容创建 blobs
         * @param {object} settings - GitHub 设置
         * @param {Array<object>} files - [{ path: string, content: string }]
         * @returns {Promise<Array<object>>} - [{ path: string, sha: string, mode: string, type: string }]
         */
        async function createBlobs(settings, files) {
            const blobPromises = files.map(file => {
                const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/git/blobs`;
                return githubApiRequest(url, settings.token, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: file.content,
                        encoding: 'utf-8' // 我们都用utf-8字符串
                    })
                }).then(blobData => ({
                    path: file.path,
                    sha: blobData.sha,
                    mode: '100644', // 文件模式
                    type: 'blob'
                }));
            });
            return Promise.all(blobPromises);
        }

        /**
         * 基于旧的 tree 和新的 blobs 创建一个新的 tree
         * @param {object} settings - GitHub 设置
         * @param {string} baseTreeSha - 父 tree 的 SHA
         * @param {Array<object>} newBlobs - createBlobs 返回的对象数组
         * @returns {Promise<string>} - 新 tree 的 SHA
         */
        async function createTree(settings, baseTreeSha, newBlobs) {
            const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/git/trees`;
            const treeData = await githubApiRequest(url, settings.token, {
                method: 'POST',
                body: JSON.stringify({
                    base_tree: baseTreeSha,
                    tree: newBlobs
                })
            });
            return treeData.sha;
        }

        /**
         * 创建一个新的 commit
         * @param {object} settings - GitHub 设置
         * @param {string} parentCommitSha - 父 commit 的 SHA
         * @param {string} newTreeSha - 新 tree 的 SHA
         * @param {string} message - 提交信息
         * @returns {Promise<string>} - 新 commit 的 SHA
         */
        async function createCommit(settings, parentCommitSha, newTreeSha, message) {
            const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/git/commits`;
            const commitData = await githubApiRequest(url, settings.token, {
                method: 'POST',
                body: JSON.stringify({
                    message: message,
                    tree: newTreeSha,
                    parents: [parentCommitSha]
                })
            });
            return commitData.sha;
        }

        /**
         * 更新分支引用，使其指向新的 commit (fast-forward)
         * @param {object} settings - GitHub 设置
         * @param {string} newCommitSha - 新 commit 的 SHA
         * @param {string} branch - 分支名
         */
        async function updateRef(settings, newCommitSha, branch = 'main') {
            const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/git/refs/heads/${branch}`;
            await githubApiRequest(url, settings.token, {
                method: 'PATCH',
                body: JSON.stringify({
                    sha: newCommitSha
                })
            });
        }


        // 2. 与 GitHub API 交互，执行真实同步
        async function syncDataToGithub() {
            if (isSyncing) {
                console.log("已有同步任务在进行中，本次跳过。");
                return;
            }

            const settings = JSON.parse(await localforage.getItem('githubSyncSettings') || '{}');
            // 【重要修改】对 token 进行清理，去除可能存在的首尾空白和引号
            const cleanedToken = settings.token ? settings.token.trim().replace(/^"|"$/g, '') : '';

            if (!settings.user || !settings.repo || !cleanedToken) { // 使用 cleanedToken 进行检查
                console.log("GitHub同步配置不完整，自动同步已跳过。");
                showGlobalToast('同步失败：GitHub 配置不完整', { type: 'error' });
                return;
            }
            // 【重要修改】将 cleanedToken 重新赋值给 settings.token，确保后续使用是干净的
            settings.token = cleanedToken;

            
            isSyncing = true;
            showGlobalToast('正在后台同步数据...', { type: 'info', duration: 3000 });
            
            try {
                // 1. 收集并分类数据
                const files = gatherAndCategorizeData();
                if (files.length === 0) {
                    showGlobalToast('没有需要同步的数据。', { type: 'info' });
                    return;
                }

                const branch = 'main'; // 或者你的默认分支

                // 2. 获取最新的 commit 和 tree 信息
                const { commitSha: parentCommitSha, treeSha: baseTreeSha } = await getLatestCommitInfo(settings, branch);

                // 3. 为所有文件创建 blobs
                const blobs = await createBlobs(settings, files);

                // 4. 基于旧 tree 和新 blobs 创建新 tree
                const newTreeSha = await createTree(settings, baseTreeSha, blobs);

                // 5. 创建新 commit
                const commitMessage = `[SYNC] Automatic data sync at ${new Date().toISOString()}`;
                const newCommitSha = await createCommit(settings, parentCommitSha, newTreeSha, commitMessage);

                // 6. 更新分支引用
                await updateRef(settings, newCommitSha, branch);

                // 7. 同步成功后的处理
                const now = Date.now();
                await localforage.setItem('lastSyncTimestamp', now.toString());
                await localforage.setItem('lastSyncCommitSha', newCommitSha); // 保存新的 SHA 值

                // 更新UI
                const timeDisplay = document.getElementById('last-sync-time-display');
                if (timeDisplay) {
                    timeDisplay.textContent = `最近一次同步: ${new Date(now).toLocaleString()}`;
                }
                
                showGlobalToast('数据同步成功！', { type: 'success' });
                console.log('同步成功, 新的 commit SHA:', newCommitSha);

            } catch (error) {
                console.error("同步失败:", error);
                showGlobalToast(`同步失败: ${error.message}`, { type: 'error', duration: 5000 });
            } finally {
                isSyncing = false;
            }
        }

        /**
         * 新增：从 GitHub 仓库拉取数据并完全覆盖本地数据
         */
        async function pullAndOverwriteData() {
            if (isSyncing) {
                showGlobalToast('已有同步任务在进行中，请稍后再试。', { type: 'info' });
                return;
            }

            const settings = JSON.parse(await localforage.getItem('githubSyncSettings') || '{}');
            const cleanedToken = settings.token ? settings.token.trim().replace(/^"|"$/g, '') : '';
            if (!settings.user || !settings.repo || !cleanedToken) {
                showCustomAlert('拉取失败：请先在数据管理中正确配置 GitHub 用户名、仓库名和 Personal Access Token。');
                return;
            }
            settings.token = cleanedToken; // 使用清理后的 token

            showCustomConfirm(
                '警告：此操作将从 GitHub 拉取数据并完全覆盖当前网页的所有本地数据，包括未同步的更改。此操作不可逆！确定要继续吗？',
                async () => { // 确认后的回调
                    isSyncing = true;
                    showGlobalToast('正在从 GitHub 拉取数据...', { type: 'info' });

                    try {
                        const allFiles = await fetchRepoContentsRecursive(settings, `data`);
                        
                        if (allFiles.length === 0) {
                            showGlobalToast('仓库中没有找到可拉取的数据文件。', { type: 'info' });
                            return;
                        }

                        const reconstructedData = {};
                        const chatAppDataObj = { messages: {}, contactApiSettings: {}, archives: {} };
                        const archiveDataObj = { characters: [] };
                        const musicPlaylistsArr = [];

                        for (const file of allFiles) {
                            const decodedBytes = atob(file.content);
                            const byteArray = new Uint8Array(decodedBytes.length).map((_, i) => decodedBytes.charCodeAt(i));
                            const content = new TextDecoder('utf-8').decode(byteArray);

                            // --- App 数据恢复 ---
                            if (file.path.startsWith('data/apps/chat/contacts.json')) {
                                chatAppDataObj.contacts = JSON.parse(content);
                            } else if (file.path.startsWith('data/apps/chat/messages/')) {
                                const contactId = file.path.split('/').pop().replace('.json', '');
                                chatAppDataObj.messages[contactId] = JSON.parse(content);
                            } else if (file.path.startsWith('data/apps/chat/settings/')) {
                                const contactId = file.path.split('/').pop().replace('.json', '');
                                chatAppDataObj.contactApiSettings[contactId] = JSON.parse(content);
                            } else if (file.path.startsWith('data/apps/chat/archives/')) {
                                const contactId = file.path.split('/').pop().replace('.json', '');
                                chatAppDataObj.archives[contactId] = JSON.parse(content);
                            } 
                            // [新增] 恢复档案App数据
                            else if (file.path.startsWith('data/apps/archive/user.json')) {
                                archiveDataObj.user = JSON.parse(content);
                            } else if (file.path.startsWith('data/apps/archive/characters/')) {
                                archiveDataObj.characters.push(JSON.parse(content));
                            } 
                            // [新增] 恢复世界书数据
                            else if (file.path.startsWith('data/apps/worldbook/data.json')) {
                                reconstructedData['worldBookData'] = content;
                            }
                            // 恢复音乐App数据
                            else if (file.path.startsWith('data/apps/music/playlists.json')) {
                                reconstructedData['musicPlaylists'] = content;
                            } else if (file.path.startsWith('data/apps/music/lastPlayedSong.json')) {
                                reconstructedData['lastPlayedSong'] = content;
                            }
                            // 恢复其他App数据
                             else if (file.path.startsWith('data/apps/emoji/data.json')) {
                                reconstructedData['emojiData'] = content;
                            } else if (file.path.startsWith('data/apps/quickreply/data.json')) {
                                reconstructedData['quickReplyData'] = content;
                            }
                            // [新增] 恢复副本App数据
                            else if (file.path.startsWith('data/apps/instance/data.json')) {
                                reconstructedData['instanceData'] = content;
                            }
                            // [新增] 恢复记忆App数据
                            else if (file.path.startsWith('data/apps/memory/collections.json')) {
                                reconstructedData['memoryCollections'] = content;
                            }

                            // --- 设置、个人信息 和 其他数据恢复 ---
                            else if (file.path.startsWith('data/settings/')) {
                                const settingsContent = JSON.parse(content);
                                Object.assign(reconstructedData, settingsContent);
                            } else if (file.path.startsWith('data/profile.json')) {
                                const profileContent = JSON.parse(content);
                                Object.assign(reconstructedData, profileContent);
                            } else if (file.path.startsWith('data/other.json')) {
                                const otherContent = JSON.parse(content);
                                Object.assign(reconstructedData, otherContent);
                            }
                        }

                        // 将聚合的对象添加到重建数据中
                        reconstructedData['chatAppData'] = JSON.stringify(chatAppDataObj);
                        reconstructedData['archiveData'] = JSON.stringify(archiveDataObj);

                        // 执行覆盖操作
                        localforage.clear();
                        for (const key in reconstructedData) {
                            await localforage.setItem(key, reconstructedData[key]);
                        }
                        
                        // 保留 GitHub 同步设置本身
                        await localforage.setItem('githubSyncSettings', JSON.stringify(settings));

                        showCustomAlert('数据拉取并覆盖成功！页面即将刷新以应用新数据。', () => {
                            location.reload();
                        });

                    } catch (error) {
                        console.error('拉取数据失败:', error);
                        showCustomAlert(`数据拉取失败: ${error.message}`);
                    } finally {
                        isSyncing = false;
                    }
                }
            );
        }

        /**
         * 新增：递归获取 GitHub 仓库中指定目录下的所有文件内容
         * @param {object} settings - GitHub 设置
         * @param {string} path - 要获取的目录路径
         * @returns {Promise<Array<object>>} 文件对象数组，每个对象包含 path 和 content (base64)
         */
        async function fetchRepoContentsRecursive(settings, path) {
            const url = `https://api.github.com/repos/${settings.user}/${settings.repo}/contents/${path}`;
            const contents = await githubApiRequest(url, settings.token);
            let allFiles = [];

            for (const item of contents) {
                if (item.type === 'file') {
                    // 对于文件，直接获取其详细信息，因为 content 字段可能在列表接口中不返回
                    const fileData = await githubApiRequest(item.url, settings.token);
                    if (fileData.content) {
                        allFiles.push({ path: fileData.path, content: fileData.content });
                    }
                } else if (item.type === 'dir') {
                    // 对于目录，递归调用
                    const subFiles = await fetchRepoContentsRecursive(settings, item.path);
                    allFiles = allFiles.concat(subFiles);
                }
            }
            return allFiles;
        }


        // --- 自动同步定时器逻辑 ---
        
        let autoSyncTimer = null;
        
        async function initializeAutoSync() {
            if (autoSyncTimer) {
                clearInterval(autoSyncTimer);
            }
            
            const settings = JSON.parse(await localforage.getItem('githubSyncSettings') || '{}');
            const intervalMinutes = parseInt(settings.interval, 10);
            
            if (isNaN(intervalMinutes) || intervalMinutes <= 0) {
                console.log("自动同步已禁用。");
                return;
            }
            
            const intervalMs = intervalMinutes * 60 * 1000;
            console.log(`自动同步已启动，间隔: ${intervalMinutes}分钟`);

            autoSyncTimer = setInterval(async () => {
                const lastSyncTimestamp = parseInt(await localforage.getItem('lastSyncTimestamp') || '0', 10) || 0;
                
                // 检查是否到了同步时间
                if (Date.now() - lastSyncTimestamp > intervalMs) {
                    // 确保不会弹出多个确认框
                    if (!isSyncing) { // 只有当前没有同步任务在进行时才弹出确认框
                        showGlobalToast('即将开始自动同步，是否立即同步？', {
                            type: 'confirmation',
                            confirmText: '同步', // 明确指定确认按钮的文本为“同步”
                            onConfirm: () => {
                                // 用户点击确认后，执行同步。使用 setTimeout 确保 toast 消失动画结束后再开始同步。
                                setTimeout(syncDataToGithub, 300);
                            }
                        });
                    }
                }
            }, 60 * 1000); // 每分钟检查一次是否需要同步

        }

        document.addEventListener('DOMContentLoaded', () => {
            // 页面加载时启动定时器
            initializeAutoSync();

            // 新增：页面加载时立即更新一次总未读角标
            updateTotalUnreadBadge();

            // [修复] 调用月历初始化函数，使其在页面加载时显示
            initializeCalendar();
        });

        // === 新增：月历小组件逻辑 ===
        async function initializeCalendar() {
            const calendarContainer = document.getElementById('calendar-container');
            if (!calendarContainer) return;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-11
            const today = now.getDate();

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); // 0=Sunday, 1=Monday...

            // 1. 创建日历框架
            const calendarWidget = document.createElement('div');
            calendarWidget.id = 'calendar-widget';

            // 2. 创建月份标题
            const monthHeader = document.createElement('div');
            monthHeader.className = 'calendar-header';
            monthHeader.textContent = `${year}年 ${month + 1}月`;
            calendarWidget.appendChild(monthHeader);

            // 3. 创建星期标题
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const weekdayEl = document.createElement('div');
                weekdayEl.className = 'calendar-weekday';
                weekdayEl.textContent = day;
                calendarWidget.appendChild(weekdayEl);
            });

            // 4. 创建日期格子
            // 填充上个月的空白
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day other-month';
                calendarWidget.appendChild(emptyCell);
            }
            
            // 填充当月的日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.dataset.date = dateString;

                if (day === today && now.getFullYear() === year && now.getMonth() === month) {
                    dayCell.classList.add('today');
                }

                // 检查是否已打卡
                const storageKey = `checkin-${dateString}`;
                if (await localforage.getItem(storageKey)) {
                    const dot = document.createElement('span');
                    dot.className = 'check-in-dot';
                    dayCell.appendChild(dot);
                }

                calendarWidget.appendChild(dayCell);
            }
            
            // 清空并添加日历
            calendarContainer.innerHTML = '';
            calendarContainer.appendChild(calendarWidget);

            // 5. 绑定双击打卡事件
            calendarContainer.addEventListener('dblclick', async (e) => {
                const dayCell = e.target.closest('.calendar-day');
                // 确保点击的是有效日期且不是上/下个月的日期
                if (!dayCell || dayCell.classList.contains('other-month') || !dayCell.dataset.date) return;
                
                const clickedDateStr = dayCell.dataset.date;
                const clickedDate = new Date(clickedDateStr);
                const todayDate = new Date();

                // 只能对当天打卡
                if (clickedDate.getFullYear() !== todayDate.getFullYear() ||
                    clickedDate.getMonth() !== todayDate.getMonth() ||
                    clickedDate.getDate() !== todayDate.getDate()) {
                    showCustomAlert('只能对今天进行打卡哦！');
                    return;
                }

                const storageKey = `checkin-${clickedDateStr}`;
                if (await localforage.getItem(storageKey)) {
                    showCustomAlert('今天已经打过卡了！');
                    return;
                }

                // 执行打卡
                await localforage.setItem(storageKey, 'true');
                
                // 添加小点
                if (!dayCell.querySelector('.check-in-dot')) {
                    const dot = document.createElement('span');
                    dot.className = 'check-in-dot';
                    dayCell.appendChild(dot);
                }

                showGlobalToast('打卡成功！', { type: 'success', duration: 2000 });
            });
        }
        
       // --- 功能3: API 切换核心逻辑 ---
        async function handleApiSwitchToolClick(contactId) {
            const apiSwitchOverlay = document.getElementById('api-switch-overlay');
            const apiPresetList = document.getElementById('api-preset-list');
            const closeBtn = document.getElementById('close-api-switch');
            apiSwitchContactId = contactId;
            const presets = JSON.parse(await localforage.getItem('apiPresets') || '{}');
            const contactSettings = chatAppData.contactApiSettings[contactId] || {};
            
            // 如果联系人没有独立设置，就从全局设置里读取作为当前设置的参考
            const globalSettings = JSON.parse(await localforage.getItem('apiSettings') || '{}');
            const currentEffectiveSettings = Object.keys(contactSettings).length > 0 ? contactSettings : globalSettings;
            apiPresetList.innerHTML = '';
            if (Object.keys(presets).length === 0) {
                apiPresetList.innerHTML = `<span class="empty-text" style="padding: 20px; text-align: center;">无可用预设，请先在API设置中保存。</span>`;
                apiSwitchOverlay.classList.add('visible');
                return;
            }
            for (const name in presets) {
                const preset = presets[name];
                const item = document.createElement('div');
                item.className = 'api-preset-item';
                item.dataset.presetName = name;
                
                // 检查此预设是否为当前对话的设定
                const isCurrentlySelected = preset.url === currentEffectiveSettings.url && preset.key === currentEffectiveSettings.key;
                if (isCurrentlySelected) {
                    item.classList.add('selected');
                }
                item.innerHTML = `
                    <span>${name}</span>
                    <div class="api-preset-details">
                        <div class="model-selection-group">
                            <select class="modal-select api-model-select">
                                ${preset.model ? `<option value="${preset.model}" selected>${preset.model}</option>` : '<option value="">未选择模型</option>'}
                            </select>
                            <button class="modal-button secondary pull-models-btn" style="padding: 10px;">拉取</button>
                        </div>
                        <div class="save-preset-container">
                                <button class="modal-button apply-preset-btn">应用此预设</button>
                        </div>
                    </div>
                `;
                apiPresetList.appendChild(item);
            }
            // 使用克隆节点法来安全地绑定事件
            const newApiPresetList = apiPresetList.cloneNode(true);
            apiPresetList.parentNode.replaceChild(newApiPresetList, apiPresetList);
            newApiPresetList.addEventListener('click', async (e) => {
                const presetItem = e.target.closest('.api-preset-item');
                if (!presetItem) return;
                const presetName = presetItem.dataset.presetName;
                const presetData = presets[presetName];
                // 点击“拉取”按钮
                if (e.target.classList.contains('pull-models-btn')) {
                    e.stopPropagation(); // 阻止展开/收起
                    const pullBtn = e.target;
                    const modelSelect = presetItem.querySelector('.api-model-select');
                    if (!presetData.url || !presetData.key) {
                        showGlobalToast('此预设缺少URL或Key', { type: 'error' });
                        return;
                    }
                    pullBtn.textContent = '...';
                    pullBtn.disabled = true;
                    try {
                        const response = await fetch(new URL('/v1/models', presetData.url).href, {
                            headers: { 'Authorization': `Bearer ${presetData.key}` }
                        });
                        if (!response.ok) throw new Error(`API错误: ${response.status}`);
                        const data = await response.json();
                        const models = data.data.map(m => m.id).sort();
                        
                        modelSelect.innerHTML = '';
                        models.forEach(modelId => {
                            modelSelect.innerHTML += `<option value="${modelId}">${modelId}</option>`;
                        });
                        
                        showGlobalToast('模型列表已更新', { type: 'success', duration: 2000 });
                    } catch (error) {
                        showGlobalToast(`拉取失败: ${error.message}`, { type: 'error' });
                    } finally {
                        pullBtn.textContent = '拉取';
                        pullBtn.disabled = false;
                    }
                    return; // 处理完后直接返回
                }
                
                // 点击“应用此预设”按钮
                if (e.target.classList.contains('apply-preset-btn')) {
                    e.stopPropagation(); // 阻止展开/收起
                    const modelSelect = presetItem.querySelector('.api-model-select');
                    const selectedModel = modelSelect.value;
                    
                    // 1. 更新主预设列表中的模型
                    presets[presetName].model = selectedModel;
                    await localforage.setItem('apiPresets', JSON.stringify(presets));
                    // 2. 将这个完整的预设应用到当前聊天
                    chatAppData.contactApiSettings[contactId] = presets[presetName];
                    saveChatData();
                    
                    // 3. 关闭弹窗并提示
                    apiSwitchOverlay.classList.remove('visible');
                    showGlobalToast(`已为当前对话切换到预设: ${presetName}`, { type: 'success' });
                    return;
                }
                // 点击预设项本身，展开/收起
                if (presetItem.classList.contains('expanded')) {
                    presetItem.classList.remove('expanded');
                } else {
                    newApiPresetList.querySelectorAll('.api-preset-item.expanded').forEach(p => p.classList.remove('expanded'));
                    presetItem.classList.add('expanded');
                }
            });
            // 绑定关闭按钮
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            newCloseBtn.onclick = () => apiSwitchOverlay.classList.remove('visible');
            
            // 显示弹窗
            apiSwitchOverlay.classList.add('visible');
        } 
               // === 音乐 App 逻辑 (新增) ===
        document.getElementById('app-music').addEventListener('click', function(e) {
            // "我的" 页面的 HTML 内容
            const myPageHTML = `
                <div class="my-page-container">
                    <div class="my-page-profile-card">
                        <div class="my-page-avatar"></div>
                        <div class="my-page-info">
                            <div class="my-page-nickname">水母</div>
                            <div class="my-page-stats">
                                <span>关注 123</span>
                                <span>粉丝 456k</span>
                                <span>点赞 7.8M</span>
                            </div>
                        </div>
                    </div>

                    <!-- === 新增：图库入口 Start === -->
                    <div id="music-gallery-entry" class="music-gallery-entry-bar">
                        <span>播放器封面图库</span>
                        <svg class="category-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
                    </div>
                    <!-- === 新增：图库入口 End === -->

                    <!-- 歌单列表容器 -->
                    <div id="my-page-playlists">
                        <!-- 歌单将由JS动态渲染到这里 -->
                    </div>
                </div>
            `;
            
            // "搜索" 页面的 HTML 内容
            const searchPageHTML = `
                <div class="music-search-page-container">
                    <div class="music-search-bar">
                        <input type="text" id="music-search-input" class="music-search-input" placeholder="搜索歌曲、歌手">
                        <button id="music-search-btn" class="music-search-button">搜索</button>
                    </div>
                    <div id="music-search-results" class="music-results-container">
                        <!-- 搜索结果将在这里动态生成 -->
                        <span class="empty-text" style="text-align:center; padding-top: 40px;">开始你的音乐探索之旅吧！</span>
                    </div>
                </div>
            `;

            // 音乐 App 的整体框架 HTML
            const musicAppHTML = `
                <div class="music-app-container">
                    <div class="music-content-area">
                        <!-- 默认显示“我的”页面 -->
                        ${myPageHTML}
                    </div>
                    <div class="music-capsule-bar">
                        <button id="music-btn-search" class="music-capsule-btn" title="搜索">
                            <svg t="1767379651110" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1313"><path d="M959.266 879.165c0 81.582-81.582 81.582-81.582 81.582l-233.38-233.381c-60.529 43.977-134.777 70.217-215.318 70.217-202.755 0-367.117-164.362-367.117-367.117S226.23 63.349 428.985 63.349s367.117 164.362 367.117 367.117c0 80.541-26.241 154.785-70.217 215.318l233.381 233.381zM428.985 144.931c-157.697 0-285.536 127.838-285.536 285.536s127.838 285.536 285.536 285.536 285.536-127.838 285.536-285.536-127.839-285.536-285.536-285.536z" p-id="1314"></path></svg>
                            <span>搜索</span>
                        </button>
                        <button id="music-btn-play" class="music-capsule-btn" title="播放">
                            <svg t="1767381029075" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6654">
                                <path d="M934.4 53.333333c-29.866667-23.466667-68.266667-32-104.533333-23.466666L334.933333 145.066667c-55.466667 12.8-96 61.866667-96 119.466666v443.733334c-14.933333-6.4-32-8.533333-49.066666-8.533334-81.066667 0-147.2 66.133333-147.2 147.2s66.133333 147.2 147.2 147.2c81.066667 0 147.2-66.133333 147.2-147.2V492.8l544-125.866667v341.333334c-14.933333-6.4-32-8.533333-49.066667-8.533334-81.066667 0-147.2 66.133333-147.2 147.2 0 81.066667 66.133333 147.2 147.2 147.2 78.933333 0 142.933333-59.733333 147.2-136.533333 0-4.266667 2.133333-6.4 2.133333-10.666667V151.466667c0-38.4-17.066667-74.666667-46.933333-98.133334zM339.2 390.4v-125.866667c0-10.666667 8.533333-21.333333 19.2-23.466666L851.2 128c10.666667-2.133333 17.066667 2.133333 21.333333 4.266667 4.266667 2.133333 8.533333 8.533333 8.533334 19.2v115.2l-541.866667 123.733333z" p-id="6655"></path>
                            </svg>
                            <span>播放</span>
                        </button>
                        <button id="music-btn-my" class="music-capsule-btn active" title="我的">
                            <svg t="1767379674232" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1530"><path d="M512 527.424c-141.184 0-256-114.816-256-256s114.816-256 256-256 256 114.816 256 256-114.816 256-256 256z m0-448c-105.856 0-192 86.144-192 192s86.144 192 192 192 192-86.144 192-192-86.144-192-192-192zM867.712 1008.576H156.352A108.416 108.416 0 0 1 48 900.288c0-188.288 151.36-339.712 337.344-339.712h253.312a337.792 337.792 0 0 1 337.344 337.344c0 62.08-48.576 110.656-108.288 110.656z m-482.368-384A273.664 273.664 0 0 0 112 897.92c0 26.752 19.904 46.656 44.352 46.656h711.36a44.352 44.352 0 0 0 44.288-44.288c0-153.088-122.624-275.712-273.344-275.712H385.344z" p-id="1531"></path></svg>
                            <span>我的</span>
                        </button>
                    </div>
                </div>
            `;
            
            // 使用通用的模态框函数打开界面
            openModal('音乐', musicAppHTML, this);

            // --- 绑定音乐App内部的事件 ---
            const contentArea = document.querySelector('.music-content-area');
            const btnSearch = document.getElementById('music-btn-search');
            const btnPlay = document.getElementById('music-btn-play'); // 新增：获取播放按钮
            const btnMy = document.getElementById('music-btn-my');

            // 新增：“播放”页面的HTML内容
            const playPageHTML = `
                <div class="music-player-container">
                    <div class="music-player-card">
                        <div id="player-album-art" class="player-album-art"></div>
                        <div class="player-info">
                            <div id="player-song-title" class="player-song-title">未在播放</div>
                            <div id="player-song-artist" class="player-song-artist">--</div>
                        </div>
                        <div class="player-progress-container">
                            <input type="range" id="player-progress-bar" value="0" min="0" max="100">
                            <div class="player-time-display">
                                <span id="player-current-time">00:00</span>
                                <span id="player-duration">00:00</span>
                            </div>
                        </div>
                        <div class="player-controls">
                            <button id="player-play-mode-btn" class="player-control-btn" title="切换播放顺序">
                                <svg id="player-mode-sequence" t="1769787775939" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1056" width="12" height="12" fill="currentColor"><path d="M405.76 738.56h-57.6C209.92 738.56 98.56 627.2 98.56 488.96s111.36-249.6 249.6-249.6h76.8L396.8 195.84c-11.52-17.92-6.4-42.24 11.52-52.48 17.92-11.52 42.24-6.4 52.48 11.52l65.28 103.68c7.68 11.52 7.68 26.88 1.28 39.68s-19.2 20.48-33.28 20.48H348.16c-94.72 0-172.8 78.08-172.8 172.8s78.08 172.8 172.8 172.8h57.6c21.76 0 38.4 16.64 38.4 38.4s-17.92 35.84-38.4 35.84zM596.48 846.08c-12.8 0-25.6-6.4-32-17.92L499.2 724.48c-7.68-11.52-7.68-26.88-1.28-39.68s19.2-20.48 33.28-20.48h145.92c94.72 0 172.8-78.08 172.8-172.8s-78.08-172.8-172.8-172.8h-57.6c-21.76 0-38.4-16.64-38.4-38.4s16.64-38.4 38.4-38.4h57.6c138.24 0 249.6 111.36 249.6 249.6s-111.36 249.6-249.6 249.6h-76.8l26.88-25.6c11.52-17.92 6.4-42.24-11.52-52.48 17.92-11.52 42.24-6.4 52.48 11.52l65.28 103.68c7.68 11.52 7.68 26.88 1.28 39.68s-19.2 20.48-33.28 20.48H596.48z" p-id="1057"></path></svg>
                                <svg id="player-mode-single" t="1769787901891" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1785" width="12" height="12" style="display: none;" fill="currentColor"><path d="M507.008 122.752a42.666667 42.666667 0 0 0-30.165333 72.832l17.749333 17.749333H383.317333A298.666667 298.666667 0 0 0 232.533333 769.834667a42.666667 42.666667 0 1 0 44.672-72.149334q-23.808-13.909333-44.714666-34.816Q169.984 600.32 169.984 512q0-88.362667 62.506667-150.869333Q294.954667 298.666667 383.317333 298.666667H597.333333a42.666667 42.666667 0 0 0 30.336-12.586667 42.666667 42.666667 0 0 0 0-60.330667l-12.373333-12.373333h25.301333L639.317333 213.333333h-24.064l-78.08-78.08a42.666667 42.666667 0 0 0-30.165333-12.501333zM937.984 512c0-110.506667-59.946667-206.933333-149.12-258.56a42.666667 42.666667 0 1 0-39.424 75.264q21.589333 13.269333 40.746667 32.426667Q852.650667 423.68 852.650667 512q0 88.362667-62.464 150.869333Q727.68 725.333333 639.317333 725.333333h-209.066666a42.666667 42.666667 0 0 0-33.621334 12.373334l-0.512 0.512a42.666667 42.666667 0 0 0 3.370667 62.677333l87.637333 87.637333a42.666667 42.666667 0 0 0 60.373334-60.330666l-17.536-17.493334h109.354666a298.666667 298.666667 0 0 0 298.666667-298.709333z" p-id="1786"></path><path d="M469.333333 597.333333v-170.666666a42.666667 42.666667 0 1 1 85.333334 0v170.666666a42.666667 42.666667 0 0 1-85.333334 0z" p-id="1787"></path></svg>
                                <svg id="player-mode-shuffle" t="1769787758628" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1056" width="12" height="12" style="display: none;" fill="currentColor"><path d="M262.4 768h-99.84c-21.76 0-38.4-16.64-38.4-38.4s16.64-38.4 38.4-38.4h99.84c88.32 0 144.64-90.88 204.8-186.88 64-104.96 138.24-224 268.8-224h28.16l-20.48-25.6c-12.8-16.64-10.24-40.96 6.4-53.76s40.96-10.24 53.76 6.4l69.12 87.04c8.96 11.52 10.24 26.88 3.84 40.96s-19.2 21.76-34.56 21.76h-107.52c-88.32 0-144.64 90.88-203.52 186.88-64 104.96-136.96 224-268.8 224z" p-id="1057"></path><path d="M843.52 666.88h-107.52c-70.4 0-120.32-57.6-167.68-130.56-5.12 7.68-8.96 15.36-14.08 21.76-10.24 15.36-20.48 32-30.72 48.64 52.48 74.24 117.76 136.96 212.48 136.96h28.16l-20.48 25.6c-12.8 16.64-10.24 40.96 6.4 53.76 6.4 5.12 15.36 7.68 24.32 7.68 11.52 0 23.04-5.12 30.72-14.08l69.12-87.04c8.96-11.52 10.24-26.88 3.84-40.96s-20.48-21.76-34.56-21.76zM162.56 332.8h99.84c78.08 0 130.56 70.4 183.04 153.6l6.4-6.4c12.8-20.48 25.6-40.96 39.68-62.72C436.48 332.8 368.64 256 262.4 256h-99.84c-21.76 0-38.4 16.64-38.4 38.4s16.64 38.4 38.4 38.4z" p-id="1058"></path></svg>
                            </button>
                            <button id="player-prev-btn" class="player-control-btn" title="上一首">
                                <svg t="1767430326326" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3483" width="28" height="28">
                                    <path d="M364.302083 465.602819L687.954365 218.588294c38.416414-29.327534 93.791393-1.929039 93.791392 46.396277v494.029051c0 48.325316-55.374979 75.725617-93.791392 46.398084L364.302083 558.397181c-30.600916-23.357989-30.600916-69.436372 0-92.794362zM238.945254 780.798397V451.684117v-164.562559c0-19.628152-5.904521-60.475733 17.057907-75.841215 25.523642-17.068744 59.747828 1.210165 59.747828 31.919454v493.676839c0 19.628152 5.915358 60.473927-17.047069 75.841215-25.53448 17.068744-59.758666-1.211971-59.758666-31.919454z" fill="currentColor" p-id="3484"></path>
                                </svg>
                            </button>
                            <button id="player-play-pause-btn" class="player-control-btn main-btn" title="播放/暂停">
                                <svg id="player-play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                                <svg id="player-pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                            </button>
                            <button id="player-next-btn" class="player-control-btn" title="下一首">
                                <svg t="1767430353937" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3732" width="28" height="28">
                                    <path d="M655.706179 465.602819L332.053897 218.588294c-38.414608-29.327534-93.791393-1.929039-93.791392 46.396277v494.029051c0 48.325316 55.376785 75.725617 93.791392 46.398084l323.652282-247.014525c30.602722-23.357989 30.602722-69.436372 0-92.794362zM781.064814 780.798397V451.684117v-164.562559c0-19.628152 5.904521-60.475733-17.057907-75.841215-25.523642-17.068744-59.747828 1.210165-59.747828 31.919454v493.676839c0 19.628152-5.915358 60.473927 17.047069 75.841215 25.532673 17.068744 59.758666-1.211971 59.758666-31.919454z" fill="currentColor" p-id="3733"></path>
                                </svg>
                            </button>
                            <button id="player-playlist-btn" class="player-control-btn" title="播放列表">
                                <svg t="1769784098582" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4130" width="28" height="28" fill="currentColor">
                                    <path d="M124.56604 259.591293l0 84.975347 764.78119 0 0-84.975347L124.56604 259.591293zM124.56604 557.00603l764.78119 0 0-84.97637L124.56604 472.02966 124.56604 557.00603zM124.56604 769.44542l764.78119 0 0-84.97637L124.56604 684.46905 124.56604 769.44542z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // 点击“搜索”按钮
            btnSearch.addEventListener('click', () => {
                if (btnSearch.classList.contains('active')) return;

                // 切换页面和按钮状态
                contentArea.innerHTML = searchPageHTML;
                btnSearch.classList.add('active');
                btnPlay.classList.remove('active');
                btnMy.classList.remove('active');

                // 获取新页面的元素
                const searchInput = document.getElementById('music-search-input');
                const searchBtn = document.getElementById('music-search-btn');
                const resultsContainer = document.getElementById('music-search-results');

                // 搜索函数
                const performSearch = async () => {
                    const query = searchInput.value.trim();
                    if (!query) {
                        showCustomAlert('请输入搜索关键词。');
                        return;
                    }
                    
                    resultsContainer.innerHTML = `<span class="empty-text" style="text-align:center; padding-top: 40px;">正在努力检索中...</span>`;
                    searchBtn.disabled = true;
                    searchBtn.textContent = '...';

                    try {
                        const results = await searchMusicFromGDStudio('netease', query);
                        
                        if (!results || results.length === 0) {
                            resultsContainer.innerHTML = `<span class="empty-text" style="text-align:center; padding-top: 40px;">未能找到相关结果。</span>`;
                            return;
                        }

                        // 构建结果列表的HTML
                        resultsContainer.innerHTML = results.map(song => {
                            const isCollected = musicPlaylists[0] && musicPlaylists[0].songs.some(s => String(s.id) === String(song.id));
                            const collectedClass = isCollected ? 'collected' : '';
                            
                            return `
                                <div class="music-result-item" 
                                    data-song-id="${song.id}" 
                                    data-song-name="${song.name}" 
                                    data-song-artist="${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist}" 
                                    data-song-cover="${song.pic}"
                                >
                                    <div class="result-item-cover" style="background-image: url('${song.pic}')"></div>
                                    <div class="result-item-info">
                                        <div class="result-item-title">${song.name}</div>
                                        <div class="result-item-artist">${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist}</div>
                                    </div>
                                    <button class="collect-song-btn ${collectedClass}" title="收藏到歌单" 
                                        data-song-id="${song.id}" 
                                        data-song-name="${song.name}" 
                                        data-song-artist="${Array.isArray(song.artist) ? song.artist.join('/') : song.artist}"
                                        data-song-cover="${song.pic}"
                                    >
                                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                                    </button>
                                </div>
                            `;
                        }).join('');

                        // 使用事件委托处理点击事件
                        resultsContainer.addEventListener('click', async (e) => {
                            const item = e.target.closest('.music-result-item');
                            const collectBtn = e.target.closest('.collect-song-btn');

                            // 如果点击的是收藏按钮，则不触发播放
                            if (collectBtn) {
                                return;
                            }
                            
                            if (item) {
                                const songId = item.dataset.songId;
                                const songName = item.dataset.songName;
                                const titleEl = item.querySelector('.result-item-title');
                                const originalText = titleEl.textContent;

                                titleEl.textContent = '获取播放链接...';

                                const songUrl = await getNeteaseSongUrl(songId);
                                if (songUrl) {
                                    // 新增：组装歌曲详情对象
                                    const songDetails = {
                                        id: item.dataset.songId,
                                        name: item.dataset.songName,
                                        artist: item.dataset.songArtist,
                                        cover: item.dataset.songCover
                                    };
                                    playSong(songUrl, songDetails); // 调用播放函数，并传递详情
                                    showGlobalToast(`正在播放: ${songName}`, { type: 'success' });
                                } else {
                                    showCustomAlert(`获取"${songName}"的播放链接失败。`);
                                }
                                titleEl.textContent = originalText;
                            }
                        });

                    } catch (error) {
                        resultsContainer.innerHTML = `<span class="empty-text" style="text-align:center; padding-top: 40px;">搜索时发生错误，请稍后重试。</span>`;
                        console.error('搜索流程出错:', error);
                    } finally {
                        searchBtn.disabled = false;
                        searchBtn.textContent = '搜索';
                    }
                };

                // 绑定搜索事件
                searchBtn.addEventListener('click', performSearch);
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            });
            
            // 新增：点击“播放”按钮
            btnPlay.addEventListener('click', () => {
                if (!btnPlay.classList.contains('active')) {
                    contentArea.innerHTML = playPageHTML;
                    btnPlay.classList.add('active');
                    btnSearch.classList.remove('active');
                    btnMy.classList.remove('active');
                }
            });

            // 点击“我的”按钮
            btnMy.addEventListener('click', () => {
                if (!btnMy.classList.contains('active')) {
                    contentArea.innerHTML = myPageHTML;
                    btnMy.classList.add('active');
                    btnSearch.classList.remove('active');
                    btnPlay.classList.remove('active');
                }
            });
        });



        /**
         * 新增：将 Blob 对象转换为 Base64 Data URL
         * @param {Blob} blob - 要转换的 Blob 对象
         * @returns {Promise<string>} 返回一个解析为 Data URL 字符串的 Promise
         */
        function blobToDataURL(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e.target.error);
                reader.readAsDataURL(blob);
            });
        }
// 在这里添加新函数
/**
 * 图片压缩辅助函数 (已更新以支持GIF)
 * @param {File} file - 用户选择的图片文件
 * @param {number} [maxSize=2500] - 图片的最大宽度或高度
 * @param {number} [quality=0.98] - 压缩质量 (0-1)
 * @returns {Promise<string>} - 返回一个Promise，解析为压缩后的Data URL
 */
function compressImage(file, maxSize = 2500, quality = 0.98) { // [修改] 提升默认压缩质量和尺寸，优化插值算法
    return new Promise((resolve, reject) => {
        // === 新增：GIF格式判断 ===
        // 如果是GIF动图，则不进行压缩，直接读取为Data URL以保留动画
        if (file.type === 'image/gif') {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                resolve(event.target.result);
            };
            reader.onerror = error => reject(error);
            return; // 提前返回，跳过后续的压缩逻辑
        }

        // === 原有逻辑：处理非GIF图片 ===
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // === 新增：优化图像插值算法，提高压缩后清晰度 ===
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high'; // 使用高质量插值
                ctx.webkitImageSmoothingEnabled = true;
                ctx.mozImageSmoothingEnabled = true;
                ctx.msImageSmoothingEnabled = true;
                
                // === 优化：根据图片类型选择合适的处理方式 ===
                if (file.type === 'image/png') {
                    // 保留PNG透明度
                    canvas.getContext('2d').clearRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/png', quality);
                    resolve(compressedDataUrl);
                } else {
                    // JPEG格式，使用更高质量压缩
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                }
            };
            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}
        // === 新增：每日情话功能核心逻辑 (已修复加载顺序问题) ===
        document.addEventListener('DOMContentLoaded', function() {
            const sweetWordsCard = document.getElementById('sweet-words-card');
            const sweetWordsText = document.getElementById('sweet-words-text');
            const sweetWordsContextMenuOverlay = document.getElementById('sweet-words-context-menu-overlay');
            const sweetWordsContextMenu = document.getElementById('sweet-words-context-menu');
            const sweetWordsSettingsOverlay = document.getElementById('sweet-words-settings-overlay');

            let swLongPressTimer = null;
            let swIsLongPress = false;

            // 显示情话上下文菜单
            function showSweetWordsContextMenu(event) {
                // 确保元素存在
                if (!sweetWordsContextMenuOverlay || !sweetWordsContextMenu) return;

                const menu = sweetWordsContextMenu;
                sweetWordsContextMenuOverlay.classList.add('visible');
                
                let x, y;
                if (event.touches && event.touches.length > 0) {
                    x = event.touches[0].clientX;
                    y = event.touches[0].clientY;
                } else {
                    x = event.clientX;
                    y = event.clientY;
                }
                
                const menuWidth = menu.offsetWidth;
                const menuHeight = menu.offsetHeight;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;

                if (x + menuWidth > windowWidth - 10) x = windowWidth - menuWidth - 10;
                if (y + menuHeight > windowHeight - 10) y = windowHeight - menuHeight - 10;
                
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                menu.style.opacity = 1;
                menu.style.pointerEvents = 'auto';
                menu.style.transform = 'scale(1)';
            }

            // 隐藏情话上下文菜单
            function hideSweetWordsContextMenu() {
                if (!sweetWordsContextMenuOverlay || !sweetWordsContextMenu) return;
                sweetWordsContextMenuOverlay.classList.remove('visible');
                sweetWordsContextMenu.style.opacity = 0;
                sweetWordsContextMenu.style.pointerEvents = 'none';
                sweetWordsContextMenu.style.transform = 'scale(0.95)';
            }

            // 卡片事件监听
            if (sweetWordsCard) {
                const startPress = (e) => {
                    e.stopPropagation(); // 阻止事件冒泡，以免触发其他元素的滑动
                    swIsLongPress = false;
                    swLongPressTimer = setTimeout(() => {
                        swIsLongPress = true;
                        showSweetWordsContextMenu(e);
                    }, 500); // 500ms 长按
                };
                
                const endPress = (e) => {
                    e.stopPropagation();
                    clearTimeout(swLongPressTimer);
                    if (!swIsLongPress) {
                        // 修改：单击不再刷新，而是调用揭晓函数
                        revealSweetWords();
                    }
                };
                // 新增：用于揭晓模糊内容
                function revealSweetWords() {
                    const container = document.getElementById('sweet-words-text-container');
                    if (container && container.dataset.revealed === 'false') {
                        container.classList.remove('blurred');
                        container.dataset.revealed = 'true';
                    }
                }

                sweetWordsCard.addEventListener('mousedown', startPress);
                sweetWordsCard.addEventListener('mouseup', endPress);
                sweetWordsCard.addEventListener('touchstart', startPress, { passive: true });
                sweetWordsCard.addEventListener('touchend', endPress);

                sweetWordsCard.addEventListener('mouseleave', () => clearTimeout(swLongPressTimer));
                sweetWordsCard.addEventListener('touchmove', () => clearTimeout(swLongPressTimer), { passive: true });
            }

            // 菜单和遮罩层事件
            if (sweetWordsContextMenuOverlay) {
                sweetWordsContextMenuOverlay.addEventListener('click', (e) => {
                    if (e.target === sweetWordsContextMenuOverlay) {
                        hideSweetWordsContextMenu();
                    }
                });
            }
            
            if (sweetWordsContextMenu) {
                sweetWordsContextMenu.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (action === 'refresh') {
                        refreshSweetWords();
                    } else if (action === 'settings') {
                        openSweetWordsSettings();
                    }
                    hideSweetWordsContextMenu();
                });
            }

            // 刷新情话功能 (已接入真实AI)
            async function refreshSweetWords() {
                const sweetWordsCard = document.getElementById('sweet-words-card');
                const contentEl = document.getElementById('sweet-words-content');
                const charEl = document.getElementById('sweet-words-char');
                const container = document.getElementById('sweet-words-text-container');

                if (!sweetWordsCard || sweetWordsCard.classList.contains('loading')) return;

                sweetWordsCard.classList.add('loading');
                contentEl.textContent = '正在生成...';
                charEl.textContent = '';
                
                try {
                    // 1. 获取API设置
                    const apiSettings = JSON.parse(await localforage.getItem('apiSettings') || '{}');
                    if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                        throw new Error('API配置不完整，请先在设置中配置。');
                    }
                    
                    // 2. 选择角色
                    const settings = JSON.parse(await localforage.getItem('sweetWordsSettings') || '{}');
                    const fixedContactId = settings.fixedContactId;
                    let selectedChar = null;

                    if (fixedContactId) {
                        selectedChar = archiveData.characters.find(c => c.id === fixedContactId);
                    }
                    if (!selectedChar && archiveData.characters && archiveData.characters.length > 0) {
                        const randomIndex = Math.floor(Math.random() * archiveData.characters.length);
                        selectedChar = archiveData.characters[randomIndex];
                    }

                    if (!selectedChar) {
                        throw new Error('没有可以生成情话的角色。');
                    }

                    // 3. 构建提示词
                    const chatHistory = (chatAppData.messages[selectedChar.id] || []).slice(-50); // 读取最近6条
                    const historyText = chatHistory.map(msg => `${msg.sender === 'me' ? 'User' : selectedChar.name}: ${msg.text}`).join('\n');
                    
                    const systemPrompt = `你将扮演名为 "${selectedChar.name}" 的角色。你的任务是，对 "User" 说一句简短的（不超过25个字）、口语化的、充满真实感的情话、悄悄话或心里话。

【参考资料】
1.  你的核心人设：${selectedChar.persona}
2.  最近的聊天记录：
${historyText || '（暂无聊天记录）'}

【输出要求】：直接返回那句话，不要包含任何开头的问候语、结尾的客套话或任何其他解释。只输出情话本身。`;

                    // 4. 调用API
                    const response = await fetch(new URL('/v1/chat/completions', apiSettings.url).href, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettings.key}` },
                        body: JSON.stringify({
                            model: apiSettings.model,
                            messages: [{
                                role: "user",
                                content: systemPrompt
                            }],
                            temperature: 0.9,
                            max_tokens: 200000, // 再次增加 token 上限，确保有足够空间生成完整句子
                            stream: false
                        })
                    });


                    if (!response.ok) {
                        throw new Error(`API 请求失败，状态码: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    let reply = '';
                    // 核心修复：同时兼容 OpenAI 和 Gemini 的响应格式
                    if (result.choices && result.choices[0] && result.choices[0].message && result.choices[0].message.content) {
                        // 优先处理 OpenAI 兼容格式
                        reply = result.choices[0].message.content.trim();
                    } 
                    else if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                        // 其次处理 Gemini 格式
                        reply = result.candidates[0].content.parts[0].text.trim();
                    } else {
                        // 如果两种格式都匹配不上，或者内容为空但有choices，说明API返回了空内容
                        const reason = result.choices && result.choices[0] ? `完成原因: ${result.choices[0].finish_reason}` : '未知原因';
                        throw new Error(`API返回了空内容。${reason}。 原始响应: ${JSON.stringify(result, null, 2)}`);
                    }
                    // 移除AI可能生成的多余引号
                    reply = reply.replace(/^["'“‘]|["'”’]$/g, ''); 

                    // 5. 渲染结果
                    contentEl.textContent = reply;
                    charEl.textContent = `— ${selectedChar.name}`;
                    contentEl.classList.remove('empty-text');

                    const savedWords = {
                        content: reply,
                        charName: selectedChar.name,
                        timestamp: Date.now() // 保存时间戳，用于判断是否是今天的
                    };
                    await localforage.setItem('savedSweetWords', JSON.stringify(savedWords));

                    // 7. 重置为模糊未揭晓状态
                    container.classList.add('blurred');
                    container.dataset.revealed = 'false';

                } catch (error) {
                    console.error("生成情话失败:", error);
                    contentEl.textContent = error.message;
                    charEl.textContent = '';
                } finally {
                    sweetWordsCard.classList.remove('loading');
                }
            }

            // === 每日情话设置功能 ===
            let swAutoGenerateInterval = null;

            async function openSweetWordsSettings() {
                const settings = JSON.parse(await localforage.getItem('sweetWordsSettings') || '{}');
                
                const select = document.getElementById('sw-fixed-contact-select');
                select.innerHTML = '<option value="">随机</option>';
                archiveData.characters.forEach(char => {
                    const option = document.createElement('option');
                    option.value = char.id;
                    option.textContent = char.name;
                    if (char.id === settings.fixedContactId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                const autoSwitch = document.getElementById('sw-auto-generate-switch');
                const timeGroup = document.getElementById('sw-auto-time-group');
                const timeInput = document.getElementById('sw-auto-time-input');
                
                autoSwitch.checked = settings.autoGenerate || false;
                if (settings.autoGenerate) {
                    timeGroup.style.display = 'block';
                    timeInput.value = settings.autoGenerateTime || '09:00';
                } else {
                    timeGroup.style.display = 'none';
                }

                autoSwitch.onchange = () => {
                    timeGroup.style.display = autoSwitch.checked ? 'block' : 'none';
                };

                sweetWordsSettingsOverlay.classList.add('visible');
            }

            function closeSweetWordsSettings() {
                sweetWordsSettingsOverlay.classList.remove('visible');
            }

            async function saveSweetWordsSettings() {
                const newSettings = {
                    fixedContactId: document.getElementById('sw-fixed-contact-select').value,
                    autoGenerate: document.getElementById('sw-auto-generate-switch').checked,
                    autoGenerateTime: document.getElementById('sw-auto-time-input').value
                };
                await localforage.setItem('sweetWordsSettings', JSON.stringify(newSettings));
                
                initializeAutoGeneration();
                closeSweetWordsSettings();
                showGlobalToast('情话设置已保存！', { type: 'success' });
            }

            async function loadSweetWordsSettings() {
                const bgImage = await localforage.getItem('sweetWordsCardBg');
                if (bgImage && sweetWordsCard) {
                    sweetWordsCard.style.background = `url(${bgImage}) center/cover no-repeat`;
                } else if (sweetWordsCard) {
                    sweetWordsCard.style.background = '';
                }
                initializeAutoGeneration();
            }

            async function autoGenerateSweetWords() {
                const settings = JSON.parse(await localforage.getItem('sweetWordsSettings') || '{}');
                if (!settings.autoGenerate) return;

                let selectedChar = null;
                if (settings.fixedContactId) {
                    selectedChar = archiveData.characters.find(c => c.id === settings.fixedContactId);
                }
                if (!selectedChar && archiveData.characters.length > 0) {
                    const randomIndex = Math.floor(Math.random() * archiveData.characters.length);
                    selectedChar = archiveData.characters[randomIndex];
                }
                
                if (selectedChar) {
                    const reply = await callSweetWordsAPI(selectedChar);
                    showGlobalMessageBanner(selectedChar.id, `对你说了句悄悄话`);
                    if (sweetWordsText) {
                        sweetWordsText.innerHTML = `<strong>${escapeHTML(selectedChar.name)}：</strong>${escapeHTML(reply)}`;
                    }
                }
            }

            async function initializeAutoGeneration() {
                if (swAutoGenerateInterval) {
                    clearInterval(swAutoGenerateInterval);
                }
                
                const settings = JSON.parse(await localforage.getItem('sweetWordsSettings') || '{}');
                if (settings.autoGenerate && settings.autoGenerateTime) {
                    console.log(`自动生成情话已启动，时间：${settings.autoGenerateTime}`);
                    swAutoGenerateInterval = setInterval(async () => {
                        const now = new Date();
                        const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                        if (currentTime === settings.autoGenerateTime) {
                            const lastTriggerKey = 'sw_last_auto_trigger';
                            const todayStr = now.toISOString().split('T')[0];
                            if (await localforage.getItem(lastTriggerKey) !== todayStr) {
                                await localforage.setItem(lastTriggerKey, todayStr);
                                autoGenerateSweetWords();
                            }
                        }
                    }, 60000);
                }
            }
        // === 每日情话卡片初始化逻辑 (已优化持久化) ===
        async function initializeSweetWordsCard() {
            const contentEl = document.getElementById('sweet-words-content');
            const charEl = document.getElementById('sweet-words-char');
            const container = document.getElementById('sweet-words-text-container');
            
            const savedData = await localforage.getItem('savedSweetWords');
            const todayDate = new Date().toDateString();

            let needsAutoRefresh = false;

            if (savedData) {
                const { content, charName, timestamp } = JSON.parse(savedData);
                const savedDate = new Date(timestamp).toDateString();

                if (content) { // 确保有内容
                    contentEl.textContent = content;
                    charEl.textContent = `— ${charName}`;
                    contentEl.classList.remove('empty-text');
                    
                    if (savedDate === todayDate) {
                        // 如果是今天的内容，直接显示，不模糊
                        container.classList.remove('blurred');
                        container.dataset.revealed = 'true';
                    } else {
                        // 如果是昨天或更早的内容，显示并保持模糊
                        container.classList.add('blurred');
                        container.dataset.revealed = 'false';
                        needsAutoRefresh = true; // 标记需要自动刷新
                    }
                } else {
                     // 如果数据损坏或内容为空
                    needsAutoRefresh = true;
                    setEmptyState();
                }

            } else {
                needsAutoRefresh = true;
                setEmptyState();
            }
            
            // 如果需要，触发一次自动刷新
            if (needsAutoRefresh) {
                // 使用 setTimeout 延迟执行，避免阻塞页面初始渲染
                setTimeout(refreshSweetWords, 500); 
            }

            // 设置为空状态的辅助函数
            function setEmptyState() {
                contentEl.textContent = '长按卡片，或点击菜单中的刷新按钮';
                contentEl.classList.add('empty-text');
                charEl.textContent = '';
                container.classList.remove('blurred');
                container.dataset.revealed = 'true';
            }
        }

        // 页面加载完成后立即初始化卡片
        document.addEventListener('DOMContentLoaded', initializeSweetWordsCard);

            // 绑定设置弹窗的按钮事件
            document.getElementById('sw-settings-save-btn').addEventListener('click', saveSweetWordsSettings);
            document.getElementById('sw-settings-close-btn').addEventListener('click', closeSweetWordsSettings);

            const setBgBtn = document.getElementById('sw-set-bg-btn');
            const clearBgBtn = document.getElementById('sw-clear-bg-btn');
            const bgUploadInput = document.getElementById('sw-bg-upload');
            
            if (setBgBtn) {
                setBgBtn.addEventListener('click', () => bgUploadInput.click());
            }
            
            if (bgUploadInput) {
                bgUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        compressImage(file).then(async (compressedDataUrl) => {
                            await localforage.setItem('sweetWordsCardBg', compressedDataUrl);
                            if (sweetWordsCard) {
                                sweetWordsCard.style.background = `url(${compressedDataUrl}) center/cover no-repeat`;
                            }
                        }).catch(error => {
                            showCustomAlert("图片压缩失败。");
                        });
                    }
                });
            }

            if (clearBgBtn) {
                clearBgBtn.addEventListener('click', () => {
                    localforage.removeItem('sweetWordsCardBg');
                    if (sweetWordsCard) {
                        sweetWordsCard.style.background = '';
                    }
                    showGlobalToast('卡片背景已清除', { type: 'info' });
                });
            }

            // 初始加载
            loadSweetWordsSettings();
        });
        // 新增：更新查手机App内时钟的函数
        function updatePhoneClock() {
            const phoneClock = document.getElementById('phone-lock-screen-time');
            if (phoneClock) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                phoneClock.textContent = `${hours}:${minutes}`;
            }
        }
        // 每秒更新一次
        setInterval(updatePhoneClock, 1000);
        // === 新增：档案App悬浮按钮抽屉菜单逻辑 ===
        document.addEventListener('DOMContentLoaded', () => {
            const archiveFab = document.getElementById('archive-fab');
            const drawerOverlay = document.getElementById('archive-fab-drawer-overlay');
            const btnAdd = document.getElementById('archive-add-btn');
            const btnImport = document.getElementById('archive-import-btn');
            const importInput = document.getElementById('character-card-import-input');
            
            // 检查元素是否存在
            if (!archiveFab || !drawerOverlay || !btnAdd || !btnImport || !importInput) {
                console.error('档案抽屉菜单所需的一个或多个HTML元素未找到。');
                return;
            }

            // 打开/关闭抽屉的函数
            const toggleArchiveDrawer = (forceClose = false) => {
                const isOpen = archiveFab.classList.contains('open');
                if (forceClose || isOpen) {
                    archiveFab.classList.remove('open');
                    drawerOverlay.classList.remove('visible');
                } else {
                    archiveFab.classList.add('open');
                    drawerOverlay.classList.add('visible');
                }
            };

            // 1. 给主按钮绑定点击事件
            archiveFab.addEventListener('click', (e) => {
                e.stopPropagation(); // 防止事件冒泡到下面的overlay
                toggleArchiveDrawer();
            });

            // 2. 点击遮罩层关闭抽屉
            drawerOverlay.addEventListener('click', (e) => {
                // 确保点击的是遮罩层本身，而不是它的子元素（按钮）
                if (e.target === drawerOverlay) {
                    toggleArchiveDrawer(true);
                }
            });

            // 3. 给"添加"按钮绑定事件
            btnAdd.addEventListener('click', () => {
                // 调用正确的函数来打开添加新角色的模态框
                if (typeof openCharEditModal === 'function') {
                    openCharEditModal(null); // 传入null表示是新建角色
                } else {
                    console.error('函数 openCharEditModal 未定义。');
                }
                toggleArchiveDrawer(true); // 关闭抽屉
            });

            // 4. 给"导入"按钮绑定事件
            btnImport.addEventListener('click', () => {
                // 这里调用的是原本长按“导入角色”应该执行的逻辑
                importInput.click(); // 触发隐藏的文件输入框
                toggleArchiveDrawer(true); // 关闭抽屉
            });
        });

        // 集中的初始化函数 - 页面加载完成后执行
        async function initializeApp() {
            try {
                // 初始化localForage配置
                localforage.config({
                    name: '水母终端',
                    storeName: '水母终端',
                    description: '存储水母终端应用数据'
                });

                // 1. 加载音效开关状态
                const soundEnabled = await localforage.getItem('soundEffectsEnabled') === 'true';
                const soundToggle = document.getElementById('sound-toggle');
                if (soundToggle) {
                    soundToggle.checked = soundEnabled;
                }

                // 2. 加载主题设置
                const isDarkMode = await localforage.getItem('darkMode') === 'true';
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    document.body.classList.toggle('dark-mode', isDarkMode);
                    themeToggle.checked = isDarkMode;
                }

                console.log('水母终端初始化完成');
            } catch (error) {
                console.error('初始化过程中发生错误:', error);
            }
        }


    </script>

    <script src="chat-app.js"></script>
    <script src="instance-app.js"></script>
    <script src="regex_app.js"></script>
    <script src="memory-app.js"></script> 
    <script src="check_phone_app.js"></script> 
    <script src="music-app.js"></script> 
    <script src="games-app.js"></script> 
    <script src="preset-app.js"></script> 
<!-- === 新增：多选、编辑、撤回等功能的悬浮窗 === -->

<!-- 撤回内容悬浮窗 -->
<div id="retracted-content-popover">
    <div class="original-content" id="popover-original-content"></div>
    <div class="inner-thought" id="popover-inner-thought"></div>
</div>

<!-- 编辑消息悬浮窗 -->
<div id="edit-message-modal">
    <div class="edit-message-box">
        <textarea id="edit-message-textarea"></textarea>
        <div class="button-group">
            <button id="cancel-edit-btn" class="modal-button secondary">取消</button>
            <button id="confirm-edit-btn" class="modal-button">确定</button>
        </div>
    </div>
</div>
<!-- === 新增：记忆App长按菜单 === -->
<div id="memory-context-menu-overlay">
    <div id="memory-context-menu">
        <div class="memory-context-menu-item" data-action="delete">删除</div>
    </div>
</div>
<!-- === 新增：内心声音悬浮窗 === -->
<div id="inner-voice-overlay">
    <div id="inner-voice-modal">
        <!-- [新增] 头像显示区域 -->
        <div id="inner-voice-avatar-area"></div>
        <!-- [新增] 内容包裹器，用于控制内边距和布局 -->
        <div id="inner-voice-content-wrapper">
            <!-- [新增] 角色姓名 -->
            <span id="inner-voice-char-name"></span>
            
            <!-- 原有内容被移动到这里 -->
            <div class="voice-section">
                <label>好感度</label>
                <div class="favor-bar-container">
                    <div class="favor-bar-track">
                        <div class="favor-bar-progress" id="favor-progress"></div>
                    </div>
                    <span class="favor-bar-text" id="favor-text">0%</span>
                </div>
            </div>
            <div class="voice-section">
                <label>状态</label>
                <span class="voice-content" id="voice-status">...</span>
            </div>
            <div class="voice-section">
                <label>心声</label>
                <span class="voice-content" id="voice-inner">...</span>
            </div>
            <div class="voice-section" id="true-feeling-field" style="display: none;">
                <label>真心话</label>
                <span class="voice-content" id="voice-true-feeling">...</span>
            </div>
        </div>
    </div>
</div>
<!-- === 新增：收藏详情弹窗 === -->
<div id="collection-detail-overlay">
    <div id="collection-detail-modal">
        <div id="collection-detail-header">
            <span id="collection-detail-title">收藏详情</span>
            <button id="collection-detail-close-btn" title="关闭">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div id="collection-detail-body">
            <!-- 收藏的聊天记录将在这里渲染 -->
        </div>
    </div>
</div>
<!-- === 自定义提示框 HTML 结构 === -->
<div id="custom-alert-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p id="custom-alert-message"></p>
        <button id="custom-alert-ok" class="modal-button">好的</button>
    </div>
</div>
<!-- === 新增：全局 Toast 容器 === -->
<div id="toast-container"></div>
<!-- === 新增：自定义确认框（Confirm） === -->
<div id="custom-confirm-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p id="custom-confirm-message"></p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="custom-confirm-cancel" class="modal-button secondary" style="width: 48%;">取消</button>
            <button id="custom-confirm-ok" class="modal-button" style="width: 48%;">确认</button>
        </div>
    </div>
</div>

<!-- === 新增：自定义输入框（Prompt） === -->
<div id="custom-prompt-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p id="custom-prompt-message"></p>
        <input type="text" id="custom-prompt-input" class="modal-input" style="margin-bottom: 20px; text-align: left;">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="custom-prompt-cancel" class="modal-button secondary" style="width: 48%;">取消</button>
            <button id="custom-prompt-ok" class="modal-button" style="width: 48%;">确定</button>
        </div>
    </div>
</div>
<!-- === 新增：表情包管理悬浮窗 === -->
<div id="emoji-management-modal-overlay">
    <div id="emoji-management-modal">
        <div class="emoji-management-header">
            <span>表情包管理</span>
            <button id="close-emoji-management-btn" title="关闭">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
<div class="emoji-management-body">
    <details id="add-emoji-group-details">
        <summary style="font-weight: 600; cursor: pointer; padding: 10px 0; list-style: inside; color: var(--text-color);">添加新分组</summary>
        <div id="add-emoji-group-form" class="modal-form-section">
            <div class="modal-form-group">
                <label for="new-group-name">分组名称</label>
                <input type="text" id="new-group-name" class="modal-input" placeholder="填写分组名">
            </div>
            <div class="modal-form-group">
                <label for="bulk-add-urls">批量添加表情 (描述:链接)</label>
                <textarea id="bulk-add-urls" class="modal-input" placeholder="例如：&#10;开心: https://example.com/happy.gif&#10;难过 https://example.com/sad.png"></textarea>
            </div>
            <div class="button-container">
                <button id="save-emoji-group-btn" class="modal-button">保存为新分组</button>
            </div>
        </div>
    </details>
    <div id="emoji-group-list">
        <!-- 分组列表将由JS动态渲染 -->
    </div>
</div>
    </div>
</div>
<!-- === 新增：聊天工具悬浮窗 === -->

<!-- 1. 图片上传预览悬浮窗 -->
<div id="image-preview-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>图片预览</h4>
        <div id="image-preview-area">
            <img id="image-preview-img" src="" alt="图片预览">
        </div>
        <textarea id="image-description-input" class="modal-input" placeholder="添加描述（可选）"></textarea>
        <div class="button-group">
            <button id="cancel-image-send" class="modal-button secondary">取消</button>
            <button id="confirm-image-send" class="modal-button">发送</button>
        </div>
    </div>
</div>
<!-- 隐藏的文件选择器 -->
<input type="file" id="image-upload-input" accept="image/*" hidden>


<!-- 2. 模拟语音输入悬浮窗 -->
<div id="voice-input-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>发送语音</h4>
        <textarea id="voice-text-input" class="modal-input" placeholder="在这里输入要转为语音的文字..."></textarea>
        <div class="button-group">
            <button id="cancel-voice-send" class="modal-button secondary">取消</button>
            <button id="confirm-voice-send" class="modal-button">发送</button>
        </div>
    </div>
</div>

<!-- 3. API 切换悬浮窗 -->
<div id="api-switch-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>切换 API 预设</h4>
            <button id="close-api-switch" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div id="api-preset-list">
            <!-- 预设列表将由JS动态填充 -->
        </div>
    </div>
</div>

<!-- 话题功能悬浮窗 -->
<div id="topic-management-modal-overlay">
    <div id="topic-management-modal">
        <div class="emoji-management-header">
            <span>话题功能</span>
            <button id="close-topic-management-btn" title="关闭">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="emoji-management-body">
            <details id="topic-settings-details">
                <summary style="font-weight: 600; cursor: pointer; padding: 10px 0; list-style: inside; color: var(--text-color);">话题功能设置</summary>
                <div id="topic-settings-form" class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="topic-api-preset-select">API预设选择</label>
                        <select id="topic-api-preset-select" class="modal-select">
                            <option value="default">默认预设</option>
                            <option value="creative">创意生成</option>
                            <option value="professional">专业分析</option>
                        </select>
                    </div>
                    <div class="modal-form-group">
                        <div class="switch-group">
                            <label for="topic-auto-init-switch">AI主动发起话题</label>
                            <label class="switch-container">
                                <input type="checkbox" id="topic-auto-init-switch">
                                <span class="switch-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div id="topic-frequency-section" class="modal-form-group" style="display: none;">
                        <label for="topic-frequency-select">发起话题频率（小时）</label>
                        <select id="topic-frequency-select" class="modal-select">
                            <option value="1">每1小时</option>
                            <option value="2">每2小时</option>
                            <option value="4">每4小时</option>
                            <option value="6">每6小时</option>
                            <option value="12">每12小时</option>
                            <option value="24">每24小时</option>
                        </select>
                    </div>
                    <div class="button-container">
                        <button id="save-topic-settings-btn" class="modal-button">保存设置</button>
                    </div>
                </div>
            </details>
        </div>
    </div>
</div>

<!-- 4. 转账悬浮窗 -->
<div id="transfer-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>转账</h4>
        <div class="modal-form-group">
            <label for="transfer-amount">转账金额</label>
            <input type="number" id="transfer-amount" class="modal-input" placeholder="输入金额" step="0.01" min="0.01">
        </div>
        <div class="modal-form-group">
            <label for="transfer-description">转账说明</label>
            <textarea id="transfer-description" class="modal-input" placeholder="添加转账说明（可选）"></textarea>
        </div>
        <div class="button-group">
            <button id="cancel-transfer" class="modal-button secondary">取消</button>
            <button id="confirm-transfer" class="modal-button">转账</button>
        </div>
    </div>
</div>

<!-- === 新增结束 === -->

<!-- === 新增：线下模式确认弹窗 === -->
<div id="offline-confirm-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p id="offline-confirm-message"></p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="offline-confirm-edit-btn" class="modal-button secondary" style="width: 48%;">编辑</button>
            <button id="offline-confirm-ok-btn" class="modal-button" style="width: 48%;">确定</button>
        </div>
    </div>
</div>

<!-- === 新增：线下模式编辑悬浮窗 === -->
<div id="offline-settings-popup-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>编辑线下模式</h4>
            <button id="close-offline-settings-btn" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div id="offline-settings-popup-body">
            <!-- 线下模式设置将动态渲染到这里 -->
        </div>
    </div>
</div>

<!-- === 新增：总结功能悬浮窗 === -->
<div id="summary-popup-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box" style="max-width: 480px; gap: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>聊天记录总结</h4>
            <button id="close-summary-popup-btn" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="modal-form-section" style="gap: 16px;">
            <div class="modal-form-group">
                <label for="summary-api-preset">API 预设</label>
                <select id="summary-api-preset" class="modal-select"></select>
            </div>
            <div class="modal-form-group">
                <label for="summary-prompt">总结提示词</label>
                <textarea id="summary-prompt" class="modal-input" style="min-height: 120px;"></textarea>
            </div>
            <div class="modal-form-group">
                <label for="summary-context-slider">总结上下文回合数: <span id="summary-context-value">20</span></label>
                <div class="slider-group">
                    <input type="range" id="summary-context-slider" min="10" max="100" step="2" value="20">
                </div>
            </div>
            <div class="modal-form-group">
                <label for="summary-threshold-slider">自动总结阈值: <span id="summary-threshold-value">50</span> 回合</label>
                <div class="slider-group">
                    <input type="range" id="summary-threshold-slider" min="0" max="200" step="10" value="50">
                    <span style="font-size: 12px; opacity: 0.7;">(0为关闭)</span>
                </div>
            </div>
        </div>

        <details id="summary-display-area">
            <summary>查看历史总结</summary>
            <div id="summary-list-container">
                <span class="empty-text">暂无历史总结</span>
            </div>
        </details>
        
        <div class="button-group" style="justify-content: space-between;">
            <button id="manual-summary-btn" class="modal-button">立即手动总结</button>
            <button id="save-summary-settings-btn" class="modal-button secondary">保存设置</button>
        </div>
    </div>
</div>

<!-- === 新增：视频通话全屏界面 === -->
<div id="video-call-overlay">
    <!-- 统一的背景层 -->
    <div class="video-call-background"></div>

    <!-- 呼叫中状态 -->
    <div id="video-call-calling-state" class="video-state-view">
        <div class="char-avatar-large"></div>
        <p class="status-text">等待对方接通...</p>
        <button class="video-call-hang-up-btn" title="挂断">
            <!-- 新的挂断图标(大) -->
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M512 0c282.769067 0 512 229.230933 512 512s-229.230933 512-512 512S0 794.769067 0 512 229.230933 0 512 0z" fill="#E83434"></path><path d="M166.382933 471.338667c-31.505067 37.632-21.879467 116.369067 0.8704 151.3728 13.994667 21.870933 28.8768 21.870933 35.874134 19.2512 50.747733-8.7552 130.372267-34.133333 152.2432-51.626667l1.749333-0.878933 0.878933-1.749334c7.876267-13.124267 6.126933-27.118933 4.369067-39.3728-2.619733-15.744-2.619733-25.3696 8.7552-35.874133 3.498667-3.498667 21.870933-13.124267 118.997333-13.994667h41.992534c99.754667 0.8704 118.126933 11.374933 121.6256 14.8736 11.374933 10.496 9.6256 20.1216 6.997333 35.874134-1.749333 12.245333-4.3776 26.248533 2.628267 39.3728l0.8704 1.749333 1.749333 0.8704c21.000533 17.501867 99.754667 42.88 149.623467 51.626667 6.997333 1.749333 20.1216 2.628267 33.245866-13.994667 27.997867-33.2544 43.7504-119.876267 8.7552-159.249067-48.9984-55.125333-166.2464-88.3712-315.869866-89.250133h-55.125334c-148.736 0-267.733333 32.375467-319.36 88.379733l-0.8704 2.619734z" fill="#FFFFFF"></path></svg>
        </button>
    </div>

    <!-- 已接通状态 -->
    <div id="video-call-connected-state" class="video-state-view">
        <!-- 用户小窗口 -->
        <div class="user-self-view"></div>
        
        <!-- 对话区域 -->
        <div id="video-chat-dialogue-area" class="video-chat-dialogue-area">
            <!-- 对话文字将由JS动态填充 -->
        </div>

        <!-- 底部悬浮输入胶囊 (新布局) -->
        <div class="video-chat-input-bar">
            <button class="chat-action-btn" id="video-re-answer-btn" title="重回">
                 <svg t="1767115092714" class="icon" viewBox="0 0 1024 1024"><path d="M512 82c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="15984"></path></svg>
            </button>
            <div class="chat-input-area">
                <input type="text" id="video-chat-input" placeholder="输入消息...">
            </div>
            <!-- 修改：移除了 API 回复按钮，只保留挂断按钮 -->
            <button class="chat-action-btn" id="video-chat-hang-up-in-bar-btn" title="挂断">
                 <!-- 新的挂断图标(小) -->
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M512 0c282.769067 0 512 229.230933 512 512s-229.230933 512-512 512S0 794.769067 0 512 229.230933 0 512 0z" fill="#E83434"></path><path d="M166.382933 471.338667c-31.505067 37.632-21.879467 116.369067 0.8704 151.3728 13.994667 21.870933 28.8768 21.870933 35.874134 19.2512 50.747733-8.7552 130.372267-34.133333 152.2432-51.626667l1.749333-0.878933 0.878933-1.749334c7.876267-13.124267 6.126933-27.118933 4.369067-39.3728-2.619733-15.744-2.619733-25.3696 8.7552-35.874133 3.498667-3.498667 21.870933-13.124267 118.997333-13.994667h41.992534c99.754667 0.8704 118.126933 11.374933 121.6256 14.8736 11.374933 10.496 9.6256 20.1216 6.997333 35.874134-1.749333 12.245333-4.3776 26.248533 2.628267 39.3728l0.8704 1.749333 1.749333 0.8704c21.000533 17.501867 99.754667 42.88 149.623467 51.626667 6.997333 1.749333 20.1216 2.628267 33.245866-13.994667 27.997867-33.2544 43.7504-119.876267 8.7552-159.249067-48.9984-55.125333-166.2464-88.3712-315.869866-89.250133h-55.125334c-148.736 0-267.733333 32.375467-319.36 88.379733l-0.8704 2.619734z" fill="#FFFFFF"></path></svg>
            </button>
        </div>
    </div>
</div>
<!-- === 新增：聊天存档悬浮窗 === -->
<div id="chat-archive-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>对话存档</h4>
            <button id="close-archive-popup-btn" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="modal-form-group">
            <input type="text" id="archive-title-input" class="modal-input" placeholder="输入存档标题 (留空则为时间)">
        </div>
        <div class="button-container">
            <button id="save-archive-btn" class="modal-button">将当前对话存档</button>
        </div>
        
        <hr class="subtle-divider">

        <div id="archive-list-container">
            <!-- 存档列表将由JS动态填充 -->
        </div>
    </div>
</div>
<!-- === 新增：开场白选择悬浮窗 === -->
<div id="opening-remark-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>选择一句开场白</h4>
        <div id="opening-remark-list">
            <!-- 开场白列表将由JS动态填充 -->
        </div>
    </div>
</div>

<!-- === 新增：快捷回复悬浮窗 === -->
<div id="quick-reply-overlay">
    <div id="quick-reply-popup">
        <div id="quick-reply-header">
            <span>快捷回复</span>
            <button id="add-quick-reply-btn" title="添加新的快捷回复">
                <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
            </button>
        </div>
        <div id="quick-reply-list">
            <!-- 快捷回复卡片将由JS动态渲染到这里 -->
        </div>
    </div>
</div>

<!-- === 新增：快捷回复编辑表单悬浮窗 === -->
<div id="quick-reply-form-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4 id="quick-reply-form-title">添加快捷回复</h4>
        <div class="modal-form-group">
            <label for="quick-reply-form-title-input">标题</label>
            <input type="text" id="quick-reply-form-title-input" class="modal-input" placeholder="简短的标题，用于列表显示">
        </div>
        <div class="modal-form-group">
            <label for="quick-reply-form-textarea">内容</label>
            <textarea id="quick-reply-form-textarea" class="modal-input" placeholder="点击卡片时实际发送的内容"></textarea>
        </div>
        <div class="button-group">
            <button id="cancel-quick-reply-form" class="modal-button secondary">取消</button>
            <button id="save-quick-reply-form" class="modal-button">保存</button>
        </div>
    </div>
</div>
<!-- === 新增：音乐App - 创建/编辑歌单悬浮窗 === -->
<div id="playlist-edit-overlay" class="music-popup-overlay">
    <div class="music-popup-box">
        <h4 id="playlist-edit-title">创建新歌单</h4>
        <div class="playlist-cover-setter">
            <div id="playlist-cover-preview">
                <span>点击设置封面</span>
            </div>
            <input type="file" id="playlist-cover-upload" accept="image/*" hidden>
        </div>
        <div class="modal-form-group">
            <label for="playlist-name-input">歌单名称</label>
            <input type="text" id="playlist-name-input" class="modal-input" placeholder="输入歌单名称">
        </div>
        <div class="button-group">
            <button id="cancel-playlist-edit" class="modal-button secondary">取消</button>
            <button id="save-playlist-edit" class="modal-button">保存</button>
        </div>
    </div>
</div>
<!-- === 新增：音乐App - 歌单详情悬浮窗 === -->
<div id="playlist-detail-overlay" class="music-popup-overlay">
    <div class="music-popup-box">
        <h4 id="playlist-detail-title">歌单详情</h4>
        <div id="playlist-detail-body" class="playlist-song-list">
            <!-- 歌曲列表将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="edit-playlist-btn" class="modal-button secondary">编辑歌单</button>
            <button id="close-playlist-detail" class="modal-button">关闭</button>
        </div>
    </div>
</div>
<!-- === 新增：副本App基础设置悬浮窗 === -->
<div id="instance-base-settings-overlay" class="chatapp-popup-overlay">
    <div id="instance-base-settings-box" class="chatapp-popup-box">
        <h4 id="instance-base-settings-title">基础设置</h4>
        <div id="instance-base-settings-body">
            <!-- 悬浮窗内容将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="close-instance-base-settings-btn" class="modal-button secondary">关闭</button>
            <button id="save-instance-base-settings-btn" class="modal-button">保存</button>
        </div>
    </div>
</div>

<!-- 3. 副本专用 - API 切换悬浮窗 -->
<div id="instance-api-switch-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box" style="max-width: 420px;">
        <h4>切换 API 预设</h4>
        <div id="instance-api-preset-list">
            <!-- 预设列表将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="close-instance-api-switch" class="modal-button secondary">关闭</button>
        </div>
    </div>
</div>

<!-- === 新增：副本创建/详情悬浮窗 === -->
<div id="instance-popup-overlay" class="chatapp-popup-overlay">
    <div id="instance-popup-box" class="chatapp-popup-box" style="max-height: 80vh;">
        <h4 id="instance-popup-title">创建新副本</h4>
        <div id="instance-popup-body" style="overflow-y: auto; flex-grow: 1; padding: 0 10px; margin: 0 -10px;">
            <!-- 内容将由JS动态填充 -->
        </div>
        <div class="button-group" id="instance-popup-footer">
            <!-- 按钮将由JS动态填充 -->
        </div>
    </div>
</div>

<!-- === 新增：副本氛围设置悬浮窗 === -->
<div id="instance-atmosphere-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>氛围设置</h4>
        <div id="instance-atmosphere-body" style="max-height: 70vh; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;">
            <!-- 氛围设置内容将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="close-atmosphere-popup-btn" class="modal-button secondary">关闭</button>
        </div>
    </div>
</div>
<!-- === 新增：进入副本确认悬浮窗 === -->
<div id="enter-instance-overlay">
    <div id="enter-instance-popup">
        <div id="enter-instance-header">
            <h4 id="enter-instance-title">进入副本</h4>
            <button id="close-enter-instance-btn" title="关闭">&times;</button>
        </div>
        <div id="enter-instance-body">
            <!-- 角色和NPC列表将由JS动态填充 -->
        </div>
        <div id="enter-instance-footer">
            <div id="confirm-entry-button-wrapper" title="长按进入">
                <svg id="progress-ring">
                    <circle id="progress-ring-circle" cx="50%" cy="50%" r="30"></circle>
                </svg>
                <button id="confirm-entry-button">
                    <svg t="1767601300391" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1418" width="32" height="32"><path d="M102.4 665.6c0 30.72-20.48 51.2-51.2 51.2s-51.2-20.48-51.2-51.2v-153.6c0-128 46.08-245.76 128-337.92 10.24-15.36 30.72-20.48 51.2-15.36s30.72 15.36 40.96 35.84c5.12 15.36 0 35.84-10.24 51.2C138.24 317.44 102.4 414.72 102.4 512v153.6zM363.52 128c-25.6 10.24-56.32 0-66.56-25.6-10.24-25.6 0-56.32 30.72-66.56C384 10.24 450.56 0 512 0c281.6 0 512 230.4 512 512 0 122.88-20.48 220.16-56.32 281.6-10.24 15.36-30.72 25.6-46.08 25.6-20.48 0-35.84-10.24-40.96-25.6-10.24-15.36-10.24-35.84 0-51.2 25.6-46.08 40.96-122.88 40.96-230.4 0-133.12-66.56-261.12-179.2-337.92s-256-92.16-378.88-46.08zM245.76 901.12c-10.24 15.36-30.72 25.6-46.08 20.48-20.48 0-35.84-15.36-40.96-30.72-5.12-15.36-5.12-35.84 5.12-51.2s20.48-35.84 25.6-51.2c10.24-35.84 15.36-66.56 15.36-122.88 0-30.72 20.48-51.2 51.2-51.2s51.2 20.48 51.2 51.2c0 66.56-5.12 102.4-20.48 153.6-10.24 30.72-20.48 56.32-40.96 81.92zM307.2 512c0 30.72-20.48 51.2-51.2 51.2s-51.2-20.48-51.2-51.2c0-122.88 71.68-230.4 179.2-281.6s240.64-30.72 327.68 51.2c20.48 20.48 20.48 51.2 5.12 71.68-20.48 20.48-51.2 20.48-71.68 5.12-61.44-51.2-148.48-66.56-220.16-35.84S307.2 430.08 307.2 512z m409.6 0c0-30.72 20.48-51.2 51.2-51.2s51.2 20.48 51.2 51.2c0 199.68-35.84 348.16-112.64 440.32-15.36 20.48-51.2 25.6-71.68 5.12-20.48-15.36-25.6-51.2-5.12-71.68 56.32-71.68 87.04-194.56 87.04-373.76z m-256-46.08c0-25.6 20.48-51.2 46.08-51.2s51.2 20.48 56.32 46.08c15.36 199.68-20.48 378.88-107.52 537.6-10.24 15.36-25.6 25.6-46.08 25.6s-35.84-10.24-46.08-25.6-10.24-35.84 0-51.2c76.8-143.36 112.64-302.08 97.28-481.28z" fill="#A1CACD" p-id="1419"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- === 新增：副本聊天界面 === -->
<div id="instance-chat-container">
    <div id="instance-chat-wallpaper"></div>
    <div id="instance-chat-header">
        <button id="instance-chat-back-btn" title="返回">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
        </button>
        <span id="instance-chat-title"></span>
    </div>
    <div id="instance-chat-messages">
        <!-- 副本聊天内容将由JS动态填充 -->
    </div>
    <div id="instance-chat-footer">
        <!-- 新增：副本聊天工具栏 -->
        <div id="instance-chat-toolbar">
            <button class="instance-toolbar-btn" title="重回">
                <svg t="1767604522525" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4600" width="16" height="16"><path d="M512 82c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="4601"></path><path d="M512 72C268.995 72 72 268.995 72 512l0.017 3.868c1.075 123.712 53.693 240.24 145.233 322.825l1.247 1.114-66.97 79.814a30.18 30.18 0 0 0-7.06 19.182c-0.118 16.666 13.296 30.272 29.962 30.39l243.649 1.735a30.288 30.288 0 0 0 5.666-0.497c16.392-3.01 27.24-18.74 24.228-35.131l-44.015-239.647a30.176 30.176 0 0 0-10.283-17.665l-0.385-0.318c-12.762-10.36-31.523-8.602-42.129 4.037l-70.41 83.91-1.394-1.273C208.845 699.358 168.786 608.439 168.786 512c0-189.552 153.662-343.214 343.214-343.214S855.214 322.448 855.214 512c0 101.661-44.508 197.103-122.127 262.532l-2.363 1.973c-10.786 8.931-12.29 24.916-3.36 35.703l29.383 35.486c8.931 10.787 24.916 12.291 35.702 3.36C893.72 767.204 952 643.547 952 512c0-243.005-196.995-440-440-440z m0 10c237.482 0 430 192.518 430 430 0 128.822-57.15 249.565-155.928 331.351-6.533 5.41-16.214 4.498-21.623-2.034l-29.382-35.487c-5.409-6.533-4.498-16.213 2.035-21.622C818.31 716.968 865.214 617.878 865.214 512c0-195.075-158.14-353.214-353.214-353.214-195.075 0-353.214 158.14-353.214 353.214 0 103.647 44.947 200.788 123.023 267.913l77.012-91.778c7.162-8.536 19.889-9.65 28.425-2.487a20.176 20.176 0 0 1 6.875 11.812l44.016 239.646c2.013 10.96-5.24 21.477-16.2 23.49-1.25 0.23-2.518 0.332-3.788 0.332l-243.65-1.734c-11.142-0.08-20.11-9.176-20.032-20.32a20.18 20.18 0 0 1 4.72-12.825l73.262-87.31C137.039 757.061 82 638.421 82 512 82 274.518 274.518 82 512 82z" p-id="4602"></path></svg>
            </button>
            <button class="instance-toolbar-btn" id="instance-options-btn" title="选项">
                <svg t="1767625102487" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3613" width="16" height="16"><path d="M695.5008 126.0032H325.12a201.2672 201.2672 0 0 0-201.0624 201.0112v370.3808a201.2672 201.2672 0 0 0 201.0624 201.0624h370.3808a201.2672 201.2672 0 0 0 201.0624-201.0624V327.0144a201.2672 201.2672 0 0 0-201.0624-201.0112z m144.7424 571.392a144.896 144.896 0 0 1-144.7424 144.7424H325.12a144.896 144.896 0 0 1-144.7424-144.7424V327.0144A144.896 144.896 0 0 1 325.12 182.3232h370.3808a144.896 144.896 0 0 1 144.7424 144.6912z" fill="#231F20" p-id="3614"></path><path d="M746.3424 606.208H503.8592a28.16 28.16 0 0 0 0 56.32h242.4832a28.16 28.16 0 0 0 0-56.32zM746.3424 372.6848H503.8592a28.16 28.16 0 0 0 0 56.32h242.4832a28.16 28.16 0 0 0 0-56.32zM355.2256 553.9328a80.4352 80.4352 0 1 0 80.384 80.4352 80.4864 80.4864 0 0 0-80.384-80.4352z m0 104.4992a24.1152 24.1152 0 1 1 24.064-24.064 24.1152 24.1152 0 0 1-24.064 24.064zM398.08 317.44L336.9472 387.9936 300.1344 353.28a28.16 28.16 0 0 0-38.8096 40.96l58.2144 54.8864a28.16 28.16 0 0 0 19.4048 7.7312h1.3312a27.9552 27.9552 0 0 0 19.9168-9.6768l80.4352-92.7744A28.16 28.16 0 0 0 398.08 317.44z" fill="#231F20" p-id="3615"></path></svg>           
            </button>
            <button class="instance-toolbar-btn" id="instance-status-btn" title="状态">
                <svg t="1767604665307" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11537"><path d="M187.97568 565.98528c14.88896 73.1648 51.58912 138.98752 106.09664 190.31552a32.68608 32.68608 0 0 0 27.1872 8.56064 32.7424 32.7424 0 0 0 23.60832-16.00512l42.56768-73.72288a32.768 32.768 0 0 0-4.096-38.36928 214.13376 214.13376 0 0 1-47.39072-86.06208 32.75264 32.75264 0 0 0-31.55456-24.00256H220.05248a32.68096 32.68096 0 0 0-25.34912 12.03712 32.65024 32.65024 0 0 0-6.72768 27.24864zM621.11744 717.53728a32.70656 32.70656 0 0 0-35.3536-15.64672 210.88256 210.88256 0 0 1-106.46016-4.22912 32.78336 32.78336 0 0 0-37.90848 14.9504l-41.78944 72.4224a32.74752 32.74752 0 0 0-2.42688 27.48416 32.62464 32.62464 0 0 0 19.44576 19.57376c39.58784 14.62272 81.40288 22.0416 124.2368 22.0416 35.41504 0 70.37952-5.11488 103.89504-15.22176a32.82944 32.82944 0 0 0 20.992-19.28192 32.73216 32.73216 0 0 0-2.0992-28.4416l-42.53184-73.6512zM771.584 217.3696a32.70144 32.70144 0 0 0-20.96128-7.60832c-1.89952 0-3.83488 0.19968-5.7344 0.52736a32.73728 32.73728 0 0 0-22.59968 15.872l-41.8816 72.47872a32.80384 32.80384 0 0 0 6.00064 40.30976 210.65216 210.65216 0 0 1 59.36128 98.19136 32.768 32.768 0 0 0 31.58528 24.07424h84.352a32.75776 32.75776 0 0 0 25.3184-12.00128 32.62464 32.62464 0 0 0 6.75328-27.22304c-16.09728-79.7696-59.48928-152.44288-122.19392-204.6208zM665.74848 168.27392a32.76288 32.76288 0 0 0-20.992-19.28704 359.80288 359.80288 0 0 0-103.89504-15.25248c-42.83392 0-84.64896 7.41376-124.2368 22.03648a32.78336 32.78336 0 0 0-17.01888 47.104l41.78944 72.41216a32.78336 32.78336 0 0 0 37.90848 14.9504 210.7392 210.7392 0 0 1 61.56288-9.14944c14.98624 0 30.1056 1.6384 44.89728 4.8896a32.74752 32.74752 0 0 0 35.3536-15.61088l42.53696-73.66144a32.70656 32.70656 0 0 0 2.09408-28.43136zM861.70624 526.6944h-84.352a32.73216 32.73216 0 0 0-31.58528 24.06912 210.74944 210.74944 0 0 1-59.36128 98.19648 32.73728 32.73728 0 0 0-6.00064 40.2688l41.8816 72.50944a32.70144 32.70144 0 0 0 22.59968 15.87712c1.89952 0.32768 3.83488 0.49152 5.7344 0.49152a32.67584 32.67584 0 0 0 20.96128-7.57248c62.70464-52.21376 106.09664-124.85632 122.19392-204.61568a32.6144 32.6144 0 0 0-6.75328-27.22304 32.6656 32.6656 0 0 0-25.3184-12.00128zM194.69824 449.17248a32.69632 32.69632 0 0 0 25.34912 12.03712h84.352a32.75776 32.75776 0 0 0 31.55456-24.00256 214.15424 214.15424 0 0 1 47.39072-86.0928 32.7168 32.7168 0 0 0 4.096-38.33856L344.87296 239.0528a32.8704 32.8704 0 0 0-23.60832-16.03584 32.70656 32.70656 0 0 0-4.75648-0.32768c-8.26368 0-16.3328 3.1488-22.43072 8.91904C239.5648 282.9312 202.86464 348.7488 187.97568 421.91872a32.68608 32.68608 0 0 0 6.72256 27.25376z" fill="#2B3B94"></path></svg>
            </button>
            <button class="instance-toolbar-btn" title="API切换">
                <svg t="1767147196485" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3575" width="32" height="32"><path d="M390.368 673.04l277.2-277.216-56.432-56.432-277.168 277.216 56.4 56.432z m83.36-11.904c10.96 30.784 4.4 66.464-20.256 91.04-53.776 53.664-71.2 80.384-116.992 80.384-45.44 0-58.448-21.984-136.352-99.696a87.36 87.36 0 0 1 0.016-123.584c48.816-48.72 82.384-98.32 147.104-74.816l59.28-59.12c-64.64-40.896-151.36-33.328-207.632 22.848L143.888 553.12c-65.2 65.04-65.216 170.88-0.032 235.936 72.768 72.592 108 122.944 192.624 122.944 81.76 0 117.184-47.648 173.248-103.616 55.824-55.632 64.112-141.6 23.36-206.464l-59.36 59.232z m388.48-442.176l-74.24-74.24c-65.12-65.168-171.04-64.88-235.856-0.016l-54.896 54.896c-56 55.984-63.936 142.432-22.864 207.184l59.12-59.136c-12.496-34.32-2.8-69.168 19.888-91.872 55.296-55.28 71.488-80.336 116.688-80.336 45.376 0 58.384 22.048 136.016 99.696a87.504 87.504 0 0 1 0.016 123.568c-48.576 48.56-81.632 97.616-145.872 75.056l-59.28 59.296a165.968 165.968 0 0 0 88.48 25.408c81.408 0 116.576-47.344 172.816-103.584 65.056-65.056 65.024-170.88 0-235.92z" fill="#2c2c2c" p-id="3576"></path></svg>
            </button>
<button class="instance-toolbar-btn" title="手机" style="position: relative;">
                <!-- 新增：手机按钮上的通知红点 -->
                <span id="instance-phone-notification-dot" style="position: absolute; top: -1px; right: -1px; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: none; border: 1.5px solid var(--bg-color-end);"></span>
                <svg t="1767605775124" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3396" width="16" height="16"><path d="M717.91 19.36H305.16c-97.66 0-177.09 79.43-177.09 177.09v633.44c0 97.64 79.43 177.07 177.09 177.07h412.75c97.66 0 177.09-79.43 177.09-177.07V196.45c0-97.66-79.43-177.09-177.09-177.09zM594.19 89.88l-30.79 52.18H459.66l-30.81-52.18h165.34z m230.29 740.01c0 58.75-47.8 106.54-106.57 106.54H305.16c-58.77 0-106.57-47.8-106.57-106.54V196.45c0-58.77 47.8-106.57 106.57-106.57h41.81l72.43 122.71h184.28l72.41-122.71h41.82c58.77 0 106.57 47.8 106.57 106.57v633.44z" fill="#333333" p-id="3397"></path><path d="M655.95 815.68H367.1c-19.47 0-35.26 15.79-35.26 35.26s15.79 35.26 35.26 35.26h288.85c19.47 0 35.26-15.79 35.26-35.26s-15.8-35.26-35.26-35.26z" fill="#333333" p-id="3398"></path></svg>
            </button>
            <button class="instance-toolbar-btn" title="氛围">
                <svg t="1767625193714" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8800" width="16" height="16"><path d="M409.09824 937.35424c-15.15008 0-30.976-2.52416-49.79712-7.94624-29.30688-8.43776-54.62016-25.89184-79.66208-54.92224-24.10496-27.93984-45.83424-60.65152-70.45632-106.0608a1601.13664 1601.13664 0 0 1-12.26752-23.24992l-0.96256-1.8432c1.72544 0.31744 3.45088 0.57344 5.20704 0.73728 4.35712 0.38912 8.73984 0.5888 13.02528 0.5888 17.09568 0 33.83808-3.13344 49.7664-9.3184 0.3072-0.11776 0.55296-0.2048 0.75264-0.27136 0.12288 0.21504 0.27648 0.50688 0.4608 0.88064l4.08576 8.46336c9.35424 19.38944 19.0208 39.43936 29.38368 58.77248 9.472 17.68448 21.76512 32.32256 36.5312 43.50976 23.54176 17.82784 49.88928 27.25376 76.19584 27.25376 22.32832-0.00512 44.288-6.656 65.26464-19.77344 25.76896-16.11264 48.42496-36.5568 69.27872-62.4896 0.0512-0.06144 0.09728-0.11264 0.13312-0.16896l0.16896 0.1024c35.36384 21.89824 64.14848 35.39968 93.33248 43.78624 17.38752 4.99712 31.69792 7.3216 45.05088 7.3216 8.96512 0 17.664-1.1008 25.86112-3.26144 35.21536-9.28256 57.48224-30.49472 66.16064-63.04256 6.17984-23.20384-1.16736-45.2096-7.22944-59.74528-4.06016-9.72288-9.51296-20.80256-19.2-29.20448-3.19488-2.78016-7.07072-5.95968-11.53536-8.45824a49390.45888 49390.45888 0 0 0-136.46848-75.9296 35.90144 35.90144 0 0 1-12.04224-10.624c14.06464-14.35136 23.29088-30.94528 27.62752-49.55136 1.24416 0.29696 2.49344 0.55296 3.74272 0.81408 4.08064 0.84992 7.936 1.64864 10.91072 3.3536 60.63616 34.72384 107.1872 61.68576 150.92736 87.41888 53.44768 31.44704 79.72864 101.06368 58.58304 155.19232-26.86976 68.79232-73.82528 110.208-139.55072 123.12064-10.2144 2.00704-20.55168 3.0208-30.72512 3.0208-29.20448 0-58.67008-8.37632-87.58272-24.88832-8.54016-4.87936-16.8704-10.15296-24.6016-15.12448-2.16576-1.39264-4.22912-2.06848-6.30784-2.06848-2.05824 0-4.11136 0.6656-6.272 2.02752l-8.47872 5.39136c-16.55296 10.51648-33.66912 21.39648-50.71872 31.67744-19.23584 11.61728-37.41184 18.93888-55.57248 22.38976a124.16 124.16 0 0 1-23.01952 2.11968zM871.15264 686.39744c-7.41376-20.31104-20.46976-38.43584-40.36608-56.15104a2630.05696 2630.05696 0 0 1 13.78816-19.91168c10.11712-14.52032 20.5824-29.53216 30.17216-44.81024 13.2864-21.15584 20.24448-43.3152 20.68992-65.87392 0.96256-49.87392-20.0448-87.42912-62.43328-111.616-25.216-14.3872-53.86752-24.45312-87.58784-30.7712l-2.0736-0.37376 0.0256-0.99328c1.21856-32.23552 1.1264-70.29248-8.85248-108.1856-7.06048-26.8288-17.67936-46.57152-33.41824-62.12096-15.81056-15.616-40.69888-25.70752-63.4112-25.70752-12.0064 0-23.12192 2.70336-33.024 8.0384-13.8752 7.46496-26.00448 18.05312-37.08416 32.36352-11.392 14.72-16.82944 31.04768-16.64 49.92 0.33792 33.67936 0.32256 67.9424 0.30208 101.07904-0.01024 16-0.02048 31.99488 0.01024 47.99488 0.01024 5.88288-1.10592 11.21792-3.2512 15.63136a780.0832 780.0832 0 0 1-6.94784-1.1776c-7.9872-1.3824-15.52384-2.68288-23.3472-3.072a68.9408 68.9408 0 0 0-3.41504-0.08704c-6.99904 0-13.96224 0.9984-20.69504 1.96608l-3.85536 0.54272c-2.58048-6.35904-2.44736-13.28128-2.304-20.60288l0.82432-41.7536c0.82944-41.64096 1.65888-83.28704 2.304-124.928 0.92672-59.83232 47.104-115.30752 105.12896-126.30016 9.83552-1.86368 19.95776-2.0992 27.68384-2.0992 4.25472 0 8.50432 0.08192 12.7232 0.16896 29.8496 0.6144 54.97856 6.21568 76.83584 17.12128 59.3664 29.62944 92.32384 77.78816 97.96096 143.15008 0.95744 11.05408 0.39936 22.6048-0.13312 33.77664-0.19456 4.06528-0.38912 8.13056-0.52224 12.1856-0.16896 5.5808 1.85344 9.23136 6.56896 11.83232 5.59104 3.09248 11.19744 6.15936 16.7936 9.22624 17.55648 9.61024 35.70688 19.54304 53.07392 30.0288 26.04032 15.7184 44.79488 36.24448 55.74144 61.0048 18.90816 42.77248 20.56704 84.48 5.04832 127.49312-11.88352 32.95232-28.1088 66.0992-49.60256 101.3504-6.74816 11.05408-13.97248 22.12864-20.95616 32.83968-1.92 2.92864-3.84 5.87264-5.75488 8.82176zM214.60992 700.98944c-37.16096 0-72.0896-14.30016-95.8208-39.22432-14.75072-15.488-24.4224-35.04128-32.32256-52.1472-22.29248-48.26112-23.22944-97.10592-2.78528-145.18272 14.592-34.31936 40.27392-61.88544 76.3392-81.92512a473.32864 473.32864 0 0 1 24.86784-12.89216c6.6816-3.20512 7.31648-8.47872 7.2192-12.16l-0.26112-9.25184c-0.54272-19.31264-1.11104-39.29088-1.16736-58.9056-0.0768-24.39168 3.44064-45.11744 10.74176-63.36 7.92576-19.80416 20.92032-37.33504 42.14272-56.85248 22.14912-20.36736 49.98144-32.82944 87.59296-39.20896 26.60352-4.51584 55.19872-6.71232 87.41888-6.71232 17.51552 0 36.76672 0.65024 58.84928 1.99168 2.87744 0.17408 5.75488 0.36352 8.69888 0.55808-13.91616 16.67072-23.10656 37.02272-28.49792 62.97088l-20.79744-2.19648c-17.664-1.85344-35.93216-3.77344-54.1184-3.77344-6.82496 0-13.16864 0.26112-19.38432 0.79872-36.49024 3.13856-66.9952 18.80576-90.67008 46.56128-16.48128 19.31776-24.91904 43.27936-25.78432 73.23648-0.88064 30.58176 4.92032 62.49472 17.7408 97.56672l0.06656 0.18944-0.22016 0.11776c-35.3536 18.304-60.76928 35.16928-82.41152 54.68672-21.0944 19.03104-34.4064 37.36576-41.88672 57.7024-8.77568 23.84384-7.2704 48.6912 4.47488 73.86112a61.056 61.056 0 0 0 18.36032 22.82496c18.81088 14.44864 40.41728 21.78048 64.21504 21.78048 4.80256 0 9.7536-0.3072 14.73024-0.896 8.0384-0.95744 15.41632-4.39296 20.19328-7.1168 36.64384-20.8896 73.76384-42.34752 109.66016-63.09376l25.68192-14.83776c3.99872-2.30912 7.86944-3.73248 11.9296-4.36736 4.98688 20.54144 14.65344 37.63712 29.42464 52.02432-2.41664 2.99008-5.57056 5.51936-9.69216 7.79776l-107.8784 59.55584c-14.46912 7.9872-28.93312 15.96928-43.38176 23.99744-18.7136 10.38336-40.58624 15.87712-63.25248 15.87712l-0.01536 0.00512z" p-id="8801"></path><path d="M504.86272 427.12064c-48.81408 4.73088-85.07904 47.86688-81.48992 96.88576 3.21024 43.8784 37.69344 79.24224 81.51552 83.45088 1.57184 0.15872 3.89632-0.32256 4.7872-1.39776 11.01824-13.2864 21.05344-27.28448 26.55232-43.84256 1.88928-5.68832 2.35008-11.89888 3.05152-17.92 0.37888-3.2512-1.26464-4.7872-5.01248-4.61824-12.18048 0.5376-24.3712 0.73728-36.56192 0.93696-2.28352 0.03584-4.87424 1.01888-6.4256-2.18624-9.84576-20.33152-12.89728-41.41568-7.10144-63.42656 4.7104-17.88928 13.68576-33.51552 26.88-47.90272-2.66752 0-4.44416-0.14336-6.1952 0.02048z" p-id="8802"></path><path d="M523.78624 607.1552c0.7168-0.03584 1.96608 0.0256 3.16416-0.16384 22.51776-3.5584 41.34912-13.8496 56.11008-31.28832 24.60672-29.0816 28.54912-70.30784 9.3184-103.36768-14.40768-24.79616-36.08064-39.72608-64.54784-44.34432-1.52576-0.24576-3.73248 0.17408-4.79232 1.16736-14.0288 13.0304-23.99744 28.65664-28.71808 47.30368-1.46432 5.78048-1.88416 11.82208-2.8672 18.304h36.53632c10.24 0 10.16832 0.03072 14.2592 9.69728 10.51136 24.86784 8.16128 49.42336-2.47808 73.41568-4.46464 10.05056-10.53184 19.39456-15.98464 29.27616z" p-id="8803"></path></svg>
            </button>
        </div>
        <!-- 复用 chatapp 的输入栏结构和样式 -->
        <div class="chat-footer-input-row">
            <div class="chat-input-area">
                <input type="text" id="instance-chat-input" placeholder="输入你的行动...">
            </div>
            <button class="chat-action-btn" id="instance-api-reply-btn" title="让AI继续">
                <!-- AI回复和暂停图标的切换逻辑将由JS控制 -->
                <svg id="instance-api-reply-icon-default" style="display:block;" t="1767101507871" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1345" fill="#A1CACD"><path d="M201.1 913.6c-1.2 0-2.4 0-3.6-0.1-11.1-1-21.6-5.2-31.2-12.5-9.3-7.7-15.9-17.2-19.7-28.4-4-10.7-4.8-22.3-2.4-34.5l24.2-111.3c-24.7-31-43.8-64.3-56.8-98.8C95.3 586.2 87 542.7 87 498.6c0-104.8 44.9-202.7 126.5-275.9 38.8-35.1 83.9-62.7 134.2-81.9 52-19.9 107.2-30 164-30 112.3 0 218 39.8 297.7 112 39.6 35.7 70.8 77.3 92.5 123.7 22.6 48.1 34 99.3 34 152.2 0 52.8-11.4 104-34 152.1-21.8 46.5-52.9 88.1-92.5 123.6-38.7 35.2-83.8 62.8-134.1 82-51.9 19.9-106.9 29.9-163.6 29.9-33.8 0-67.9-3.8-101.6-11.4-28.8-6.2-55.6-14.9-79.7-25.7l-100.5 56.9c-9.5 4.9-19.2 7.5-28.8 7.5z m29.4-223.2c9.1 9 12.8 22 10 34.7l-22.8 105.5 94.9-53.9c5.2-2.8 10.9-4.3 16.6-4.3 5 0 9.7 1.1 14.1 3.2 26.5 12.9 53.9 22.4 81.4 28.3 27.4 6.2 56.6 9.4 87 9.4 95.5 0 185.3-33.4 252.7-94.1 31.9-28.6 57-62.1 74.5-99.4 18-38.5 27.2-79.3 27.2-121.3s-9.1-82.8-27.2-121.3c-17.5-37.3-42.6-70.9-74.5-99.7-67.7-60.7-157.4-94.1-252.7-94.1-95.5 0-185.4 33.4-253.1 94.1-31.8 28.9-56.9 62.4-74.5 99.7-18.2 38.6-27.5 79.5-27.5 121.3 0 34.7 6.5 68.9 19.2 101.8 12.9 33.1 31.2 63.4 54.7 90.1z m453.3-124.8c-13.2 0-26.2-5.7-36.5-16.1-9.7-10.2-15-23.6-15-37.8 0-14.1 5.3-27.6 14.9-38.1 10.1-10.2 23.1-15.8 36.6-15.8s26.5 5.6 36.5 15.7c9.7 10.6 15 24.1 15 38.2 0 14.3-5.3 27.7-15 37.8-10.3 10.4-23.2 16.1-36.5 16.1z m-172 0c-13.7 0-26.6-5.7-36.5-16.1-9.8-10.3-15.1-23.7-15.1-37.8 0-13.9 5.4-27.5 15.1-38.1 9.7-10.2 22.7-15.8 36.6-15.8 13.7 0 26.5 5.6 36.2 15.7 9.6 10.3 15 23.9 15 38.2 0 14.5-5.3 27.8-15 37.8-10 10.4-22.8 16.1-36.3 16.1z m-168.7 0c-13.4 0-26.6-5.9-36.3-16.1-9.6-9.9-14.9-23.3-14.9-37.8 0-14.3 5.3-27.8 14.9-38.1 9.7-10.2 22.6-15.8 36.4-15.8 13.6 0 26.5 5.6 36.4 15.7 9.8 10.5 15.1 24 15.1 38.2 0 14.3-5.4 27.8-15.1 37.8-10.2 10.4-23.2 16.1-36.5 16.1z" p-id="1346"></path></svg>
                <svg id="instance-api-reply-icon-stop" style="display:none;" t="1767105419099" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4974" fill="#A1CACD"><path d="M512 928.3c-229.2 0-415-185.8-415-415s185.8-415 415-415 415 185.8 415 415-185.8 415-415 415z m0.4-77.5c186.2 0 337.2-151 337.2-337.2s-151-337.2-337.2-337.2-337.2 151-337.2 337.2 150.9 337.2 337.2 337.2zM382.3 357.6h259.4c14.3 0 25.9 11.6 25.9 25.9V643c0 14.3-11.6 25.9-25.9 25.9H382.3c-14.3 0-25.9-11.6-25.9-25.9V383.6c0-14.4 11.6-26 25.9-26z"></path></svg>
            </button>
            <button class="chat-action-btn" id="instance-send-btn" title="发送">
                <svg t="1767102878463" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4994" fill="currentColor"><path d="M955 125.6c-4.5-12.5-15.4-21.8-28.6-24.2-9.2-1.7-18.4 0.1-26.1 4.8L83.9 544.3c-12.8 6.8-20.6 20.6-19.8 35.1 0.8 14.3 9.9 27.3 23.2 32.9l238.5 97.9c12.4 5.2 26.8 3.4 37.5-4.9s16.1-21.3 14.4-34.8c-1.6-13.2-10.4-24.6-23-29.9l-165-67.7 573-307.3-357 421.9c-6.5 7.7-9.6 17.4-8.8 27.4L411.4 884c1.6 19.7 17.7 34.6 37.5 34.6 9.5 0 18.7-3.7 25.8-10.4l74-69.2 0.1-0.1c13.5-13.2 15.2-33.5 4.8-48.4l222.6 72c4 1.3 7.9 2 11.7 2 18.2 0 33.8-12.9 37-30.6l131.6-688.3h-0.1c1.4-6.6 0.9-13.5-1.4-20zM497.3 783.8L479.9 800l-6.5-75.9L856 271.6l-96.8 506.3L539 706.6c-19.7-6.4-41.1 4.4-47.5 24.2-5.8 17.9 2.5 37.1 18.9 45.4-4.7 1.5-9.2 4-13.1 7.6z"></path></svg>
            </button>
        </div>
    </div>
</div>
<!-- === 新增：副本行动选项悬浮框 === -->
<div id="action-options-overlay">
    <div id="action-options-box">
        <div id="action-options-list">
            <!-- 选项将由JS动态填充 -->
        </div>
    </div>
</div>
    <!-- === 新增：副本状态悬浮窗 === -->
    <div id="instance-status-overlay" class="chatapp-popup-overlay">
        <div id="instance-status-popup" class="chatapp-popup-box" style="padding: 0; position: absolute; bottom: 0; left: 0; right: 0; margin: 0 auto 20px; border-radius: 20px 20px 0 0;">
            <div id="instance-status-header">
                <!-- 可以留空或添加标题 -->
            </div>
            <div id="instance-status-content-area">
<div class="instance-status-page active" id="status-page-panel">
    <div class="status-card-container">
        <!-- User 面板：仅显示时间、地点、积分 -->
        <div class="status-card" id="user-status-card" style="cursor: pointer;">
            <div id="user-status-avatar" class="status-card-avatar"></div>
            <div class="status-card-info">
                <div class="name">
                    <span id="user-status-name">--</span>
                    <span class="points">积分: <span id="user-status-points">0</span></span>
                </div>
                <div class="meta-item">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></svg>
                    <span id="user-status-time">时间: 未知</span>
                </div>
                <div class="meta-item">
                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5z"></path></svg>
                    <span id="user-status-location">地点: 未知</span>
                </div>
            </div>
            <!-- 折叠指示器 -->
            <svg class="status-card-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
        </div>
        <!-- 新增：副本进度显示框 -->
        <div id="user-progress-details" class="progress-details-container">
            <!-- 进度列表将由JS动态填充 -->
        </div>
        <!-- Char 面板：仅显示地点、状态、好感度 -->
        <div id="char-status-cards-container">
            <!-- 角色卡片将由JS动态填充 -->
        </div>
    </div>
</div>
                <div class="instance-status-page" id="status-page-backpack">
                    <span class="empty-text">这是背包页面</span>
                </div>
                <div class="instance-status-page" id="status-page-task">
                    <div id="instance-task-list" style="text-align: left; line-height: 1.8; font-size: 15px;">
                        <!-- 副本任务将由JS动态渲染到这里 -->
                    </div>
                </div>
            </div>
            <div id="instance-status-footer">
                <div id="instance-status-nav-bar">
                    <div class="instance-status-nav-item active" data-page="panel">
                        <svg t="1767627860899" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M128 213.333333a42.666667 42.666667 0 0 0-42.666667 42.666667v512a42.666667 42.666667 0 0 0 42.666667 42.666667h768a42.666667 42.666667 0 0 0 42.666667-42.666667V256a42.666667 42.666667 0 0 0-42.666667-42.666667H128z m0-85.333333h768a128 128 0 0 1 128 128v512a128 128 0 0 1-128 128H128a128 128 0 0 1-128-128V256a128 128 0 0 1 128-128z"></path><path d="M384 384m42.666667 0l170.666666 0q42.666667 0 42.666667 42.666667l0 0q0 42.666667-42.666667 42.666666l-170.666666 0q-42.666667 0-42.666667-42.666666l0 0q0-42.666667 42.666667-42.666667Z"></path><path d="M298.666667 554.666667m42.666666 0l341.333334 0q42.666667 0 42.666666 42.666666l0 0q0 42.666667-42.666666 42.666667l-341.333334 0q-42.666667 0-42.666666-42.666667l0 0q0-42.666667 42.666666-42.666666Z"></path></svg>
                        <span>面板</span>
                    </div>
                    <div class="instance-status-nav-item" data-page="backpack">
                        <svg t="1767627951793" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M889.002667 714.666667l-13.098667-122.88c-2.517333-25.429333-25.685333-44.714667-52.906667-44.714667h-24.149333l-16.128-203.818667a131.157333 131.157333 0 0 0-2.986667-20.224V322.56c-15.616-64.512-77.568-112.512-150.613333-112.512h-26.197333c-5.546667-42.368-43.818667-75.306667-90.666667-75.306667S426.666667 167.68 421.589333 210.048h-26.197333c-72.533333 0-134.954667 48-150.613333 112.512v0.426667c-1.493333 6.613333-2.474667 13.653333-3.498667 20.736l-16.128 203.818666h-24.149333c-27.733333 0-50.389333 19.285333-52.906667 44.714667l-13.098667 122.88c-1.493333 14.08 3.541333 27.733333 13.610667 38.570667s24.661333 16.469333 39.253333 16.469333h19.669334l-2.005334 23.04a85.248 85.248 0 0 0 25.173334 67.328 98.986667 98.986667 0 0 0 70.016 28.714667h422.101333a98.133333 98.133333 0 0 0 69.973333-28.714667c18.176-18.346667 27.221333-42.837333 25.173334-67.285333l-1.962667-23.082667h19.626667c15.104 0 29.226667-6.101333 39.253333-16.469333 10.112-10.368 15.658667-25.429333 14.122667-39.082667zM511.744 180.821333a41.386667 41.386667 0 0 1 39.808 28.245334h-79.061333c4.522667-16 20.138667-28.245333 39.253333-28.245334z m-117.333333 75.306667h234.24c48.298667 0 90.112 31.573333 100.693333 74.368a285.994667 285.994667 0 0 1-5.546667 68.693333l-21.632 106.410667c-4.053333 19.754667-22.698667 34.346667-44.373333 34.346667h-17.066667v-13.653334c0-13.141333-11.093333-23.509333-25.173333-23.509333-14.122667 0-25.216 10.368-25.216 23.509333v13.653334H432.64v-13.653334c0-13.141333-11.093333-23.509333-25.173333-23.509333-14.08 0-25.173333 10.368-25.173334 23.509333v13.653334h-17.152c-21.674667 0-40.277333-14.592-44.330666-34.346667l-21.632-106.368a285.994667 285.994667 0 0 1-5.546667-68.693333c11.093333-42.410667 52.352-74.410667 100.693333-74.410667zM187.392 722.176c-1.024 0-1.536-0.469333-2.005333-0.938667-0.512-0.469333-1.024-1.408-0.512-2.346666l13.098666-122.88c0-1.408 1.493333-2.346667 2.986667-2.346667h20.693333l-10.112 128.512h-24.149333z m568.661333 105.386667c-8.533333 8.96-20.650667 13.653333-33.28 13.653333H300.757333c-12.586667 0-24.661333-4.693333-33.28-13.653333a41.088 41.088 0 0 1-12.032-32l20.650667-264.96c14.08 33.877333 49.322667 56.96 89.130667 56.96h17.109333v33.877333c0 13.184 11.093333 23.552 25.173333 23.552 14.122667 0 25.173333-10.368 25.173334-23.552v-33.877333h157.696v33.877333c0 13.184 11.093333 23.552 25.173333 23.552 14.08 0 25.173333-10.368 25.173333-23.552v-33.877333h17.152c39.765333 0 75.050667-23.04 89.173334-56.96l20.608 264.96a40.618667 40.618667 0 0 1-11.562667 32z m82.090667-106.325334a3.925333 3.925333 0 0 1-2.005333 0.938667h-23.68l-10.069334-128.512h20.650667c1.493333 0 2.986667 0.938667 2.986667 2.346667l13.141333 122.88c0 0.938667 0 1.877333-1.024 2.346666z"></path></svg>
                        <span>背包</span>
                    </div>
                    <div class="instance-status-nav-item" data-page="task">
                        <svg t="1767628032710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M613.888 715.264h-41.984C448.512 715.264 348.16 614.912 348.16 491.52s99.84-223.232 223.232-223.232h41.984c123.392 0 223.232 99.84 223.232 223.232 0.512 123.392-99.328 223.744-222.72 223.744z" fill="#8a8a8a" opacity=".2"></path><path d="M839.68 271.36zM919.552 941.056h-132.096c-14.336 0-25.6-11.264-25.6-25.6s11.264-25.6 25.6-25.6h80.896V191.488H155.648v698.368h283.136c14.336 0 25.6 11.264 25.6 25.6s-11.264 25.6-25.6 25.6H104.448V186.368c0-25.6 20.48-46.08 46.08-46.08h722.944c25.6 0 46.08 20.48 46.08 46.08v754.688z"></path><path d="M722.432 327.68H419.84c-10.24 0-17.92-11.264-17.92-25.6s7.68-25.6 17.92-25.6h302.592c10.24 0 17.92 11.264 17.92 25.6s-8.192 25.6-17.92 25.6zM773.632 483.84H419.84c-10.24 0-17.92-11.264-17.92-25.6s7.68-25.6 17.92-25.6h353.792c10.24 0 17.92 11.264 17.92 25.6s-8.192 25.6-17.92 25.6zM620.032 639.488H419.84c-10.24 0-17.92-11.264-17.92-25.6s7.68-25.6 17.92-25.6h200.192c10.24 0 17.92 11.264 17.92 25.6s-8.192 25.6-17.92 25.6z"></path><path d="M625.664 941.056H509.952c-14.336 0-25.6-11.264-25.6-25.6s11.264-25.6 25.6-25.6h115.712c14.336 0 25.6 11.264 25.6 25.6s-11.776 25.6-25.6 25.6zM720.896 941.056h-26.624c-14.336 0-25.6-11.264-25.6-25.6s11.264-25.6 25.6-25.6h26.624c14.336 0 25.6 11.264 25.6 25.6s-11.264 25.6-25.6 25.6zM276.48 187.904c-14.336 0-25.6-11.264-25.6-25.6v-48.64c0-14.336 11.264-25.6 25.6-25.6s25.6 11.264 25.6 25.6v48.64c0 13.824-11.776 25.6-25.6 25.6zM753.664 187.904c-14.336 0-25.6-11.264-25.6-25.6v-48.64c0-14.336 11.264-25.6 25.6-25.6s25.6 11.264 25.6 25.6v48.64c0 13.824-11.264 25.6-25.6 25.6z"></path><path d="M286.72 358.4c-25.6 0-46.08-20.48-46.08-46.08s20.48-46.08 46.08-46.08 46.08 20.48 46.08 46.08-20.992 46.08-46.08 46.08z m0-71.68c-13.824 0-25.6 11.264-25.6 25.6s11.264 25.6 25.6 25.6 25.6-11.264 25.6-25.6-11.776-25.6-25.6-25.6zM286.72 659.968c-25.6 0-46.08-20.48-46.08-46.08s20.48-46.08 46.08-46.08 46.08 20.48 46.08 46.08-20.992 46.08-46.08 46.08z m0-71.68c-13.824 0-25.6 11.264-25.6 25.6 0 13.824 11.264 25.6 25.6 25.6s25.6-11.264 25.6-25.6c0-13.824-11.776-25.6-25.6-25.6zM297.472 458.24l20.992-17.92c4.096-3.584 5.12-10.24 1.024-14.336-3.584-4.096-10.24-5.12-14.336-1.024L281.6 444.928 257.536 424.96c-4.096-3.584-10.752-3.072-14.336 1.024-3.584 4.096-3.072 10.752 1.024 14.336l20.992 17.92-20.992 17.92c-4.096 3.584-5.12 10.24-1.024 14.336 2.048 2.56 5.12 3.584 7.68 3.584s4.608-1.024 6.656-2.56l24.064-19.968 24.064 19.968c2.048 1.536 4.096 2.56 6.656 2.56 3.072 0 5.632-1.024 7.68-3.584 3.584-4.096 3.072-10.752-1.024-14.336l-21.504-17.92z"></path></svg>
                        <span>任务</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- === 新增：副本内手机模拟器 === -->
<div id="instance-phone-simulator-overlay">
    <div id="phone-simulator-frame">
        <div id="phone-simulator-screen">
            <!-- 手机屏幕内容将由JS动态渲染 -->
        </div>
        <!-- 新增：右下角缩放把手 -->
        <div id="phone-resize-handle"></div>
    </div>
</div>
<!-- === 新增：副本结算加载动画悬浮窗 === -->
<div id="instance-settlement-loading-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box" style="background: transparent; box-shadow: none; text-align: center;">
        <!-- 动态加载图标 -->
        <div class="settlement-loader"></div>
        <p style="color: white; font-weight: 600; margin-top: 15px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">正在结算……</p>
    </div>
</div>

<!-- === 新增：副本结算结果悬浮窗 === -->
<div id="instance-settlement-result-overlay" class="chatapp-popup-overlay">
    <div id="instance-settlement-result-popup" class="chatapp-popup-box" style="max-width: 500px; max-height: 90vh;">
        <div id="instance-settlement-result-body" style="overflow-y: auto; display: flex; flex-direction: column; gap: 20px; padding: 10px;">
            <!-- 通关者 -->
            <div class="settlement-section">
                <h5>通关者</h5>
                <div id="settlement-participants" class="participants-container">
                    <!-- 通关者卡片将由JS动态填充 -->
                </div>
            </div>
            <!-- 结局与成就 -->
            <div class="settlement-section">
                <h5>结局</h5>
                <div class="settlement-ending-achievement">
                    <span id="settlement-ending-result">结局：成功</span>
                    <span id="settlement-achievement-title">成就：末日救世主</span>
                </div>
            </div>
            <!-- 副本故事 -->
            <div class="settlement-section">
                <h5>副本故事</h5>
                <div id="settlement-story-summary" class="story-summary-box">
                    <!-- 故事梗概将由JS动态填充 -->
                </div>
            </div>
            <!-- 结算奖励 -->
            <div class="settlement-section">
                <h5>结算奖励</h5>
                <div id="settlement-rewards" class="rewards-container">
                    <!-- 结算奖励将由JS动态填充 -->
                </div>
            </div>
        </div>
        <div class="button-group">
            <button id="close-settlement-result-btn" class="modal-button">确认</button>
        </div>
    </div>
</div>
<!-- === 新增：音乐播放器封面图库悬浮窗 === -->
<div id="music-gallery-overlay" class="music-popup-overlay">
    <div id="music-gallery-box" class="music-popup-box">
        <h4>播放器封面图库</h4>
        <div id="music-gallery-grid" class="music-gallery-grid">
            <!-- 图片预览将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="close-music-gallery-btn" class="modal-button">关闭</button>
        </div>
    </div>
</div>
<input type="file" id="music-cover-upload-input" accept="image/*" hidden multiple>

<!-- === 新增：副本内气泡长按菜单 === -->
<div id="instance-message-context-menu">
    <div class="instance-context-menu-item" data-action="edit">编辑</div>
    <div class="instance-context-menu-item" data-action="delete">删除</div>
</div>

<!-- === 新增：副本消息编辑悬浮窗 === -->
<div id="instance-edit-message-overlay">
    <div class="instance-edit-message-box">
        <h4>编辑消息</h4>
        <textarea id="instance-edit-message-textarea"></textarea>
        <div class="button-group">
            <button id="cancel-instance-edit-btn" class="modal-button secondary">取消</button>
            <button id="confirm-instance-edit-btn" class="modal-button">确定</button>
        </div>
    </div>
</div>
<!-- === 新增：每日情话卡片上下文菜单 === -->
<div id="sweet-words-context-menu-overlay">
    <div id="sweet-words-context-menu">
        <div class="sw-context-menu-item" data-action="refresh">刷新</div>
        <div class="sw-context-menu-item" data-action="settings">设置</div>
    </div>
</div>

<!-- === 新增：每日情话设置悬浮窗 === -->
<div id="sweet-words-settings-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4>每日情话设置</h4>
        <div class="modal-form-section" style="gap: 20px; max-height: 60vh; overflow-y: auto; padding: 10px;">
            <div class="modal-form-group">
                <label>卡片背景</label>
                <div style="display:flex; gap: 10px;">
                     <button id="sw-set-bg-btn" class="modal-button secondary" style="flex-grow: 1;">选择图片</button>
                     <button id="sw-clear-bg-btn" class="modal-button danger" style="flex-shrink: 0;">清除背景</button>
                </div>
                <input type="file" id="sw-bg-upload" accept="image/*" hidden>
            </div>

            <div class="modal-form-group">
                <label for="sw-fixed-contact-select">固定联系人</label>
                <select id="sw-fixed-contact-select" class="modal-select">
                    <option value="">随机</option>
                    <!-- 角色列表将由JS动态填充 -->
                </select>
            </div>

            <div class="modal-form-group">
                <div class="switch-group">
                    <label>每日自动生成</label>
                    <label class="switch-container">
                        <input type="checkbox" id="sw-auto-generate-switch">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <div id="sw-auto-time-group" class="modal-form-group" style="display: none;">
                <label for="sw-auto-time-input">自动生成时间</label>
                <input type="time" id="sw-auto-time-input" class="modal-input">
            </div>
        </div>
        <div class="button-group">
            <button id="sw-settings-close-btn" class="modal-button secondary">关闭</button>
            <button id="sw-settings-save-btn" class="modal-button">保存设置</button>
        </div>
    </div>
</div>
<input type="file" id="character-card-import-input" accept=".png,.json" hidden>
<!-- === 新增：聊天图库管理悬浮窗 === -->
<div id="gallery-management-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box" style="max-height: 80vh; max-width: 480px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>图库管理</h4>
            <button id="close-gallery-management" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div id="gallery-management-body" style="overflow-y: auto; display: flex; flex-direction: column; gap: 20px;">
            <!-- 添加新图片表单 (已修改为可折叠) -->
            <details id="add-gallery-section">
                <summary>
                    <span>添加新图片</span>
                    <svg class="gallery-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg>
                </summary>
                <div class="modal-form-section">
                    <div class="modal-form-group">
                        <label for="gallery-image-name">图片名称/描述</label>
                        <input type="text" id="gallery-image-name" class="modal-input" placeholder="AI将通过此名称发送图片">
                    </div>
                    <div class="modal-form-group">
                        <label>绑定范围</label>
                        <div class="injection-position-selector"> <!-- 复用已有样式 -->
                             <input type="radio" id="scope-global" name="gallery-scope" value="global" checked>
                             <label for="scope-global">全局</label>
                             <input type="radio" id="scope-chat" name="gallery-scope" value="chat">
                             <label for="scope-chat">当前聊天</label>
                        </div>
                    </div>
                    <div class="modal-form-group">
                        <label for="gallery-image-url">图片链接 或</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="gallery-image-url" class="modal-input" placeholder="输入图床链接">
                            <button id="gallery-upload-btn" class="modal-button secondary" style="flex-shrink: 0;">上传本地</button>
                            <input type="file" id="gallery-upload-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div class="button-container">
                        <button id="add-gallery-image-btn" class="modal-button">添加到图库</button>
                    </div>
                </div>
            </details>
            <!-- 图片列表 -->
            <div id="gallery-grid-container">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                <!-- 图片列表将由JS动态渲染 -->
                <span class="empty-text">图库为空</span>
            </div>
        </div>
    </div>
</div>
<!-- === 新增：“印象”功能悬浮窗 === -->
<div id="impression-overlay" class="chatapp-popup-overlay">
    <div id="impression-modal">
        <button id="impression-close-btn" class="close-btn" title="关闭">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
        <div class="impression-header">
            <div id="impression-avatars" class="impression-avatars">
                <!-- 头像将由JS动态填充 -->
            </div>
            <div id="impression-relationship" class="impression-relationship">
                <!-- 关系将由JS动态填充 -->
            </div>
        </div>
        <div id="impression-list" class="impression-list">
            <!-- 印象列表将由JS动态填充 -->
        </div>
    </div>
</div>
<!-- === 新增：创建群聊悬浮窗 === -->
 
<div id="create-group-popup-overlay">
    <div class="create-group-popup-box">
        <h4>创建群聊</h4>
        <div class="create-group-avatar-setter">
            <div id="group-avatar-preview">
                <span>群头像</span>
            </div>
            <input type="file" id="group-avatar-upload" accept="image/*" hidden>
        </div>
        <div class="modal-form-group">
            <input type="text" id="group-name-input" class="modal-input" placeholder="请输入群聊名称">
        </div>
        <div id="group-member-selection-list">
            <!-- 成员选择列表将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="cancel-create-group-btn" class="modal-button secondary">取消</button>
            <button id="confirm-create-group-btn" class="modal-button">确认</button>
        </div>
    </div>
</div>

<!-- === 新增：分组管理悬浮窗 === -->
<div id="group-management-overlay" class="chatapp-popup-overlay">
    <div id="group-management-popup" class="chatapp-popup-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>分组管理</h4>
            <button id="close-group-management-btn" title="关闭" style="background: none; border: none; cursor: pointer; padding: 4px; line-height: 1;">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: var(--text-color);"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="modal-form-group">
            <input type="text" id="new-group-name-input" class="modal-input" placeholder="输入新分组名称...">
        </div>
        <div id="group-list-container" style="flex-grow: 1; overflow-y: auto; padding: 5px;">
            <!-- 分组列表将由JS动态渲染 -->
        </div>
        <div class="button-group">
            <button id="create-new-group-btn" class="modal-button">创建新分组</button>
        </div>
    </div>
</div>

<!-- === 新增：联系人选择悬浮窗 === -->
<div id="group-contact-selector-overlay" class="chatapp-popup-overlay" style="z-index: 2300;">
    <div class="chatapp-popup-box">
        <h4>选择联系人</h4>
        <div id="group-contact-selector-list" style="max-height: 50vh; overflow-y: auto;">
             <!-- 可选联系人将由JS动态渲染 -->
        </div>
        <div class="button-group">
            <button id="cancel-contact-selection-btn" class="modal-button secondary">取消</button>
            <button id="confirm-contact-selection-btn" class="modal-button">确认添加</button>
        </div>
    </div>
</div>
<!-- === 新增：移动分组-分组选择悬浮窗 === -->
<div id="move-to-group-overlay" class="chatapp-popup-overlay" style="z-index: 2250;">
    <div id="move-to-group-popup" class="chatapp-popup-box">
        <h4>
            移动分组
            <span id="current-group-display" style="font-size: 12px; font-weight: 400; color: #94a3b8; margin-left: 10px;"></span>
        </h4>
        <div id="move-to-group-list" style="max-height: 50vh; overflow-y: auto;">
            <!-- 分组列表将由JS动态填充 -->
        </div>
        <div class="button-group">
            <button id="cancel-move-to-group-btn" class="modal-button secondary">取消</button>
        </div>
    </div>
</div>
<!-- === 新增：转账操作悬浮窗 === -->
<div id="transfer-action-overlay" class="chatapp-popup-overlay">
    <div class="chatapp-popup-box">
        <h4 id="transfer-action-amount" style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">¥ 0.00</h4>
        <p id="transfer-action-description" style="text-align: center; color: var(--text-color); opacity: 0.7; margin: 0 0 20px 0;"></p>
        <div class="button-group" style="justify-content: space-around;">
            <button id="transfer-action-return" class="modal-button secondary">退还</button>
            <button id="transfer-action-accept" class="modal-button">收下</button>
        </div>
    </div>
</div>
<!-- === 新增：小剧场创建悬浮窗 === -->
<div id="little-theater-fab" title="创建小剧场">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
</div>
<div id="create-theater-overlay">
    <div id="create-theater-popup">
        <h4>创建小剧场</h4>
        
        <!-- 新增的滚动容器 -->
        <div class="create-theater-body">
            <div class="modal-form-group">
                <label for="theater-theme-textarea">小剧场主题</label>
                <textarea id="theater-theme-textarea" class="modal-input" placeholder="输入小剧场的主题或背景设定..."></textarea>
            </div>
            <div class="modal-form-group">
                <label>选择角色</label>
                <div id="theater-character-list">
                    <!-- 角色列表将由JS动态填充 -->
                    <span class="empty-text" style="padding: 30px 0; text-align: center;">暂无可用角色</span>
                </div>
            </div>
            
            <!-- 新增：文风预设板块 -->
            <div class="modal-form-group">
                <h5>文风预设</h5>
                <!-- 预设管理部分 -->
                <div class="preset-controls" style="margin-bottom: 12px;">
                    <select id="theater-style-preset-select" class="modal-select">
                        <option value="">加载预设到输入框...</option>
                    </select>
                    <button id="save-theater-style-btn" class="modal-button" style="padding: 8px 12px; font-size: 13px;">保存</button>
                    <button id="update-theater-style-btn" class="modal-button secondary" style="padding: 8px 12px; font-size: 13px;">更新</button>
                    <button id="delete-theater-style-btn" class="modal-button secondary" style="background-color:#be123c; color:white; padding: 8px 12px; font-size: 13px;">删除</button>
                </div>

                <!-- 主输入框 -->
                <textarea id="theater-writing-style-textarea" class="modal-input" placeholder="在此输入或从预设加载主要文风..."></textarea>
                
                <!-- 多选区域 -->
                <div id="theater-writing-style-presets-list">
                    <!-- 多选框将在这里动态生成 -->
                </div>
            </div>
        </div>

        <div class="button-group">
            <button id="cancel-create-theater" class="modal-button secondary">取消</button>
            <button id="confirm-create-theater" class="modal-button">生成</button>
        </div>
    </div>
</div>
<!-- === 新增：小剧场卡片长按菜单 === -->
<div id="little-theater-context-menu-overlay">
    <div id="little-theater-context-menu">
        <div class="lt-context-menu-item" data-action="delete">删除</div>
    </div>
</div>
<!-- === 新增：线下聊天界面容器 === -->
<div id="offline-chat-container">
    <div id="offline-chat-header">
        <button id="offline-chat-back-btn" title="返回">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
        </button>
    </div>
    <div id="offline-chat-messages">
        <!-- 线下聊天消息将在这里渲染 -->
    </div>
    <div id="offline-chat-footer">
        <!-- 这里的内容将从主聊天界面的底栏动态复制过来 -->
    </div>
    <!-- === 新增：线下模式退出确认弹窗 === -->
<div id="offline-exit-confirm-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p>您要暂时离开，还是彻底退出线下模式？</p>
        <div style="display: flex; flex-direction: column; gap: 10px; justify-content: center;">
            <button id="offline-exit-temp-btn" class="modal-button secondary">暂时离开</button>
            <button id="offline-exit-confirm-btn" class="modal-button">退出线下模式</button>
            <button id="offline-exit-cancel-btn" class="modal-button secondary" style="background: transparent; color: var(--text-color); margin-top: 10px;">取消</button>
        </div>
    </div>
</div>

<!-- === 新增：AI自主切换线下模式提示框 === -->
<div id="ai-offline-prompt-overlay" class="chatapp-popup-overlay" style="z-index: 2900;">
    <div id="ai-offline-prompt-box" class="chatapp-popup-box">
        <p>检测到即将线下见面，是否开启线下模式？</p>
        <div class="button-group" style="justify-content: space-around;">
            <button id="ai-offline-confirm-no" class="modal-button secondary">否</button>
            <button id="ai-offline-confirm-yes" class="modal-button">是</button>
        </div>
    </div>
</div>

</div>
</body>
</html>
